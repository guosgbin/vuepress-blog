<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.62" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://blog.guosgbin.cn/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html"><meta property="og:title" content="20-çº¿ç¨‹æ± ä½“ç³»-ThreadPoolExecutor"><meta property="og:description" content="ç‰ˆæœ¬ å†…å®¹ æ—¶é—´ ---- ------------------------ ---------------------- V1 æ–°å»º 2021å¹´03æœˆ12æ—¥23:09:11 V2 åŸºäºç¬¬ä¸€ç‰ˆä¿®æ”¹å¹¶é‡æ–°æ’ç‰ˆ 2022å¹´10æœˆ12æ—¥21:20:34 çº¿ç¨‹æ± çš„ä¼˜åŠ¿ é™ä½èµ„æºæ¶ˆè€— æˆ‘ä»¬çŸ¥é“ï¼Œçº¿ç¨‹åœ¨Javaå †é‡Œé¢æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†èµ„æºï¼Œçº¿ç¨‹åˆ›å»ºã€..."><meta property="og:type" content="article"><meta property="og:image" content="https://blog.guosgbin.cn/"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-05-04T03:52:42.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="20-çº¿ç¨‹æ± ä½“ç³»-ThreadPoolExecutor"><meta property="article:author" content="è¶…å¨è“çŒ« Dylan Kwok"><meta property="article:modified_time" content="2023-05-04T03:52:42.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"20-çº¿ç¨‹æ± ä½“ç³»-ThreadPoolExecutor","image":["https://blog.guosgbin.cn/"],"dateModified":"2023-05-04T03:52:42.000Z","author":[{"@type":"Person","name":"è¶…å¨è“çŒ« Dylan Kwok","url":"","email":"guosgbin@163.com"}]}</script><link rel="icon" href="/å°ç†ŠçŒ«.svg"><title>20-çº¿ç¨‹æ± ä½“ç³»-ThreadPoolExecutor</title><meta name="description" content="ç‰ˆæœ¬ å†…å®¹ æ—¶é—´ ---- ------------------------ ---------------------- V1 æ–°å»º 2021å¹´03æœˆ12æ—¥23:09:11 V2 åŸºäºç¬¬ä¸€ç‰ˆä¿®æ”¹å¹¶é‡æ–°æ’ç‰ˆ 2022å¹´10æœˆ12æ—¥21:20:34 çº¿ç¨‹æ± çš„ä¼˜åŠ¿ é™ä½èµ„æºæ¶ˆè€— æˆ‘ä»¬çŸ¥é“ï¼Œçº¿ç¨‹åœ¨Javaå †é‡Œé¢æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†èµ„æºï¼Œçº¿ç¨‹åˆ›å»ºã€...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-219a40be.css" as="style"><link rel="stylesheet" href="/assets/style-219a40be.css">
    <link rel="modulepreload" href="/assets/app-2523771a.js"><link rel="modulepreload" href="/assets/20-çº¿ç¨‹æ± ä½“ç³»-ThreadPoolExecutor.html-96e09bd4.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/20-çº¿ç¨‹æ± ä½“ç³»-ThreadPoolExecutor.html-a274637a.js"><link rel="prefetch" href="/assets/index.html-f838ce4f.js" as="script"><link rel="prefetch" href="/assets/01-CASå’ŒUnsafeçš„APIåˆ†æ.html-612c4d6a.js" as="script"><link rel="prefetch" href="/assets/02-åŸºæœ¬ç±»å‹åŸå­ç±»AtomicLong.html-4083b8fd.js" as="script"><link rel="prefetch" href="/assets/03-å¼•ç”¨ç±»å‹åŸå­ç±»AtomicReference.html-8442553d.js" as="script"><link rel="prefetch" href="/assets/04-åŸå­æ•°ç»„ç±»AtomicLongArray.html-74e4c741.js" as="script"><link rel="prefetch" href="/assets/05-åŸå­æ“ä½œç±»AtomicReferenceFieldUpdater.html-d0310b2a.js" as="script"><link rel="prefetch" href="/assets/06-é«˜æ€§èƒ½åŸå­ç±»LongAdder.html-d6e3da8b.js" as="script"><link rel="prefetch" href="/assets/07-LockSupportåˆ†æ.html-8117dd17.js" as="script"><link rel="prefetch" href="/assets/08-AQSç®€å•ä»‹ç».html-f6f424de.js" as="script"><link rel="prefetch" href="/assets/09-åŸºäºReentrantLockåˆ†æAQSçš„ç‹¬å æ¨¡å¼.html-2423c430.js" as="script"><link rel="prefetch" href="/assets/10-åŸºäºCountDownLatchåˆ†æAQSçš„å…±äº«æ¨¡å¼.html-91ef4833.js" as="script"><link rel="prefetch" href="/assets/11-AQSçš„Conditionæœºåˆ¶.html-836364af.js" as="script"><link rel="prefetch" href="/assets/12-ä¿¡å·é‡Semaphore.html-3509682c.js" as="script"><link rel="prefetch" href="/assets/13-å¾ªç¯æ æ …CyclicBarrier.html-812d137d.js" as="script"><link rel="prefetch" href="/assets/14-é˜¶æ®µPhaser.html-d684f4a1.js" as="script"><link rel="prefetch" href="/assets/15-äº¤æ¢Exchanger.html-b9bf24f3.js" as="script"><link rel="prefetch" href="/assets/16-è¯»å†™é”ReentrantReadWriteLock.html-de44a1d3.js" as="script"><link rel="prefetch" href="/assets/17-Futureæ¨¡å¼-FutureTask.html-641c6250.js" as="script"><link rel="prefetch" href="/assets/18-çº¿ç¨‹æ± ä½“ç³»æ¦‚è¿°.html-dbcc52e5.js" as="script"><link rel="prefetch" href="/assets/19-çº¿ç¨‹æ± ä½“ç³»-AbstractExecutorService.html-fbd70afb.js" as="script"><link rel="prefetch" href="/assets/21-çº¿ç¨‹æ± ä½“ç³»-ScheduledThreadPoolExecutor.html-707ffd40.js" as="script"><link rel="prefetch" href="/assets/22-CopyOnWriteArrayListå†™æ—¶å¤åˆ¶.html-914977b9.js" as="script"><link rel="prefetch" href="/assets/23-CopyOnWriteArraySetå†™æ—¶å¤åˆ¶.html-6c9c3cf6.js" as="script"><link rel="prefetch" href="/assets/24-ConcurrentSkipListMapè·³è¡¨.html-6cff54bf.js" as="script"><link rel="prefetch" href="/assets/25-ConcurrentSkipListSetè·³è¡¨.html-36cf4f7d.js" as="script"><link rel="prefetch" href="/assets/26-ConcurrentHashMapæºç åˆ†æ.html-a3bba8a9.js" as="script"><link rel="prefetch" href="/assets/27-é˜»å¡é˜Ÿåˆ—ArrayBlockingQueue.html-cd091357.js" as="script"><link rel="prefetch" href="/assets/28-é˜»å¡é˜Ÿåˆ—LinkedBlockingQueue.html-d3579ee7.js" as="script"><link rel="prefetch" href="/assets/29-é˜»å¡é˜Ÿåˆ—LinkedBlockingDeque.html-32c13680.js" as="script"><link rel="prefetch" href="/assets/30-é˜»å¡é˜Ÿåˆ—PriorityBlockingQueue.html-b5455c77.js" as="script"><link rel="prefetch" href="/assets/31-é˜»å¡é˜Ÿåˆ—DelayQueue.html-7759c195.js" as="script"><link rel="prefetch" href="/assets/32-é˜»å¡é˜Ÿåˆ—SynchronousQueue.html-97ed879a.js" as="script"><link rel="prefetch" href="/assets/33-é˜»å¡é˜Ÿåˆ—LinkedTransferQueue.html-3281c1b4.js" as="script"><link rel="prefetch" href="/assets/index.html-f5239cf3.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis01ï¼šmyabtisçš„æ•´ä½“æ¶æ„.html-f25c0705.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis02ï¼šå…¥é—¨æ¡ˆä¾‹.html-30e68cd3.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis03ï¼šè§£æå…¨å±€é…ç½®æ–‡ä»¶.html-2db85266.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis04ï¼šè§£æMapperæ˜ å°„æ–‡ä»¶.html-60756a5b.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis05ï¼šè§£æStatementæ“ä½œèŠ‚ç‚¹.html-31e11b60.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis06ï¼šè§£æSQLè¯­å¥.html-a9181b56.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis07ï¼šJavaæ–¹æ³•å’ŒSQLè¯­å¥ç»‘å®š.html-9bfa3db6.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis08ï¼šè·å¾—SqlSession.html-e2a92940.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis09ï¼šExecutoræ‰§è¡Œå™¨.html-ad701715.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis10ï¼šç¼“å­˜æœºåˆ¶.html-f2daa10c.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis11ï¼šStatementHandler.html-95b30d9b.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis12ï¼šå‚æ•°è§£æå’Œèµ‹å€¼.html-5778c0ea.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis13ï¼šç»“æœé›†å¤„ç†.html-2ff72779.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis14ï¼šæ’ä»¶.html-76cc6bf8.js" as="script"><link rel="prefetch" href="/assets/01-æœåŠ¡ç«¯å¯åŠ¨æµç¨‹.html-d2fc1f19.js" as="script"><link rel="prefetch" href="/assets/02-æœåŠ¡ç«¯å¯åŠ¨æ·»åŠ ChannelInitializeråˆ°ç®¡é“.html-86cb5d6a.js" as="script"><link rel="prefetch" href="/assets/03-å®¢æˆ·ç«¯å¯åŠ¨æµç¨‹.html-becc83be.js" as="script"><link rel="prefetch" href="/assets/04-çº¿ç¨‹ä½“ç³»-NioEventLoopGroup.html-700e797e.js" as="script"><link rel="prefetch" href="/assets/05-çº¿ç¨‹ä½“ç³»-NioEventLoopç›¸å…³çˆ¶æ¥å£åˆ†æ.html-754320bc.js" as="script"><link rel="prefetch" href="/assets/06-çº¿ç¨‹ä½“ç³»-AbstractEventExecutor.html-5250cd42.js" as="script"><link rel="prefetch" href="/assets/07-çº¿ç¨‹ä½“ç³»-AbstractScheduledEventExecutor-ä¼˜å…ˆé˜Ÿåˆ—.html-e7bbaf32.js" as="script"><link rel="prefetch" href="/assets/08-çº¿ç¨‹ä½“ç³»-NioEventLoopæ¦‚è¿°.html-fce3fb2c.js" as="script"><link rel="prefetch" href="/assets/09-çº¿ç¨‹ä½“ç³»-NioEventLoopå¼€å¯SelectoråŠä¼˜åŒ–.html-6d8230cf.js" as="script"><link rel="prefetch" href="/assets/10-çº¿ç¨‹ä½“ç³»-NioEventLoopç»‘å®šçº¿ç¨‹.html-db947821.js" as="script"><link rel="prefetch" href="/assets/11-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„runæ–¹æ³•.html-def4cc31.js" as="script"><link rel="prefetch" href="/assets/12-çº¿ç¨‹ä½“ç³»-NioEventLoopè§„é¿JDKçš„NIOç©ºå¾ªç¯bug.html-16ecaf4e.js" as="script"><link rel="prefetch" href="/assets/13-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„ä¼˜é›…å…³é—­.html-912d668d.js" as="script"><link rel="prefetch" href="/assets/14-æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥(ACCEPT).html-63afdec1.js" as="script"><link rel="prefetch" href="/assets/15-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶æ¦‚è¿°.html-b35daeb8.js" as="script"><link rel="prefetch" href="/assets/16-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶è¯¦è§£åŠRecvByteBufAllocator.html-a9faccfa.js" as="script"><link rel="prefetch" href="/assets/17-Nettyç®¡é“æœºåˆ¶.html-ba70b238.js" as="script"><link rel="prefetch" href="/assets/18-Nettyå‘é€æ•°æ®æµç¨‹åŠå‡ºç«™ç¼“å†²åŒº.html-223d04a7.js" as="script"><link rel="prefetch" href="/assets/index.html-b475d8b0.js" as="script"><link rel="prefetch" href="/assets/Redis_BenchmarkåŸºå‡†æµ‹è¯•.html-dbf21951.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤å’Œæ§½ç®¡ç†å‘½ä»¤.html-2b4a1244.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤åŸºæœ¬ç‰¹æ€§å’Œé›†ç¾¤æ­å»º.html-42be726b.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤ç®¡ç†å·¥å…·redis-cli.html-fc4f1503.js" as="script"><link rel="prefetch" href="/assets/Redis_Pipelineä¼˜åŒ–RTT.html-8a4aa041.js" as="script"><link rel="prefetch" href="/assets/Redis_Sentinelé«˜å¯ç”¨.html-6bcdb34a.js" as="script"><link rel="prefetch" href="/assets/Redis_keyè®¾è®¡è§„èŒƒ.html-ab90a7dc.js" as="script"><link rel="prefetch" href="/assets/Redisäº‹åŠ¡.html-e43061e1.js" as="script"><link rel="prefetch" href="/assets/Rediså†…å­˜æ·˜æ±°ç­–ç•¥.html-feabd314.js" as="script"><link rel="prefetch" href="/assets/Rediså‘å¸ƒè®¢é˜….html-68771977.js" as="script"><link rel="prefetch" href="/assets/Rediså¤åˆ¶.html-33b20d6f.js" as="script"><link rel="prefetch" href="/assets/Rediså¤§keyå’Œçƒ­keyé—®é¢˜.html-394d194e.js" as="script"><link rel="prefetch" href="/assets/Redisæ…¢æŸ¥è¯¢æ—¥å¿—.html-7fb06db0.js" as="script"><link rel="prefetch" href="/assets/RedisæŒä¹…åŒ–æœºåˆ¶.html-53af3f7a.js" as="script"><link rel="prefetch" href="/assets/Redisé”®ç©ºé—´é€šçŸ¥(keyspace notification).html-012bd277.js" as="script"><link rel="prefetch" href="/assets/redis-cli ä½¿ç”¨.html-f7ab22db.js" as="script"><link rel="prefetch" href="/assets/01-RocketMQæ¦‚è¿°.html-25463efe.js" as="script"><link rel="prefetch" href="/assets/02-NameServerå¯åŠ¨æµç¨‹.html-a514999f.js" as="script"><link rel="prefetch" href="/assets/03-Brokerå¯åŠ¨æµç¨‹.html-43c84806.js" as="script"><link rel="prefetch" href="/assets/04-RocketMQç½‘ç»œé€šä¿¡åŸç†.html-ac88de8d.js" as="script"><link rel="prefetch" href="/assets/05-RocketMQ æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¯åŠ¨.html-ef7f1888.js" as="script"><link rel="prefetch" href="/assets/06-RocketMQç½‘ç»œé€šä¿¡æºç .html-b8e0bf43.js" as="script"><link rel="prefetch" href="/assets/07-NameServerä½œç”¨å’Œè·¯ç”±å…ƒä¿¡æ¯.html-82a23869.js" as="script"><link rel="prefetch" href="/assets/08-NameServerè·¯ç”±ç®¡ç†æºç åˆ†æ.html-8da2bd72.js" as="script"><link rel="prefetch" href="/assets/09-ç”Ÿäº§è€…ç›¸å…³ç±»åˆ†æ.html-08f6e840.js" as="script"><link rel="prefetch" href="/assets/10-ç”Ÿäº§è€…å¯åŠ¨æµç¨‹.html-d761cf07.js" as="script"><link rel="prefetch" href="/assets/11-ç”Ÿäº§è€…å‘é€æ¶ˆæ¯.html-743328bc.js" as="script"><link rel="prefetch" href="/assets/resume.html-ae9f6b8c.js" as="script"><link rel="prefetch" href="/assets/404.html-f3795607.js" as="script"><link rel="prefetch" href="/assets/index.html-10b45510.js" as="script"><link rel="prefetch" href="/assets/index.html-dfd17ea5.js" as="script"><link rel="prefetch" href="/assets/index.html-2f392b9e.js" as="script"><link rel="prefetch" href="/assets/index.html-0efbdc5e.js" as="script"><link rel="prefetch" href="/assets/index.html-ca6dfd42.js" as="script"><link rel="prefetch" href="/assets/01-CASå’ŒUnsafeçš„APIåˆ†æ.html-7ba17841.js" as="script"><link rel="prefetch" href="/assets/02-åŸºæœ¬ç±»å‹åŸå­ç±»AtomicLong.html-1fd0e0c2.js" as="script"><link rel="prefetch" href="/assets/03-å¼•ç”¨ç±»å‹åŸå­ç±»AtomicReference.html-f8ecd582.js" as="script"><link rel="prefetch" href="/assets/04-åŸå­æ•°ç»„ç±»AtomicLongArray.html-693a6fe4.js" as="script"><link rel="prefetch" href="/assets/05-åŸå­æ“ä½œç±»AtomicReferenceFieldUpdater.html-8a26126d.js" as="script"><link rel="prefetch" href="/assets/06-é«˜æ€§èƒ½åŸå­ç±»LongAdder.html-e1f87209.js" as="script"><link rel="prefetch" href="/assets/07-LockSupportåˆ†æ.html-a574f1fc.js" as="script"><link rel="prefetch" href="/assets/08-AQSç®€å•ä»‹ç».html-10b7fbdb.js" as="script"><link rel="prefetch" href="/assets/09-åŸºäºReentrantLockåˆ†æAQSçš„ç‹¬å æ¨¡å¼.html-ccd5152d.js" as="script"><link rel="prefetch" href="/assets/10-åŸºäºCountDownLatchåˆ†æAQSçš„å…±äº«æ¨¡å¼.html-5cf0e2ee.js" as="script"><link rel="prefetch" href="/assets/11-AQSçš„Conditionæœºåˆ¶.html-7526fe2d.js" as="script"><link rel="prefetch" href="/assets/12-ä¿¡å·é‡Semaphore.html-49442431.js" as="script"><link rel="prefetch" href="/assets/13-å¾ªç¯æ æ …CyclicBarrier.html-8197c1f6.js" as="script"><link rel="prefetch" href="/assets/14-é˜¶æ®µPhaser.html-17b533e6.js" as="script"><link rel="prefetch" href="/assets/15-äº¤æ¢Exchanger.html-308e2996.js" as="script"><link rel="prefetch" href="/assets/16-è¯»å†™é”ReentrantReadWriteLock.html-ca79d4d3.js" as="script"><link rel="prefetch" href="/assets/17-Futureæ¨¡å¼-FutureTask.html-fc1ae379.js" as="script"><link rel="prefetch" href="/assets/18-çº¿ç¨‹æ± ä½“ç³»æ¦‚è¿°.html-25c9a3e1.js" as="script"><link rel="prefetch" href="/assets/19-çº¿ç¨‹æ± ä½“ç³»-AbstractExecutorService.html-57231832.js" as="script"><link rel="prefetch" href="/assets/21-çº¿ç¨‹æ± ä½“ç³»-ScheduledThreadPoolExecutor.html-6a99c023.js" as="script"><link rel="prefetch" href="/assets/22-CopyOnWriteArrayListå†™æ—¶å¤åˆ¶.html-60b87bd1.js" as="script"><link rel="prefetch" href="/assets/23-CopyOnWriteArraySetå†™æ—¶å¤åˆ¶.html-bf41b559.js" as="script"><link rel="prefetch" href="/assets/24-ConcurrentSkipListMapè·³è¡¨.html-bfad0eee.js" as="script"><link rel="prefetch" href="/assets/25-ConcurrentSkipListSetè·³è¡¨.html-f4028904.js" as="script"><link rel="prefetch" href="/assets/26-ConcurrentHashMapæºç åˆ†æ.html-9735c629.js" as="script"><link rel="prefetch" href="/assets/27-é˜»å¡é˜Ÿåˆ—ArrayBlockingQueue.html-ef2b7834.js" as="script"><link rel="prefetch" href="/assets/28-é˜»å¡é˜Ÿåˆ—LinkedBlockingQueue.html-f4393f96.js" as="script"><link rel="prefetch" href="/assets/29-é˜»å¡é˜Ÿåˆ—LinkedBlockingDeque.html-e7f54a25.js" as="script"><link rel="prefetch" href="/assets/30-é˜»å¡é˜Ÿåˆ—PriorityBlockingQueue.html-b6091772.js" as="script"><link rel="prefetch" href="/assets/31-é˜»å¡é˜Ÿåˆ—DelayQueue.html-03a4c0ed.js" as="script"><link rel="prefetch" href="/assets/32-é˜»å¡é˜Ÿåˆ—SynchronousQueue.html-99584a0a.js" as="script"><link rel="prefetch" href="/assets/33-é˜»å¡é˜Ÿåˆ—LinkedTransferQueue.html-d3aa5acd.js" as="script"><link rel="prefetch" href="/assets/index.html-37a2f13f.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis01ï¼šmyabtisçš„æ•´ä½“æ¶æ„.html-ddf7694d.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis02ï¼šå…¥é—¨æ¡ˆä¾‹.html-21120744.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis03ï¼šè§£æå…¨å±€é…ç½®æ–‡ä»¶.html-0e220500.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis04ï¼šè§£æMapperæ˜ å°„æ–‡ä»¶.html-9b18cbb7.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis05ï¼šè§£æStatementæ“ä½œèŠ‚ç‚¹.html-76d6a753.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis06ï¼šè§£æSQLè¯­å¥.html-9fd200fb.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis07ï¼šJavaæ–¹æ³•å’ŒSQLè¯­å¥ç»‘å®š.html-41f8fe9e.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis08ï¼šè·å¾—SqlSession.html-c94319d0.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis09ï¼šExecutoræ‰§è¡Œå™¨.html-d4559164.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis10ï¼šç¼“å­˜æœºåˆ¶.html-6449b343.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis11ï¼šStatementHandler.html-f65ebbc7.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis12ï¼šå‚æ•°è§£æå’Œèµ‹å€¼.html-13dee4ed.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis13ï¼šç»“æœé›†å¤„ç†.html-c53a9c81.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis14ï¼šæ’ä»¶.html-2cd11f11.js" as="script"><link rel="prefetch" href="/assets/01-æœåŠ¡ç«¯å¯åŠ¨æµç¨‹.html-e26c618a.js" as="script"><link rel="prefetch" href="/assets/02-æœåŠ¡ç«¯å¯åŠ¨æ·»åŠ ChannelInitializeråˆ°ç®¡é“.html-92cd4736.js" as="script"><link rel="prefetch" href="/assets/03-å®¢æˆ·ç«¯å¯åŠ¨æµç¨‹.html-7bcd50c4.js" as="script"><link rel="prefetch" href="/assets/04-çº¿ç¨‹ä½“ç³»-NioEventLoopGroup.html-3a10e518.js" as="script"><link rel="prefetch" href="/assets/05-çº¿ç¨‹ä½“ç³»-NioEventLoopç›¸å…³çˆ¶æ¥å£åˆ†æ.html-197db18d.js" as="script"><link rel="prefetch" href="/assets/06-çº¿ç¨‹ä½“ç³»-AbstractEventExecutor.html-a020fd06.js" as="script"><link rel="prefetch" href="/assets/07-çº¿ç¨‹ä½“ç³»-AbstractScheduledEventExecutor-ä¼˜å…ˆé˜Ÿåˆ—.html-740cfdc6.js" as="script"><link rel="prefetch" href="/assets/08-çº¿ç¨‹ä½“ç³»-NioEventLoopæ¦‚è¿°.html-9e53b84b.js" as="script"><link rel="prefetch" href="/assets/09-çº¿ç¨‹ä½“ç³»-NioEventLoopå¼€å¯SelectoråŠä¼˜åŒ–.html-4cd07e8b.js" as="script"><link rel="prefetch" href="/assets/10-çº¿ç¨‹ä½“ç³»-NioEventLoopç»‘å®šçº¿ç¨‹.html-c8221178.js" as="script"><link rel="prefetch" href="/assets/11-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„runæ–¹æ³•.html-866157b8.js" as="script"><link rel="prefetch" href="/assets/12-çº¿ç¨‹ä½“ç³»-NioEventLoopè§„é¿JDKçš„NIOç©ºå¾ªç¯bug.html-8dfa5222.js" as="script"><link rel="prefetch" href="/assets/13-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„ä¼˜é›…å…³é—­.html-89178761.js" as="script"><link rel="prefetch" href="/assets/14-æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥(ACCEPT).html-243c879e.js" as="script"><link rel="prefetch" href="/assets/15-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶æ¦‚è¿°.html-b57353a9.js" as="script"><link rel="prefetch" href="/assets/16-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶è¯¦è§£åŠRecvByteBufAllocator.html-0e3314b9.js" as="script"><link rel="prefetch" href="/assets/17-Nettyç®¡é“æœºåˆ¶.html-8a5a570a.js" as="script"><link rel="prefetch" href="/assets/18-Nettyå‘é€æ•°æ®æµç¨‹åŠå‡ºç«™ç¼“å†²åŒº.html-a0b3d6e0.js" as="script"><link rel="prefetch" href="/assets/index.html-93e15c87.js" as="script"><link rel="prefetch" href="/assets/Redis_BenchmarkåŸºå‡†æµ‹è¯•.html-fec02713.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤å’Œæ§½ç®¡ç†å‘½ä»¤.html-b8762600.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤åŸºæœ¬ç‰¹æ€§å’Œé›†ç¾¤æ­å»º.html-74c18eb5.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤ç®¡ç†å·¥å…·redis-cli.html-26ee1786.js" as="script"><link rel="prefetch" href="/assets/Redis_Pipelineä¼˜åŒ–RTT.html-c53997a1.js" as="script"><link rel="prefetch" href="/assets/Redis_Sentinelé«˜å¯ç”¨.html-3d3190c8.js" as="script"><link rel="prefetch" href="/assets/Redis_keyè®¾è®¡è§„èŒƒ.html-139be2b0.js" as="script"><link rel="prefetch" href="/assets/Redisäº‹åŠ¡.html-910bd516.js" as="script"><link rel="prefetch" href="/assets/Rediså†…å­˜æ·˜æ±°ç­–ç•¥.html-ca1a68c0.js" as="script"><link rel="prefetch" href="/assets/Rediså‘å¸ƒè®¢é˜….html-3c04a859.js" as="script"><link rel="prefetch" href="/assets/Rediså¤åˆ¶.html-0fc585a3.js" as="script"><link rel="prefetch" href="/assets/Rediså¤§keyå’Œçƒ­keyé—®é¢˜.html-a051743e.js" as="script"><link rel="prefetch" href="/assets/Redisæ…¢æŸ¥è¯¢æ—¥å¿—.html-cc751958.js" as="script"><link rel="prefetch" href="/assets/RedisæŒä¹…åŒ–æœºåˆ¶.html-edc370a3.js" as="script"><link rel="prefetch" href="/assets/Redisé”®ç©ºé—´é€šçŸ¥(keyspace notification).html-0b7a5999.js" as="script"><link rel="prefetch" href="/assets/redis-cli ä½¿ç”¨.html-67ec9191.js" as="script"><link rel="prefetch" href="/assets/01-RocketMQæ¦‚è¿°.html-42bb3fc6.js" as="script"><link rel="prefetch" href="/assets/02-NameServerå¯åŠ¨æµç¨‹.html-c40b8eb8.js" as="script"><link rel="prefetch" href="/assets/03-Brokerå¯åŠ¨æµç¨‹.html-d2cce092.js" as="script"><link rel="prefetch" href="/assets/04-RocketMQç½‘ç»œé€šä¿¡åŸç†.html-7b0752e1.js" as="script"><link rel="prefetch" href="/assets/05-RocketMQ æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¯åŠ¨.html-811092ed.js" as="script"><link rel="prefetch" href="/assets/06-RocketMQç½‘ç»œé€šä¿¡æºç .html-47e2bd4f.js" as="script"><link rel="prefetch" href="/assets/07-NameServerä½œç”¨å’Œè·¯ç”±å…ƒä¿¡æ¯.html-943e68b9.js" as="script"><link rel="prefetch" href="/assets/08-NameServerè·¯ç”±ç®¡ç†æºç åˆ†æ.html-3fed8567.js" as="script"><link rel="prefetch" href="/assets/09-ç”Ÿäº§è€…ç›¸å…³ç±»åˆ†æ.html-7f93645b.js" as="script"><link rel="prefetch" href="/assets/10-ç”Ÿäº§è€…å¯åŠ¨æµç¨‹.html-802d3584.js" as="script"><link rel="prefetch" href="/assets/11-ç”Ÿäº§è€…å‘é€æ¶ˆæ¯.html-36f66be5.js" as="script"><link rel="prefetch" href="/assets/resume.html-10f58f64.js" as="script"><link rel="prefetch" href="/assets/404.html-7c0f415c.js" as="script"><link rel="prefetch" href="/assets/index.html-dbae77d3.js" as="script"><link rel="prefetch" href="/assets/index.html-36bac0f5.js" as="script"><link rel="prefetch" href="/assets/index.html-77ddb35c.js" as="script"><link rel="prefetch" href="/assets/index.html-4e2a4ed6.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-2450701e.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a href="/" class="vp-brand"><img class="vp-nav-logo" src="/å°ç†ŠçŒ«.png" alt><!----><!----></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a href="/JDK_source/" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="JUCåŒ…æºç åˆ†æ"><!---->JUCåŒ…æºç åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/01-CAS%E5%92%8CUnsafe%E7%9A%84API%E5%88%86%E6%9E%90.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="01-CASå’ŒUnsafeçš„APIåˆ†æ"><!---->01-CASå’ŒUnsafeçš„APIåˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/02-%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BBAtomicLong.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="02-åŸºæœ¬ç±»å‹åŸå­ç±»AtomicLong"><!---->02-åŸºæœ¬ç±»å‹åŸå­ç±»AtomicLong<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/03-%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BBAtomicReference.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="03-å¼•ç”¨ç±»å‹åŸå­ç±»AtomicReference"><!---->03-å¼•ç”¨ç±»å‹åŸå­ç±»AtomicReference<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/04-%E5%8E%9F%E5%AD%90%E6%95%B0%E7%BB%84%E7%B1%BBAtomicLongArray.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="04-åŸå­æ•°ç»„ç±»AtomicLongArray"><!---->04-åŸå­æ•°ç»„ç±»AtomicLongArray<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/05-%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E7%B1%BBAtomicReferenceFieldUpdater.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="05-åŸå­æ“ä½œç±»AtomicReferenceFieldUpdater"><!---->05-åŸå­æ“ä½œç±»AtomicReferenceFieldUpdater<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/06-%E9%AB%98%E6%80%A7%E8%83%BD%E5%8E%9F%E5%AD%90%E7%B1%BBLongAdder.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="06-é«˜æ€§èƒ½åŸå­ç±»LongAdder"><!---->06-é«˜æ€§èƒ½åŸå­ç±»LongAdder<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/07-LockSupport%E5%88%86%E6%9E%90.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="07-LockSupportåˆ†æ"><!---->07-LockSupportåˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/08-AQS%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="08-AQSç®€å•ä»‹ç»"><!---->08-AQSç®€å•ä»‹ç»<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/09-%E5%9F%BA%E4%BA%8EReentrantLock%E5%88%86%E6%9E%90AQS%E7%9A%84%E7%8B%AC%E5%8D%A0%E6%A8%A1%E5%BC%8F.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="09-åŸºäºReentrantLockåˆ†æAQSçš„ç‹¬å æ¨¡å¼"><!---->09-åŸºäºReentrantLockåˆ†æAQSçš„ç‹¬å æ¨¡å¼<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/10-%E5%9F%BA%E4%BA%8ECountDownLatch%E5%88%86%E6%9E%90AQS%E7%9A%84%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%BC%8F.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="10-åŸºäºCountDownLatchåˆ†æAQSçš„å…±äº«æ¨¡å¼"><!---->10-åŸºäºCountDownLatchåˆ†æAQSçš„å…±äº«æ¨¡å¼<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/11-AQS%E7%9A%84Condition%E6%9C%BA%E5%88%B6.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="11-AQSçš„Conditionæœºåˆ¶"><!---->11-AQSçš„Conditionæœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/12-%E4%BF%A1%E5%8F%B7%E9%87%8FSemaphore.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="12-ä¿¡å·é‡Semaphore"><!---->12-ä¿¡å·é‡Semaphore<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/13-%E5%BE%AA%E7%8E%AF%E6%A0%8F%E6%A0%85CyclicBarrier.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="13-å¾ªç¯æ æ …CyclicBarrier"><!---->13-å¾ªç¯æ æ …CyclicBarrier<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/14-%E9%98%B6%E6%AE%B5Phaser.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="14-é˜¶æ®µPhaser"><!---->14-é˜¶æ®µPhaser<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/15-%E4%BA%A4%E6%8D%A2Exchanger.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="15-äº¤æ¢Exchanger"><!---->15-äº¤æ¢Exchanger<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/16-%E8%AF%BB%E5%86%99%E9%94%81ReentrantReadWriteLock.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="16-è¯»å†™é”ReentrantReadWriteLock"><!---->16-è¯»å†™é”ReentrantReadWriteLock<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/17-Future%E6%A8%A1%E5%BC%8F-FutureTask.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="17-Futureæ¨¡å¼-FutureTask"><!---->17-Futureæ¨¡å¼-FutureTask<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/18-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB%E6%A6%82%E8%BF%B0.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="18-çº¿ç¨‹æ± ä½“ç³»æ¦‚è¿°"><!---->18-çº¿ç¨‹æ± ä½“ç³»æ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/19-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-AbstractExecutorService.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="19-çº¿ç¨‹æ± ä½“ç³»-AbstractExecutorService"><!---->19-çº¿ç¨‹æ± ä½“ç³»-AbstractExecutorService<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html" class="router-link-active router-link-exact-active nav-link active vp-sidebar-link vp-sidebar-page active" aria-label="20-çº¿ç¨‹æ± ä½“ç³»-ThreadPoolExecutor"><!---->20-çº¿ç¨‹æ± ä½“ç³»-ThreadPoolExecutor<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± çš„ä¼˜åŠ¿" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="çº¿ç¨‹æ± çš„ä¼˜åŠ¿"><!---->çº¿ç¨‹æ± çš„ä¼˜åŠ¿<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#jucä¸­çº¿ç¨‹æ± ä½“ç³»çš„ç»§æ‰¿å…³ç³»" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="JUCä¸­çº¿ç¨‹æ± ä½“ç³»çš„ç»§æ‰¿å…³ç³»"><!---->JUCä¸­çº¿ç¨‹æ± ä½“ç³»çš„ç»§æ‰¿å…³ç³»<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± åŸºæœ¬ä»‹ç»" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="çº¿ç¨‹æ± åŸºæœ¬ä»‹ç»"><!---->çº¿ç¨‹æ± åŸºæœ¬ä»‹ç»<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#å¼•å…¥" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="å¼•å…¥"><!---->å¼•å…¥<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°"><!---->æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#é¢„å¯åŠ¨çº¿ç¨‹" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="é¢„å¯åŠ¨çº¿ç¨‹"><!---->é¢„å¯åŠ¨çº¿ç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#åˆ›å»ºæ–°çº¿ç¨‹" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="åˆ›å»ºæ–°çº¿ç¨‹"><!---->åˆ›å»ºæ–°çº¿ç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± å­˜æ´»æ—¶é—´" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="çº¿ç¨‹æ± å­˜æ´»æ—¶é—´"><!---->çº¿ç¨‹æ± å­˜æ´»æ—¶é—´<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#ä»»åŠ¡é˜Ÿåˆ—" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="ä»»åŠ¡é˜Ÿåˆ—"><!---->ä»»åŠ¡é˜Ÿåˆ—<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#æ‹’ç»ç­–ç•¥" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="æ‹’ç»ç­–ç•¥"><!---->æ‹’ç»ç­–ç•¥<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#é’©å­æ–¹æ³•" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="é’©å­æ–¹æ³•"><!---->é’©å­æ–¹æ³•<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#ç§»é™¤é˜Ÿåˆ—çš„ä»»åŠ¡" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="ç§»é™¤é˜Ÿåˆ—çš„ä»»åŠ¡"><!---->ç§»é™¤é˜Ÿåˆ—çš„ä»»åŠ¡<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± å…³é—­" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="çº¿ç¨‹æ± å…³é—­"><!---->çº¿ç¨‹æ± å…³é—­<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#æ„é€ æ–¹æ³•" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="æ„é€ æ–¹æ³•"><!---->æ„é€ æ–¹æ³•<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± çŠ¶æ€å’ŒåŸå­å˜é‡-ctl" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="çº¿ç¨‹æ± çŠ¶æ€å’ŒåŸå­å˜é‡ ctl"><!---->çº¿ç¨‹æ± çŠ¶æ€å’ŒåŸå­å˜é‡ ctl<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#åŸå­å˜é‡-ctl" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="åŸå­å˜é‡ ctl"><!---->åŸå­å˜é‡ ctl<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸ" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸ"><!---->çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#åŸå­å˜é‡-ctl-çš„ä½æ“ä½œ" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="åŸå­å˜é‡ ctl çš„ä½æ“ä½œ"><!---->åŸå­å˜é‡ ctl çš„ä½æ“ä½œ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#å…¶ä»–å±æ€§" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="å…¶ä»–å±æ€§"><!---->å…¶ä»–å±æ€§<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#å†…éƒ¨ç±»-worker" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="å†…éƒ¨ç±» Worker"><!---->å†…éƒ¨ç±» Worker<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹"><!---->çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#æäº¤ä»»åŠ¡å…¥å£-execute" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="æäº¤ä»»åŠ¡å…¥å£ execute"><!---->æäº¤ä»»åŠ¡å…¥å£ execute<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#addworker" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="addWorker"><!---->addWorker<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± ä»»åŠ¡çš„æ‰§è¡Œ" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="çº¿ç¨‹æ± ä»»åŠ¡çš„æ‰§è¡Œ"><!---->çº¿ç¨‹æ± ä»»åŠ¡çš„æ‰§è¡Œ<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#runworker-æ–¹æ³•" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="runWorker æ–¹æ³•"><!---->runWorker æ–¹æ³•<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#è·å–ä»»åŠ¡-gettask-æ–¹æ³•" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="è·å–ä»»åŠ¡ getTask æ–¹æ³•"><!---->è·å–ä»»åŠ¡ getTask æ–¹æ³•<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#processworkerexit-æ–¹æ³•" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="processWorkerExit æ–¹æ³•"><!---->processWorkerExit æ–¹æ³•<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± ä¼˜é›…å…³é—­" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="çº¿ç¨‹æ± ä¼˜é›…å…³é—­"><!---->çº¿ç¨‹æ± ä¼˜é›…å…³é—­<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#shutdown-æ–¹æ³•" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="shutdown æ–¹æ³•"><!---->shutdown æ–¹æ³•<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#shutdownnow-æ–¹æ³•" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="shutdownNow æ–¹æ³•"><!---->shutdownNow æ–¹æ³•<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#tryterminate-æ–¹æ³•" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="tryTerminate æ–¹æ³•"><!---->tryTerminate æ–¹æ³•<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#awaittermination-ç­‰å¾…ä»»åŠ¡å®Œæˆ" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="awaitTermination ç­‰å¾…ä»»åŠ¡å®Œæˆ"><!---->awaitTermination ç­‰å¾…ä»»åŠ¡å®Œæˆ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#å°ç»“" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="å°ç»“"><!---->å°ç»“<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/JDK_source/21-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ScheduledThreadPoolExecutor.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="21-çº¿ç¨‹æ± ä½“ç³»-ScheduledThreadPoolExecutor"><!---->21-çº¿ç¨‹æ± ä½“ç³»-ScheduledThreadPoolExecutor<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/22-CopyOnWriteArrayList%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="22-CopyOnWriteArrayListå†™æ—¶å¤åˆ¶"><!---->22-CopyOnWriteArrayListå†™æ—¶å¤åˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/23-CopyOnWriteArraySet%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="23-CopyOnWriteArraySetå†™æ—¶å¤åˆ¶"><!---->23-CopyOnWriteArraySetå†™æ—¶å¤åˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/24-ConcurrentSkipListMap%E8%B7%B3%E8%A1%A8.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="24-ConcurrentSkipListMapè·³è¡¨"><!---->24-ConcurrentSkipListMapè·³è¡¨<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/25-ConcurrentSkipListSet%E8%B7%B3%E8%A1%A8.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="25-ConcurrentSkipListSetè·³è¡¨"><!---->25-ConcurrentSkipListSetè·³è¡¨<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/26-ConcurrentHashMap%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="26-ConcurrentHashMapæºç åˆ†æ"><!---->26-ConcurrentHashMapæºç åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/27-%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97ArrayBlockingQueue.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="27-é˜»å¡é˜Ÿåˆ—ArrayBlockingQueue"><!---->27-é˜»å¡é˜Ÿåˆ—ArrayBlockingQueue<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/28-%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97LinkedBlockingQueue.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="28-é˜»å¡é˜Ÿåˆ—LinkedBlockingQueue"><!---->28-é˜»å¡é˜Ÿåˆ—LinkedBlockingQueue<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/29-%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97LinkedBlockingDeque.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="29-é˜»å¡é˜Ÿåˆ—LinkedBlockingDeque"><!---->29-é˜»å¡é˜Ÿåˆ—LinkedBlockingDeque<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/30-%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97PriorityBlockingQueue.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="30-é˜»å¡é˜Ÿåˆ—PriorityBlockingQueue"><!---->30-é˜»å¡é˜Ÿåˆ—PriorityBlockingQueue<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/31-%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97DelayQueue.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="31-é˜»å¡é˜Ÿåˆ—DelayQueue"><!---->31-é˜»å¡é˜Ÿåˆ—DelayQueue<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/32-%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97SynchronousQueue.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="32-é˜»å¡é˜Ÿåˆ—SynchronousQueue"><!---->32-é˜»å¡é˜Ÿåˆ—SynchronousQueue<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/JDK_source/33-%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97LinkedTransferQueue.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="33-é˜»å¡é˜Ÿåˆ—LinkedTransferQueue"><!---->33-é˜»å¡é˜Ÿåˆ—LinkedTransferQueue<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->20-çº¿ç¨‹æ± ä½“ç³»-ThreadPoolExecutor</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">è¶…å¨è“çŒ« Dylan Kwok</span></span><span property="author" content="è¶…å¨è“çŒ« Dylan Kwok"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-05-04T02:26:04.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 41 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT41M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± çš„ä¼˜åŠ¿" class="router-link-active router-link-exact-active toc-link level2">çº¿ç¨‹æ± çš„ä¼˜åŠ¿</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#jucä¸­çº¿ç¨‹æ± ä½“ç³»çš„ç»§æ‰¿å…³ç³»" class="router-link-active router-link-exact-active toc-link level2">JUCä¸­çº¿ç¨‹æ± ä½“ç³»çš„ç»§æ‰¿å…³ç³»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± åŸºæœ¬ä»‹ç»" class="router-link-active router-link-exact-active toc-link level2">çº¿ç¨‹æ± åŸºæœ¬ä»‹ç»</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#å¼•å…¥" class="router-link-active router-link-exact-active toc-link level3">å¼•å…¥</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°" class="router-link-active router-link-exact-active toc-link level3">æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#é¢„å¯åŠ¨çº¿ç¨‹" class="router-link-active router-link-exact-active toc-link level3">é¢„å¯åŠ¨çº¿ç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#åˆ›å»ºæ–°çº¿ç¨‹" class="router-link-active router-link-exact-active toc-link level3">åˆ›å»ºæ–°çº¿ç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± å­˜æ´»æ—¶é—´" class="router-link-active router-link-exact-active toc-link level3">çº¿ç¨‹æ± å­˜æ´»æ—¶é—´</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#ä»»åŠ¡é˜Ÿåˆ—" class="router-link-active router-link-exact-active toc-link level3">ä»»åŠ¡é˜Ÿåˆ—</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#æ‹’ç»ç­–ç•¥" class="router-link-active router-link-exact-active toc-link level3">æ‹’ç»ç­–ç•¥</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#é’©å­æ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">é’©å­æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#ç§»é™¤é˜Ÿåˆ—çš„ä»»åŠ¡" class="router-link-active router-link-exact-active toc-link level3">ç§»é™¤é˜Ÿåˆ—çš„ä»»åŠ¡</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± å…³é—­" class="router-link-active router-link-exact-active toc-link level3">çº¿ç¨‹æ± å…³é—­</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#æ„é€ æ–¹æ³•" class="router-link-active router-link-exact-active toc-link level2">æ„é€ æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± çŠ¶æ€å’ŒåŸå­å˜é‡-ctl" class="router-link-active router-link-exact-active toc-link level2">çº¿ç¨‹æ± çŠ¶æ€å’ŒåŸå­å˜é‡ ctl</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#åŸå­å˜é‡-ctl" class="router-link-active router-link-exact-active toc-link level3">åŸå­å˜é‡ ctl</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸ" class="router-link-active router-link-exact-active toc-link level3">çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#åŸå­å˜é‡-ctl-çš„ä½æ“ä½œ" class="router-link-active router-link-exact-active toc-link level3">åŸå­å˜é‡ ctl çš„ä½æ“ä½œ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#å…¶ä»–å±æ€§" class="router-link-active router-link-exact-active toc-link level2">å…¶ä»–å±æ€§</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#å†…éƒ¨ç±»-worker" class="router-link-active router-link-exact-active toc-link level2">å†…éƒ¨ç±» Worker</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹" class="router-link-active router-link-exact-active toc-link level2">çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#æäº¤ä»»åŠ¡å…¥å£-execute" class="router-link-active router-link-exact-active toc-link level3">æäº¤ä»»åŠ¡å…¥å£ execute</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#addworker" class="router-link-active router-link-exact-active toc-link level3">addWorker</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± ä»»åŠ¡çš„æ‰§è¡Œ" class="router-link-active router-link-exact-active toc-link level2">çº¿ç¨‹æ± ä»»åŠ¡çš„æ‰§è¡Œ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#runworker-æ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">runWorker æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#è·å–ä»»åŠ¡-gettask-æ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">è·å–ä»»åŠ¡ getTask æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#processworkerexit-æ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">processWorkerExit æ–¹æ³•</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#çº¿ç¨‹æ± ä¼˜é›…å…³é—­" class="router-link-active router-link-exact-active toc-link level2">çº¿ç¨‹æ± ä¼˜é›…å…³é—­</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#shutdown-æ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">shutdown æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#shutdownnow-æ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">shutdownNow æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#tryterminate-æ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">tryTerminate æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#awaittermination-ç­‰å¾…ä»»åŠ¡å®Œæˆ" class="router-link-active router-link-exact-active toc-link level3">awaitTermination ç­‰å¾…ä»»åŠ¡å®Œæˆ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/JDK_source/20-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ThreadPoolExecutor.html#å°ç»“" class="router-link-active router-link-exact-active toc-link level2">å°ç»“</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><table><thead><tr><th>ç‰ˆæœ¬</th><th>å†…å®¹</th><th>æ—¶é—´</th></tr></thead><tbody><tr><td>V1</td><td>æ–°å»º</td><td>2021å¹´03æœˆ12æ—¥23:09:11</td></tr><tr><td>V2</td><td>åŸºäºç¬¬ä¸€ç‰ˆä¿®æ”¹å¹¶é‡æ–°æ’ç‰ˆ</td><td>2022å¹´10æœˆ12æ—¥21:20:34</td></tr></tbody></table><h2 id="çº¿ç¨‹æ± çš„ä¼˜åŠ¿" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ± çš„ä¼˜åŠ¿" aria-hidden="true">#</a> çº¿ç¨‹æ± çš„ä¼˜åŠ¿</h2><p><b>é™ä½èµ„æºæ¶ˆè€—</b></p><p>æˆ‘ä»¬çŸ¥é“ï¼Œçº¿ç¨‹åœ¨Javaå †é‡Œé¢æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†èµ„æºï¼Œçº¿ç¨‹åˆ›å»ºã€é”€æ¯éœ€è¦æ—¶é—´ã€‚å¦‚æœåˆ›å»ºçº¿ç¨‹åŠ ä¸Šé”€æ¯çš„æ—¶é—´å¤§äºæ‰§è¡Œä»»åŠ¡çš„æ—¶é—´å°±å¾ˆä¸åˆ’ç®—äº†ã€‚æ‰€ä»¥ï¼Œ<strong>çº¿ç¨‹æ± é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—</strong>ã€‚</p><p>Javaå¯¹è±¡å ç”¨å †å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿçº¿ç¨‹å ç”¨ç³»ç»Ÿçš„å†…å­˜ï¼Œæ ¹æ®JVMè™šæ‹Ÿæœºçš„è§„èŒƒï¼Œä¸€ä¸ªçº¿ç¨‹é»˜è®¤æœ€å¤§çš„æ˜¯1Mï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡-xsså»ä¿®æ”¹ï¼Œè¿™ä¸ªæ ˆç©ºé—´æ˜¯éœ€è¦å†…å­˜åˆ†é…çš„ï¼Œ<strong>çº¿ç¨‹çš„å¢åŠ ï¼Œå¿…ç„¶å¢åŠ å†…å­˜çš„æ¶ˆè€—ï¼Œæ‰€ä»¥çº¿ç¨‹ä¸æ˜¯è¶Šå¤šè¶Šå¥½</strong>ã€‚</p><p><b>æé«˜å“åº”é€Ÿåº¦</b></p><p>å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚</p><p><b>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§</b></p><p><strong>çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶åœ°åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€åˆ†é…ã€è°ƒä¼˜å’Œç›‘æ§</strong>ã€‚</p><h2 id="jucä¸­çº¿ç¨‹æ± ä½“ç³»çš„ç»§æ‰¿å…³ç³»" tabindex="-1"><a class="header-anchor" href="#jucä¸­çº¿ç¨‹æ± ä½“ç³»çš„ç»§æ‰¿å…³ç³»" aria-hidden="true">#</a> JUCä¸­çº¿ç¨‹æ± ä½“ç³»çš„ç»§æ‰¿å…³ç³»</h2><p><img src="/assets/23-çº¿ç¨‹æ± æ¡†æ¶çš„ç»§æ‰¿ä½“ç³»-dee7b0e0.png" alt="23-çº¿ç¨‹æ± æ¡†æ¶çš„ç»§æ‰¿ä½“ç³»"></p><h2 id="çº¿ç¨‹æ± åŸºæœ¬ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ± åŸºæœ¬ä»‹ç»" aria-hidden="true">#</a> çº¿ç¨‹æ± åŸºæœ¬ä»‹ç»</h2><p>ä¸‹é¢å¤§éƒ¨åˆ†ç¿»è¯‘ JDK çš„æ–‡æ¡£</p><h3 id="å¼•å…¥" tabindex="-1"><a class="header-anchor" href="#å¼•å…¥" aria-hidden="true">#</a> å¼•å…¥</h3><p>ThreadPoolExecutor ç±»æ˜¯ ExecutorService æ¥å£çš„ä¸€ä¸ªå®ç°ï¼Œæäº¤çš„ä»»åŠ¡ç”±çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ¥æ‰§è¡Œã€‚<b>çº¿ç¨‹æ± å·¥å‚ Executors å¯ä»¥ç”¨æ¥åˆ›å»ºå„ç§å·²ç»é…ç½®å¥½å‚æ•°çš„çº¿ç¨‹æ± ã€‚</b></p><p>çº¿ç¨‹æ± çš„å¼•å…¥ä¸»è¦è§£å†³ä¸‹é¢çš„é—®é¢˜ï¼š</p><ol><li>çº¿ç¨‹æ± <b>æé«˜äº†æ‰§è¡Œå¤§é‡å¼‚æ­¥ä»»åŠ¡çš„æ€§èƒ½ï¼Œå‡å°‘äº†æ¯ä¸ªä»»åŠ¡çš„è°ƒç”¨å¼€é”€</b>ï¼Œ</li><li>ç»™çº¿ç¨‹æä¾›äº†é™åˆ¶å’Œç®¡ç†çš„ä¸€äº›æªæ–½ã€‚çº¿ç¨‹æ± è¿˜æä¾›äº†ä¸€äº›ç»Ÿè®¡åŠŸèƒ½ï¼Œä¾‹å¦‚çº¿ç¨‹æ± æ€»å…±å®Œæˆäº†å¤šå°‘ä¸ªä»»åŠ¡ç­‰ã€‚</li></ol><p><b>ThreadPoolExecutoræä¾›äº†å¤šä¸ªå¯é…ç½®çš„å‚æ•°å’Œå¤§é‡çš„é’©å­æ–¹æ³•ï¼Œé’©å­æ–¹æ³•å¯ä»¥ç”±å­ç±»å®ç°æ¥å®Œæˆæ‰©å±•</b>ã€‚ä¾‹å¦‚åœ¨æ‰§è¡Œä»»åŠ¡å‰è°ƒç”¨çš„ beforeExecute æ–¹æ³•ï¼Œæ‰§è¡Œä»»åŠ¡åè°ƒç”¨çš„ afterExecute æ–¹æ³•ç­‰ã€‚</p><h3 id="æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°" aria-hidden="true">#</a> æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°</h3><p>ThreadPoolExecutor ä¼šæ ¹æ® corePoolSize å’Œ maximumPoolSize è‡ªåŠ¨è°ƒæ•´çº¿ç¨‹æ± çš„çº¿ç¨‹çš„ä¸ªæ•°ã€‚</p><p>å½“ä¸€ä¸ªæ–°çš„ä»»åŠ¡è¢«æäº¤åˆ° execute æ–¹æ³•æ—¶ï¼š</p><ul><li>å‡å¦‚<strong>çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹çš„æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•° corePoolSizeï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å»å¤„ç†è¿™ä¸ªä»»åŠ¡</strong>ï¼Œå³ä½¿çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯ç©ºé—²çš„ã€‚</li><li>å¦‚æœæ­¤æ—¶<strong>çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ä½†æ˜¯å°äºæœ€å¤§çº¿ç¨‹æ•°</strong>maximumPoolSizeï¼Œæ­¤æ—¶<strong>åªä¼šåœ¨ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†çš„æ—¶å€™æ‰ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹</strong>ã€‚</li></ul><p>å‡å¦‚è®¾ç½®<strong>æ ¸å¿ƒçº¿ç¨‹æ•°</strong> corePoolSize å’Œ<strong>æœ€å¤§çº¿ç¨‹æ•°</strong> maximumPoolSize <strong>ç›¸åŒ</strong>çš„è¯ï¼Œ<strong>è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå›ºå®šçš„çº¿ç¨‹æ± </strong>ã€‚</p><p>å‡å¦‚å°†æœ€å¤§çº¿ç¨‹æ•° maximumPoolSize è®¾ç½®çš„å¾ˆå¤§çš„è¯ï¼Œå¦‚ Integer.MAX_VALUEï¼Œåˆ™è¡¨ç¤ºå…è®¸çº¿ç¨‹æ± å®¹çº³ä»»æ„æ•°é‡çš„å¹¶å‘ä»»åŠ¡ã€‚æ ¸å¿ƒçº¿ç¨‹ä¸ªæ•° corePoolSize å’Œæœ€å¤§çº¿ç¨‹ä¸ªæ•° maximumPoolSize ä¸€èˆ¬åœ¨æ„é€ å™¨æ—¶èµ‹å€¼ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ä½¿ç”¨å¯¹åº”çš„ set æ–¹æ³•è®¾ç½®ã€‚</p><h3 id="é¢„å¯åŠ¨çº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#é¢„å¯åŠ¨çº¿ç¨‹" aria-hidden="true">#</a> é¢„å¯åŠ¨çº¿ç¨‹</h3><ul><li><strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œå³ä½¿æ˜¯æ ¸å¿ƒçº¿ç¨‹ä¹Ÿæ˜¯åœ¨ä¸€ä¸ªæ–°ä»»åŠ¡æäº¤çš„æ—¶å€™æ‰ä¼šå»åˆ›å»º</strong>ã€‚ä½†æ˜¯å¯ä»¥ä½¿ç”¨æ–¹æ³• prestartCoreThread å’Œ prestartAllCoreThreads åŠ¨æ€è¦†ç›–ã€‚</li></ul><p>é¢„å¯åŠ¨çº¿ç¨‹çš„ç›¸å…³æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å¼€å¯ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">prestartCoreThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize <span class="token operator">&amp;&amp;</span>
        <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ä¸ prestartCoreThread ç›¸åŒï¼Œ</span>
<span class="token comment">// å³ä½¿ corePoolSizeä¸º0ï¼Œä¹Ÿè‡³å°‘å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ã€‚</span>
<span class="token keyword">void</span> <span class="token function">ensurePrestart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span>
        <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// å¯åŠ¨æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œä¸ç”¨ç­‰å¾…ä»»åŠ¡åˆ°æ¥æ—¶å†åˆ›å»ºçº¿ç¨‹</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">prestartAllCoreThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">++</span>n<span class="token punctuation">;</span>
    <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åˆ›å»ºæ–°çº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºæ–°çº¿ç¨‹" aria-hidden="true">#</a> åˆ›å»ºæ–°çº¿ç¨‹</h3><ul><li><p><strong>çº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹å·¥å‚ ThreadFactory åˆ›å»ºçš„</strong>ã€‚é»˜è®¤ä½¿ç”¨ DefaultThreadFactory ç±»æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå®ƒå°†åˆ›å»ºå…·æœ‰ç›¸åŒçº¿ç¨‹ç»„ã€ä¼˜å…ˆçº§å’Œå®ˆæŠ¤çŠ¶æ€ã€‚<strong>é€šè¿‡æä¾›ä¸åŒçš„çº¿ç¨‹å·¥å‚ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ”¹çº¿ç¨‹çš„åç§°ã€çº¿ç¨‹ç»„ã€ä¼˜å…ˆçº§ã€å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€ç­‰</strong>ã€‚</p></li><li><p>å½“çº¿ç¨‹å·¥å‚åˆ›å»ºçº¿ç¨‹åˆ›å»ºå¤±è´¥è¿”å› null æ—¶ï¼Œä»£ç ä¼šç»§ç»­è¿è¡Œï¼Œä½†æ˜¯å¯èƒ½ä»»åŠ¡æ— æ³•æ‰§è¡Œæˆã€‚</p></li></ul><h3 id="çº¿ç¨‹æ± å­˜æ´»æ—¶é—´" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ± å­˜æ´»æ—¶é—´" aria-hidden="true">#</a> çº¿ç¨‹æ± å­˜æ´»æ—¶é—´</h3><ul><li>å¦‚æœçº¿ç¨‹æ± å½“å‰æ‹¥æœ‰çš„çº¿ç¨‹ä¸ªæ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•° corePoolSizeï¼Œå¤šå‡ºçš„çº¿ç¨‹ä¼šåœ¨ç©ºé—²è¶…è¿‡è¿‡æœŸæ—¶é—´ keepAliveTime æ—¶è¢«æ€æ­»ï¼Œæœ‰æ•ˆå‡å°‘äº†çº¿ç¨‹æ± çš„èµ„æºæ¶ˆè€—ã€‚</li><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªè¶…æ—¶æ—¶é—´æ˜¯é’ˆå¯¹è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°ä¹‹å¤–çš„çº¿ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ allowCoreThreadTimeOut æ–¹æ³•è®¾ç½®æ ¸å¿ƒçº¿ç¨‹ä¹Ÿå¯ä»¥è¶…æ—¶ã€‚</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ç©ºé—²çº¿ç¨‹è¶…æ—¶æœºåˆ¶æ˜¯å¦åº”ç”¨åˆ°æ ¸å¿ƒçº¿ç¨‹</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">allowCoreThreadTimeOut</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> keepAliveTime <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Core threads must have nonzero keep alive times&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> allowCoreThreadTimeOut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        allowCoreThreadTimeOut <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token comment">// å‡å¦‚æ˜¯ trueï¼Œéœ€è¦ä¸­æ–­çº¿ç¨‹ï¼Œå› ä¸ºæ ¸å¿ƒçº¿ç¨‹å¯èƒ½åœ¨ è·å–é˜»å¡é˜Ÿåˆ—çš„ä»»åŠ¡æ—¶ è¢«é˜»å¡äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            <span class="token function">interruptIdleWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä»»åŠ¡é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#ä»»åŠ¡é˜Ÿåˆ—" aria-hidden="true">#</a> ä»»åŠ¡é˜Ÿåˆ—</h3><p>å¯ä»¥ä½¿ç”¨ä»»ä½•é˜»å¡é˜Ÿåˆ—BlockingQueueæ¥ä¼ è¾“å’Œä¿å­˜æäº¤çš„ä»»åŠ¡ã€‚</p><ul><li>å¦‚æœçº¿ç¨‹æ± çš„çº¿ç¨‹ä¸ªæ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•° corePoolSizeï¼Œæ­¤æ—¶æ¥äº†æ–°ä»»åŠ¡æ—¶ä¼šæ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œï¼Œè€Œä¸æ˜¯æ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—ã€‚</li><li>å¦‚æœçº¿ç¨‹æ± çš„çº¿ç¨‹ä¸ªæ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•° corePoolSizeï¼Œæ­¤æ—¶æ¥äº†æ–°ä»»åŠ¡æ—¶ä¼šå°†ä»»åŠ¡å…¥é˜Ÿï¼Œè€Œä¸æ˜¯åˆ›å»ºæ–°çº¿ç¨‹å»æ‰§è¡Œã€‚</li><li>å¦‚æœä¸€ä¸ªä»»åŠ¡æ— æ³•å…¥é˜Ÿï¼Œå‡å¦‚å½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹ä¸ªæ•°å°äºæœ€å¤§çº¿ç¨‹æ•° maximumPoolSizeï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹å»æ‰§è¡Œæ­¤ä»»åŠ¡ï¼Œå¦åˆ™æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚</li></ul><p><strong>ä¸€èˆ¬æœ‰ä¸‰ç§å…¥é˜Ÿçš„ç­–ç•¥</strong>ï¼š</p><ul><li><p>Direct handoffsã€‚ä¸€ä¸ªå¥½çš„é€‰æ‹©æ˜¯ä½¿ç”¨ SynchronousQueueï¼Œå®ƒå°†ä»»åŠ¡äº¤ç»™çº¿ç¨‹è€Œä¸ç”¨å…¶ä»–æ–¹å¼ä¿å­˜å®ƒä»¬ã€‚å¦‚æœæ²¡æœ‰ç«‹å³å¯ç”¨çš„çº¿ç¨‹æ¥è¿è¡Œä»»åŠ¡ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºå¯¹ä»»åŠ¡çš„å°è¯•å…¥é˜Ÿå¤±è´¥ï¼Œå› æ­¤å°†åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ã€‚åœ¨å¤„ç†å¯èƒ½å…·æœ‰å†…éƒ¨ä¾èµ–å…³ç³»çš„è¯·æ±‚é›†æ—¶ï¼Œæ­¤ç­–ç•¥é¿å…äº†é”å®šã€‚Direct handoffs é€šå¸¸éœ€è¦æ— é™åˆ¶çš„æœ€å¤§çº¿ç¨‹æ•° maximumPoolSizesï¼Œä»¥é¿å…æ‹’ç»æ–°æäº¤çš„ä»»åŠ¡ã€‚<strong>æœ‰ä¸ªç¼ºç‚¹å°±æ˜¯ï¼Œå½“ä»»åŠ¡çš„å¹³å‡æäº¤é€Ÿåº¦è¶…è¿‡äº†å®ƒä»¬çš„å¤„ç†é€Ÿåº¦æ—¶ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´æ— é™åˆ¶çš„çº¿ç¨‹å¢é•¿</strong>ã€‚</p></li><li><p>Unbounded queuesã€‚<strong>æ— ç•Œé˜Ÿåˆ—</strong>ï¼Œä¾‹å¦‚ LinkedBlockingQueueã€‚<strong>ä½¿ç”¨é•¿åº¦æ— é™åˆ¶çš„é˜Ÿåˆ—åœ¨æ‰€æœ‰çš„æ ¸å¿ƒçº¿ç¨‹éƒ½åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œä¼šå¯¼è‡´ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚æ­¤æ—¶ï¼Œçº¿ç¨‹æ± ä¸­æ°¸è¿œä¸ä¼šåˆ›å»ºè¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ï¼Œæ‰€ä»¥æœ€å¤§çº¿ç¨‹æ•° maximumPoolSize æ²¡ä»€ä¹ˆç”¨äº†</strong>ã€‚è¿™ç§é€‚åˆä»»åŠ¡æäº¤é€Ÿåº¦æ¯”è¾ƒå¹³ç¼“çš„åœºæ™¯ï¼Œå‡å¦‚æ˜¯é«˜å¹¶å‘è®¿é—®çš„æƒ…å†µçš„è¯ï¼Œå°±å®¹æ˜“å¯¼è‡´çº¿ç¨‹æ— é™å¢é•¿ï¼Œå¯¼è‡´OOMã€‚</p></li><li><p>Bounded queuesã€‚<strong>æœ‰ç•Œé˜Ÿåˆ—</strong>ï¼Œä¾‹å¦‚ ArrayBlockingQueueã€‚è¿™ç§é˜Ÿåˆ—å¯ä»¥é…åˆé…ç½®æœ€å¤§çº¿ç¨‹æ•° maximumPoolSizes æ¥é¿å…èµ„æºè€—å°½ï¼Œä½†å¯èƒ½æ›´éš¾ä»¥è°ƒæ•´å’Œæ§åˆ¶ã€‚</p><p>é˜Ÿåˆ—çš„é•¿åº¦å’Œæœ€å¤§çº¿ç¨‹æ± ä¸ªæ•°å¯ä»¥ç›¸äº’æƒè¡¡ã€‚<strong>ä½¿ç”¨å®¹é‡å¤§çš„é˜Ÿåˆ—é…åˆå°çš„æœ€å¤§çº¿ç¨‹æ•° maximumPoolSizes ä¼šæœ€å¤§é™åº¦åœ°å‡å°‘ CPU ä½¿ç”¨ç‡ã€æ“ä½œç³»ç»Ÿèµ„æºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Œä½†æ˜¯è¿™ç§ä¼šäººä¸ºçš„é™ä½ååé‡</strong>ã€‚</p><p>å¦‚æœä»»åŠ¡ç»å¸¸é˜»å¡ï¼Œå¯ä»¥è€ƒè™‘è°ƒç”¨è®¾ç½®æœ€å¤§çº¿ç¨‹æ•°çš„æ–¹æ³•ï¼Œé‡æ–°è®¾ç½®çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°ã€‚ä½¿ç”¨å°é˜Ÿåˆ—é€šå¸¸éœ€è¦æ›´å¤§çš„æ± å¤§å°ï¼Œè¿™ä¼šä½¿ CPU é•¿æœŸå¿™ç¢Œã€‚å¦‚æœçº¿ç¨‹æ± çš„å®¹é‡è®¾ç½®çš„è¿‡å¤§ï¼Œå¹¶å‘é‡å°±ä¼šå¢åŠ ï¼Œåˆ™éœ€è¦è€ƒè™‘çº¿ç¨‹è°ƒåº¦çš„é—®é¢˜ï¼Œåè€Œå¯èƒ½ä¼šé™ä½ä»»åŠ¡çš„ååé‡ã€‚</p></li></ul><p>çº¿ç¨‹æ± çš„çº¿ç¨‹å¯ä»¥è¿™æ ·é…ç½®ï¼š</p><ul><li>CPU å¯†é›†å‹ä»»åŠ¡ï¼šå‚è€ƒå€¼å¯ä»¥è®¾ç½®ä¸º NCPU + 1ï¼›</li><li>IO å¯†é›†å‹ä»»åŠ¡ï¼šå‚è€ƒå€¼å¯ä»¥è®¾ç½®ä¸º 2 * NCPUï¼›</li></ul><h3 id="æ‹’ç»ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#æ‹’ç»ç­–ç•¥" aria-hidden="true">#</a> æ‹’ç»ç­–ç•¥</h3><p>æ‰§è¡Œæ‹’ç»ç­–ç•¥çš„æƒ…å†µï¼š</p><ul><li><strong>çº¿ç¨‹æ± è¢«å…³é—­äº†</strong>ï¼ŒSHUTDOWNï¼›</li><li><strong>çº¿ç¨‹æ± çš„ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ï¼Œä¸”çº¿ç¨‹æ± çš„çº¿ç¨‹è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°äº†</strong>ï¼›</li></ul><p>æœ‰4ä¸ªé¢„å®šä¹‰çš„æ‹’ç»ç­–ç•¥ï¼š</p><ol><li><strong>é»˜è®¤çš„æ‹’ç»ç­–ç•¥</strong>ï¼ŒThreadPoolExecutor.AbortPolicyï¼Œ<b>åœ¨æ‹’ç»çš„æ—¶å€™æŠ›å‡ºä¸€ä¸ªè¿è¡Œæ—¶å¼‚å¸¸</b>ã€‚</li><li>ThreadPoolExecutor.CallerRunsPolicyï¼Œå‡å¦‚çº¿ç¨‹æ± è¿˜æœªå…³é—­ï¼Œè®©è°ƒç”¨ execute æ–¹æ³•çš„çº¿ç¨‹ç›´æ¥å»æ‰§è¡Œ run æ–¹æ³•ï¼Œå¦åˆ™ä¸æ‰§è¡Œã€‚</li><li>ThreadPoolExecutor.DiscardPolicyï¼Œ<b>è¿™ä¸ªæ‹’ç»ç­–ç•¥ï¼Œä»€ä¹ˆéƒ½æ²¡åšã€‚å…¶å®å°±æ˜¯æŠŠä»»åŠ¡æŠ›å¼ƒäº†</b>ã€‚</li><li>ThreadPoolExecutor.DiscardOldestPolicyï¼Œç”¨äºè¢«æ‹’ç»ä»»åŠ¡çš„å¤„ç†ç¨‹åºï¼Œå®ƒæ”¾å¼ƒæœ€æ—§çš„æœªå¤„ç†è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯<b>è®©æœ€æ—§çš„ä»»åŠ¡å‡ºé˜Ÿï¼Œè‡ªå·±å…¥é˜Ÿï¼Œç„¶åé‡è¯• execute ã€‚å¦‚æœæ‰§è¡Œç¨‹åºå·²å…³é—­ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»»åŠ¡å°†è¢«ä¸¢å¼ƒ</b>ã€‚</li></ol><p>è°ƒç”¨ reject æ–¹æ³•æ‹’ç»ä»»åŠ¡ï¼Œæ ¹æ®è®¾ç½®çš„æ‹’ç»ç­–ç•¥å¤„ç†ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handler<span class="token punctuation">.</span><span class="token function">rejectedExecution</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é»˜è®¤ AbortPolicyï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ç›´æ¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AbortPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RejectedExecutionException</span><span class="token punctuation">(</span><span class="token string">&quot;Task &quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                                             <span class="token string">&quot; rejected from &quot;</span> <span class="token operator">+</span>
                                             e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>CallerRunsPolicyï¼Œå°±æ˜¯åœ¨çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ä¸‹è®©è°ƒç”¨ execute æ–¹æ³•çš„çº¿ç¨‹å»æ‰§è¡Œè¿™ä¸ªæ‹’ç»çš„ä»»åŠ¡ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CallerRunsPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>DiscardPolicyï¼Œä»€ä¹ˆä¹Ÿæ²¡åšï¼Œå…¶å®å°±æ˜¯æŠŠä»»åŠ¡æŠ›å¼ƒäº†ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DiscardPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">DiscardPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>DiscardOldestPolicyï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨çº¿ç¨‹æ± æ˜¯è¿è¡Œæ€æ—¶ä¸¢æ‰æœ€æ—§çš„ä»»åŠ¡ï¼Œç„¶åè°ƒç”¨ execute æ–¹æ³•é‡æ–°æäº¤ä»»åŠ¡ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DiscardOldestPolicy</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">DiscardOldestPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * Obtains and ignores the next task that the executor
     * would otherwise execute, if one is immediately available,
     * and then retries execution of task r, unless the executor
     * is shut down, in which case task r is instead discarded.
     *
     * <span class="token keyword">@param</span> <span class="token parameter">r</span> the runnable task requested to be executed
     * <span class="token keyword">@param</span> <span class="token parameter">e</span> the executor attempting to execute this task
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªæ‹’ç»ç­–ç•¥ï¼Œåšä¸€ä¸‹è®°å½•ï¼Œä¾‹å¦‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomRejectedExecutionHandler</span> <span class="token keyword">implements</span> <span class="token class-name">RejectedExecutionHandler</span> <span class="token punctuation">{</span>
    <span class="token comment">// å…±æŠ›å¼ƒå¤šå°‘ä¸ªä»»åŠ¡</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> handlerCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¯æŠ›å¼ƒå¤šå°‘ä¸ªä»»åŠ¡æŠ¥è­¦ä¸€æ¬¡</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> period<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">CustomRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token class-name">Long</span> period<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>period <span class="token operator">=</span> period<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rejectedExecution</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> executor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executor<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> currentCount <span class="token operator">=</span> handlerCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> model <span class="token operator">=</span> currentCount <span class="token operator">%</span> period<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentCount <span class="token operator">==</span> <span class="token number">1L</span> <span class="token operator">||</span> model <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ‰“æ—¥å¿—ï¼Œå‘é€çŸ­ä¿¡æˆ–è€…é’‰é’‰......</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¤„ç†...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="é’©å­æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#é’©å­æ–¹æ³•" aria-hidden="true">#</a> é’©å­æ–¹æ³•</h3><p>æä¾›äº†ä¸€äº›ç»™å­ç±»å®ç°çš„é’©å­æ–¹æ³•ï¼Œ</p><p>ä¾‹å¦‚åœ¨æ‰§è¡Œä»»åŠ¡ä¹‹å‰æ‰§è¡Œçš„ beforeExecute æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œä»»åŠ¡ä¹‹åæ‰§è¡Œçš„ afterExecute æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™äº›æ–¹æ³•é‡Œé¢åŠ ä¸€äº›ç»Ÿè®¡çš„æ“ä½œã€‚</p><p>æ­¤å¤–ï¼Œæ–¹æ³• terminated å¯ä»¥è¢«é‡å†™ï¼Œä»¥æ‰§è¡Œåœ¨çº¿ç¨‹æ± å®Œå…¨ç»ˆæ­¢åéœ€è¦å®Œæˆçš„ä»»ä½•ç‰¹æ®Šå¤„ç†ã€‚</p><p>å¦‚æœé’©å­æ–¹æ³•å’Œå›è°ƒæ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œå†…éƒ¨å·¥ä½œçº¿ç¨‹å¯èƒ½ä¼šä¾æ¬¡å¤±è´¥å¹¶çªç„¶ç»ˆæ­¢ã€‚</p><h3 id="ç§»é™¤é˜Ÿåˆ—çš„ä»»åŠ¡" tabindex="-1"><a class="header-anchor" href="#ç§»é™¤é˜Ÿåˆ—çš„ä»»åŠ¡" aria-hidden="true">#</a> ç§»é™¤é˜Ÿåˆ—çš„ä»»åŠ¡</h3><p>å¯ä»¥ä½¿ç”¨ getQueue æ–¹æ³•å»è·å–ä»»åŠ¡é˜Ÿåˆ—å¯¹è±¡ã€‚å¼ºçƒˆå»ºè®®ä¸è¦å°†æ­¤æ–¹æ³•ç”¨äºä»»ä½•å…¶ä»–ç›®çš„ã€‚</p><p>æä¾›çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œremove(Runnable) å’Œ purgeï¼Œå¯ç”¨äºåœ¨å–æ¶ˆå¤§é‡æ’é˜Ÿçš„ä»»åŠ¡æ—¶å¸®åŠ©è¿›è¡Œå­˜å‚¨å›æ”¶ã€‚</p><h3 id="çº¿ç¨‹æ± å…³é—­" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ± å…³é—­" aria-hidden="true">#</a> çº¿ç¨‹æ± å…³é—­</h3><p>å¦‚æœä¸€ä¸ªçº¿ç¨‹æ± åœ¨ç¨‹åºä¸­ä¸å†è¢«å¼•ç”¨ï¼Œå¹¶ä¸”å†…éƒ¨æ²¡æœ‰å‰©ä½™çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆå®ƒå°†<strong>è‡ªåŠ¨è¢« shutdown å…³é—­</strong>ã€‚</p><p>å¦‚æœä½ æƒ³ç¡®ä¿å³ä½¿ç”¨æˆ·å¿˜è®°è°ƒç”¨ shutdown ä¹Ÿèƒ½å›æ”¶æœªå¼•ç”¨çš„çº¿ç¨‹ï¼Œæˆ‘ä»¬å¿…é¡»è¦è®©æœªä½¿ç”¨çš„çº¿ç¨‹æœ€ç»ˆæ­»äº¡ã€‚å¯ä»¥é€šè¿‡è®¾ç½®é€‚å½“çš„çº¿ç¨‹çš„æ´»è·ƒè¶…æ—¶æ—¶é—´ï¼Œ0 æ ¸å¿ƒçº¿ç¨‹æˆ–è€…é€šè¿‡ allowCoreThreadTimeOut æ–¹æ³•è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦å…è®¸è¶…æ—¶ç­‰ã€‚</p><h2 id="æ„é€ æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#æ„é€ æ–¹æ³•" aria-hidden="true">#</a> æ„é€ æ–¹æ³•</h2><p>â€ƒâ€ƒçº¿ç¨‹æ± çš„æ„é€ æ–¹æ³•æœ‰ 4 ä¸ªï¼Œå…¶å®éƒ½æ˜¯åŸºäºä¸€ä¸ªå‚æ•°æœ€å¤šçš„æ„é€ æ–¹æ³•ï¼Œåªéœ€è¦å…³æ³¨è¿™ä¸ªå³å¯ã€‚</p><p>â€ƒâ€ƒæ„é€ æ–¹æ³•ä¸­é’ˆå¯¹æŸäº›å‚æ•°æœ‰äº›é™åˆ¶</p><ul><li>æ ¸å¿ƒçº¿ç¨‹æ•°ä¸èƒ½å°äº 0ï¼›</li><li>æœ€å¤§çº¿ç¨‹æ•°é‡ä¸èƒ½å°äºç­‰äº 0ï¼Œä¸”ä¸å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼›</li><li>çº¿ç¨‹è¶…æ—¶æ—¶é—´ä¸èƒ½å°äº 0ï¼›</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *
 * <span class="token keyword">@param</span> <span class="token parameter">corePoolSize</span> æ ¸å¿ƒçº¿ç¨‹æ•°
 * <span class="token keyword">@param</span> <span class="token parameter">maximumPoolSize</span> æœ€å¤§çº¿ç¨‹æ•°
 * <span class="token keyword">@param</span> <span class="token parameter">keepAliveTime</span> çº¿ç¨‹çš„è¶…æ—¶æ—¶é—´
 * <span class="token keyword">@param</span> <span class="token parameter">unit</span> è¶…æ—¶æ—¶é—´çš„å•ä½
 * <span class="token keyword">@param</span> <span class="token parameter">workQueue</span> å­˜æ”¾ä»»åŠ¡çš„ä»»åŠ¡é˜Ÿåˆ—
 * <span class="token keyword">@param</span> <span class="token parameter">threadFactory</span> åˆ›å»ºçº¿ç¨‹çš„çº¿ç¨‹å·¥å‚ç±»
 * <span class="token keyword">@param</span> <span class="token parameter">handler</span> çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥
 */</span>
<span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                          <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                          <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                          <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                          <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span>
                          <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>
                          <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ ¸å¿ƒçº¿ç¨‹æ•°ä¸èƒ½å°äº0</span>
    <span class="token comment">// æœ€å¤§çº¿ç¨‹æ•°é‡ä¸èƒ½å°äºç­‰äº0ï¼Œä¸”ä¸å°äºæ ¸å¿ƒçº¿ç¨‹æ•°</span>
    <span class="token comment">// è¶…æ—¶æ—¶é—´ä¸èƒ½å°äº0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>corePoolSize <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
        maximumPoolSize <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span>
        maximumPoolSize <span class="token operator">&lt;</span> corePoolSize <span class="token operator">||</span>
        keepAliveTime <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workQueue <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> threadFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¸‹é¢æ˜¯è¿™äº›å‚æ•°çš„èµ‹å€¼</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>acc <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span>
            <span class="token keyword">null</span> <span class="token operator">:</span>
            <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize <span class="token operator">=</span> corePoolSize<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>maximumPoolSize <span class="token operator">=</span> maximumPoolSize<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>workQueue <span class="token operator">=</span> workQueue<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>threadFactory <span class="token operator">=</span> threadFactory<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="çº¿ç¨‹æ± çŠ¶æ€å’ŒåŸå­å˜é‡-ctl" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ± çŠ¶æ€å’ŒåŸå­å˜é‡-ctl" aria-hidden="true">#</a> çº¿ç¨‹æ± çŠ¶æ€å’ŒåŸå­å˜é‡ ctl</h2><h3 id="åŸå­å˜é‡-ctl" tabindex="-1"><a class="header-anchor" href="#åŸå­å˜é‡-ctl" aria-hidden="true">#</a> åŸå­å˜é‡ ctl</h3><p>ThreadPoolExecutor ä½¿ç”¨ä¸€ä¸ª AtomicInteger çš„åŸå­å˜é‡ ctl æ¥è®°å½•çº¿ç¨‹æ± çš„çŠ¶æ€å’Œå½“å‰çº¿ç¨‹æ± çš„æœ‰æ•ˆçº¿ç¨‹çš„ä¸ªæ•°ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> ctl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token constant">RUNNING</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ctl æŒ‰ç…§ä½æ•°åˆ†éš”è¡¨ç¤ºäº†ä¸¤ä¸ªå±æ€§ï¼š</p><ul><li><strong>wokerCountï¼šè¡¨æ˜äº†å­˜æ´»çš„æœ‰æ•ˆçš„çº¿ç¨‹çš„ä¸ªæ•°</strong>ï¼›</li><li><strong>runStateï¼šè¡¨æ˜çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œä¾‹å¦‚æ­£åœ¨è¿è¡Œï¼Œå…³é—­ç­‰</strong>ï¼›</li></ul><p>ctl æ˜¯ int ç±»å‹çš„æ•°ï¼Œå‰é¢ 3 ä½è¡¨ç¤ºçº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œåé¢ 29 ä¸ºè¡¨ç¤ºæœ‰æ•ˆçº¿ç¨‹çš„ä¸ªæ•°ã€‚ä¹Ÿå°±è¯´æœ€å¤š<code>(2 ^ 29) - 1</code> (å¤§çº¦5ä¸ªäº¿)ä¸ªçº¿ç¨‹ã€‚</p><blockquote><p>æ³¨æ„ï¼š<b>wokerCountè¡¨ç¤ºæ­£åœ¨è¿è¡Œæ²¡æœ‰åœæ­¢çš„çš„çº¿ç¨‹çš„ä¸ªæ•°ï¼Œè¯¥å€¼å¯èƒ½æš‚æ—¶ä¸ç­‰äºå®é™…çš„æ´»åŠ¨çº¿ç¨‹æ•°</b>ã€‚</p></blockquote><h3 id="çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸ" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸ" aria-hidden="true">#</a> çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸ</h3><p>runState è¡¨ç¤ºçº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€ï¼š</p><ul><li><p><strong>RUNNINGï¼šæ¥å—æ–°çš„ä»»åŠ¡å¹¶å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</strong></p></li><li><p><strong>SHUTDOWNï¼šä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¼šå»å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</strong></p></li><li><p><strong>STOPï¼šä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä¸å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¸­æ–­æ­£åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡ã€‚</strong></p></li><li><p><strong>TIDYINGï¼šä¸´æ—¶çŠ¶æ€ã€‚å¦‚æœæ‰€æœ‰çš„ä»»åŠ¡ç»ˆæ­¢ï¼ŒwokerCount ä¸º 0ï¼ˆé˜»å¡é˜Ÿåˆ—ä¸ºç©ºï¼Œçº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º 0ï¼‰ï¼Œçº¿ç¨‹æ± å°±ä¼šè¿›å…¥è¿™ä¸ªçŠ¶æ€ï¼Œæ˜¯ä¸€ä¸ªè¿‡æ¸¡çŠ¶æ€ï¼Œä¼šåœ¨ TERMINATED çŠ¶æ€ä¹‹å‰æ‰§è¡Œ terminated() çš„é’©å­æ–¹æ³•ã€‚</strong></p></li><li><p><strong>TERMINATEDï¼šå¤„äº TIDYING çŠ¶æ€çš„çº¿ç¨‹æ± è°ƒç”¨ terminated() æ–¹æ³•æ‰§è¡Œå®Œäº†ï¼Œå°±ä¼šè¿›å…¥è¿™ä¸ªçŠ¶æ€</strong></p></li></ul><p>ä¸ºäº†ç»™è¿™äº›ä¸ªçŠ¶æ€ä½œæ¯”è¾ƒï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­æ•°å€¼çš„å¤§å°ï¼Œæ‰€ä»¥å®ƒä»¬çš„æ•°å€¼å¤§å°å¾ˆé‡è¦ï¼Œè¿è¡ŒçŠ¶æ€éšæ—¶é—´å¢åŠ ï¼Œä½†ä¸ä¿è¯èƒ½å¤Ÿåˆ°è¾¾æ¯ä¸ªçŠ¶æ€ã€‚</p><p>çº¿ç¨‹æ± çš„çŠ¶æ€è¿‡åº¦è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li><p><code>RUNNING -&gt; SHUTDOWN</code>ï¼š<strong>è°ƒç”¨äº†shutdown()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿˜éšè—åœ¨finalize()æ–¹æ³•ä¸­ã€‚</strong></p></li><li><p><code>(RUNNING or SHUTDOWN) -&gt; STOP</code>ï¼š<strong>è°ƒç”¨äº†shutdownNow()æ–¹æ³•ã€‚</strong></p></li><li><p><code>SHUTDOWN -&gt; TIDYING</code>ï¼š<strong>é˜Ÿåˆ—å’Œæ± å­éƒ½ä¸ºç©ºã€‚</strong></p></li><li><p><code>STOP -&gt; TIDYING</code>ï¼š<strong>å½“æ± å­ä¸ºç©ºæ—¶ã€‚</strong></p></li><li><p><code>TIDYING -&gt; TERMINATED</code>ï¼š<strong>å½“terminated()çš„é’©å­æ–¹æ³•æ‰§è¡Œå®Œæˆåã€‚</strong></p></li></ul><p><img src="/assets/25-çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸ-684ca070.png" alt="25-çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸ"></p><p>å½“çŠ¶æ€æ˜¯TERMINATEDæ—¶ï¼Œåœ¨awaitTermination()æ–¹æ³•ä¸­ç­‰å¾…çš„çº¿ç¨‹å°†ä¼šè¿”å›ã€‚</p><p>æ£€æµ‹ä»SHUTDOWNçŠ¶æ€åˆ°TIDYINGçŠ¶æ€ï¼Œæ²¡æœ‰æˆ‘ä»¬æƒ³è±¡çš„é‚£ä¹ˆç®€å•ï¼Œå› ä¸ºé˜Ÿåˆ—å¯èƒ½åœ¨éç©ºä¹‹åå˜ä¸ºç©ºï¼Œåä¹‹äº¦ç„¶ã€‚ä½†æ˜¯æˆ‘ä»¬åªèƒ½åœ¨çœ‹åˆ°é˜Ÿåˆ—ä¸ºç©ºä¹‹åç»ˆæ­¢ï¼Œæˆ‘ä»¬çœ‹åˆ°workerCountä¸º0ï¼ˆè¿™æœ‰æ—¶éœ€è¦é‡æ–°æ£€æŸ¥â€”â€”è§ä¸‹æ–‡ï¼‰</p><h3 id="åŸå­å˜é‡-ctl-çš„ä½æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#åŸå­å˜é‡-ctl-çš„ä½æ“ä½œ" aria-hidden="true">#</a> åŸå­å˜é‡ ctl çš„ä½æ“ä½œ</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ctlå˜é‡ï¼Œä»£è¡¨ä¸¤ä¸ªå«ä¹‰ï¼Œé«˜ä¸‰ä½ä»£è¡¨çŠ¶æ€ï¼Œä½ä½è¡¨ç¤ºçº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°é‡
 */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> ctl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token constant">RUNNING</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * COUNT_BITSè¡¨ç¤ºå¸¦ä»£è¡¨è¡¨ç¤ºçº¿ç¨‹æ•°é‡çš„ä¸Šé™çš„ä½æ•°
 * ä¸€èˆ¬æ¥è¯´Integer.SIZEä¸º32ï¼Œæ‰€ä»¥COUNT_BITSå€¼ä¸º29
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COUNT_BITS</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">SIZE</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// ä¸€èˆ¬æ¥è¯´æ˜¯29</span>

<span class="token doc-comment comment">/**
 * CAPACITYè¡¨ç¤ºçº¿ç¨‹ä¸ªæ•°çš„ä¸Šé™ å¤§çº¦5äº¿å¤š  (2 ^ 29) - 1
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CAPACITY</span>   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>


<span class="token comment">/* ---- runStateå­˜å‚¨åœ¨ctlçš„é«˜ä¸‰ä½ ---- */</span>

<span class="token doc-comment comment">/**
 * RUNNINGï¼šçº¿ç¨‹æ± RUNNINGçŠ¶æ€
 * æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä¹Ÿä¼šå»å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
 * -1å³ç§»29ä½ 11100000 00000000 00000000 00000000 è´Ÿæ•°
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RUNNING</span>    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * SHUTDOWNï¼šçº¿ç¨‹æ± SHUTDOWNçŠ¶æ€
 * ä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¼šå»å¤„ç†çº¿ç¨‹æ± çš„ä»»åŠ¡
 * 0å³ç§»29ä½ 00000000 00000000 00000000 00000000
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SHUTDOWN</span>   <span class="token operator">=</span>  <span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * STOPï¼šçº¿ç¨‹æ± STOPçŠ¶æ€
 * ä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä¸å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¸­æ–­æ­£åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡
 * 1å³ç§»29ä½ 00100000 00000000 00000000 00000000
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STOP</span>       <span class="token operator">=</span>  <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * TIDYINGï¼šTERMINATEDå‰çš„è¿‡æ¸¡çŠ¶æ€ï¼Œç”¨äºæ‰§è¡Œé’©å­æ–¹æ³•
 * 2å³ç§»29ä½ 01000000 00000000 00000000 00000000
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TIDYING</span>    <span class="token operator">=</span>  <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * TERMINATEDï¼šçº¿ç¨‹æ± TERMINATEDçŠ¶æ€ï¼Œè¡¨ç¤ºçº¿ç¨‹æ± å…³é—­äº†
 * 3å³ç§»29ä½ 01100000 00000000 00000000 00000000
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TERMINATED</span> <span class="token operator">=</span>  <span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çº¿ç¨‹æ± è¿è¡Œçš„çŠ¶æ€runStateå­˜å‚¨åœ¨ctlçš„é«˜ä¸‰ä½ï¼Œæ‰€ä»¥ä¸Šé¢æ¯ä¸ªçŠ¶æ€å€¼å¯¹åº”çš„äºŒè¿›åˆ¶å°±æ˜¯</p><p>RUNNINGï¼š<code>11100000 00000000 00000000 00000000</code>;</p><p>SHUTDOWNï¼š<code>00000000 00000000 00000000 00000000</code>;</p><p>STOPï¼š<code>00100000 00000000 00000000 00000000</code>;</p><p>TIDYINGï¼š<code>01000000 00000000 00000000 00000000</code>;</p><p>TERMINATEDï¼š<code>01100000 00000000 00000000 00000000</code>;</p><p><b>è·å–æˆ–ç»„è£… ctl å˜é‡ä¸­ä»£è¡¨çº¿ç¨‹æ± çŠ¶æ€ runState å’Œçº¿ç¨‹ä¸ªæ•° workCount éƒ¨åˆ†çš„å€¼</b></p><p><strong>ï¼ˆ1ï¼‰è·å– ctl ä¸­è¡¨ç¤ºå½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€çš„å€¼ï¼Œé«˜ä¸‰ä½</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ~CAPACITYä¸º 11100000 00000000 00000000 00000000
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> c <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token constant">CAPACITY</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ2ï¼‰è·å– ctl ä¸­ worker çš„æ•°é‡</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * CAPACITYä¸º 00011111 11111111 11111111 11111111
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> c <span class="token operator">&amp;</span> <span class="token constant">CAPACITY</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ3ï¼‰ç”¨åœ¨é‡ç½®å½“å‰çº¿ç¨‹æ±  ctl å€¼æ—¶ä¼šç”¨åˆ°</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * rs è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€   wc è¡¨ç¤ºå½“å‰çº¿ç¨‹æ± ä¸­workerï¼ˆçº¿ç¨‹ï¼‰æ•°é‡
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> rs<span class="token punctuation">,</span> <span class="token keyword">int</span> wc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> rs <span class="token operator">|</span> wc<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><b>æ¯”è¾ƒçº¿ç¨‹æ± å„ä¸ªçŠ¶æ€çš„å€¼çš„å¤§å°çš„æ–¹æ³•</b></p><p><code> RUNNING &lt; SHUTDOWN &lt; STOP &lt; TIDYING &lt; TERMINATED</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * æ¯”è¾ƒå½“å‰çº¿ç¨‹æ± ctlæ‰€è¡¨ç¤ºçš„çŠ¶æ€cï¼Œæ˜¯å¦å°äºæŸä¸ªçŠ¶æ€s
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">runStateLessThan</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">,</span> <span class="token keyword">int</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> c <span class="token operator">&lt;</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * æ¯”è¾ƒå½“å‰çº¿ç¨‹æ± ctlæ‰€è¡¨ç¤ºçš„çŠ¶æ€cï¼Œæ˜¯å¦å¤§äºç­‰äºæŸä¸ªçŠ¶æ€s
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">,</span> <span class="token keyword">int</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> c <span class="token operator">&gt;=</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * åˆ¤æ–­å½“å‰çº¿ç¨‹æ± æ˜¯å¦æ˜¯RUNNINGçŠ¶æ€ï¼Œå› ä¸ºSHUTDOWNçŠ¶æ€æ˜¯0ï¼Œåªæœ‰RUNNINGæ˜¯è´Ÿæ•°
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> c <span class="token operator">&lt;</span> <span class="token constant">SHUTDOWN</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><b>CAS æ›´æ–°çº¿ç¨‹æ± çº¿ç¨‹ä¸ªæ•°çš„æ–¹æ³•</b></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * å°è¯•CASæ›´æ–°workerCountï¼Œçº¿ç¨‹çš„æ•°é‡åŠ 1
 */</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">compareAndIncrementWorkerCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> ctl<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>expect<span class="token punctuation">,</span> expect <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * å°è¯•CASæ›´æ–°workerCountï¼Œçº¿ç¨‹çš„æ•°é‡å‡1
 */</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">compareAndDecrementWorkerCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> ctl<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>expect<span class="token punctuation">,</span> expect <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * æ›´æ–°workerCountï¼Œçº¿ç¨‹çš„æ•°é‡å‡1ã€‚
 * åªæœ‰æ›´æ–°æˆåŠŸæ‰ä¼šè¿”å›
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">compareAndDecrementWorkerCount</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é™¤äº†ä¸Šé¢è¿™äº›ä¸ªæ–¹æ³•ï¼Œè¿˜æœ‰ä¸€äº›åˆ¤æ–­å½“å‰çŠ¶æ€çš„ä¸€äº›æ–¹æ³•ï¼Œæ¯”è¾ƒç®€å•ï¼Œå°±ä¸ç½—åˆ—äº†ã€‚</p><h2 id="å…¶ä»–å±æ€§" tabindex="-1"><a class="header-anchor" href="#å…¶ä»–å±æ€§" aria-hidden="true">#</a> å…¶ä»–å±æ€§</h2><ul><li><code>BlockingQueue&lt;Runnable&gt; workQueue</code>ï¼šé˜»å¡é˜Ÿåˆ—ï¼›</li><li>ReentrantLock mainLockï¼šå…¨å±€é”ï¼›</li><li><code>HashSet&lt;Worker&gt; workers</code>ï¼šæ‰€æœ‰å·¥ä½œçº¿ç¨‹çš„ set æ± å­ï¼ˆåªèƒ½åœ¨ mainLock ä¸‹è®¿é—®ï¼‰ï¼›</li><li>Condition terminationï¼šç”¨äºçº¿ç¨‹äº¤äº’ï¼Œé˜»å¡å”¤é†’ï¼›</li><li>int largestPoolSizeï¼šçº¿ç¨‹æ± çš„æ›¾ç»åˆ°è¾¾è¿‡çš„æœ€å¤§å·¥ä½œçº¿ç¨‹ä¸ªæ•°ï¼ˆåªèƒ½åœ¨ mainLock ä¸‹è®¿é—®ï¼‰ï¼›</li><li>long completedTaskCountï¼šçº¿ç¨‹æ± å®Œæˆçš„ä»»åŠ¡æ€»æ•°çš„è¿‘ä¼¼å€¼ï¼ˆåªèƒ½åœ¨ mainLock ä¸‹è®¿é—®ï¼‰ï¼›</li><li>ThreadFactory threadFactoryï¼šçº¿ç¨‹å·¥å‚ï¼›</li><li>RejectedExecutionHandler handlerï¼šæ‹’ç»ç­–ç•¥ï¼›</li><li>long keepAliveTimeï¼šç©ºé—²çº¿ç¨‹çš„è¶…æ—¶æ—¶é—´ï¼›</li><li>boolean allowCoreThreadTimeOutï¼šæ§åˆ¶ keepAliveTime çš„ç­–ç•¥æ˜¯å¦åº”ç”¨åˆ°æ ¸å¿ƒçº¿ç¨‹ï¼›</li><li>int corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼›</li><li>int maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°ï¼›</li></ul><h2 id="å†…éƒ¨ç±»-worker" tabindex="-1"><a class="header-anchor" href="#å†…éƒ¨ç±»-worker" aria-hidden="true">#</a> å†…éƒ¨ç±» Worker</h2><p>Worker ç±»ç»§æ‰¿ AbstractQueuedSynchronizerï¼Œå¹¶å®ç°äº† Runnable æ¥å£ã€‚</p><p><strong>Worker ç»§æ‰¿ AbstractQueuedSynchronizerï¼Œä»¥ç®€åŒ–è·å–å’Œé‡Šæ”¾æ¯ä¸ªä»»åŠ¡æ‰§è¡Œçš„é”ï¼Œä¸ºäº†é˜²æ­¢çº¿ç¨‹è¢«ä¸­æ–­</strong>ã€‚å› ä¸ºè¿™äº›ä¸­æ–­æ—¨åœ¨å”¤é†’ç­‰å¾…ä»»åŠ¡çš„å·¥ä½œçº¿ç¨‹ï¼Œè€Œä¸æ˜¯ä¸­æ–­æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ã€‚</p><p>lock æ–¹æ³•ä¸€æ—¦è·å–äº†ç‹¬å é”ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œä»»åŠ¡ä¸­ï¼Œæœ‰ä¸‹é¢å‡ ä¸ªä½œç”¨ï¼š</p><ul><li>å¦‚æœæ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™ä¸åº”è¯¥ä¸­æ–­çº¿ç¨‹ï¼›</li><li>å¦‚æœçº¿ç¨‹ç°åœ¨ä¸æ˜¯ç‹¬å é”çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ç©ºé—²çŠ¶æ€ï¼Œè¯´æ˜å®ƒæ²¡æœ‰åœ¨å¤„ç†ä»»åŠ¡ï¼Œè¿™æ—¶å¯ä»¥å¯¹çº¿ç¨‹è¿›è¡Œä¸­æ–­ï¼›</li></ul><p>çº¿ç¨‹æ± åœ¨æ‰§è¡Œ shutdown æ–¹æ³•æˆ– tryTerminate æ–¹æ³•æ—¶ä¼šè°ƒç”¨ interruptIdleWorkers æ–¹æ³•æ¥ä¸­æ–­ç©ºé—²çš„çº¿ç¨‹ï¼ŒinterruptIdleWorkers æ–¹æ³•ä¼šä½¿ç”¨ tryLock æ–¹æ³•æ¥åˆ¤æ–­çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦æ˜¯ç©ºé—²çŠ¶æ€ã€‚</p><p><strong>åœ¨è¿è¡Œ Workeçš„æ—¶å€™ä¹‹æ‰€ä»¥æ²¡æœ‰ç”¨ ReentrantLock ä½œä¸ºç‹¬å é”æ¥ä½¿ç”¨æ˜¯å› ä¸ºè¿™é‡Œæ˜¯è¦æ±‚ä¸å¯é‡å…¥çš„</strong>ï¼Œçº¿ç¨‹æ± å®ç°äº†ä¸€ä¸ªç®€å•çš„ä¸å¯é‡å…¥äº’æ–¥é”ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å¯é‡å…¥é”ã€‚å› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›ä»»åŠ¡åœ¨è°ƒç”¨åƒsetCorePoolSizeè¿™æ ·çš„çº¿ç¨‹æ± æ§åˆ¶æ–¹æ³•æ—¶é‡æ–°è·å–é”ï¼Œè¿™æ ·ä¼šä¸­æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ã€‚</p><p>æ­¤å¤–ï¼Œ<strong>ä¸ºäº†åœ¨çº¿ç¨‹å®é™…å¼€å§‹è¿è¡Œä»»åŠ¡ä¹‹å‰æŠ‘åˆ¶ä¸­æ–­ï¼Œæˆ‘ä»¬å°†é”çŠ¶æ€åˆå§‹åŒ–ä¸º -1ï¼Œå¹¶åœ¨å¯åŠ¨æ—¶å°†å…¶æ¸…é™¤ï¼ˆåœ¨runWorker ä¸­ï¼‰</strong>ã€‚</p><p>å±æ€§ï¼š</p><ul><li>Thread threadï¼šWorker å°è£…çš„çº¿ç¨‹ï¼›</li><li>Runnable firstTaskï¼šWorker å°è£…çš„ä»»åŠ¡ï¼Œå‡å¦‚æ­¤å˜é‡ä¸ä¸º nullï¼Œåˆ™ worker çš„çº¿ç¨‹å°±ä¼˜å…ˆæ‰§è¡Œæ­¤ä»»åŠ¡ï¼›</li><li>long completedTasksï¼šæ¯ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡ä¸ªæ•°çš„è®¡æ•°å™¨ï¼›</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span>
    <span class="token keyword">implements</span> <span class="token class-name">Runnable</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">6138294804551838833L</span><span class="token punctuation">;</span>

    <span class="token comment">// worker çš„çº¿ç¨‹ï¼Œå½“åœ¨çº¿ç¨‹å·¥å‚åˆ›å»ºå¤±è´¥çš„æ—¶å€™æ˜¯ null</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>
    <span class="token comment">// ä¸æ˜¯ null çš„è¯ï¼Œå½“çº¿ç¨‹å¯åŠ¨åä¼šç¬¬ä¸€ä¸ªæ‰§è¡Œè¿™ä¸ªä»»åŠ¡</span>
    <span class="token class-name">Runnable</span> firstTask<span class="token punctuation">;</span>
    <span class="token comment">// çº¿ç¨‹å®Œæˆä»»åŠ¡ä¸ªæ•°</span>
    <span class="token keyword">volatile</span> <span class="token keyword">long</span> completedTasks<span class="token punctuation">;</span>

    <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é˜²æ­¢åœ¨ runWorker ä¹‹å‰è¢«ä¸­æ–­</span>
        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// inhibit interrupts until runWorker</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>firstTask <span class="token operator">=</span> firstTask<span class="token punctuation">;</span>
        <span class="token comment">// é€šè¿‡çº¿ç¨‹å·¥å‚åˆ›å»ºçº¿ç¨‹ï¼Œæ³¨æ„çº¿ç¨‹å¯èƒ½åˆ›å»ºå¤±è´¥</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token function">getThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// çº¿ç¨‹æ‰§è¡Œå…¥å£</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Lock methods</span>
    <span class="token comment">//</span>
    <span class="token comment">// The value 0 represents the unlocked state.</span>
    <span class="token comment">// The value 1 represents the locked state.</span>

    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * å°è¯•åŠ é”
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°è¯•ä¿®æ”¹åŒæ­¥çŠ¶æ€ä¸º 0 -&gt; 1 ï¼Œä¿®æ”¹æˆåŠŸè¡¨ç¤ºåŠ é”æˆåŠŸ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * å°è¯•é‡Šæ”¾é”
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åŠ é”</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">// å°è¯•åŠ é”</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">// é‡Šæ”¾é”</span>
    <span class="token comment">// å¯åŠ¨workerä¹‹å‰ä¼šå…ˆè°ƒç”¨unlock()è¿™ä¸ªæ–¹æ³•,</span>
    <span class="token comment">// ä¼šå¼ºåˆ¶åˆ·æ–°ç‹¬å çº¿ç¨‹ä¼šå¼ºåˆ¶åˆ·æ–°ç‹¬å çº¿ç¨‹ExclusiveOwnerThreadä¸ºnullï¼ŒåŒæ­¥çŠ¶æ€Stateä¸º0</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">// è¿”å›å½“å‰workerçš„ç‹¬å é”lockæ˜¯å¦è¢«å ç”¨</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">interruptIfStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> thread<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹" aria-hidden="true">#</a> çº¿ç¨‹æ± æäº¤ä»»åŠ¡æµç¨‹</h2><h3 id="æäº¤ä»»åŠ¡å…¥å£-execute" tabindex="-1"><a class="header-anchor" href="#æäº¤ä»»åŠ¡å…¥å£-execute" aria-hidden="true">#</a> æäº¤ä»»åŠ¡å…¥å£ execute</h3><p>æäº¤ä»»åŠ¡å…¥å£ï¼Œæˆ‘ä»¬ä» ThreadPoolExecutor#execute åˆ†æ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ ¡éªŒï¼šå½“å‰çº¿ç¨‹æ± çš„å­˜æ´»çš„çº¿ç¨‹æ•°é‡ å°äº æ ¸å¿ƒçº¿ç¨‹æ•°å—ï¼Ÿ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°äºæ ¸å¿ƒçº¿ç¨‹æ•°å°±å°è¯•åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œæ·»åŠ æˆåŠŸåç›´æ¥ return</span>
        <span class="token comment">// å…¥å‚ true è¡¨ç¤ºä½¿ç”¨æ ¸å¿ƒçº¿ç¨‹æ•° corePoolSize æ¥é™åˆ¶</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ°è¿™é‡Œè¯´æ˜æ·»åŠ æ–°çº¿ç¨‹å¤±è´¥ï¼ˆå¹¶å‘ï¼‰ï¼Œé‡æ–°è·å–åŸå­å€¼</span>
        c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å‰ç½®æ¡ä»¶ï¼šå½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹æ•° &gt;= æ ¸å¿ƒçº¿ç¨‹å®¹é‡ï¼Œæˆ–è€…æ˜¯ addWorker åˆ›å»ºçº¿ç¨‹å¤±è´¥äº†</span>
    <span class="token comment">// æ ¡éªŒï¼šå½“å‰çº¿ç¨‹æ± æ˜¯è¿è¡ŒçŠ¶æ€ &amp;&amp; ä»»åŠ¡å…¥é˜ŸæˆåŠŸ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é‡æ–°è·å–åŸå­çŠ¶æ€ double-check</span>
        <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ ¡éªŒï¼šå½“å‰çº¿ç¨‹æ± ä¸æ˜¯è¿è¡ŒçŠ¶æ€ &amp;&amp; ä»é˜Ÿåˆ—ç§»é™¤ä»»åŠ¡æˆåŠŸï¼Œåˆ™æ‰§è¡Œæ‹’ç»ç­–ç•¥</span>
        <span class="token comment">/*
         * CASE 1ï¼š!isRunning(recheck) ä¸º true çš„è¯
         *   è¯´æ˜ä»»åŠ¡æäº¤åˆ°é˜Ÿåˆ—ä¹‹åï¼Œçº¿ç¨‹æ± çŠ¶æ€è¢«å¤–éƒ¨çº¿ç¨‹ç»™ä¿®æ”¹ æ¯”å¦‚ï¼šshutdown() shutdownNow()
         *   æ­¤æ—¶éœ€è¦ç”¨ remove å°†åˆšåˆšæäº¤çš„ä»»åŠ¡ä»é˜Ÿåˆ—ç§»é™¤
         * CASE 2ï¼šremove(command)
         *   ç§»é™¤æˆåŠŸï¼šè¯´æ˜è¿™ä¸ªä»»åŠ¡æäº¤ä¹‹åï¼Œæ²¡æœ‰çº¿ç¨‹è¿‡æ¥å¤„ç†
         *   ç§»é™¤å¤±è´¥ï¼šè¯´æ˜è¿™ä¸ªä»»åŠ¡æäº¤ä¹‹åï¼Œåœ¨çº¿ç¨‹æ± å…³é—­å‰è¢«å…¶ä»–çº¿ç¨‹ç»™å¤„ç†äº†
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å‰ç½®æ¡ä»¶ï¼šçº¿ç¨‹æ± æ˜¯è¿è¡Œæ€ï¼Œæˆ–è€…ä¸æ˜¯è¿è¡Œæ€ä½†æ˜¯ç§»é™¤é˜Ÿåˆ—å¤±è´¥äº†</span>
        <span class="token comment">// å‡å¦‚çº¿ç¨‹æ± çš„çº¿ç¨‹ä¸ªæ•°æ˜¯ 0ï¼Œé‚£ä¹ˆéœ€è¦åˆ›å»ºä¸€ä¸ª worker çº¿ç¨‹ä¿è¯è¿™ä¸ªä»»åŠ¡æ‰§è¡Œ</span>
        <span class="token comment">// æ­¤å¤„æ˜¯ä¿è¯çº¿ç¨‹æ± æ­¤æ—¶è‡³å°‘å¾—æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œé˜²æ­¢çº¿ç¨‹æ± æ²¡æœ‰çº¿ç¨‹äº†</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å‰ç½®æ¡ä»¶ï¼šçº¿ç¨‹æ± ä¸æ˜¯è¿è¡Œæ€ï¼Œæˆ–è€…æ˜¯è¿è¡Œæ€ä½†æ˜¯ä»»åŠ¡å…¥é˜Ÿå¤±è´¥</span>
    <span class="token comment">// æ­¤æ—¶å°è¯•åˆ›å»ºæ–° worker çº¿ç¨‹å»æ‰§è¡Œï¼Œ</span>
    <span class="token comment">// 1.çº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯è¿è¡Œæ€ï¼ŒaddWorker è‚¯å®šä¼šå¤±è´¥ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥</span>
    <span class="token comment">// 2.å‡å¦‚æ˜¯ä»»åŠ¡å…¥é˜Ÿå¤±è´¥ï¼Œéœ€è¦è°ƒç”¨ addWorker æ–¹æ³•å»å°è¯•åˆ›å»ºæ–°çº¿ç¨‹ï¼Œæ·»åŠ å¤±è´¥éœ€è¦æ‰§è¡Œæ‹’ç»ç­–ç•¥</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨çº¿ç¨‹æ± åˆšåˆ›å»ºæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°æ˜¯ 0ã€‚å½“æˆ‘ä»¬å‘çº¿ç¨‹æ± æäº¤ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•çš„æµç¨‹ï¼š</p><ol><li>å¦‚æœå½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°å°äº corePoolSizeï¼Œè¯´æ˜çº¿ç¨‹æ•°è¿˜æœªåˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œè¿™æ—¶<strong>å³ä½¿æ˜¯æœ‰ç©ºé—²çº¿ç¨‹ä¹Ÿä¼šå»åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡</strong>ã€‚å…·ä½“å¯¹åº”ä»£ç å°±æ˜¯è°ƒç”¨ addWorker æ–¹æ³•å»åˆ›å»ºçº¿ç¨‹ï¼›</li><li><strong>å¦‚æœå½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°å¤§äºç­‰äº corePoolSize</strong>ï¼Œæˆ–è€…æ˜¯ç¬¬ä¸€æ­¥ addWorker åˆ›å»ºçº¿ç¨‹å¤±è´¥äº†çš„æƒ…å†µã€‚å‡å¦‚æ­¤æ—¶çº¿ç¨‹æ± æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œå°±ä¼š<strong>å°è¯•å°†ä»»åŠ¡å…¥é˜Ÿï¼Œç­‰å¾…çº¿ç¨‹æ± ä¸­æœ‰ç©ºé—²çº¿ç¨‹æ—¶ï¼Œå°±ä¼šæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</strong>ã€‚è¿™é‡Œéœ€è¦æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Œ<strong>å¦‚æœçº¿ç¨‹æ± çŠ¶æ€æ˜¯éè¿è¡ŒçŠ¶æ€æ—¶ï¼Œéœ€è¦æ‹’ç»æ–°ä»»åŠ¡ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼›</strong></li><li>å‡å¦‚åœ¨æ­¥éª¤ 2 ä¸­ä»»åŠ¡å…¥é˜ŸæˆåŠŸï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½ä¼šä¿®æ”¹çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œéœ€è¦å¯¹çº¿ç¨‹æ± çš„çŠ¶æ€è¿›è¡Œ double-checkï¼› <ol><li>å‡å¦‚çº¿ç¨‹æ± å½“å‰çŠ¶æ€ä¸å†æ˜¯è¿è¡Œæ€æ—¶ï¼Œéœ€è¦å°†åˆšåˆšæ·»åŠ çš„ä»»åŠ¡ä»é˜»å¡é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œç§»é™¤æˆåŠŸåˆ™æ‰§è¡Œåç»­çš„æ‹’ç»ç­–ç•¥ï¼ˆç§»é™¤å¤±è´¥å¯èƒ½æ˜¯å› ä¸ºå·²ç»æ‰§è¡Œäº†ï¼‰ï¼›</li><li>å‡å¦‚çº¿ç¨‹æ± å½“å‰çŠ¶æ€è¿˜æ˜¯è¿è¡Œæ€æ—¶ï¼Œéœ€è¦åˆ¤æ–­çº¿ç¨‹æ± çš„çº¿ç¨‹ä¸ªæ•°æ˜¯å¦ä¸º 0ï¼Œå¦‚æœçº¿ç¨‹æ± ä¸­æ²¡æœ‰çº¿ç¨‹äº†ï¼Œéœ€è¦æ–°å»ºä¸€ä¸ªçº¿ç¨‹åˆ°çº¿ç¨‹æ± ä¸­ï¼ˆä¿è¯çº¿ç¨‹æ± æ­¤æ—¶è‡³å°‘å¾—æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œé˜²æ­¢çº¿ç¨‹æ± æ²¡æœ‰çº¿ç¨‹æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼‰ï¼›</li></ol></li><li><strong>å‡å¦‚åœ¨æ­¥éª¤ 2 ä¸­ä»»åŠ¡å…¥é˜Ÿå¤±è´¥ï¼Œè¯´æ˜é˜»å¡é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œåˆ™ä¼šå°è¯•å¼€å¯æ–°çš„çº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ã€‚å‡å¦‚å½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹ä¸ªæ•°å·²ç»åˆ°è¾¾ maximumPoolSizeï¼Œåˆ™æ‰§è¡Œæ‹’ç»ç­–ç•¥</strong>ï¼›</li></ol><h3 id="addworker" tabindex="-1"><a class="header-anchor" href="#addworker" aria-hidden="true">#</a> addWorker</h3><p>å‰é¢åˆ†æçš„ä»£ç ä¸­ï¼Œæœ‰å¾ˆå¤šåœ°æ–¹è°ƒç”¨äº† addWorker æ–¹æ³•ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å°è¯•åˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚</p><p>é¦–å…ˆçœ‹ addWorker æ–¹æ³•çš„å‚æ•°è§£é‡Šï¼š</p><ul><li>Runnable firstTaskï¼šå‡å¦‚ä¸ä¸º null çš„è¯ï¼Œåˆ›å»ºçš„çº¿ç¨‹ä¼šé¦–å…ˆæ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼›</li><li>boolean coreï¼štrue è¡¨ç¤ºä½¿ç”¨ corePoolSize é™åˆ¶çº¿ç¨‹æ•°é‡ï¼Œfalse è¡¨ç¤ºä½¿ç”¨ maximumPoolSize é™åˆ¶ï¼›</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">,</span> <span class="token keyword">boolean</span> core<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¤–éƒ¨å¾ªç¯æ ‡è®° retry</span>
    retry<span class="token operator">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * åˆ¤æ–­çº¿ç¨‹æ± åœ¨æ­¤çŠ¶æ€æ˜¯å¦å…è®¸æ·»åŠ çº¿ç¨‹
         * æ¡ä»¶ 1ï¼šrs &gt;= SHUTDOWNï¼šæˆç«‹åˆ™è¯´æ˜ä¸æ˜¯ running çŠ¶æ€
         * æ¡ä»¶ 2ï¼šç»“æœå–åï¼Œæ³¨æ„çš„æ˜¯å½“çº¿ç¨‹æ± æ˜¯ SHOTDOWN çŠ¶æ€æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­è¿˜æœ‰ä»»åŠ¡æœªå¤„ç†å®Œ
         *      è¿™æ—¶æ˜¯å…è®¸æ·»åŠ  Worker çš„ï¼Œä½†æ˜¯ä¸å…è®¸å†æ¬¡æäº¤ä»»åŠ¡
         *
         * é‚£ä¹ˆè¿™ä¹ˆè¯´ï¼Œä»€ä¹ˆæ—¶å€™èµ°åé¢çš„é€»è¾‘å‘¢ï¼Ÿå°±æ˜¯ if æ¡ä»¶è¿”å› false çš„æ—¶å€™
         * 1. rs è¿è¡Œæ€
         * 2. rs æ˜¯ SHUTDOWN ä¸” firstTask == null ä¸”é˜Ÿåˆ—ä¸æ˜¯ç©º
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span> <span class="token punctuation">(</span>rs <span class="token operator">==</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span> firstTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// è¿›å…¥è¿™ä¸ªçš„æƒ…å†µ</span>
            <span class="token comment">// 1. å½“å‰æ± å­çš„çŠ¶æ€ &gt; SHUTDOWN</span>
            <span class="token comment">// 2. å½“å‰æ± å­çŠ¶æ€æ˜¯ SHUTDOWNï¼Œä½†æ˜¯ firstTask ä¸æ˜¯ null</span>
            <span class="token comment">// 3. å½“å‰æ± å­çŠ¶æ€æ˜¯ SHUTDOWNï¼Œä½†æ˜¯ firstTask æ˜¯ null ä¸”é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œä¹Ÿå°±æ˜¯æ²¡ä»»åŠ¡äº†</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token comment">// å†…éƒ¨è‡ªæ—‹ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¢åŠ çº¿ç¨‹çš„ä¸ªæ•°</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å‡å¦‚å½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹ä¸ªæ•°å·²ç»è¾¾åˆ°äº† CAPACITY æˆ–è€…æ ¹æ® core å˜é‡æ ¡éªŒçº¿ç¨‹ä¸ªæ•°</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">&gt;=</span> <span class="token constant">CAPACITY</span> <span class="token operator">||</span>
                wc <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>core <span class="token operator">?</span> corePoolSize <span class="token operator">:</span> maximumPoolSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// çº¿ç¨‹ä¸ªæ•°è¢«é™åˆ¶äº†ï¼Œè¿”å› false</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// CAS å¢åŠ  WorkerCountï¼Œå¢åŠ æˆåŠŸé€€å‡ºå¤–å¾ªç¯ retry</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndIncrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span> retry<span class="token punctuation">;</span>
            c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Re-read ctl</span>
            <span class="token comment">// è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼Œå‘ç°çº¿ç¨‹æ± çš„çŠ¶æ€æ”¹å˜äº†ï¼Œé‡æ–°å¼€å§‹å¤–å¾ªç¯ï¼Œé‡æ–°æ ¡éªŒ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> rs<span class="token punctuation">)</span>
                <span class="token keyword">continue</span> retry<span class="token punctuation">;</span>
            <span class="token comment">// else CAS failed due to workerCount change; retry inner loop</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// èµ°åˆ°è¿™é‡Œ workCount å·²ç»æˆåŠŸ +1 äº†</span>

    <span class="token comment">// è¡¨ç¤ºåˆ›å»ºçš„ Worker æ˜¯å¦å·²ç»å¯åŠ¨</span>
    <span class="token keyword">boolean</span> workerStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// è¡¨ç¤ºåˆ›å»ºçš„ Worker æ˜¯å¦æ·»åŠ åˆ°æ± å­ä¸­</span>
    <span class="token keyword">boolean</span> workerAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token class-name">Worker</span> w <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ›å»ºæ–°çº¿ç¨‹</span>
        w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Thread</span> t <span class="token operator">=</span> w<span class="token punctuation">.</span>thread<span class="token punctuation">;</span>
        <span class="token comment">// åˆ¤æ–­ t != null çš„åŸå› æ˜¯ï¼Œçº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹å·¥å‚è·å–çš„ï¼Œçº¿ç¨‹å·¥å‚å¯èƒ½è¿”å›çš„æ˜¯ null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
            mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>               
                <span class="token comment">// åŒé‡æ£€æŸ¥ï¼Œå¦‚æœå‡ºç°ThreadFactoryæ•…éšœæˆ–åœ¨è·å–é”ä¹‹å‰å…³é—­ï¼Œè¯·é€€å‡ºã€‚</span>
                <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// æ ¡éªŒï¼šçº¿ç¨‹æ± è¿è¡Œæ€ || (SHUTDOWN &amp;&amp; firstTask == null)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&lt;</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">||</span>
                    <span class="token punctuation">(</span>rs <span class="token operator">==</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span> firstTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æ ¡éªŒçº¿ç¨‹æ˜¯å¦è°ƒç”¨äº† start æ–¹æ³•ï¼Œè¿™æ˜¯é˜²æ­¢è‡ªå·±å®ç°çš„ ThreadFactory åœ¨åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™è°ƒäº† start</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// precheck that t is startable</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    workers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> s <span class="token operator">=</span> workers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// è·å– Set çš„å¤§å°ï¼Œå‡å¦‚å¤§äºè®°å½•çš„æœ€å¤§ worker æ•°é‡ largestPoolSizeï¼Œåˆ™æ›´æ–°</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;</span> largestPoolSize<span class="token punctuation">)</span>
                        largestPoolSize <span class="token operator">=</span> s<span class="token punctuation">;</span>
                    <span class="token comment">// worker æ·»åŠ æˆåŠŸæ ‡å¿—</span>
                    workerAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// çº¿ç¨‹æ ¡éªŒæ·»åŠ å¤„ç†æˆåŠŸï¼Œåˆ™å¼€å¯çº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>workerAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                workerStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> workerStarted<span class="token punctuation">)</span>
            <span class="token comment">// çº¿ç¨‹å¯åŠ¨å¤±è´¥ï¼Œåˆ™è¿›å…¥è¿™é‡Œ</span>
            <span class="token comment">// ä¸»è¦å°±æ˜¯å°† Worker æ•°é‡å‡ 1ï¼Œç§»é™¤åˆšåˆšä¿å­˜åˆ° set çš„ worker</span>
            <span class="token function">addWorkerFailed</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¿”å›æ˜¯å¦æˆåŠŸå¯åŠ¨çº¿ç¨‹</span>
    <span class="token keyword">return</span> workerStarted<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ†æä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œå¤§æ¦‚å¯ä»¥åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€æ­¥æ˜¯æ·»åŠ çº¿ç¨‹æ± çš„ workerCountï¼Œç¬¬äºŒæ­¥æ˜¯åˆ›å»ºå¹¶å¼€å¯çº¿ç¨‹ï¼›</p><p>ï¼ˆ1ï¼‰é¦–å…ˆå¼€å¯ä¸€ä¸ªå¤–å¾ªç¯ï¼Œå¤–å¾ªç¯ä¸»è¦æ˜¯æ ¡éªŒçº¿ç¨‹æ± çš„çŠ¶æ€ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">/*
 * åˆ¤æ–­çº¿ç¨‹æ± åœ¨æ­¤çŠ¶æ€æ˜¯å¦å…è®¸æ·»åŠ çº¿ç¨‹
 * æ¡ä»¶ 1ï¼šrs &gt;= SHUTDOWNï¼šæˆç«‹åˆ™è¯´æ˜ä¸æ˜¯ running çŠ¶æ€
 * æ¡ä»¶ 2ï¼šç»“æœå–åï¼Œæ³¨æ„çš„æ˜¯å½“çº¿ç¨‹æ± æ˜¯ SHOTDOWN çŠ¶æ€æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­è¿˜æœ‰ä»»åŠ¡æœªå¤„ç†å®Œ
 *      è¿™æ—¶æ˜¯å…è®¸æ·»åŠ  Worker çš„ï¼Œä½†æ˜¯ä¸å…è®¸å†æ¬¡æäº¤ä»»åŠ¡
 *
 * é‚£ä¹ˆè¿™ä¹ˆè¯´ï¼Œä»€ä¹ˆæ—¶å€™èµ°åé¢çš„é€»è¾‘å‘¢ï¼Ÿå°±æ˜¯ if æ¡ä»¶è¿”å› false çš„æ—¶å€™
 * 1. rs è¿è¡Œæ€
 * 2. rs æ˜¯ SHUTDOWN ä¸” firstTask == null ä¸”é˜Ÿåˆ—ä¸æ˜¯ç©º
 */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span> <span class="token punctuation">(</span>rs <span class="token operator">==</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span> firstTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// è¿›å…¥è¿™ä¸ªçš„æƒ…å†µ</span>
    <span class="token comment">// 1. å½“å‰æ± å­çš„çŠ¶æ€ &gt; SHUTDOWN</span>
    <span class="token comment">// 2. å½“å‰æ± å­çŠ¶æ€æ˜¯ SHUTDOWNï¼Œä½†æ˜¯ firstTask ä¸æ˜¯ null</span>
    <span class="token comment">// 3. å½“å‰æ± å­çŠ¶æ€æ˜¯ SHUTDOWNï¼Œä½†æ˜¯ firstTask æ˜¯ null ä¸”é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œä¹Ÿå°±æ˜¯æ²¡ä»»åŠ¡äº†</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ï¼ˆ2ï¼‰ å‡å¦‚ä¸Šé¢çš„çŠ¶æ€æ ¡éªŒé€šè¿‡ï¼Œåˆ™è¿›å…¥å†…å¾ªç¯ï¼Œå†…å¾ªç¯æ˜¯ä¸ºäº†å¢åŠ çº¿ç¨‹æ± å·¥ä½œçº¿ç¨‹çš„æ•°é‡ã€‚æ ¹æ® core å‚æ•°æ§åˆ¶å½“å‰æ˜¯å¦å…è®¸åˆ›å»º Worker çº¿ç¨‹ã€‚</p><ul><li>å‡å¦‚å¢åŠ å·¥ä½œçº¿ç¨‹æ•°é‡æˆåŠŸï¼Œåˆ™é€€å‡ºå¤–å¾ªç¯ç»§ç»­å‘åèµ°ï¼›</li><li>å‡å¦‚å¢åŠ å·¥ä½œçº¿ç¨‹æ•°é‡å¤±è´¥ï¼Œéœ€è¦æ ¡éªŒçº¿ç¨‹æ± æ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼› <ul><li>çº¿ç¨‹æ± å‘ç”Ÿæ”¹å˜ï¼Œç»§ç»­å¤–å¾ªç¯ï¼Œé‡æ–°æ ¡éªŒçº¿ç¨‹æ± çŠ¶æ€ï¼›</li><li>çº¿ç¨‹æ± æœªå‘ç”Ÿæ”¹å˜ï¼Œç»§ç»­å†…å¾ªç¯å°è¯•å¢åŠ å·¥ä½œçº¿ç¨‹çš„ä¸ªæ•°ï¼›</li></ul></li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å†…éƒ¨è‡ªæ—‹ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¢åŠ çº¿ç¨‹çš„ä¸ªæ•°</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‡å¦‚å½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹ä¸ªæ•°å·²ç»è¾¾åˆ°äº† CAPACITY æˆ–è€…æ ¹æ® core å˜é‡æ ¡éªŒçº¿ç¨‹ä¸ªæ•°</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">&gt;=</span> <span class="token constant">CAPACITY</span> <span class="token operator">||</span>
        wc <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>core <span class="token operator">?</span> corePoolSize <span class="token operator">:</span> maximumPoolSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// çº¿ç¨‹ä¸ªæ•°è¢«é™åˆ¶äº†ï¼Œè¿”å› false</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// CAS å¢åŠ  WorkerCountï¼Œå¢åŠ æˆåŠŸé€€å‡ºå¤–å¾ªç¯ retry</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndIncrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span> retry<span class="token punctuation">;</span>
    c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Re-read ctl</span>
    <span class="token comment">// è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼Œå‘ç°çº¿ç¨‹æ± çš„çŠ¶æ€æ”¹å˜äº†ï¼Œé‡æ–°å¼€å§‹å¤–å¾ªç¯ï¼Œé‡æ–°æ ¡éªŒ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> rs<span class="token punctuation">)</span>
        <span class="token keyword">continue</span> retry<span class="token punctuation">;</span>
    <span class="token comment">// else CAS failed due to workerCount change; retry inner loop</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ï¼ˆ3ï¼‰èµ°å®Œä¸Šé¢çš„æ­¥éª¤åï¼Œçº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹ä¸ªæ•°å·²ç»åŠ  1 æˆåŠŸäº†ï¼Œæ­¤æ—¶éœ€è¦åˆ›å»º Worker çº¿ç¨‹ï¼Œå¹¶å¼€å¯çº¿ç¨‹ã€‚å‡å¦‚çº¿ç¨‹å¼€å¯å¤±è´¥ï¼Œåˆ™éœ€è¦è°ƒç”¨ addWorkerFailed æ–¹æ³•å¤„ç†ï¼›</p><p>ï¼ˆ4ï¼‰å‡å¦‚çº¿ç¨‹æ­£å¸¸åˆ›å»ºå¹¶ start å¯åŠ¨æˆåŠŸï¼Œåˆ™ç»“æŸæ–¹æ³•ã€‚å¦åˆ™è°ƒç”¨ addWorkerFailed æ–¹æ³•ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addWorkerFailed</span><span class="token punctuation">(</span><span class="token class-name">Worker</span> w<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
    mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">// å‡å¦‚workerå·²ç»åˆ›å»ºäº†ï¼Œåˆ™ç§»é™¤å®ƒ</span>
            workers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// workerçš„æ•°é‡å‡1 å› ä¸ºåœ¨ addWorker æ–¹æ³•çš„å¾ªç¯æ ¡éªŒé˜¶æ®µå°±å¢åŠ äº†çº¿ç¨‹ä¸ªæ•°</span>
        <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬éœ€è¦çŸ¥é“çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯<strong>SHUTDOWNæ—¶ï¼Œçº¿ç¨‹æ± ä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¼šå»å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</strong>ã€‚è¿™ä¸ªæ—¶å€™æ˜¯<strong>å…è®¸æ·»åŠ workerï¼Œä½†æ˜¯ä¸å…è®¸å†æ¬¡æäº¤ä»»åŠ¡</strong>ã€‚</p><p><strong>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ addWorker æ–¹æ³•ä¼šåˆ›å»ºçº¿ç¨‹å¤±è´¥å‘¢ï¼Ÿ</strong></p><ul><li>å½“å‰çº¿ç¨‹æ± çŠ¶æ€å¤§äº SHUTDOWN çŠ¶æ€ï¼Œå³<strong>STOPã€TIDYINGã€TERMINATEDçŠ¶æ€</strong>ï¼›</li><li>å½“å‰çº¿ç¨‹æ± çŠ¶æ€æ˜¯ <strong>SHUTDOWN çŠ¶æ€ï¼Œä¸”å‚æ•° firstTask ä¸ä¸º null</strong>ï¼›</li><li>å½“å‰çº¿ç¨‹æ± çŠ¶æ€æ˜¯ <strong>SHUTDOWN çŠ¶æ€ï¼Œä¸”å‚æ•° firstTask ä¸º nullï¼Œä¸”ä»»åŠ¡é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œä¹Ÿå°±æ˜¯æ²¡ä»»åŠ¡</strong>ï¼›</li><li>å½“å‰çº¿ç¨‹æ± çš„çº¿<strong>ç¨‹ä¸ªæ•°è¶…è¿‡ä¸Šé™ 5äº¿ï¼ŒåŸºæœ¬ä¸å¯èƒ½</strong>ï¼›</li><li>å½“å‰çº¿ç¨‹æ± çš„<strong>çº¿ç¨‹ä¸ªæ•°è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°æˆ–æœ€å¤§çº¿ç¨‹ä¸ªæ•°ï¼Œå…·ä½“å“ªä¸€ä¸ªéœ€è¦æ ¹æ®å‚æ•° core å†³å®š</strong>ï¼›</li><li>å½“å‰çº¿ç¨‹æ± çš„ ThreadFactory æœ‰é—®é¢˜ï¼Œåˆ›å»ºçš„çº¿ç¨‹æ˜¯ nullï¼Œæˆ–è€…æ˜¯å·¥å‚ä¸­åˆ›å»ºçº¿ç¨‹åç«‹é©¬è°ƒç”¨äº† start æ–¹æ³•ï¼›</li><li>å¯èƒ½å‘ç”Ÿå¼‚å¸¸äº†ï¼Œé€šå¸¸æ˜¯ Thread.start() ä¸­å‘ç”Ÿ OOM äº†ï¼›</li></ul><h2 id="çº¿ç¨‹æ± ä»»åŠ¡çš„æ‰§è¡Œ" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ± ä»»åŠ¡çš„æ‰§è¡Œ" aria-hidden="true">#</a> çº¿ç¨‹æ± ä»»åŠ¡çš„æ‰§è¡Œ</h2><h3 id="runworker-æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#runworker-æ–¹æ³•" aria-hidden="true">#</a> runWorker æ–¹æ³•</h3><p>çº¿ç¨‹åˆ›å»ºå¹¶å¯åŠ¨å®Œæˆåå°±ä¼šè°ƒç”¨ Worker çš„ run æ–¹æ³•ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// çº¿ç¨‹æ‰§è¡Œå…¥å£</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰€ä»¥çº¿ç¨‹è¿è¡Œåï¼Œå°±ä¼šè°ƒç”¨ ThreadPoolExecutor#runWorker æ–¹æ³•ã€‚</p><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦å°±æ˜¯æ‰§è¡Œ firstTask ä»»åŠ¡å’Œé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">Worker</span> w<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> wt <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runnable</span> task <span class="token operator">=</span> w<span class="token punctuation">.</span>firstTask<span class="token punctuation">;</span>
    w<span class="token punctuation">.</span>firstTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>
    <span class="token comment">/*
     * å› ä¸ºä¹‹å‰åˆ›å»º Worker çš„æ—¶å€™å°† AQS çš„ state åˆå§‹ä¸º -1ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹è¢«ä¸­æ–­
     * è€Œè¿™é‡Œ unlock æ–¹æ³•æ˜¯æŠŠ state é‡ç½®ä¸º 0ï¼ŒexclusiveOwnerThread ==nullã€‚
     * æ„æ€å°±æ˜¯å·²ç»è¿›å…¥åˆ° runWorker æ–¹æ³•ä¸­ï¼Œå¯ä»¥å…è®¸ä¸­æ–­äº†
     */</span>
    w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// allow interrupts</span>
    <span class="token comment">// æ˜¯å¦æ˜¯æ­£å¸¸é€€å‡ºæ ‡å¿—ï¼Œfalse æ­£å¸¸é€€å‡º true å­—é¢æ„æ€çªç„¶é€€å‡ºï¼Œä¹Ÿå°±æ˜¯æœ‰å¼‚å¸¸</span>
    <span class="token keyword">boolean</span> completedAbruptly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‰§è¡Œ firstTask ä»»åŠ¡ï¼Œæˆ–è€…ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡æ‰§è¡Œ</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>task <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è®¾ç½®ç‹¬å é” ä¸æ˜¯å¯é‡å…¥é”ï¼Œä¸ºäº†ç¡®ä¿ä¸‹é¢çš„ä»£ç ä¸ä¼šè¢«åŒä¸€çº¿ç¨‹æ‰€é‡å…¥ï¼ŒåŒæ—¶å¯ä»¥åšåˆ°ä¸åŒçº¿ç¨‹å¯ä»¥å¹¶å‘æ‰§è¡Œ</span>
            <span class="token comment">// shutdown æ—¶ä¼šåˆ¤æ–­å½“å‰ worker çŠ¶æ€ï¼Œæ ¹æ®ç‹¬å é”æ˜¯å¦ç©ºé—²æ¥åˆ¤æ–­å½“å‰ worker æ˜¯å¦æ­£åœ¨å·¥ä½œã€‚</span>
            w<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å‡å¦‚çº¿ç¨‹æ± çš„çŠ¶æ€ &gt;= STOP éœ€è¦ä¿è¯çº¿ç¨‹è¢«ä¸­æ–­ã€‚</span>
            <span class="token comment">// çº¿ç¨‹æ± çš„çŠ¶æ€ &lt; STOPï¼Œéœ€è¦ä¿è¯çº¿ç¨‹æœªè¢«ä¸­æ–­ã€‚</span>
            <span class="token comment">// è¿™éœ€è¦åœ¨ç¬¬äºŒç§æƒ…å†µä¸‹é‡æ–°æ£€æŸ¥ï¼Œä»¥å¤„ç† shutdownNow äº‰ç”¨ï¼ŒåŒæ—¶æ¸…é™¤ä¸­æ–­çŠ¶æ€</span>
            <span class="token comment">// ((å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€ &gt;= STOP) || (å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ &amp;&amp; å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€ &gt;= STOP)) &amp;&amp; å½“å‰çº¿ç¨‹æœªè¢«ä¸­æ–­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">STOP</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">STOP</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>wt<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// ä¸­æ–­çº¿ç¨‹</span>
                wt<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ‰§è¡Œä»»åŠ¡å‰çš„é€»è¾‘</span>
                <span class="token function">beforeExecute</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Throwable</span> thrown <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æ‰§è¡Œä»»åŠ¡çš„ run æ–¹æ³•</span>
                    task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æ‰§è¡Œä»»åŠ¡åæ‰§è¡Œçš„é€»è¾‘</span>
                    <span class="token function">afterExecute</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> thrown<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// beforeExecuteï¼Œrunï¼ŒafterExecuteéƒ½å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸</span>
                <span class="token comment">// ä»»åŠ¡ç½®null ä¸‹æ¬¡å¾ªç¯çš„æ—¶å€™å°±ä¼šåœ¨é˜»å¡é˜Ÿåˆ—ä¸­æ‹¿å–ä¸‹ä¸€ä¸ªä»»åŠ¡äº†</span>
                task <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token comment">// å®Œæˆä»»åŠ¡+1</span>
                w<span class="token punctuation">.</span>completedTasks<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment">// é‡Šæ”¾ç‹¬å é”</span>
                w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¼šç»§ç»­è¿›è¡Œwhileå¾ªç¯</span>
                <span class="token comment">// å¼‚å¸¸æƒ…å†µä¸‹ï¼Œä¼šç›´æ¥é€€å‡ºå¾ªç¯ï¼Œç›´æ¥è·³åˆ°processWorkerExitï¼Œæ­¤æ—¶completedAbruptlyä¸ºtrue</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// èµ°åˆ°æ­¤å¤„è¯´æ˜ Worker å’Œé˜Ÿåˆ—ä¸­éƒ½å·²ç»æ²¡æœ‰äº†ä»»åŠ¡</span>
        completedAbruptly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‰§è¡Œé€€å‡º Worker çš„é€»è¾‘</span>
        <span class="token function">processWorkerExit</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> completedAbruptly<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ†æä¸‹ä¸Šé¢è¿™ä¸ªæ–¹æ³•ï¼š</p><ul><li>é¦–å…ˆè°ƒç”¨ unlock æ–¹æ³•ï¼Œå…è®¸çº¿ç¨‹è¢«ä¸­æ–­ï¼›</li><li>å¼€å¯ä¸€ä¸ª while å¾ªç¯ï¼Œæ‰§è¡Œ firstTask ä»»åŠ¡æˆ–è€…é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼›</li><li>æ¯æ¬¡æ‰§è¡Œä»»åŠ¡è®©çº¿ç¨‹æŒæœ‰ç‹¬å é”ï¼Œä»»åŠ¡æ‰§è¡Œå®Œåé‡Šæ”¾ç‹¬å é”ï¼›</li><li>è·å–ç‹¬å é”åï¼Œéœ€è¦æ ¡éªŒçº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œ <ul><li>å‡å¦‚çº¿ç¨‹æ± çš„çŠ¶æ€ &gt;= STOP éœ€è¦ä¿è¯çº¿ç¨‹è¢«ä¸­æ–­ï¼›</li><li>å‡å¦‚çº¿ç¨‹æ± çš„çŠ¶æ€ &lt; STOPï¼Œéœ€è¦ä¿è¯çº¿ç¨‹æœªè¢«ä¸­æ–­ï¼›</li></ul></li><li>ä»»åŠ¡æ‰§è¡Œå‰ï¼Œéœ€è¦æ‰§è¡Œé’©å­æ–¹æ³• ThreadPoolExecutor#beforeExecuteï¼Œä»»åŠ¡æ‰§è¡Œå®Œåï¼Œéœ€è¦æ‰§è¡Œé’©å­æ–¹æ³•ThreadPoolExecutor#afterExecuteï¼›</li><li>æ²¡æœ‰ä»»åŠ¡æ‰§è¡Œæˆ–è€…å‘ç”Ÿå¼‚å¸¸äº†ä¼šé€€å‡º while å¾ªç¯ï¼Œæœ€åä¼šè°ƒç”¨ ThreadPoolExecutor#processWorkerExit æ–¹æ³•é€€å‡ºä»»åŠ¡çº¿ç¨‹ã€‚beforeExecuteï¼Œrunï¼ŒafterExecute æ–¹æ³•éƒ½å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤æ—¶å…¥å‚ completedAbruptly ä¼šæ˜¯ trueï¼›</li></ul><h3 id="è·å–ä»»åŠ¡-gettask-æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#è·å–ä»»åŠ¡-gettask-æ–¹æ³•" aria-hidden="true">#</a> è·å–ä»»åŠ¡ getTask æ–¹æ³•</h3><p>åœ¨ ThreadPoolExecutor#runWorker æ–¹æ³•ä¸­ï¼Œé€šè¿‡ ThreadPoolExecutor#getTask æ–¹æ³•ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡æ‰§è¡Œï¼Œå½“ getTask æ–¹æ³•è¿”å› null çš„æ—¶å€™ï¼Œè¯´æ˜é˜»å¡é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡äº†ï¼Œéœ€è¦ Worker æ‰§è¡Œé€€å‡ºé€»è¾‘ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Runnable</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// Did the last poll() time out?</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * Check if queue empty only if necessary.
         * æ¡ä»¶1ï¼šrs &gt;= SHUTDOWN çº¿ç¨‹æ± çš„çŠ¶æ€ä¸æ˜¯RUNNINGçŠ¶æ€
         * æ¡ä»¶2ï¼šrs &gt;= STOP || workQueue.isEmpty()
         *     çº¿ç¨‹æ± çš„çŠ¶æ€ä¸ºSTOPï¼ŒTIDYINGï¼ŒTERMINATED
         *  æˆ–è€… çº¿ç¨‹æ± çš„çŠ¶æ€ä¸ºSHUTDOWNçŠ¶æ€ä¸”é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡äº†
         * è¿™ä¸¤ç§çŠ¶æ€å·²ç»ä¸éœ€è¦è·å–ä»»åŠ¡äº†ï¼Œè¿”å›nullä¹‹årunWorkerå°±é€€å‡ºå¾ªç¯äº†
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> <span class="token constant">STOP</span> <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// èµ°åˆ°è¿™é‡Œè¯´æ˜ï¼š1-çº¿ç¨‹æ± æ—¶RUNNING 2-SHUTDOWNä½†æ˜¯é˜»å¡é˜Ÿåˆ—ä¸­è¿˜æœ‰ä»»åŠ¡</span>

        <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Are workers subject to culling?</span>
        <span class="token comment">// allowCoreThreadTimeOut æ˜¯æ§åˆ¶æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦å…è®¸è¶…æ—¶çš„</span>
        <span class="token comment">// timedè¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯å¦å…è®¸è¶…æ—¶ é”€æ¯</span>
        <span class="token keyword">boolean</span> timed <span class="token operator">=</span> allowCoreThreadTimeOut <span class="token operator">||</span> wc <span class="token operator">&gt;</span> corePoolSize<span class="token punctuation">;</span>
        <span class="token comment">/*
         * timedOut ä¸º trueè¯´æ˜ä¸æ˜¯ç¬¬ä¸€æ¬¡å¾ªç¯äº† ä¸Šæ¬¡å¾ªç¯ä¸­å·²ç»å‘ç”Ÿäº†pollçš„è¶…æ—¶
         * æ¡ä»¶ä¸€ï¼š(wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))
         * 1.1ï¼šwc &gt; maximumPoolSize  ä¸ºä»€ä¹ˆä¼šæˆç«‹ï¼ŸsetMaximumPoolSize()æ–¹æ³•ï¼Œå¯èƒ½å¤–éƒ¨çº¿ç¨‹å°†çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°è®¾ç½®ä¸ºæ¯”åˆå§‹åŒ–æ—¶çš„è¦å°
         * 1.2: (timed &amp;&amp; timedOut) æ¡ä»¶æˆç«‹ï¼šå‰ç½®æ¡ä»¶ï¼Œå½“å‰çº¿ç¨‹ä½¿ç”¨ pollæ–¹å¼è·å–taskã€‚ä¸Šä¸€æ¬¡å¾ªç¯æ—¶  ä½¿ç”¨pollæ–¹å¼è·å–ä»»åŠ¡æ—¶ï¼Œè¶…æ—¶äº†
         * æ¡ä»¶ä¸€ ä¸ºtrue è¡¨ç¤º çº¿ç¨‹å¯ä»¥è¢«å›æ”¶ï¼Œè¾¾åˆ°å›æ”¶æ ‡å‡†ï¼Œå½“ç¡®å®éœ€è¦å›æ”¶æ—¶å†å›æ”¶ã€‚
         * æ¡ä»¶äºŒï¼š(wc &gt; 1 || workQueue.isEmpty())
         * 2.1: wc &gt; 1  æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ± ä¸­è¿˜æœ‰å…¶ä»–çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥ç›´æ¥å›æ”¶ï¼Œè¿”å›null
         * 2.2: workQueue.isEmpty() å‰ç½®æ¡ä»¶ wc == 1ï¼Œ æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰ä»»åŠ¡é˜Ÿåˆ— å·²ç»ç©ºäº†ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥æ”¾å¿ƒçš„é€€å‡ºã€‚
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wc <span class="token operator">&gt;</span> maximumPoolSize <span class="token operator">||</span> <span class="token punctuation">(</span>timed <span class="token operator">&amp;&amp;</span> timedOut<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wc <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndDecrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">/*
             * å¦‚æœ timed ä¸ºtrueï¼Œåˆ™é€šè¿‡ poll æ–¹æ³•è¿›è¡Œé™æ—¶æ‹¿å–
             *ï¼ˆè¶…è¿‡ keepAliveTime æ—¶é—´æ²¡æœ‰æ‹¿å–åˆ°ï¼Œå°±ç›´æ¥è¿”å› nullï¼‰ï¼Œ
             * å¦åˆ™é€šè¿‡ take æ–¹æ³•è¿›è¡Œæ‹¿å–
             *ï¼ˆå¦‚æœé˜»å¡é˜Ÿåˆ—ä¸ºç©ºï¼Œtake æ–¹æ³•åœ¨æ­¤æ—¶å°±ä¼šè¢«é˜»å¡ä½ï¼Œä¹Ÿå°±æ˜¯æœ¬çº¿ç¨‹ä¼šè¢«é˜»å¡ä½ï¼Œç›´åˆ°é˜»å¡é˜Ÿåˆ—
             * ä¸­æœ‰æ•°æ®äº†ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœ timed ä¸º false çš„è¯ï¼Œè¿™äº›å·¥ä½œçº¿ç¨‹ä¼šä¸€ç›´è¢«é˜»å¡åœ¨è¿™é‡Œï¼‰
             */</span>
            <span class="token class-name">Runnable</span> r <span class="token operator">=</span> timed <span class="token operator">?</span>
                workQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                workQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> r<span class="token punctuation">;</span>
            timedOut <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> retry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ†æä¸‹ä¸Šé¢çš„æ–¹æ³•ï¼š</p><p>getTask æ–¹æ³•å¯èƒ½ä¼šä½¿å½“å‰çº¿ç¨‹é˜»å¡æˆ–ç­‰å¾…ï¼Œå–å†³äºå½“å‰çš„é…ç½®ã€‚</p><p>getTaskè¿”å› null æ˜¯å› ä¸ºå½“å‰çš„ worker å¿…é¡»é€€å‡ºäº†ï¼Œé€€å‡ºçš„å¯èƒ½æƒ…å†µæœ‰ä¸‹ï¼š</p><ul><li>çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹æ•°é‡å¤§äº maximumPoolSize äº†ï¼Œè¿™æ˜¯å› ä¸ºè°ƒç”¨äº† setMaximumPoolSize æ–¹æ³•ï¼›</li><li>çº¿ç¨‹æ± åœ¨ STOP çŠ¶æ€ã€‚æ­¤æ—¶ä¸ä¼šæ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šå»æ‰§è¡Œé˜Ÿåˆ—çš„ä»»åŠ¡ï¼›</li><li>çº¿ç¨‹æ± åœ¨ SHUTDOWN çŠ¶æ€ï¼Œä¸”é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡äº†ã€‚å› ä¸ºæ­¤çŠ¶æ€ä¸ä¼šæ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œå‡å¦‚é˜Ÿåˆ—ä¸­è¿˜æœ‰ä»»åŠ¡çš„è¯ï¼Œè¿˜æ˜¯ä¼šå»æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼›</li><li>Worker ç­‰å¾…ä»»åŠ¡è¶…æ—¶ï¼Œå½“å‰çš„ worker å¿…é¡»é€€å‡ºäº†ï¼›</li></ul><p><strong>å¯ä»¥çœ‹åˆ° keepAliveTime å°±æ˜¯æ§åˆ¶çº¿ç¨‹ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡çš„è¶…æ—¶æ—¶é—´ã€‚</strong></p><h3 id="processworkerexit-æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#processworkerexit-æ–¹æ³•" aria-hidden="true">#</a> processWorkerExit æ–¹æ³•</h3><p>å½“çº¿ç¨‹åœ¨è¿è¡Œæ—¶ï¼Œåœ¨è·å–ä»»åŠ¡è¶…æ—¶æˆ–è€…æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸äº†ï¼Œéœ€è¦ Worker é€€å‡ºï¼Œå°±ä¼šè°ƒç”¨ processWorkerExit æ–¹æ³•å¤„ç†ã€‚</p><p>è¿™ä¸ªæ–¹æ³•å°†è¦é€€å‡ºçš„çº¿ç¨‹ä» WorkerSet ä¸­ç§»é™¤ï¼Œå¹¶å°è¯• tryTerminateï¼Œåœ¨ä¸‹é¢å‡ ç§æƒ…å†µä¼šåˆ›å»ºæ–°çš„ Worker æ·»åŠ åˆ°æ± ä¸­ï¼Œå‰æéƒ½æ˜¯å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯ RUNNING æˆ–è€… SHUTDOWNã€‚</p><ul><li>å½“å‰çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ–° worker åˆ°çº¿ç¨‹æ± ï¼›</li><li>!workQueue.isEmpty() è¯´æ˜ä»»åŠ¡é˜Ÿåˆ—ä¸­è¿˜æœ‰ä»»åŠ¡ï¼Œæœ€èµ·ç è¦ç•™ä¸€ä¸ªçº¿ç¨‹ï¼›</li><li>å½“å‰çº¿ç¨‹æ•°é‡å°äº corePoolSize å€¼ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºçº¿ç¨‹ï¼Œç»´æŠ¤çº¿ç¨‹æ± æ•°é‡åœ¨corePoolSizeä¸ªï¼›</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processWorkerExit</span><span class="token punctuation">(</span><span class="token class-name">Worker</span> w<span class="token punctuation">,</span> <span class="token keyword">boolean</span> completedAbruptly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>completedAbruptly<span class="token punctuation">)</span> <span class="token comment">// If abrupt, then workerCount wasn&#39;t adjusted</span>
        <span class="token comment">// å¦‚æœæ˜¯å‘ç”Ÿå¼‚å¸¸é€€å‡ºå¾ªç¯çš„ï¼Œéœ€è¦å‡å°‘workerçš„æ•°é‡</span>
        <span class="token comment">// å¼‚å¸¸é€€å‡ºæ—¶ï¼Œctl è®¡æ•°ï¼Œå¹¶æ²¡æœ‰-1</span>
        <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
    mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†å•ä¸ª worker å®Œæˆçš„ä»»åŠ¡æ•°é‡ç´¯åŠ åˆ°çº¿ç¨‹æ± çš„å®Œæˆæ•°é‡</span>
        completedTaskCount <span class="token operator">+=</span> w<span class="token punctuation">.</span>completedTasks<span class="token punctuation">;</span>
        <span class="token comment">/*
         * æŠŠå½“å‰ Workerï¼ˆä¹Ÿå°±æ˜¯å½“å‰çº¿ç¨‹ï¼‰å‰”é™¤å‡º workers é›†åˆä¸­ï¼Œç­‰å¾…GC
         * è¦ä¹ˆæ˜¯ç©ºé—²çš„æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶éœ€è¦è¢«é”€æ¯ï¼Œè¦ä¹ˆæ˜¯ç©ºé—²çš„éæ ¸å¿ƒçº¿ç¨‹è¶…æ—¶éœ€è¦è¢«é”€æ¯ã€‚
         * ä¸ç®¡å±äºå“ªä¸€ç§ï¼Œå½“å‰çº¿ç¨‹éƒ½æ˜¯è¦è¢«é”€æ¯çš„
         */</span>
        workers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å°è¯•å°†çº¿ç¨‹æ± æ”¹ä¸ºTerminateçŠ¶æ€</span>
    <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯ RUNNING æˆ–è€… SHUTDOWN</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateLessThan</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token constant">STOP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜ï¼Œå½“å‰çº¿ç¨‹çš„é€€å‡ºæ˜¯æ­£å¸¸é€€å‡ºï¼Œä¸æ˜¯å¼‚å¸¸</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>completedAbruptly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> min <span class="token operator">=</span> allowCoreThreadTimeOut <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> corePoolSize<span class="token punctuation">;</span>
            <span class="token comment">// æ­¤æ—¶å¦‚æœé˜Ÿåˆ—é‡Œè¿˜æœ‰ä»»åŠ¡æ²¡æ‰§è¡Œï¼ˆå¯èƒ½åœ¨æ‰§è¡Œåˆ°æ­¤å¤„çš„æ—¶å€™ï¼Œåˆæœ‰äººæäº¤äº†ä»»åŠ¡åˆ°é˜Ÿåˆ—ä¸­äº†ï¼‰ï¼Œ</span>
            <span class="token comment">// å°±ä½¿ min=1ï¼Œå› ä¸ºè¿˜éœ€è¦è‡³å°‘ç•™ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œtaskä»»åŠ¡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>min <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                min <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment">// å‡å¦‚å½“å‰çº¿ç¨‹æ± çš„workerçš„æ•°é‡å¤§äºç­‰äºminï¼Œè¯´æ˜çº¿ç¨‹æ± çš„workeræ•°é‡è¶³å¤Ÿï¼Œç›´æ¥è¿”å›</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> min<span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// replacement not needed</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ­¤å¤„å‰ç½®æ¡ä»¶ï¼š1-çº¿ç¨‹æ‰§è¡Œä»»åŠ¡å‘ç”Ÿå¼‚å¸¸ 2-æ­£å¸¸æ‰§è¡Œä»»åŠ¡ä½†æ˜¯workerCountOf(c) &lt; min</span>
        <span class="token comment">// 1.å½“å‰çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ–° worker åˆ°çº¿ç¨‹æ± ã€‚</span>
        <span class="token comment">// 2.!workQueue.isEmpty() è¯´æ˜ä»»åŠ¡é˜Ÿåˆ—ä¸­è¿˜æœ‰ä»»åŠ¡ï¼Œæœ€èµ·ç è¦ç•™ä¸€ä¸ªçº¿ç¨‹ã€‚ å½“å‰çŠ¶æ€ä¸º RUNNING || SHUTDOWN</span>
        <span class="token comment">// 3.å½“å‰çº¿ç¨‹æ•°é‡ &lt; corePoolSizeå€¼ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºçº¿ç¨‹ï¼Œç»´æŠ¤çº¿ç¨‹æ± æ•°é‡åœ¨corePoolSizeä¸ªã€‚</span>
        <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="çº¿ç¨‹æ± ä¼˜é›…å…³é—­" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ± ä¼˜é›…å…³é—­" aria-hidden="true">#</a> çº¿ç¨‹æ± ä¼˜é›…å…³é—­</h2><h3 id="shutdown-æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#shutdown-æ–¹æ³•" aria-hidden="true">#</a> shutdown æ–¹æ³•</h3><p>å…³é—­çº¿ç¨‹æ± æ—¶ä¸€èˆ¬è°ƒç”¨çš„æ˜¯ shutdown æ–¹æ³•ï¼Œè€Œä¸æ˜¯ shutdownNow æ–¹æ³•ï¼š</p><p><strong>SHUTDOWN çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¸ä¼šæ¥å—æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¼šå»æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</strong>ã€‚å¦‚æœå½“å‰çš„çŠ¶æ€å·²ç»æ˜¯ SHUTDOWNçŠ¶æ€æˆ–è€…ä¹‹åçš„çŠ¶æ€ï¼Œåˆ™æ­¤æ¬¡è°ƒç”¨ï¼Œæ²¡æœ‰ä»€ä¹ˆé¢å¤–çš„æ•ˆæœã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š<strong>æ­¤æ–¹æ³•ä¸ç­‰å¾…å…ˆå‰æäº¤çš„ä»»åŠ¡å®Œæˆæ‰§è¡Œ</strong>ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ awaitTermination æ–¹æ³•ç­‰å¾…ä¹‹å‰çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
    mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ£€æŸ¥å…³é—­çš„æƒé™</span>
        <span class="token function">checkShutdownAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å°è¯•å°†çº¿ç¨‹æ± çš„çŠ¶æ€æ”¹ä¸º SHUTDOWN</span>
        <span class="token function">advanceRunState</span><span class="token punctuation">(</span><span class="token constant">SHUTDOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸­æ–­ç©ºé—²çº¿ç¨‹ï¼ˆçº¿ç¨‹å¯èƒ½åœ¨é˜»å¡ç­‰å¾…é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼‰</span>
        <span class="token function">interruptIdleWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ScheduledThreadPoolExecutor çš„é’©å­æ–¹æ³•</span>
        <span class="token function">onShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hook for ScheduledThreadPoolExecutor</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="shutdownnow-æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#shutdownnow-æ–¹æ³•" aria-hidden="true">#</a> shutdownNow æ–¹æ³•</h3><p>**å°è¯•åœæ­¢æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œåœæ­¢å¤„ç†ç­‰å¾…ä¸­çš„ä»»åŠ¡ï¼Œè¿”å›é‚£äº›ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡çš„é›†åˆã€‚**ä»è¯¥æ–¹æ³•è¿”å›æ—¶ï¼Œè¿™äº›ä»»åŠ¡å°†ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚</p><p>è¿™ä¸ªæ–¹æ³•ä¸ä¼šç­‰å¾…æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚ä½¿ç”¨ awaitTermination æ–¹æ³•å®Œæˆçš„ã€‚</p><p>é™¤äº†å°½æœ€å¤§åŠªåŠ›å°è¯•åœæ­¢æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¹‹å¤–ï¼Œæ²¡æœ‰ä»»ä½•ä¿è¯ã€‚æ­¤å®ç°é€šè¿‡ interrupt å–æ¶ˆä»»åŠ¡ï¼Œ<strong>å› æ­¤ä»»ä½•æœªèƒ½å“åº”ä¸­æ–­çš„ä»»åŠ¡å¯èƒ½æ°¸è¿œä¸ä¼šç»ˆæ­¢</strong>ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> <span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> tasks<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
    mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ ¡éªŒå…³é—­çº¿ç¨‹çš„æƒé™</span>
        <span class="token function">checkShutdownAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// çº¿ç¨‹æ± çš„çŠ¶æ€æ”¹ä¸º STOP</span>
        <span class="token function">advanceRunState</span><span class="token punctuation">(</span><span class="token constant">STOP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸­æ–­æ‰€æœ‰å·²ç»å¯åŠ¨çš„çº¿ç¨‹</span>
        <span class="token function">interruptWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¯¼å‡ºæœªå¤„ç†çš„ä»»åŠ¡åˆ—è¡¨</span>
        tasks <span class="token operator">=</span> <span class="token function">drainQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ ¹æ®çº¿ç¨‹æ± çŠ¶æ€æ¥åˆ¤æ–­æ˜¯å¦åº”è¯¥ç»“æŸçº¿ç¨‹æ± </span>
    <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿”å›å½“å‰ä»»åŠ¡é˜Ÿåˆ—ä¸­ æœªå¤„ç†çš„ä»»åŠ¡ã€‚</span>
    <span class="token keyword">return</span> tasks<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>shutdownNow æ–¹æ³•å’Œ shutdown æ–¹æ³•çš„é€»è¾‘å¤§ä½“ç›¸åŒï¼Œåªæ˜¯ shutdownNow æ–¹æ³•æ˜¯å°†çº¿ç¨‹æ± çŠ¶æ€æ”¹ä¸º STOPï¼Œä¸­æ–­æ‰€æœ‰çš„ Worker çº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡é˜Ÿåˆ—ä¸­å‰©ä½™æœªæ‰§è¡Œçš„ä»»åŠ¡è¿”å›ç»™è°ƒç”¨æ–¹æ³•äº†ã€‚</p><h3 id="tryterminate-æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#tryterminate-æ–¹æ³•" aria-hidden="true">#</a> tryTerminate æ–¹æ³•</h3><p>åœ¨çœ‹ awaitTermination æ–¹æ³•ä¹‹å‰ï¼Œéœ€è¦å…ˆçœ‹çœ‹ tryTerminate æ–¹æ³•ã€‚</p><p>tryTerminate åœ¨çº¿ç¨‹æ± ä¸­æœ‰å¾ˆå¤šåœ°æ–¹åœ¨è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°è¯•å°†çº¿ç¨‹æ± çš„çŠ¶æ€æ”¹æˆ TERMINATEDã€‚</p><ul><li><strong>addWorkerFailed(Worker)</strong></li><li><strong>processWorkerExit(Worker, boolean)</strong></li><li>purge()</li><li>remove(Runnable)</li><li><strong>shutdown()</strong></li><li><strong>shutdownNow()</strong></li></ul><p>éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š</p><ol><li>å½“çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹çš„ä¸ªæ•°æ˜¯ 0 çš„æ—¶å€™ï¼Œè°ƒç”¨ interruptIdleWorkers æ–¹æ³•ä¸­æ–­ä¸€ä¸ªç©ºé—²çš„çº¿ç¨‹ï¼Œç›¸å½“äºä¼ æ’­ä¸€ä¸ªå…³é—­çš„ä¿¡å·ã€‚å› ä¸ºè¿™é‡Œä¸­æ–­æ˜¯ getTask æ–¹æ³•ä¸­é˜»å¡ç­‰å¾…ä»»åŠ¡çš„çº¿ç¨‹ï¼Œä¸­æ–­å getTask è¿”å› nullï¼Œè¿”å› null åï¼Œå°±ä¼šè°ƒç”¨ processWorkerExit ä¸­ç»§ç»­è°ƒç”¨ tryTerminate æ–¹æ³•ï¼›</li><li>ä¼šè°ƒç”¨é’©å­æ–¹æ³• terminated() æ–¹æ³•ï¼›</li><li>åœ¨çº¿ç¨‹æ± çš„çŠ¶æ€è¢«æ”¹ä¸º TERMINATED æ—¶ï¼Œå°±ä¼šè°ƒç”¨ Condition çš„ await æ–¹æ³•å”¤é†’å¯èƒ½åœ¨ æ–¹æ³•åœ¨awaitTermination() ä¸­é˜»å¡çš„çº¿ç¨‹ï¼›</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è‡ªæ—‹</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * 1 å½“å‰çº¿ç¨‹æ± æ˜¯RUNNINGçŠ¶æ€ æ­¤æ—¶æ— éœ€ç»“æŸçº¿ç¨‹æ± 
         * 2 å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€å¤§äºç­‰äºTIDYINGï¼Œè¯´æ˜å·²ç»æœ‰å…¶å®ƒçº¿ç¨‹åœ¨æ‰§è¡ŒTIDYING -&gt; TERMINATEDçŠ¶æ€äº†ï¼Œ
         *   ä¹Ÿå°±æ˜¯å·²ç»èµ°åˆ°äº†ä¸‹é¢çš„æ­¥éª¤ï¼Œçº¿ç¨‹æ± å³å°†ç»ˆç»“ï¼Œæ­¤çº¿ç¨‹ç›´æ¥è¿”å›
         * 3 å½“å‰çº¿ç¨‹æ± æ˜¯SHUTDOWNçŠ¶æ€ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºã€‚è¯´æ˜è¿˜æœ‰ä»»åŠ¡éœ€è¦å¤„ç† ä¸èƒ½æ”¹å˜çº¿ç¨‹æ± çŠ¶æ€
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token constant">TIDYING</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * è¿è¡Œåˆ°æ­¤å¤„å‰ææ˜¯
         * 1-çº¿ç¨‹æ± çš„çŠ¶æ€ä¸ºSTOP
         * 2-çº¿ç¨‹æ± çš„çŠ¶æ€ä¸ºSHUTDOWNï¼Œä½†æ˜¯é˜Ÿåˆ—ä¸ºç©º
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Eligible to terminate</span>
            <span class="token comment">// ä¸­æ–­ä¸€ä¸ªç©ºé—²çš„çº¿ç¨‹</span>
            <span class="token comment">// è¿™é‡Œä¸­æ–­æ˜¯ getTask æ–¹æ³•ä¸­é˜»å¡ç­‰å¾…ä»»åŠ¡çš„çº¿ç¨‹ï¼Œä¸­æ–­å getTask è¿”å› null</span>
            <span class="token comment">// è¿”å› null åï¼Œå°±ä¼šè°ƒç”¨ processWorkerExit ä¸­ç»§ç»­è°ƒç”¨ tryTerminate æ–¹æ³•</span>
            <span class="token comment">// ä¸­æ–­ä¸€ä¸ªç©ºé—²çš„çº¿ç¨‹ï¼Œç›¸å½“äºä¼ æ’­ä¸€ä¸ªå…³é—­çº¿ç¨‹æ± çš„ä¿¡å·</span>
            <span class="token function">interruptIdleWorkers</span><span class="token punctuation">(</span><span class="token constant">ONLY_ONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// èµ°åˆ°è¿™é‡Œè¯´æ˜å½“å‰å·¥ä½œçº¿ç¨‹æ•°å·²ç»ä¸º0äº†ï¼Œ</span>
        <span class="token comment">// ä¹Ÿå°±æ˜¯è¯´å½“å‰çº¿ç¨‹æ˜¯æœ€åä¸€ä¸ªæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œæ­¤æ—¶éœ€è¦å®Œæˆç»“æŸçº¿ç¨‹æ± çš„åŠ¨ä½œ</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
        mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// CAS å°è¯•åˆ›å»º c   æ˜¯ TIDYING çŠ¶æ€ä¸” workcount æ˜¯ 0</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token constant">TIDYING</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ç»ˆæ­¢ï¼Œé’©å­æ–¹æ³•ï¼Œå­ç±»å®ç°</span>
                    <span class="token function">terminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è®¾ç½® TERMINATED çŠ¶æ€ä¸” workcount æ˜¯ 0</span>
                    ctl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token constant">TERMINATED</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// å”¤é†’é˜»å¡åœ¨terminationæ¡ä»¶çš„æ‰€æœ‰çº¿ç¨‹ï¼Œè¿™ä¸ªå˜é‡çš„await()æ–¹æ³•åœ¨awaitTermination()ä¸­è°ƒç”¨</span>
                    termination<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// else retry on failed CAS</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="awaittermination-ç­‰å¾…ä»»åŠ¡å®Œæˆ" tabindex="-1"><a class="header-anchor" href="#awaittermination-ç­‰å¾…ä»»åŠ¡å®Œæˆ" aria-hidden="true">#</a> awaitTermination ç­‰å¾…ä»»åŠ¡å®Œæˆ</h3><p>è¯¥æ–¹æ³•è°ƒç”¨ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å¹¶ä¸” shutdown è¯·æ±‚è¢«è°ƒç”¨ï¼Œæˆ–è€…å‚æ•°ä¸­å®šä¹‰çš„ timeout æ—¶é—´åˆ°è¾¾æˆ–è€…å½“å‰çº¿ç¨‹è¢«æ‰“æ–­ï¼Œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ç­‰å¾…çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯ TERMINATEDï¼Œæ‰é€€å‡ºé˜»å¡
 * å…¶å®å°±æ˜¯ç­‰å¾…ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼Œå…·ä½“å¯åœ¨ tryTerminated æ–¹æ³•çœ‹åˆ°
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> nanos <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
    mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è‡ªæ—‹ç›´åˆ°çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯ TERMINATED</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TERMINATED</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nanos <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// é˜»å¡ç­‰å¾…</span>
            nanos <span class="token operator">=</span> termination<span class="token punctuation">.</span><span class="token function">awaitNanos</span><span class="token punctuation">(</span>nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å°ç»“" tabindex="-1"><a class="header-anchor" href="#å°ç»“" aria-hidden="true">#</a> å°ç»“</h2><p>çº¿ç¨‹æ± çš„æ ¸å¿ƒæ–¹æ³•æ˜¯ execute æ–¹æ³•ï¼Œæ§åˆ¶ç€å·¥ä½œçº¿ç¨‹çš„åˆ›å»ºå’Œä»»åŠ¡çš„æ‰§è¡Œã€‚</p><img src="/assets/26-çº¿ç¨‹æ± executeæ–¹æ³•æµç¨‹å›¾-c91af31c.png" alt="26-çº¿ç¨‹æ± executeæ–¹æ³•æµç¨‹å›¾1" style="zoom:67%;"><p>å…³äºçº¿ç¨‹æ± ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£çš„æ˜¯ï¼š</p><ul><li>çº¿ç¨‹æ± æœ‰é‚£äº›ä¼˜ç‚¹ï¼›</li><li>åˆ›å»ºçº¿ç¨‹æ± çš„å‚æ•°çš„å¦‚ä½•è®¾ç½®ï¼Œä¾‹å¦‚æ ¸å¿ƒçº¿ç¨‹æ± æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°ç­‰ï¼›</li><li>çº¿ç¨‹æ± çš„æ‰§è¡Œæµç¨‹ï¼›</li></ul><p>å…³äºçº¿ç¨‹æ± çš„ä¼˜ç‚¹å¯ä»¥çœ‹æ–‡ç« çš„å¼€å¤´ã€‚çº¿ç¨‹æ± çš„æ‰§è¡Œæµç¨‹å¯ä»¥çœ‹ä¸Šé¢çš„å›¾ã€‚</p><p>å…³äºçº¿ç¨‹æ± çš„å‚æ•°ï¼ŒJDK çš„æ³¨é‡Šé‡Œé¢ç»™æˆ‘ä»¬çš„å»ºè®®æ˜¯</p><ul><li>CPU å¯†é›†å‹ä»»åŠ¡ï¼šå°±æ˜¯ä»»åŠ¡éœ€è¦ CPU å‚ä¸å¤§é‡çš„è®¡ç®—ï¼Œå‚è€ƒå€¼å¯ä»¥è®¾ç½®ä¸º NCPU + 1ï¼Œè¿™æ ·å¯ä»¥é¿å…å¾ˆå¤šçº¿ç¨‹åœ¨äº‰æŠ¢èµ„æºï¼›</li><li>IO å¯†é›†å‹ä»»åŠ¡ï¼šå°±æ˜¯ä»»åŠ¡ä¸»è¦æ—¶é—´éƒ½æ¶ˆè€—åœ¨ I/O æ—¶ï¼Œå‚è€ƒå€¼å¯ä»¥è®¾ç½®ä¸º 2 * NCPUï¼›</li></ul></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: guosgbin@163.com">Dylan Kwok</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a href="/JDK_source/19-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-AbstractExecutorService.html" class="nav-link prev" aria-label="19-çº¿ç¨‹æ± ä½“ç³»-AbstractExecutorService"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->19-çº¿ç¨‹æ± ä½“ç³»-AbstractExecutorService</div></a><a href="/JDK_source/21-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%93%E7%B3%BB-ScheduledThreadPoolExecutor.html" class="nav-link next" aria-label="21-çº¿ç¨‹æ± ä½“ç³»-ScheduledThreadPoolExecutor"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">21-çº¿ç¨‹æ± ä½“ç³»-ScheduledThreadPoolExecutor<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-2523771a.js" defer></script>
  </body>
</html>
