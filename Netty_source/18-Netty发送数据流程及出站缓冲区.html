<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.62" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://blog.guosgbin.cn/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html"><meta property="og:title" content="18-Nettyå‘é€æ•°æ®æµç¨‹åŠå‡ºç«™ç¼“å†²åŒº"><meta property="og:description" content="ç‰ˆæœ¬ å†…å®¹ æ—¶é—´ ---- ---- ---------------------- V1 æ–°å»º 2022å¹´03æœˆ21æ—¥01:00:11 V2 é‡æ„ 2023å¹´06æœˆ03æ—¥13:51:13 å¼•å…¥ ä¸ºäº†æé«˜ç½‘ç»œçš„ååé‡ï¼Œåœ¨è°ƒç”¨ write æ–¹æ³•æ—¶ï¼Œæ•°æ®å¹¶æ²¡æœ‰ç›´æ¥å†™åˆ°åº•å±‚ Socket ä¸­ï¼Œè€Œæ˜¯è¢«å†™åˆ°äº† Netty çš„å‡ºç«™ç¼“å†²åŒº ChannelOutboun..."><meta property="og:type" content="article"><meta property="og:image" content="https://blog.guosgbin.cn/"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-06-04T09:46:30.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="18-Nettyå‘é€æ•°æ®æµç¨‹åŠå‡ºç«™ç¼“å†²åŒº"><meta property="article:author" content="è¶…å¨è“çŒ« Dylan Kwok"><meta property="article:tag" content="Netty"><meta property="article:published_time" content="2022-03-21T01:00:11.000Z"><meta property="article:modified_time" content="2023-06-04T09:46:30.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"18-Nettyå‘é€æ•°æ®æµç¨‹åŠå‡ºç«™ç¼“å†²åŒº","image":["https://blog.guosgbin.cn/"],"datePublished":"2022-03-21T01:00:11.000Z","dateModified":"2023-06-04T09:46:30.000Z","author":[{"@type":"Person","name":"è¶…å¨è“çŒ« Dylan Kwok","url":"","email":"guosgbin@163.com"}]}</script><link rel="icon" href="/å°ç†ŠçŒ«.svg"><title>18-Nettyå‘é€æ•°æ®æµç¨‹åŠå‡ºç«™ç¼“å†²åŒº</title><meta name="description" content="ç‰ˆæœ¬ å†…å®¹ æ—¶é—´ ---- ---- ---------------------- V1 æ–°å»º 2022å¹´03æœˆ21æ—¥01:00:11 V2 é‡æ„ 2023å¹´06æœˆ03æ—¥13:51:13 å¼•å…¥ ä¸ºäº†æé«˜ç½‘ç»œçš„ååé‡ï¼Œåœ¨è°ƒç”¨ write æ–¹æ³•æ—¶ï¼Œæ•°æ®å¹¶æ²¡æœ‰ç›´æ¥å†™åˆ°åº•å±‚ Socket ä¸­ï¼Œè€Œæ˜¯è¢«å†™åˆ°äº† Netty çš„å‡ºç«™ç¼“å†²åŒº ChannelOutboun...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-542658da.css" as="style"><link rel="stylesheet" href="/assets/style-542658da.css">
    <link rel="modulepreload" href="/assets/app-ecfdc732.js"><link rel="modulepreload" href="/assets/18-Nettyå‘é€æ•°æ®æµç¨‹åŠå‡ºç«™ç¼“å†²åŒº.html-223d04a7.js"><link rel="modulepreload" href="/assets/18-Nettyå‘é€æ•°æ®æµç¨‹åŠå‡ºç«™ç¼“å†²åŒº.html-0f2349b8.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/assets/index.html-d93d8c2f.js" as="script"><link rel="prefetch" href="/assets/01-åˆ›å»ºå’Œé”€æ¯å¯¹è±¡.html-98280ce1.js" as="script"><link rel="prefetch" href="/assets/index.html-c4f42206.js" as="script"><link rel="prefetch" href="/assets/SPIæœºåˆ¶.html-a1ca3921.js" as="script"><link rel="prefetch" href="/assets/01-CASå’ŒUnsafeçš„APIåˆ†æ.html-612c4d6a.js" as="script"><link rel="prefetch" href="/assets/02-åŸºæœ¬ç±»å‹åŸå­ç±»AtomicLong.html-4083b8fd.js" as="script"><link rel="prefetch" href="/assets/03-å¼•ç”¨ç±»å‹åŸå­ç±»AtomicReference.html-8442553d.js" as="script"><link rel="prefetch" href="/assets/04-åŸå­æ•°ç»„ç±»AtomicLongArray.html-74e4c741.js" as="script"><link rel="prefetch" href="/assets/05-åŸå­æ“ä½œç±»AtomicReferenceFieldUpdater.html-d0310b2a.js" as="script"><link rel="prefetch" href="/assets/06-é«˜æ€§èƒ½åŸå­ç±»LongAdder.html-d6e3da8b.js" as="script"><link rel="prefetch" href="/assets/07-LockSupportåˆ†æ.html-8117dd17.js" as="script"><link rel="prefetch" href="/assets/08-AQSç®€å•ä»‹ç».html-30b6ef5b.js" as="script"><link rel="prefetch" href="/assets/09-åŸºäºReentrantLockåˆ†æAQSçš„ç‹¬å æ¨¡å¼.html-2423c430.js" as="script"><link rel="prefetch" href="/assets/10-åŸºäºCountDownLatchåˆ†æAQSçš„å…±äº«æ¨¡å¼.html-91ef4833.js" as="script"><link rel="prefetch" href="/assets/11-AQSçš„Conditionæœºåˆ¶.html-836364af.js" as="script"><link rel="prefetch" href="/assets/12-ä¿¡å·é‡Semaphore.html-3509682c.js" as="script"><link rel="prefetch" href="/assets/13-å¾ªç¯æ æ …CyclicBarrier.html-812d137d.js" as="script"><link rel="prefetch" href="/assets/14-é˜¶æ®µPhaser.html-d684f4a1.js" as="script"><link rel="prefetch" href="/assets/15-äº¤æ¢Exchanger.html-b9bf24f3.js" as="script"><link rel="prefetch" href="/assets/16-è¯»å†™é”ReentrantReadWriteLock.html-de44a1d3.js" as="script"><link rel="prefetch" href="/assets/17-Futureæ¨¡å¼-FutureTask.html-641c6250.js" as="script"><link rel="prefetch" href="/assets/18-çº¿ç¨‹æ± ä½“ç³»æ¦‚è¿°.html-dbcc52e5.js" as="script"><link rel="prefetch" href="/assets/19-çº¿ç¨‹æ± ä½“ç³»-AbstractExecutorService.html-fbd70afb.js" as="script"><link rel="prefetch" href="/assets/20-çº¿ç¨‹æ± ä½“ç³»-ThreadPoolExecutor.html-a274637a.js" as="script"><link rel="prefetch" href="/assets/21-çº¿ç¨‹æ± ä½“ç³»-ScheduledThreadPoolExecutor.html-707ffd40.js" as="script"><link rel="prefetch" href="/assets/22-CopyOnWriteArrayListå†™æ—¶å¤åˆ¶.html-914977b9.js" as="script"><link rel="prefetch" href="/assets/23-CopyOnWriteArraySetå†™æ—¶å¤åˆ¶.html-6c9c3cf6.js" as="script"><link rel="prefetch" href="/assets/24-ConcurrentSkipListMapè·³è¡¨.html-6cff54bf.js" as="script"><link rel="prefetch" href="/assets/25-ConcurrentSkipListSetè·³è¡¨.html-36cf4f7d.js" as="script"><link rel="prefetch" href="/assets/26-ConcurrentHashMapæºç åˆ†æ.html-a3bba8a9.js" as="script"><link rel="prefetch" href="/assets/27-é˜»å¡é˜Ÿåˆ—ArrayBlockingQueue.html-cd091357.js" as="script"><link rel="prefetch" href="/assets/28-é˜»å¡é˜Ÿåˆ—LinkedBlockingQueue.html-d3579ee7.js" as="script"><link rel="prefetch" href="/assets/29-é˜»å¡é˜Ÿåˆ—LinkedBlockingDeque.html-32c13680.js" as="script"><link rel="prefetch" href="/assets/30-é˜»å¡é˜Ÿåˆ—PriorityBlockingQueue.html-b5455c77.js" as="script"><link rel="prefetch" href="/assets/31-é˜»å¡é˜Ÿåˆ—DelayQueue.html-7759c195.js" as="script"><link rel="prefetch" href="/assets/32-é˜»å¡é˜Ÿåˆ—SynchronousQueue.html-97ed879a.js" as="script"><link rel="prefetch" href="/assets/33-é˜»å¡é˜Ÿåˆ—LinkedTransferQueue.html-3281c1b4.js" as="script"><link rel="prefetch" href="/assets/index.html-f5239cf3.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis01ï¼šmyabtisçš„æ•´ä½“æ¶æ„.html-f25c0705.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis02ï¼šå…¥é—¨æ¡ˆä¾‹.html-30e68cd3.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis03ï¼šè§£æå…¨å±€é…ç½®æ–‡ä»¶.html-2db85266.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis04ï¼šè§£æMapperæ˜ å°„æ–‡ä»¶.html-60756a5b.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis05ï¼šè§£æStatementæ“ä½œèŠ‚ç‚¹.html-31e11b60.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis06ï¼šè§£æSQLè¯­å¥.html-a9181b56.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis07ï¼šJavaæ–¹æ³•å’ŒSQLè¯­å¥ç»‘å®š.html-9bfa3db6.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis08ï¼šè·å¾—SqlSession.html-e2a92940.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis09ï¼šExecutoræ‰§è¡Œå™¨.html-ad701715.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis10ï¼šç¼“å­˜æœºåˆ¶.html-f2daa10c.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis11ï¼šStatementHandler.html-95b30d9b.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis12ï¼šå‚æ•°è§£æå’Œèµ‹å€¼.html-5778c0ea.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis13ï¼šç»“æœé›†å¤„ç†.html-2ff72779.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis14ï¼šæ’ä»¶.html-76cc6bf8.js" as="script"><link rel="prefetch" href="/assets/01-æœåŠ¡ç«¯å¯åŠ¨æµç¨‹.html-d2fc1f19.js" as="script"><link rel="prefetch" href="/assets/02-æœåŠ¡ç«¯å¯åŠ¨æ·»åŠ ChannelInitializeråˆ°ç®¡é“.html-86cb5d6a.js" as="script"><link rel="prefetch" href="/assets/03-å®¢æˆ·ç«¯å¯åŠ¨æµç¨‹.html-becc83be.js" as="script"><link rel="prefetch" href="/assets/04-çº¿ç¨‹ä½“ç³»-NioEventLoopGroup.html-700e797e.js" as="script"><link rel="prefetch" href="/assets/05-çº¿ç¨‹ä½“ç³»-NioEventLoopç›¸å…³çˆ¶æ¥å£åˆ†æ.html-754320bc.js" as="script"><link rel="prefetch" href="/assets/06-çº¿ç¨‹ä½“ç³»-AbstractEventExecutor.html-5250cd42.js" as="script"><link rel="prefetch" href="/assets/07-çº¿ç¨‹ä½“ç³»-AbstractScheduledEventExecutor-ä¼˜å…ˆé˜Ÿåˆ—.html-e7bbaf32.js" as="script"><link rel="prefetch" href="/assets/08-çº¿ç¨‹ä½“ç³»-NioEventLoopæ¦‚è¿°.html-fce3fb2c.js" as="script"><link rel="prefetch" href="/assets/09-çº¿ç¨‹ä½“ç³»-NioEventLoopå¼€å¯SelectoråŠä¼˜åŒ–.html-6d8230cf.js" as="script"><link rel="prefetch" href="/assets/10-çº¿ç¨‹ä½“ç³»-NioEventLoopç»‘å®šçº¿ç¨‹.html-db947821.js" as="script"><link rel="prefetch" href="/assets/11-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„runæ–¹æ³•.html-def4cc31.js" as="script"><link rel="prefetch" href="/assets/12-çº¿ç¨‹ä½“ç³»-NioEventLoopè§„é¿JDKçš„NIOç©ºå¾ªç¯bug.html-16ecaf4e.js" as="script"><link rel="prefetch" href="/assets/13-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„ä¼˜é›…å…³é—­.html-912d668d.js" as="script"><link rel="prefetch" href="/assets/14-æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥(ACCEPT).html-63afdec1.js" as="script"><link rel="prefetch" href="/assets/15-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶æ¦‚è¿°.html-b35daeb8.js" as="script"><link rel="prefetch" href="/assets/16-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶è¯¦è§£åŠRecvByteBufAllocator.html-a9faccfa.js" as="script"><link rel="prefetch" href="/assets/17-Nettyç®¡é“æœºåˆ¶.html-ba70b238.js" as="script"><link rel="prefetch" href="/assets/index.html-b475d8b0.js" as="script"><link rel="prefetch" href="/assets/Redis_BenchmarkåŸºå‡†æµ‹è¯•.html-dbf21951.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤å’Œæ§½ç®¡ç†å‘½ä»¤.html-2b4a1244.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤åŸºæœ¬ç‰¹æ€§å’Œé›†ç¾¤æ­å»º.html-42be726b.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤ç®¡ç†å·¥å…·redis-cli.html-fc4f1503.js" as="script"><link rel="prefetch" href="/assets/Redis_Pipelineä¼˜åŒ–RTT.html-8a4aa041.js" as="script"><link rel="prefetch" href="/assets/Redis_Sentinelé«˜å¯ç”¨.html-6bcdb34a.js" as="script"><link rel="prefetch" href="/assets/Redis_keyè®¾è®¡è§„èŒƒ.html-ab90a7dc.js" as="script"><link rel="prefetch" href="/assets/Redisäº‹åŠ¡.html-e43061e1.js" as="script"><link rel="prefetch" href="/assets/Rediså†…å­˜æ·˜æ±°ç­–ç•¥.html-feabd314.js" as="script"><link rel="prefetch" href="/assets/Rediså‘å¸ƒè®¢é˜….html-68771977.js" as="script"><link rel="prefetch" href="/assets/Rediså¤åˆ¶.html-33b20d6f.js" as="script"><link rel="prefetch" href="/assets/Rediså¤§keyå’Œçƒ­keyé—®é¢˜.html-394d194e.js" as="script"><link rel="prefetch" href="/assets/Redisæ…¢æŸ¥è¯¢æ—¥å¿—.html-7fb06db0.js" as="script"><link rel="prefetch" href="/assets/RedisæŒä¹…åŒ–æœºåˆ¶.html-53af3f7a.js" as="script"><link rel="prefetch" href="/assets/Redisé”®ç©ºé—´é€šçŸ¥(keyspace notification).html-012bd277.js" as="script"><link rel="prefetch" href="/assets/redis-cli ä½¿ç”¨.html-f7ab22db.js" as="script"><link rel="prefetch" href="/assets/01-RocketMQæ¦‚è¿°.html-25463efe.js" as="script"><link rel="prefetch" href="/assets/02-NameServerå¯åŠ¨æµç¨‹.html-a514999f.js" as="script"><link rel="prefetch" href="/assets/03-Brokerå¯åŠ¨æµç¨‹.html-43c84806.js" as="script"><link rel="prefetch" href="/assets/04-RocketMQç½‘ç»œé€šä¿¡åŸç†.html-ac88de8d.js" as="script"><link rel="prefetch" href="/assets/05-RocketMQ æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¯åŠ¨.html-ef7f1888.js" as="script"><link rel="prefetch" href="/assets/06-RocketMQç½‘ç»œé€šä¿¡æºç .html-b8e0bf43.js" as="script"><link rel="prefetch" href="/assets/07-NameServerä½œç”¨å’Œè·¯ç”±å…ƒä¿¡æ¯.html-82a23869.js" as="script"><link rel="prefetch" href="/assets/08-NameServerè·¯ç”±ç®¡ç†æºç åˆ†æ.html-8da2bd72.js" as="script"><link rel="prefetch" href="/assets/09-ç”Ÿäº§è€…ç›¸å…³ç±»åˆ†æ.html-08f6e840.js" as="script"><link rel="prefetch" href="/assets/10-ç”Ÿäº§è€…å¯åŠ¨æµç¨‹.html-d761cf07.js" as="script"><link rel="prefetch" href="/assets/11-ç”Ÿäº§è€…å‘é€æ¶ˆæ¯.html-743328bc.js" as="script"><link rel="prefetch" href="/assets/12-Brokerå­˜å‚¨æœºåˆ¶æ¦‚è¿°.html-5e7ed491.js" as="script"><link rel="prefetch" href="/assets/13-MappedFileå’ŒMappedFileQueueåˆ†æ.html-5b9afaf2.js" as="script"><link rel="prefetch" href="/assets/14-CommitLogåŸç†åˆ†æ.html-93362aa2.js" as="script"><link rel="prefetch" href="/assets/15-brokerçš„åˆ·ç›˜æœºåˆ¶.html-21e2029f.js" as="script"><link rel="prefetch" href="/assets/16-ConsumeQueueå’ŒIndexåŸç†åˆ†æ.html-ff18bade.js" as="script"><link rel="prefetch" href="/assets/17-brokerè¿‡æœŸæ–‡ä»¶åˆ é™¤æœºåˆ¶.html-89f05919.js" as="script"><link rel="prefetch" href="/assets/18-æ¶ˆè´¹è€…å¯åŠ¨æµç¨‹(TODO).html-988c43b3.js" as="script"><link rel="prefetch" href="/assets/19-æ¶ˆæ¯æ‹‰å–å…¥å£å’Œæ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡.html-7e4e20d4.js" as="script"><link rel="prefetch" href="/assets/20-æ¶ˆè´¹è€…å‘é€æ¶ˆæ¯æ‹‰å–è¯·æ±‚æµç¨‹.html-19825069.js" as="script"><link rel="prefetch" href="/assets/21-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-1-ä¸»æµç¨‹.html-d9ca6fa4.js" as="script"><link rel="prefetch" href="/assets/22-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-2-é•¿è½®è¯¢.html-0aba4f38.js" as="script"><link rel="prefetch" href="/assets/23-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-3-è¯»å–æ¶ˆæ¯.html-729d741b.js" as="script"><link rel="prefetch" href="/assets/24-æ¶ˆè´¹è€…å¤„ç†ä»brokeræ‹‰å–çš„æ¶ˆæ¯.html-dcfb7d07.js" as="script"><link rel="prefetch" href="/assets/25-å¹¶å‘æ¶ˆè´¹åŸç†.html-5ef206ec.js" as="script"><link rel="prefetch" href="/assets/Test.html-8ac87e1e.js" as="script"><link rel="prefetch" href="/assets/JUCç›¸å…³é—®é¢˜.html-9dc4b717.js" as="script"><link rel="prefetch" href="/assets/JVMé—®é¢˜.html-17300c49.js" as="script"><link rel="prefetch" href="/assets/MySQLç›¸å…³é—®é¢˜.html-a6c2cd41.js" as="script"><link rel="prefetch" href="/assets/index.html-8f5e683a.js" as="script"><link rel="prefetch" href="/assets/Redisç›¸å…³é—®é¢˜.html-575f1ee1.js" as="script"><link rel="prefetch" href="/assets/HowToSayResume.html-11d8bbca.js" as="script"><link rel="prefetch" href="/assets/resume.html-3b3f8934.js" as="script"><link rel="prefetch" href="/assets/404.html-f3795607.js" as="script"><link rel="prefetch" href="/assets/index.html-1f3390c0.js" as="script"><link rel="prefetch" href="/assets/index.html-10b45510.js" as="script"><link rel="prefetch" href="/assets/index.html-dfd17ea5.js" as="script"><link rel="prefetch" href="/assets/index.html-2f392b9e.js" as="script"><link rel="prefetch" href="/assets/index.html-4060f68d.js" as="script"><link rel="prefetch" href="/assets/index.html-0efbdc5e.js" as="script"><link rel="prefetch" href="/assets/index.html-9784a76b.js" as="script"><link rel="prefetch" href="/assets/01-åˆ›å»ºå’Œé”€æ¯å¯¹è±¡.html-b84cc6a4.js" as="script"><link rel="prefetch" href="/assets/index.html-d1b39c8b.js" as="script"><link rel="prefetch" href="/assets/SPIæœºåˆ¶.html-4b9dc94b.js" as="script"><link rel="prefetch" href="/assets/01-CASå’ŒUnsafeçš„APIåˆ†æ.html-908b75e4.js" as="script"><link rel="prefetch" href="/assets/02-åŸºæœ¬ç±»å‹åŸå­ç±»AtomicLong.html-69cdfa47.js" as="script"><link rel="prefetch" href="/assets/03-å¼•ç”¨ç±»å‹åŸå­ç±»AtomicReference.html-06de544a.js" as="script"><link rel="prefetch" href="/assets/04-åŸå­æ•°ç»„ç±»AtomicLongArray.html-d919420a.js" as="script"><link rel="prefetch" href="/assets/05-åŸå­æ“ä½œç±»AtomicReferenceFieldUpdater.html-30468688.js" as="script"><link rel="prefetch" href="/assets/06-é«˜æ€§èƒ½åŸå­ç±»LongAdder.html-35899fc6.js" as="script"><link rel="prefetch" href="/assets/07-LockSupportåˆ†æ.html-341251b9.js" as="script"><link rel="prefetch" href="/assets/08-AQSç®€å•ä»‹ç».html-a91aea5d.js" as="script"><link rel="prefetch" href="/assets/09-åŸºäºReentrantLockåˆ†æAQSçš„ç‹¬å æ¨¡å¼.html-df7cc8d0.js" as="script"><link rel="prefetch" href="/assets/10-åŸºäºCountDownLatchåˆ†æAQSçš„å…±äº«æ¨¡å¼.html-aaa5b92f.js" as="script"><link rel="prefetch" href="/assets/11-AQSçš„Conditionæœºåˆ¶.html-d981cb75.js" as="script"><link rel="prefetch" href="/assets/12-ä¿¡å·é‡Semaphore.html-d5ee2b12.js" as="script"><link rel="prefetch" href="/assets/13-å¾ªç¯æ æ …CyclicBarrier.html-8c24a69e.js" as="script"><link rel="prefetch" href="/assets/14-é˜¶æ®µPhaser.html-6932e273.js" as="script"><link rel="prefetch" href="/assets/15-äº¤æ¢Exchanger.html-8f9972a5.js" as="script"><link rel="prefetch" href="/assets/16-è¯»å†™é”ReentrantReadWriteLock.html-c73d70ac.js" as="script"><link rel="prefetch" href="/assets/17-Futureæ¨¡å¼-FutureTask.html-857ed2cf.js" as="script"><link rel="prefetch" href="/assets/18-çº¿ç¨‹æ± ä½“ç³»æ¦‚è¿°.html-870e03ae.js" as="script"><link rel="prefetch" href="/assets/19-çº¿ç¨‹æ± ä½“ç³»-AbstractExecutorService.html-5bc7bff3.js" as="script"><link rel="prefetch" href="/assets/20-çº¿ç¨‹æ± ä½“ç³»-ThreadPoolExecutor.html-baed85aa.js" as="script"><link rel="prefetch" href="/assets/21-çº¿ç¨‹æ± ä½“ç³»-ScheduledThreadPoolExecutor.html-ceaefbe9.js" as="script"><link rel="prefetch" href="/assets/22-CopyOnWriteArrayListå†™æ—¶å¤åˆ¶.html-b0a181f3.js" as="script"><link rel="prefetch" href="/assets/23-CopyOnWriteArraySetå†™æ—¶å¤åˆ¶.html-ee7ac583.js" as="script"><link rel="prefetch" href="/assets/24-ConcurrentSkipListMapè·³è¡¨.html-055cfd2a.js" as="script"><link rel="prefetch" href="/assets/25-ConcurrentSkipListSetè·³è¡¨.html-5e9a36a7.js" as="script"><link rel="prefetch" href="/assets/26-ConcurrentHashMapæºç åˆ†æ.html-cd802369.js" as="script"><link rel="prefetch" href="/assets/27-é˜»å¡é˜Ÿåˆ—ArrayBlockingQueue.html-258ed076.js" as="script"><link rel="prefetch" href="/assets/28-é˜»å¡é˜Ÿåˆ—LinkedBlockingQueue.html-c201fb0b.js" as="script"><link rel="prefetch" href="/assets/29-é˜»å¡é˜Ÿåˆ—LinkedBlockingDeque.html-ea81fa87.js" as="script"><link rel="prefetch" href="/assets/30-é˜»å¡é˜Ÿåˆ—PriorityBlockingQueue.html-0e8b2424.js" as="script"><link rel="prefetch" href="/assets/31-é˜»å¡é˜Ÿåˆ—DelayQueue.html-16ddd445.js" as="script"><link rel="prefetch" href="/assets/32-é˜»å¡é˜Ÿåˆ—SynchronousQueue.html-633a1293.js" as="script"><link rel="prefetch" href="/assets/33-é˜»å¡é˜Ÿåˆ—LinkedTransferQueue.html-a56a0969.js" as="script"><link rel="prefetch" href="/assets/index.html-1c7602c0.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis01ï¼šmyabtisçš„æ•´ä½“æ¶æ„.html-51f539b0.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis02ï¼šå…¥é—¨æ¡ˆä¾‹.html-947b1f8f.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis03ï¼šè§£æå…¨å±€é…ç½®æ–‡ä»¶.html-f845751b.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis04ï¼šè§£æMapperæ˜ å°„æ–‡ä»¶.html-9afa6faa.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis05ï¼šè§£æStatementæ“ä½œèŠ‚ç‚¹.html-a9b4c7a5.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis06ï¼šè§£æSQLè¯­å¥.html-33b35ec7.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis07ï¼šJavaæ–¹æ³•å’ŒSQLè¯­å¥ç»‘å®š.html-c6d20029.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis08ï¼šè·å¾—SqlSession.html-ccbc6a00.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis09ï¼šExecutoræ‰§è¡Œå™¨.html-4b5a76d0.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis10ï¼šç¼“å­˜æœºåˆ¶.html-8e767408.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis11ï¼šStatementHandler.html-b743a66f.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis12ï¼šå‚æ•°è§£æå’Œèµ‹å€¼.html-a08cdeb9.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis13ï¼šç»“æœé›†å¤„ç†.html-2cf6010a.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis14ï¼šæ’ä»¶.html-ef59dc9d.js" as="script"><link rel="prefetch" href="/assets/01-æœåŠ¡ç«¯å¯åŠ¨æµç¨‹.html-6ee7b9a2.js" as="script"><link rel="prefetch" href="/assets/02-æœåŠ¡ç«¯å¯åŠ¨æ·»åŠ ChannelInitializeråˆ°ç®¡é“.html-0a549e89.js" as="script"><link rel="prefetch" href="/assets/03-å®¢æˆ·ç«¯å¯åŠ¨æµç¨‹.html-03ea2d09.js" as="script"><link rel="prefetch" href="/assets/04-çº¿ç¨‹ä½“ç³»-NioEventLoopGroup.html-5880d5dd.js" as="script"><link rel="prefetch" href="/assets/05-çº¿ç¨‹ä½“ç³»-NioEventLoopç›¸å…³çˆ¶æ¥å£åˆ†æ.html-985d3848.js" as="script"><link rel="prefetch" href="/assets/06-çº¿ç¨‹ä½“ç³»-AbstractEventExecutor.html-7c4c8730.js" as="script"><link rel="prefetch" href="/assets/07-çº¿ç¨‹ä½“ç³»-AbstractScheduledEventExecutor-ä¼˜å…ˆé˜Ÿåˆ—.html-46b9f2e7.js" as="script"><link rel="prefetch" href="/assets/08-çº¿ç¨‹ä½“ç³»-NioEventLoopæ¦‚è¿°.html-6afc9474.js" as="script"><link rel="prefetch" href="/assets/09-çº¿ç¨‹ä½“ç³»-NioEventLoopå¼€å¯SelectoråŠä¼˜åŒ–.html-10923ea1.js" as="script"><link rel="prefetch" href="/assets/10-çº¿ç¨‹ä½“ç³»-NioEventLoopç»‘å®šçº¿ç¨‹.html-de1677bf.js" as="script"><link rel="prefetch" href="/assets/11-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„runæ–¹æ³•.html-fb1d6035.js" as="script"><link rel="prefetch" href="/assets/12-çº¿ç¨‹ä½“ç³»-NioEventLoopè§„é¿JDKçš„NIOç©ºå¾ªç¯bug.html-01f114fd.js" as="script"><link rel="prefetch" href="/assets/13-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„ä¼˜é›…å…³é—­.html-ae11fb2e.js" as="script"><link rel="prefetch" href="/assets/14-æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥(ACCEPT).html-c6ca116d.js" as="script"><link rel="prefetch" href="/assets/15-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶æ¦‚è¿°.html-4a9fc02c.js" as="script"><link rel="prefetch" href="/assets/16-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶è¯¦è§£åŠRecvByteBufAllocator.html-d901fd26.js" as="script"><link rel="prefetch" href="/assets/17-Nettyç®¡é“æœºåˆ¶.html-6809a475.js" as="script"><link rel="prefetch" href="/assets/index.html-75a82bf4.js" as="script"><link rel="prefetch" href="/assets/Redis_BenchmarkåŸºå‡†æµ‹è¯•.html-6bf7a606.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤å’Œæ§½ç®¡ç†å‘½ä»¤.html-8f38e285.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤åŸºæœ¬ç‰¹æ€§å’Œé›†ç¾¤æ­å»º.html-a1fa51e7.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤ç®¡ç†å·¥å…·redis-cli.html-9aadc41f.js" as="script"><link rel="prefetch" href="/assets/Redis_Pipelineä¼˜åŒ–RTT.html-a3b81191.js" as="script"><link rel="prefetch" href="/assets/Redis_Sentinelé«˜å¯ç”¨.html-11b436fd.js" as="script"><link rel="prefetch" href="/assets/Redis_keyè®¾è®¡è§„èŒƒ.html-ab5d4cf1.js" as="script"><link rel="prefetch" href="/assets/Redisäº‹åŠ¡.html-f1de2ae5.js" as="script"><link rel="prefetch" href="/assets/Rediså†…å­˜æ·˜æ±°ç­–ç•¥.html-1009bb67.js" as="script"><link rel="prefetch" href="/assets/Rediså‘å¸ƒè®¢é˜….html-48cd5f93.js" as="script"><link rel="prefetch" href="/assets/Rediså¤åˆ¶.html-4e1dc834.js" as="script"><link rel="prefetch" href="/assets/Rediså¤§keyå’Œçƒ­keyé—®é¢˜.html-f11ae339.js" as="script"><link rel="prefetch" href="/assets/Redisæ…¢æŸ¥è¯¢æ—¥å¿—.html-4cb400c3.js" as="script"><link rel="prefetch" href="/assets/RedisæŒä¹…åŒ–æœºåˆ¶.html-d08f249e.js" as="script"><link rel="prefetch" href="/assets/Redisé”®ç©ºé—´é€šçŸ¥(keyspace notification).html-1f78b78f.js" as="script"><link rel="prefetch" href="/assets/redis-cli ä½¿ç”¨.html-b02457bc.js" as="script"><link rel="prefetch" href="/assets/01-RocketMQæ¦‚è¿°.html-8e4ffa50.js" as="script"><link rel="prefetch" href="/assets/02-NameServerå¯åŠ¨æµç¨‹.html-dad1c474.js" as="script"><link rel="prefetch" href="/assets/03-Brokerå¯åŠ¨æµç¨‹.html-f4b7c80d.js" as="script"><link rel="prefetch" href="/assets/04-RocketMQç½‘ç»œé€šä¿¡åŸç†.html-bcf737f2.js" as="script"><link rel="prefetch" href="/assets/05-RocketMQ æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¯åŠ¨.html-862fa716.js" as="script"><link rel="prefetch" href="/assets/06-RocketMQç½‘ç»œé€šä¿¡æºç .html-09c101c8.js" as="script"><link rel="prefetch" href="/assets/07-NameServerä½œç”¨å’Œè·¯ç”±å…ƒä¿¡æ¯.html-6ab8c72a.js" as="script"><link rel="prefetch" href="/assets/08-NameServerè·¯ç”±ç®¡ç†æºç åˆ†æ.html-961626f6.js" as="script"><link rel="prefetch" href="/assets/09-ç”Ÿäº§è€…ç›¸å…³ç±»åˆ†æ.html-c7093050.js" as="script"><link rel="prefetch" href="/assets/10-ç”Ÿäº§è€…å¯åŠ¨æµç¨‹.html-15038ac7.js" as="script"><link rel="prefetch" href="/assets/11-ç”Ÿäº§è€…å‘é€æ¶ˆæ¯.html-98164fb2.js" as="script"><link rel="prefetch" href="/assets/12-Brokerå­˜å‚¨æœºåˆ¶æ¦‚è¿°.html-75e0b6f8.js" as="script"><link rel="prefetch" href="/assets/13-MappedFileå’ŒMappedFileQueueåˆ†æ.html-1c0831f4.js" as="script"><link rel="prefetch" href="/assets/14-CommitLogåŸç†åˆ†æ.html-e3946cad.js" as="script"><link rel="prefetch" href="/assets/15-brokerçš„åˆ·ç›˜æœºåˆ¶.html-5fbcc24e.js" as="script"><link rel="prefetch" href="/assets/16-ConsumeQueueå’ŒIndexåŸç†åˆ†æ.html-fd7bbb03.js" as="script"><link rel="prefetch" href="/assets/17-brokerè¿‡æœŸæ–‡ä»¶åˆ é™¤æœºåˆ¶.html-abaad10c.js" as="script"><link rel="prefetch" href="/assets/18-æ¶ˆè´¹è€…å¯åŠ¨æµç¨‹(TODO).html-b4721ecb.js" as="script"><link rel="prefetch" href="/assets/19-æ¶ˆæ¯æ‹‰å–å…¥å£å’Œæ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡.html-7d5e34b1.js" as="script"><link rel="prefetch" href="/assets/20-æ¶ˆè´¹è€…å‘é€æ¶ˆæ¯æ‹‰å–è¯·æ±‚æµç¨‹.html-928e828c.js" as="script"><link rel="prefetch" href="/assets/21-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-1-ä¸»æµç¨‹.html-9c500247.js" as="script"><link rel="prefetch" href="/assets/22-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-2-é•¿è½®è¯¢.html-a69b102b.js" as="script"><link rel="prefetch" href="/assets/23-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-3-è¯»å–æ¶ˆæ¯.html-330c1784.js" as="script"><link rel="prefetch" href="/assets/24-æ¶ˆè´¹è€…å¤„ç†ä»brokeræ‹‰å–çš„æ¶ˆæ¯.html-ed5fb28a.js" as="script"><link rel="prefetch" href="/assets/25-å¹¶å‘æ¶ˆè´¹åŸç†.html-7a296875.js" as="script"><link rel="prefetch" href="/assets/Test.html-806da57f.js" as="script"><link rel="prefetch" href="/assets/JUCç›¸å…³é—®é¢˜.html-7e14b457.js" as="script"><link rel="prefetch" href="/assets/JVMé—®é¢˜.html-171f0cc4.js" as="script"><link rel="prefetch" href="/assets/MySQLç›¸å…³é—®é¢˜.html-ddf23070.js" as="script"><link rel="prefetch" href="/assets/index.html-e0070464.js" as="script"><link rel="prefetch" href="/assets/Redisç›¸å…³é—®é¢˜.html-6f6e0d2f.js" as="script"><link rel="prefetch" href="/assets/HowToSayResume.html-998ba8a9.js" as="script"><link rel="prefetch" href="/assets/resume.html-d0b30503.js" as="script"><link rel="prefetch" href="/assets/404.html-0e7f810a.js" as="script"><link rel="prefetch" href="/assets/index.html-999ddfc0.js" as="script"><link rel="prefetch" href="/assets/index.html-423a081f.js" as="script"><link rel="prefetch" href="/assets/index.html-b7837fd9.js" as="script"><link rel="prefetch" href="/assets/index.html-4f4f1e47.js" as="script"><link rel="prefetch" href="/assets/index.html-35d818e0.js" as="script"><link rel="prefetch" href="/assets/index.html-2f6dab8b.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-2450701e.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a href="/" class="vp-brand"><img class="vp-nav-logo" src="/å°ç†ŠçŒ«.png" alt><!----><!----></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a href="/Netty_source/" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="Nettyæºç åˆ†æ"><!---->Nettyæºç åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/01-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="01-æœåŠ¡ç«¯å¯åŠ¨æµç¨‹"><!---->01-æœåŠ¡ç«¯å¯åŠ¨æµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/02-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B7%BB%E5%8A%A0ChannelInitializer%E5%88%B0%E7%AE%A1%E9%81%93.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="02-æœåŠ¡ç«¯å¯åŠ¨æ·»åŠ ChannelInitializeråˆ°ç®¡é“"><!---->02-æœåŠ¡ç«¯å¯åŠ¨æ·»åŠ ChannelInitializeråˆ°ç®¡é“<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/03-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="03-å®¢æˆ·ç«¯å¯åŠ¨æµç¨‹"><!---->03-å®¢æˆ·ç«¯å¯åŠ¨æµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/04-%E7%BA%BF%E7%A8%8B%E4%BD%93%E7%B3%BB-NioEventLoopGroup.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="04-çº¿ç¨‹ä½“ç³»-NioEventLoopGroup"><!---->04-çº¿ç¨‹ä½“ç³»-NioEventLoopGroup<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/05-%E7%BA%BF%E7%A8%8B%E4%BD%93%E7%B3%BB-NioEventLoop%E7%9B%B8%E5%85%B3%E7%88%B6%E6%8E%A5%E5%8F%A3%E5%88%86%E6%9E%90.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="05-çº¿ç¨‹ä½“ç³»-NioEventLoopç›¸å…³æ¥å£åˆ†æ"><!---->05-çº¿ç¨‹ä½“ç³»-NioEventLoopç›¸å…³æ¥å£åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/06-%E7%BA%BF%E7%A8%8B%E4%BD%93%E7%B3%BB-AbstractEventExecutor.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="06-çº¿ç¨‹ä½“ç³»-AbstractEventExecutor"><!---->06-çº¿ç¨‹ä½“ç³»-AbstractEventExecutor<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/07-%E7%BA%BF%E7%A8%8B%E4%BD%93%E7%B3%BB-AbstractScheduledEventExecutor-%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="07-çº¿ç¨‹ä½“ç³»-AbstractScheduledEventExecutor-ä¼˜å…ˆé˜Ÿåˆ—"><!---->07-çº¿ç¨‹ä½“ç³»-AbstractScheduledEventExecutor-ä¼˜å…ˆé˜Ÿåˆ—<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/08-%E7%BA%BF%E7%A8%8B%E4%BD%93%E7%B3%BB-NioEventLoop%E6%A6%82%E8%BF%B0.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="08-çº¿ç¨‹ä½“ç³»-NioEventLoopæ¦‚è¿°"><!---->08-çº¿ç¨‹ä½“ç³»-NioEventLoopæ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/09-%E7%BA%BF%E7%A8%8B%E4%BD%93%E7%B3%BB-NioEventLoop%E5%BC%80%E5%90%AFSelector%E5%8F%8A%E4%BC%98%E5%8C%96.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="09-çº¿ç¨‹ä½“ç³»-NioEventLoopå¼€å¯SelectoråŠä¼˜åŒ–"><!---->09-çº¿ç¨‹ä½“ç³»-NioEventLoopå¼€å¯SelectoråŠä¼˜åŒ–<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/10-%E7%BA%BF%E7%A8%8B%E4%BD%93%E7%B3%BB-NioEventLoop%E7%BB%91%E5%AE%9A%E7%BA%BF%E7%A8%8B.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="10-çº¿ç¨‹ä½“ç³»-NioEventLoopç»‘å®šçº¿ç¨‹"><!---->10-çº¿ç¨‹ä½“ç³»-NioEventLoopç»‘å®šçº¿ç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/11-%E7%BA%BF%E7%A8%8B%E4%BD%93%E7%B3%BB-NioEventLoop%E7%9A%84run%E6%96%B9%E6%B3%95.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="11-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„runæ–¹æ³•"><!---->11-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„runæ–¹æ³•<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/12-%E7%BA%BF%E7%A8%8B%E4%BD%93%E7%B3%BB-NioEventLoop%E8%A7%84%E9%81%BFJDK%E7%9A%84NIO%E7%A9%BA%E5%BE%AA%E7%8E%AFbug.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="12-çº¿ç¨‹ä½“ç³»-NioEventLoopè§„é¿JDKçš„NIOç©ºå¾ªç¯bug"><!---->12-çº¿ç¨‹ä½“ç³»-NioEventLoopè§„é¿JDKçš„NIOç©ºå¾ªç¯bug<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/13-%E7%BA%BF%E7%A8%8B%E4%BD%93%E7%B3%BB-NioEventLoop%E7%9A%84%E4%BC%98%E9%9B%85%E5%85%B3%E9%97%AD.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="13-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„ä¼˜é›…å…³é—­"><!---->13-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„ä¼˜é›…å…³é—­<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/14-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%A4%84%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E8%BF%9E%E6%8E%A5(ACCEPT).html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="14-æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥(ACCEPT)"><!---->14-æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥(ACCEPT)<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/15-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A4%84%E7%90%86READ%E4%BA%8B%E4%BB%B6%E6%A6%82%E8%BF%B0.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="15-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶æ¦‚è¿°"><!---->15-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶æ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/16-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A4%84%E7%90%86READ%E4%BA%8B%E4%BB%B6%E8%AF%A6%E8%A7%A3%E5%8F%8ARecvByteBufAllocator.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="16-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶è¯¦è§£åŠRecvByteBufAllocator"><!---->16-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶è¯¦è§£åŠRecvByteBufAllocator<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/Netty_source/17-Netty%E7%AE%A1%E9%81%93%E6%9C%BA%E5%88%B6.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="17-Nettyç®¡é“æœºåˆ¶"><!---->17-Nettyç®¡é“æœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html" class="router-link-active router-link-exact-active nav-link active vp-sidebar-link vp-sidebar-page active" aria-label="18-Nettyå‘é€æ•°æ®æµç¨‹åŠå‡ºç«™ç¼“å†²åŒº"><!---->18-Nettyå‘é€æ•°æ®æµç¨‹åŠå‡ºç«™ç¼“å†²åŒº<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å¼•å…¥" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="å¼•å…¥"><!---->å¼•å…¥<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#netty-çš„-write-äº‹ä»¶çš„å…¥å£" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="Netty çš„ write äº‹ä»¶çš„å…¥å£"><!---->Netty çš„ write äº‹ä»¶çš„å…¥å£<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#netty-çš„-write-äº‹ä»¶çš„ä¼ æ’­" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="Netty çš„ write äº‹ä»¶çš„ä¼ æ’­"><!---->Netty çš„ write äº‹ä»¶çš„ä¼ æ’­<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#æŸ¥æ‰¾ä¸Šä¸€ä¸ª-channelhandler" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="æŸ¥æ‰¾ä¸Šä¸€ä¸ª ChannelHandler"><!---->æŸ¥æ‰¾ä¸Šä¸€ä¸ª ChannelHandler<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å½“å‰çº¿ç¨‹æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="å½“å‰çº¿ç¨‹æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹"><!---->å½“å‰çº¿ç¨‹æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹"><!---->å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#headcontext-çš„-write-æ–¹æ³•" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="HeadContext çš„ write æ–¹æ³•"><!---->HeadContext çš„ write æ–¹æ³•<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#netty-çš„-flush-äº‹ä»¶çš„ä¼ æ’­" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="Netty çš„ flush äº‹ä»¶çš„ä¼ æ’­"><!---->Netty çš„ flush äº‹ä»¶çš„ä¼ æ’­<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡å’ŒåŸç†" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡å’ŒåŸç†"><!---->å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡å’ŒåŸç†<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡åŸç†" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡åŸç†"><!---->å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡åŸç†<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#channeloutboundbuffer-çš„å±æ€§" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="ChannelOutboundBuffer çš„å±æ€§"><!---->ChannelOutboundBuffer çš„å±æ€§<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#é“¾è¡¨èŠ‚ç‚¹-entry" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="é“¾è¡¨èŠ‚ç‚¹ Entry"><!---->é“¾è¡¨èŠ‚ç‚¹ Entry<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#æ·»åŠ æ•°æ®åˆ°å‡ºç«™ç¼“å†²åŒº" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="æ·»åŠ æ•°æ®åˆ°å‡ºç«™ç¼“å†²åŒº"><!---->æ·»åŠ æ•°æ®åˆ°å‡ºç«™ç¼“å†²åŒº<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å‡ºç«™ç¼“å†²åŒºåˆ·æ–°æ•°æ®çš„å‡†å¤‡å·¥ä½œ" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="å‡ºç«™ç¼“å†²åŒºåˆ·æ–°æ•°æ®çš„å‡†å¤‡å·¥ä½œ"><!---->å‡ºç«™ç¼“å†²åŒºåˆ·æ–°æ•°æ®çš„å‡†å¤‡å·¥ä½œ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å‡ºç«™ç¼“å†²åŒºçš„é«˜ä½æ°´ä½" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="å‡ºç«™ç¼“å†²åŒºçš„é«˜ä½æ°´ä½"><!---->å‡ºç«™ç¼“å†²åŒºçš„é«˜ä½æ°´ä½<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#çœŸæ­£å‘é€æ•°æ®æµç¨‹" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="çœŸæ­£å‘é€æ•°æ®æµç¨‹"><!---->çœŸæ­£å‘é€æ•°æ®æµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#è·å–-netty-å…è®¸å†™å¾ªç¯çš„æ¬¡æ•°" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="è·å– Netty å…è®¸å†™å¾ªç¯çš„æ¬¡æ•°"><!---->è·å– Netty å…è®¸å†™å¾ªç¯çš„æ¬¡æ•°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#do-while-å‡ºç«™ç¼“å†²åŒºæ•°æ®å†™å®Œåé€€å‡º" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="do...whileï¼šå‡ºç«™ç¼“å†²åŒºæ•°æ®å†™å®Œåé€€å‡º"><!---->do...whileï¼šå‡ºç«™ç¼“å†²åŒºæ•°æ®å†™å®Œåé€€å‡º<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#do-while-è·å–æ­¤æ¬¡å¾ªç¯èƒ½å¤Ÿå†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="do...whileï¼šè·å–æ­¤æ¬¡å¾ªç¯èƒ½å¤Ÿå†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°"><!---->do...whileï¼šè·å–æ­¤æ¬¡å¾ªç¯èƒ½å¤Ÿå†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#do-while-å¾…å‘é€æ•°æ®è½¬æ¢ä¸º-bytebuffer" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="do...whileï¼šå¾…å‘é€æ•°æ®è½¬æ¢ä¸º ByteBuffer"><!---->do...whileï¼šå¾…å‘é€æ•°æ®è½¬æ¢ä¸º ByteBuffer<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#do-while-å‘é€æ•°æ®åˆ°-socket" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="do...whileï¼šå‘é€æ•°æ®åˆ° Socket"><!---->do...whileï¼šå‘é€æ•°æ®åˆ° Socket<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#do-while-é€€å‡ºå†™å¾ªç¯çš„åœ°æ–¹" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="do...whileï¼šé€€å‡ºå†™å¾ªç¯çš„åœ°æ–¹"><!---->do...whileï¼šé€€å‡ºå†™å¾ªç¯çš„åœ°æ–¹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å¤„ç†-socket-å¯å†™ä½†å†™æ»¡16æ¬¡è¿˜æ²¡å®Œå…¨å†™å®Œ" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="å¤„ç† Socket å¯å†™ä½†å†™æ»¡16æ¬¡è¿˜æ²¡å®Œå…¨å†™å®Œ"><!---->å¤„ç† Socket å¯å†™ä½†å†™æ»¡16æ¬¡è¿˜æ²¡å®Œå…¨å†™å®Œ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#nioeventloop-å¤„ç†-op-write-äº‹ä»¶" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="NioEventLoop å¤„ç† OP_WRITE äº‹ä»¶"><!---->NioEventLoop å¤„ç† OP_WRITE äº‹ä»¶<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->18-Nettyå‘é€æ•°æ®æµç¨‹åŠå‡ºç«™ç¼“å†²åŒº</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">è¶…å¨è“çŒ« Dylan Kwok</span></span><span property="author" content="è¶…å¨è“çŒ« Dylan Kwok"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-03-21T01:00:11.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 40 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT40M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å¼•å…¥" class="router-link-active router-link-exact-active toc-link level2">å¼•å…¥</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#netty-çš„-write-äº‹ä»¶çš„å…¥å£" class="router-link-active router-link-exact-active toc-link level2">Netty çš„ write äº‹ä»¶çš„å…¥å£</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#netty-çš„-write-äº‹ä»¶çš„ä¼ æ’­" class="router-link-active router-link-exact-active toc-link level2">Netty çš„ write äº‹ä»¶çš„ä¼ æ’­</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#æŸ¥æ‰¾ä¸Šä¸€ä¸ª-channelhandler" class="router-link-active router-link-exact-active toc-link level3">æŸ¥æ‰¾ä¸Šä¸€ä¸ª ChannelHandler</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å½“å‰çº¿ç¨‹æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹" class="router-link-active router-link-exact-active toc-link level3">å½“å‰çº¿ç¨‹æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹" class="router-link-active router-link-exact-active toc-link level3">å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#headcontext-çš„-write-æ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">HeadContext çš„ write æ–¹æ³•</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#netty-çš„-flush-äº‹ä»¶çš„ä¼ æ’­" class="router-link-active router-link-exact-active toc-link level2">Netty çš„ flush äº‹ä»¶çš„ä¼ æ’­</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡å’ŒåŸç†" class="router-link-active router-link-exact-active toc-link level2">å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡å’ŒåŸç†</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡åŸç†" class="router-link-active router-link-exact-active toc-link level3">å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡åŸç†</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#channeloutboundbuffer-çš„å±æ€§" class="router-link-active router-link-exact-active toc-link level3">ChannelOutboundBuffer çš„å±æ€§</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#é“¾è¡¨èŠ‚ç‚¹-entry" class="router-link-active router-link-exact-active toc-link level3">é“¾è¡¨èŠ‚ç‚¹ Entry</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#æ·»åŠ æ•°æ®åˆ°å‡ºç«™ç¼“å†²åŒº" class="router-link-active router-link-exact-active toc-link level3">æ·»åŠ æ•°æ®åˆ°å‡ºç«™ç¼“å†²åŒº</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å‡ºç«™ç¼“å†²åŒºåˆ·æ–°æ•°æ®çš„å‡†å¤‡å·¥ä½œ" class="router-link-active router-link-exact-active toc-link level3">å‡ºç«™ç¼“å†²åŒºåˆ·æ–°æ•°æ®çš„å‡†å¤‡å·¥ä½œ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å‡ºç«™ç¼“å†²åŒºçš„é«˜ä½æ°´ä½" class="router-link-active router-link-exact-active toc-link level3">å‡ºç«™ç¼“å†²åŒºçš„é«˜ä½æ°´ä½</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#çœŸæ­£å‘é€æ•°æ®æµç¨‹" class="router-link-active router-link-exact-active toc-link level2">çœŸæ­£å‘é€æ•°æ®æµç¨‹</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#è·å–-netty-å…è®¸å†™å¾ªç¯çš„æ¬¡æ•°" class="router-link-active router-link-exact-active toc-link level3">è·å– Netty å…è®¸å†™å¾ªç¯çš„æ¬¡æ•°</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#do-while-å‡ºç«™ç¼“å†²åŒºæ•°æ®å†™å®Œåé€€å‡º" class="router-link-active router-link-exact-active toc-link level3">do...whileï¼šå‡ºç«™ç¼“å†²åŒºæ•°æ®å†™å®Œåé€€å‡º</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#do-while-è·å–æ­¤æ¬¡å¾ªç¯èƒ½å¤Ÿå†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°" class="router-link-active router-link-exact-active toc-link level3">do...whileï¼šè·å–æ­¤æ¬¡å¾ªç¯èƒ½å¤Ÿå†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#do-while-å¾…å‘é€æ•°æ®è½¬æ¢ä¸º-bytebuffer" class="router-link-active router-link-exact-active toc-link level3">do...whileï¼šå¾…å‘é€æ•°æ®è½¬æ¢ä¸º ByteBuffer</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#do-while-å‘é€æ•°æ®åˆ°-socket" class="router-link-active router-link-exact-active toc-link level3">do...whileï¼šå‘é€æ•°æ®åˆ° Socket</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#do-while-é€€å‡ºå†™å¾ªç¯çš„åœ°æ–¹" class="router-link-active router-link-exact-active toc-link level3">do...whileï¼šé€€å‡ºå†™å¾ªç¯çš„åœ°æ–¹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#å¤„ç†-socket-å¯å†™ä½†å†™æ»¡16æ¬¡è¿˜æ²¡å®Œå…¨å†™å®Œ" class="router-link-active router-link-exact-active toc-link level3">å¤„ç† Socket å¯å†™ä½†å†™æ»¡16æ¬¡è¿˜æ²¡å®Œå…¨å†™å®Œ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/Netty_source/18-Netty%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%87%BA%E7%AB%99%E7%BC%93%E5%86%B2%E5%8C%BA.html#nioeventloop-å¤„ç†-op-write-äº‹ä»¶" class="router-link-active router-link-exact-active toc-link level2">NioEventLoop å¤„ç† OP_WRITE äº‹ä»¶</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><table><thead><tr><th>ç‰ˆæœ¬</th><th>å†…å®¹</th><th>æ—¶é—´</th></tr></thead><tbody><tr><td>V1</td><td>æ–°å»º</td><td>2022å¹´03æœˆ21æ—¥01:00:11</td></tr><tr><td>V2</td><td>é‡æ„</td><td>2023å¹´06æœˆ03æ—¥13:51:13</td></tr></tbody></table><h2 id="å¼•å…¥" tabindex="-1"><a class="header-anchor" href="#å¼•å…¥" aria-hidden="true">#</a> å¼•å…¥</h2><p>ä¸ºäº†æé«˜ç½‘ç»œçš„ååé‡ï¼Œåœ¨è°ƒç”¨ write æ–¹æ³•æ—¶ï¼Œæ•°æ®å¹¶æ²¡æœ‰ç›´æ¥å†™åˆ°åº•å±‚ Socket ä¸­ï¼Œè€Œæ˜¯è¢«å†™åˆ°äº† Netty çš„å‡ºç«™ç¼“å†²åŒº ChannelOutboundBuffer ä¸­ã€‚</p><p>æœ¬æ–‡ä¸»è¦åˆ†æ Netty çš„å†™æ“ä½œçš„æµç¨‹ï¼Œä¸»è¦åˆ†ä¸ºä¸€ä¸‹å‡ éƒ¨åˆ†ã€‚</p><ol><li>Netty çš„ write äº‹ä»¶çš„ä¼ æ’­ï¼›</li><li>Netty çš„ write äº‹ä»¶çš„å¤„ç†ï¼›</li><li>å‡ºç«™ç¼“å†²åŒº ChannelOutboundBuffer åŸç†ï¼›</li><li>Netty çš„ flush äº‹ä»¶çš„å¤„ç†ï¼›</li><li>Netty çš„ writeAndFlush æ–¹æ³•çš„é€»è¾‘ï¼›</li></ol><h2 id="netty-çš„-write-äº‹ä»¶çš„å…¥å£" tabindex="-1"><a class="header-anchor" href="#netty-çš„-write-äº‹ä»¶çš„å…¥å£" aria-hidden="true">#</a> Netty çš„ write äº‹ä»¶çš„å…¥å£</h2><p>åœ¨ ChannelHandler å¤„ç†å™¨ä¸­æœ‰ä¸¤ä¸ªåœ°æ–¹å¯ä»¥è§¦å‘ write äº‹ä»¶ï¼š</p><ol><li>è°ƒç”¨ ChannelHandlerContext çš„ write æ–¹æ³•ã€‚è¯¥æ–¹å¼ä¼šç›´æ¥æ²¿ç€å½“å‰ ChannelHandlerContext å‘ HeadContext ä¼ é€’ write äº‹ä»¶ï¼›</li><li>è°ƒç”¨ ChannelHandlerContext æ‰€å±çš„ Channel çš„ write æ–¹æ³•ã€‚è¯¥æ–¹å¼ä¼šä» TailContext å‘ HeadContext ä¼ é€’ write äº‹ä»¶ï¼›</li></ol><p>ä»¥ç¬¬äºŒç§æ–¹å¼ AbstractChannel#write(Object) ä¸ºä¾‹æ¥åˆ†æï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> pipeline<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°±æ˜¯è°ƒç”¨ç®¡é“çš„ DefaultChannelPipeline#write(Object) æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è°ƒç”¨ TailContext çš„ write æ–¹æ³•ï¼Œå› ä¸º TailContext å°±æ˜¯ AbstractChannelHandlerContext çš„å®ä¾‹ï¼Œæ‰€ä»¥éœ€è¦çœ‹ AbstractChannelHandlerContext çš„ write æ–¹æ³•</p><h2 id="netty-çš„-write-äº‹ä»¶çš„ä¼ æ’­" tabindex="-1"><a class="header-anchor" href="#netty-çš„-write-äº‹ä»¶çš„ä¼ æ’­" aria-hidden="true">#</a> Netty çš„ write äº‹ä»¶çš„ä¼ æ’­</h2><p><img src="/assets/Writeäº‹ä»¶çš„ä¼ æ’­-eb1f8a94.png" alt="Writeäº‹ä»¶çš„ä¼ æ’­"></p><h3 id="æŸ¥æ‰¾ä¸Šä¸€ä¸ª-channelhandler" tabindex="-1"><a class="header-anchor" href="#æŸ¥æ‰¾ä¸Šä¸€ä¸ª-channelhandler" aria-hidden="true">#</a> æŸ¥æ‰¾ä¸Šä¸€ä¸ª ChannelHandler</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token function">newPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å†™å…¥æ¶ˆæ¯ ä¸åˆ·æ–°</span>
    <span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸¤ä¸ª write æ–¹æ³•å°±æ˜¯åˆ›å»ºä¸€ä¸ª ChannelFuture å¯¹è±¡ï¼Œä¼ å…¥åˆ°é‡è½½çš„ write ä¸­ï¼Œå¹¶å°† ChannelFuture å¯¹è±¡è¿”å›ç»™è°ƒç”¨è€…ï¼Œè°ƒç”¨è€…å¯ä»¥ç›‘å¬è¿™ä¸ª ChannelFutureï¼Œå°±èƒ½çŸ¥é“ write æ“ä½œæ˜¯æ­£å¸¸è¿˜æ˜¯å¼‚å¸¸äº†ã€‚</p><p>æ¥ä¸‹æ¥çœ‹æ ¸å¿ƒçš„ AbstractChannelHandlerContext#write(Object, boolean, ChannelPromise) æ–¹æ³•äº†</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> flush<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...... çœç•¥å‚æ•°æ ¡éªŒ......</span>

    <span class="token comment">// æ‰¾å‡ºä¸Šä¸€ä¸ªå‡ºç«™çš„ctxå¯¹è±¡</span>
    <span class="token comment">// flush = true è¡¨ç¤ºchannelHandlerä¸­è°ƒç”¨çš„æ˜¯writeAndFlushæ–¹æ³•ï¼Œè¿™é‡Œéœ€è¦æ‰¾åˆ°pipelineä¸­è¦†ç›–writeæˆ–è€…flushæ–¹æ³•çš„channelHandler</span>
    <span class="token comment">// flush = false è¡¨ç¤ºè°ƒç”¨çš„æ˜¯writeæ–¹æ³•ï¼Œåªéœ€è¦æ‰¾åˆ°pipelineä¸­è¦†ç›–writeæ–¹æ³•çš„channelHandler</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> next <span class="token operator">=</span> <span class="token function">findContextOutbound</span><span class="token punctuation">(</span>flush <span class="token operator">?</span>
            <span class="token punctuation">(</span><span class="token constant">MASK_WRITE</span> <span class="token operator">|</span> <span class="token constant">MASK_FLUSH</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">MASK_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ·»åŠ é™„åŠ ä¿¡æ¯ï¼Œåœ¨å†…å­˜æ³„éœ²çš„æ—¶å€™ï¼Œå¯ä»¥è·å–åˆ°è¿™ä¸ªé™„åŠ ä¿¡æ¯</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span> m <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœéœ€è¦åˆ·æ–°ï¼Œå°±è°ƒç”¨ invokeWriteAndFlush æ–¹æ³•</span>
            next<span class="token punctuation">.</span><span class="token function">invokeWriteAndFlush</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœä¸éœ€è¦åˆ·æ–°ï¼Œå°±è°ƒç”¨ invokeWrite æ–¹æ³•</span>
            next<span class="token punctuation">.</span><span class="token function">invokeWrite</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†å†™æ“ä½œå°è£…æˆä¸€ä¸ª WriteTaskï¼Œæ˜¯ Runnable å­ç±»ã€‚</span>
        <span class="token keyword">final</span> <span class="token class-name">WriteTask</span> task <span class="token operator">=</span> <span class="token class-name">WriteTask</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> m<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">safeExecute</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> task<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token operator">!</span>flush<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// See https://github.com/netty/netty/issues/8343.</span>
            task<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç®€å•åˆ†æä¸‹è¿™ä¸ªæ–¹æ³•çš„æµç¨‹ï¼š</p><ul><li>é¦–å…ˆä½¿ç”¨ <code>findContextOutbound(flush ? (MASK_WRITE | MASK_FLUSH) : MASK_WRITE)</code> æ–¹æ³•ï¼Œæ‰¾åˆ°ä¸Šä¸€ä¸ªå®ç°äº† write æˆ–è€… ã€write å’Œ flushã€çš„ ChannelHandlerã€‚ï¼ˆfindContextOutbound æ–¹æ³•åœ¨ç®¡é“é‚£ä¸€ç¯‡ä¸­è¯¦ç»†åˆ†æè¿‡ï¼Œæ˜¯äº‹ä»¶ä¼ æ’­çš„æ ¸å¿ƒæ–¹æ³•ï¼‰ï¼›</li><li><code>pipeline.touch(msg, next)</code> æ˜¯æ£€æµ‹èµ„æºæ³„æ¼ç”¨çš„ï¼Œåé¢å•ç‹¬å‡ºä¸€ç¯‡æ–‡ç« è¯¦ç»†åˆ†æï¼›</li><li>æœ€åæ ¹æ®å½“å‰æ‰§è¡Œä»£ç çš„çº¿ç¨‹æ˜¯å¦æ˜¯ä¸‹ä¸€ä¸ª ChannelHandler ç»‘å®šçš„çº¿ç¨‹ï¼Œåšä¸åŒçš„å¤„ç†é€»è¾‘ï¼› <ul><li>æ˜¯ï¼šæ ¹æ® flush å‚æ•°å†³å®šè°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼ŒinvokeWriteAndFlush æˆ–è€… invokeWrite æ–¹æ³•ï¼›</li><li>ä¸æ˜¯ï¼šéœ€è¦ä¿è¯ä¸‹ä¸€ä¸ª ChannelHandler æ‰§è¡Œçš„çº¿ç¨‹æ˜¯å®ƒç»‘å®šçš„çº¿ç¨‹ï¼Œæ‰€ä»¥è¦å°è£…ä¸€ä¸ª WriteTask ä»»åŠ¡ï¼Œæ·»åŠ åˆ°å¯¹åº”çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼›</li></ul></li></ul><h3 id="å½“å‰çº¿ç¨‹æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#å½“å‰çº¿ç¨‹æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹" aria-hidden="true">#</a> å½“å‰çº¿ç¨‹æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">Object</span> m <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœéœ€è¦åˆ·æ–°ï¼Œå°±è°ƒç”¨ invokeWriteAndFlush æ–¹æ³•</span>
        next<span class="token punctuation">.</span><span class="token function">invokeWriteAndFlush</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœä¸éœ€è¦åˆ·æ–°ï¼Œå°±è°ƒç”¨ invokeWrite æ–¹æ³•</span>
        next<span class="token punctuation">.</span><span class="token function">invokeWrite</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    	<span class="token comment">// ...... çœç•¥å…¶ä»–åˆ†æ”¯ ......</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœå½“å‰çº¿ç¨‹å°±æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹ï¼Œé‚£ä¹ˆç›´æ¥è°ƒç”¨ä¸‹ä¸ª ChannelHandlerContext çš„å¯¹åº”æ–¹æ³•ï¼Œä»¥ AbstractChannelHandlerContext#invokeWrite ä¸ºä¾‹ï¼Œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">invokeWrite</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeWrite0</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeWrite0</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">notifyOutboundHandlerException</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°å°±æ˜¯è°ƒç”¨ä¸‹ä¸€ä¸ª ChannelHandler å®ç°çš„ write æ–¹æ³•ï¼Œå‡å¦‚æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸åï¼Œè¿™é‡Œä¼šé€šçŸ¥å¯¹åº”çš„ ChannelFutureã€‚</p><h3 id="å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹" aria-hidden="true">#</a> å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">Object</span> m <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...... çœç•¥å…¶ä»–åˆ†æ”¯ ......</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†å†™æ“ä½œå°è£…æˆä¸€ä¸ª WriteTaskï¼Œæ˜¯ Runnable å­ç±»ã€‚</span>
    <span class="token keyword">final</span> <span class="token class-name">WriteTask</span> task <span class="token operator">=</span> <span class="token class-name">WriteTask</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> m<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">safeExecute</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> task<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token operator">!</span>flush<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        task<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“å½“å‰æ‰§è¡Œä»£ç çš„çº¿ç¨‹ä¸æ˜¯ä¸‹ä¸ªå‡ºç«™å¤„ç†å™¨ç»‘å®šçš„çº¿ç¨‹ï¼Œä¸ºäº†ä¿è¯ ChannelHandler çš„å†…çš„ write æ–¹æ³•çš„é€»è¾‘æ˜¯å®ƒç»‘å®šçš„çº¿ç¨‹æ‰§è¡Œï¼Œé‚£ä¹ˆå°±éœ€è¦å‘å®ƒç»‘å®šçš„çº¿ç¨‹æäº¤ä¸€ä¸ª WriteTask ç±»å‹çš„ä»»åŠ¡ã€‚</p><h4 id="writetask-å¯¹è±¡æ± " tabindex="-1"><a class="header-anchor" href="#writetask-å¯¹è±¡æ± " aria-hidden="true">#</a> WriteTask å¯¹è±¡æ± </h4><p>å› ä¸ºåœ¨ Netty ä¸­å†™æ“ä½œæ˜¯å¾ˆé¢‘ç¹çš„ï¼Œå¦‚æœæ¯æ¬¡å†™æ“ä½œéƒ½åˆ›å»ºä¸€ä¸ª WriteTask å¯¹è±¡ï¼Œé¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯å¯¹è±¡ä¼šå¯¹ Netty çš„æ€§èƒ½æœ‰å¾ˆå¤§çš„å½±å“ã€‚æ‰€ä»¥ WriteTask å†…éƒ¨æ˜¯ä½¿ç”¨å¯¹è±¡æ± æŠ€æœ¯æ¥é¿å…å¯¹è±¡é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WriteTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¯¹è±¡æ± </span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ObjectPool</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WriteTask</span><span class="token punctuation">&gt;</span></span> <span class="token constant">RECYCLER</span> <span class="token operator">=</span> <span class="token class-name">ObjectPool</span><span class="token punctuation">.</span><span class="token function">newPool</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectCreator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WriteTask</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">WriteTask</span> <span class="token function">newObject</span><span class="token punctuation">(</span><span class="token class-name">Handle</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WriteTask</span><span class="token punctuation">&gt;</span></span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WriteTask</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="writetask-çš„åˆå§‹åŒ–" tabindex="-1"><a class="header-anchor" href="#writetask-çš„åˆå§‹åŒ–" aria-hidden="true">#</a> WriteTask çš„åˆå§‹åŒ–</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">WriteTask</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">AbstractChannelHandlerContext</span> ctx<span class="token punctuation">,</span>
                             <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">,</span> <span class="token keyword">boolean</span> flush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»å¯¹è±¡æ± ä¸­è·å¾—å®ä¾‹</span>
    <span class="token class-name">WriteTask</span> task <span class="token operator">=</span> <span class="token constant">RECYCLER</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆå§‹åŒ–å‚æ•°</span>
    <span class="token function">init</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">WriteTask</span> task<span class="token punctuation">,</span> <span class="token class-name">AbstractChannelHandlerContext</span> ctx<span class="token punctuation">,</span>
                           <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">,</span> <span class="token keyword">boolean</span> flush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    task<span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>promise <span class="token operator">=</span> promise<span class="token punctuation">;</span>

    <span class="token comment">// æ˜¯å¦éœ€è¦ä¼°ç®—å†™å…¥æ•°æ®å¤§å°</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">ESTIMATE_TASK_SIZE_ON_SUBMIT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¼°ç®—æ•°æ®å¤§å°</span>
        task<span class="token punctuation">.</span>size <span class="token operator">=</span> ctx<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span><span class="token function">estimatorHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">WRITE_TASK_OVERHEAD</span><span class="token punctuation">;</span>
        <span class="token comment">// å¢åŠ ç­‰å¾…å†™å…¥æ•°æ®çš„å¤§å°</span>
        ctx<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span><span class="token function">incrementPendingOutboundBytes</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        task<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†size å¤§å°å˜æˆè´Ÿæ•°ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨ å†™å…¥å¹¶åˆ·æ–°çš„æ–¹æ³•</span>
        task<span class="token punctuation">.</span>size <span class="token operator">|=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>WriteTask çš„åˆå§‹åŒ–æµç¨‹ï¼Œå…ˆä»å¯¹è±¡æ± ä¸­è·å–ä¸€ä¸ª WriteTask å¯¹è±¡ï¼Œç„¶ååˆå§‹åŒ– WriteTask çš„å±æ€§ã€‚</p><p>æœ‰ä¸€ä¸ªå¸ƒå°”ç±»å‹çš„å¯é…ç½®é¡¹ ESTIMATE_TASK_SIZE_ON_SUBMITï¼Œæ§åˆ¶æ˜¯å¦åœ¨æäº¤ WriteTask ä»»åŠ¡çš„æ—¶å€™å°±è®¡ç®— Netty å‡ºç«™ç¼“å†²åŒºçš„é«˜ä½æ°´ä½çº¿ã€‚è¿™é‡ŒçŸ¥é“è¿™ä¸ªæ°´ä½çº¿å°±è¡Œäº†ï¼Œåé¢è¯¦ç»†åˆ†æã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æ˜¯å¦éœ€è¦ä¼°ç®—å†™å…¥æ•°æ®å¤§å°</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token constant">ESTIMATE_TASK_SIZE_ON_SUBMIT</span> <span class="token operator">=</span>
        <span class="token class-name">SystemPropertyUtil</span><span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;io.netty.transport.estimateSizeOnSubmit&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡å¦‚è¯¥å€¼æ˜¯ true çš„è¯ï¼Œå°±éœ€è¦æ¯æ¬¡è®¡ç®—æ­¤æ¬¡å†™å…¥æ•°æ®çš„å¤§å°ï¼Œåˆ¤æ–­å‡ºç«™ç¼“å†²åŒºçš„ä¸­æ•°æ®æ˜¯å¦è¶…è¿‡é«˜æ°´ä½çº¿ï¼Œå‡å¦‚è¶…è¿‡é«˜æ°´ä½çº¿ï¼Œå°±éœ€è¦å°†é€šé“ ChannelPipeline å‘èµ·unwriteable æ›´æ”¹äº‹ä»¶ï¼Œè®¾ç½®ä¸å¯å†™ã€‚</p><p>ä¸‹é¢ä¸€æ­¥æ˜¯å‡å¦‚è°ƒç”¨äº† flush çš„æ–¹æ³•ï¼Œå°±éœ€è¦é€šè¿‡ä½æ“ä½œå°†åŸæ¥çš„ size å¤§å°å˜æˆè´Ÿæ•°ï¼Œè¿™ä¹ˆåšæ˜¯ä¸ºäº†åŒºåˆ«åç»­ run æ–¹æ³•ä¸­è°ƒç”¨ä¸åŒçš„æ–¹æ³•ï¼ŒåŒºåˆ«è°ƒç”¨ write æ–¹æ³•è¿˜æ˜¯ write å’Œ flush æ–¹æ³•ã€‚</p><h4 id="writetask-çš„æ‰§è¡Œ" tabindex="-1"><a class="header-anchor" href="#writetask-çš„æ‰§è¡Œ" aria-hidden="true">#</a> WriteTask çš„æ‰§è¡Œ</h4><p>å½“ä¸‹ä¸€ä¸ªå‡ºç«™ ChannelHandler çš„çº¿ç¨‹æ‰§è¡Œåˆ°äº†å½“å‰çš„ WriteTask ä¹‹åï¼Œå°±ä¼šè°ƒç”¨ WriteTask#run æ–¹æ³•å»æ‰§è¡Œäº†ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// å‡å°ç­‰å¾…å†™å…¥æ•°æ®å¤§å°</span>
        <span class="token function">decrementPendingOutboundBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// åªè°ƒç”¨å†™å…¥æ“ä½œ</span>
            ctx<span class="token punctuation">.</span><span class="token function">invokeWrite</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// å½“ size &lt; 0 ,å†™å…¥å¹¶åˆ·æ–°æ“ä½œ</span>
            ctx<span class="token punctuation">.</span><span class="token function">invokeWriteAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// å›æ”¶å¯¹è±¡</span>
        <span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * å‡å°ç­‰å¾…å†™å…¥æ•°æ®å¤§å°
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">decrementPendingOutboundBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">ESTIMATE_TASK_SIZE_ON_SUBMIT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span><span class="token function">decrementPendingOutboundBytes</span><span class="token punctuation">(</span>size <span class="token operator">&amp;</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç®€å•æ˜äº†ï¼Œå°±æ˜¯è°ƒç”¨ä¸‹ä¸ª ChannelHandlerContext çš„å¯¹åº”æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ invokeWrite å’Œ invokeWriteAndFlush æ–¹æ³•äº†ã€‚æˆ‘ä»¬å‰é¢å·²ç»åˆ†æè¿‡ã€‚å¦å¤–ï¼Œå‡å¦‚é…ç½®é¡¹ ESTIMATE_TASK_SIZE_ON_SUBMIT æ˜¯ trueï¼Œå› ä¸ºå‰é¢ç´¯åŠ äº†å‡ºç«™ç¼“å†²åŒºå¾…å‘é€æ•°æ®ï¼Œè¿™é‡Œéœ€è¦å‡å°‘è¿™ä¸ªç´¯åŠ å€¼ã€‚</p><h3 id="headcontext-çš„-write-æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#headcontext-çš„-write-æ–¹æ³•" aria-hidden="true">#</a> HeadContext çš„ write æ–¹æ³•</h3><p>å› ä¸º write æ˜¯å‡ºç«™äº‹ä»¶ï¼Œæ‰€ä»¥æœ€ç»ˆä¼šè°ƒç”¨åˆ° HeadContext çš„ write æ–¹æ³•ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// NioSocketChannelUnsafe</span>
    unsafe<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç´§æ¥ç€è°ƒç”¨ UnSafe çš„ write æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 1 å…ˆåˆ¤æ–­å†™ç¼“å†²åŒº outboundBuffer æ˜¯ä¸æ˜¯ä¸º nullï¼Œä¸ºç©ºè¯´æ˜é€šé“å·²å…³é—­ï¼Œè¿›è¡Œå¤±è´¥é€šçŸ¥ã€‚
 * 2 é€šè¿‡ filterOutboundMessage(msg) æ–¹æ³•è¿›è¡Œæ•°æ®è½¬æ¢ï¼Œä¾‹å¦‚å°† Heap ç¼“å†²åŒºå˜æˆ Direct ç¼“å†²åŒºã€‚
 * 3 ä¼°ç®—æ•°æ®å¤§å°ã€‚
 * 4 é€šè¿‡ outboundBuffer.addMessage(...) æ–¹æ³•ï¼Œå°†æ•°æ®æ·»åŠ åˆ°å†™ç¼“å†²åŒº outboundBuffer ä¸­ã€‚
 * 5 å¦‚æœå‘é€å¼‚å¸¸ï¼Œè®°å¾—é‡Šæ”¾æ•°æ® msg çš„å¼•ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²ï¼Œå¹¶è¿›è¡Œæ“ä½œå¤±è´¥é€šçŸ¥ã€‚
 *
 * msg å¤§æ¦‚ç‡æ˜¯ ByteBuf å¯¹è±¡
 *
 * <span class="token keyword">@param</span> <span class="token parameter">msg</span>
 * <span class="token keyword">@param</span> <span class="token parameter">promise</span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assertEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelOutboundBuffer</span> outboundBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outboundBuffer<span class="token punctuation">;</span>
    
    <span class="token comment">// ...... çœç•¥é˜²æ­¢èµ„æºæ³„æ¼çš„ä»£ç  ......</span>

    <span class="token comment">// msgæ•°æ®å¤§å°</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// msgä¸€èˆ¬æ˜¯ByteBufå¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ ¹æ®å†…å­˜å½’å±åˆ†ä¸ºHeapå’ŒDirectï¼Œå¦‚æœByteBufç±»å‹æ˜¯Heapç±»å‹çš„è¯ï¼Œè¿™é‡Œä¼šå°†å…¶è½¬æ¢ä¸ºdirectç±»å‹</span>
        msg <span class="token operator">=</span> <span class="token function">filterOutboundMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–å½“å‰æ¶ˆæ¯ æœ‰æ•ˆæ•°æ®é‡å¤§å°</span>
        size <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">estimatorHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...... å¼‚å¸¸å¤„ç†é€»è¾‘ ......</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å°†ByteBufæ•°æ®åŠ å…¥åˆ°å‡ºç«™ç¼“å­˜åŒºå†…</span>
    <span class="token comment">// å‚æ•°1ï¼šmsg ä¸€èˆ¬ByteBufå¯¹è±¡ï¼Œdirectå †å¤–å†…å­˜</span>
    <span class="token comment">// å‚æ•°2ï¼šsize æ•°æ®é‡å¤§å°</span>
    outboundBuffer<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> size<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸ºäº†æé«˜ç½‘ç»œçš„ååé‡ï¼Œåœ¨è°ƒç”¨ write æ–¹æ³•æ—¶ï¼Œæ•°æ®å¹¶æ²¡æœ‰ç›´æ¥å†™åˆ°åº•å±‚ Socket ä¸­ï¼Œè€Œæ˜¯è¢«å†™åˆ°äº† Netty çš„å‡ºç«™ç¼“å†²åŒº ChannelOutboundBuffer ä¸­ã€‚</p><h4 id="filteroutboundmessage-æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#filteroutboundmessage-æ–¹æ³•" aria-hidden="true">#</a> filterOutboundMessage æ–¹æ³•</h4><p>AbstractNioByteChannel#filterOutboundMessage</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> <span class="token function">filterOutboundMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token comment">// æ˜¯å †å¤–ç›´æ¥è¿”å›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">isDirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è½¬æ¢ä¸ºdirectè¿”å›</span>
        <span class="token keyword">return</span> <span class="token function">newDirectBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">FileRegion</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;unsupported message type: &quot;</span> <span class="token operator">+</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">simpleClassName</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">EXPECTED_TYPES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡ºç«™ç¼“å†²åŒº ChannelOutboundBuffer åªå…è®¸æ·»åŠ  ByteBuffer ç±»å‹ä»¥åŠ FileRegion ç±»å‹çš„æ•°æ®ã€‚</p><h4 id="messagesizeestimator-handle-è®¡ç®—æ•°æ®å¤§å°" tabindex="-1"><a class="header-anchor" href="#messagesizeestimator-handle-è®¡ç®—æ•°æ®å¤§å°" aria-hidden="true">#</a> MessageSizeEstimator.Handle è®¡ç®—æ•°æ®å¤§å°</h4><p>MessageSizeEstimator å¯¹è±¡æ˜¯åœ¨åˆå§‹åŒ– Channel çš„æ—¶å€™ï¼Œéšç€åˆ›å»º ChannelConfig ä¸€èµ·åˆ›å»ºçš„ã€‚ä»¥ NioSocketChannel çš„åˆ›å»ºä¸ºä¾‹ï¼Œåˆ›å»ºäº†ä¸€ä¸ª NioSocketChannelConfig å¯¹è±¡ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NioSocketChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">,</span> <span class="token class-name">SocketChannel</span> socket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è€Œåœ¨ NioSocketChannelConfig çš„çˆ¶ç±» DefaultChannelConfig ä¸­æœ‰ä¸ª MessageSizeEstimator ç±»å‹çš„å±æ€§ï¼Œå®ƒçš„é»˜è®¤å€¼å°±æ˜¯ DefaultMessageSizeEstimator å¯¹è±¡ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MessageSizeEstimator</span> <span class="token constant">DEFAULT</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMessageSizeEstimator</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>DefaultMessageSizeEstimator ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DefaultMessageSizeEstimator</span> <span class="token keyword">implements</span> <span class="token class-name">MessageSizeEstimator</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HandleImpl</span> <span class="token keyword">implements</span> <span class="token class-name">Handle</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> unknownSize<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">HandleImpl</span><span class="token punctuation">(</span><span class="token keyword">int</span> unknownSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>unknownSize <span class="token operator">=</span> unknownSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * è®¡ç®—ä¸åŒç±»å‹çš„ æ•°æ®é‡å¤§å°
         * <span class="token keyword">@param</span> <span class="token parameter">msg</span>       The message for which the size should be calculated
         * <span class="token keyword">@return</span>
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBufHolder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ByteBufHolder</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">FileRegion</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> unknownSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å°±æ˜¯è°ƒç”¨ size æ–¹æ³•å»è®¡ç®— ByteBuffer çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ Buffer ä¸­æœªè¯»å–çš„å­—èŠ‚æ•° writerIndex - readerIndexã€‚</p><p>åœ¨è®¡ç®—å®Œæ•°æ®å¤§å°ï¼Œå°±è°ƒç”¨ ChannelOutboundBuffer#addMessage æ–¹æ³•å°† msg æ·»åŠ åˆ°å‡ºç«™ç¼“å†²åŒºä¸­å»äº†ã€‚</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬çŸ¥é“å°†æ•°æ®æ·»åŠ åˆ°å‡ºç«™ç¼“å†²åŒºå†…å°±è¡Œäº†ï¼Œå…·ä½“å‡ºç«™ç¼“å†²åŒºå†…æ˜¯å¦‚ä½•å¤„ç†çš„åé¢è¯¦ç»†åˆ†æã€‚</p><h2 id="netty-çš„-flush-äº‹ä»¶çš„ä¼ æ’­" tabindex="-1"><a class="header-anchor" href="#netty-çš„-flush-äº‹ä»¶çš„ä¼ æ’­" aria-hidden="true">#</a> Netty çš„ flush äº‹ä»¶çš„ä¼ æ’­</h2><p>Netty çš„ flush äº‹ä»¶çš„ä¼ æ’­ï¼Œå…¶å®å®ƒå’Œ write äº‹ä»¶çš„ä¼ æ’­çš„æµç¨‹åŸºæœ¬ä¸€è‡´ï¼Œå› ä¸ºéƒ½æ˜¯å‡ºç«™äº‹ä»¶ã€‚è¿™é‡Œç®€è¦è¯´æ˜ä¸‹ï¼š</p><p>ï¼ˆ1ï¼‰é¦–å…ˆä¼šè°ƒç”¨ ChannelHandlerContext çš„ flush æ–¹æ³•ï¼Œè¿™é‡Œå°±æ˜¯é€šè¿‡ <code>findContextOutbound(MASK_FLUSH)</code> æ–¹æ³•æ‰¾åˆ°ä¸Šä¸€ä¸ªå®ç°äº† flush æ–¹æ³•çš„å‡ºç«™ ChannelHandlerã€‚</p><p>ç„¶ååˆ¤æ–­å½“å‰æ‰§è¡Œçš„çº¿ç¨‹æ˜¯å¦æ˜¯ä¸Šä¸€ä¸ª ChannelHandlerContext ç»‘å®šçš„çº¿ç¨‹ã€‚å¦‚æœæ˜¯å°±ç›´æ¥è°ƒç”¨å®ƒçš„ invokeFlush æ–¹æ³•ï¼›å¦‚æœä¸æ˜¯å°±æäº¤ä¸€ä¸ªåˆ·æ–°ä»»åŠ¡åˆ°ä¸Šä¸€ä¸ª ChannelHandlerContext ç»‘å®šçš„çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—é‡Œå»ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelHandlerContext</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> next <span class="token operator">=</span> <span class="token function">findContextOutbound</span><span class="token punctuation">(</span><span class="token constant">MASK_FLUSH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        next<span class="token punctuation">.</span><span class="token function">invokeFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// å› ä¸ºåˆ·æ–°æ“ä½œæ²¡æœ‰å‚æ•°ï¼Œä¸ç”¨æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„ Runnable å®ä¾‹</span>
        <span class="token class-name">Tasks</span> tasks <span class="token operator">=</span> next<span class="token punctuation">.</span>invokeTasks<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tasks <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            next<span class="token punctuation">.</span>invokeTasks <span class="token operator">=</span> tasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tasks</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">safeExecute</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> tasks<span class="token punctuation">.</span>invokeFlushTask<span class="token punctuation">,</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ï¼ˆ2ï¼‰åœ¨ä¸Šä¸€ä¸ª ChannelHandlerContext ç»‘å®šçš„çº¿ç¨‹å†…æ‰§è¡Œ AbstractChannelHandlerContext#invokeFlush æ–¹æ³•ï¼ŒåŒæ ·æ˜¯å…ˆåˆ¤æ–­å¤„ç†å™¨çš„çŠ¶æ€ï¼Œç„¶åè°ƒç”¨å¤„ç†å™¨å¯¹åº”çš„ flush æ–¹æ³•ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è°ƒç”¨å½“å‰ä¸Šä¸‹æ–‡å¯¹åº”å¤„ç†å™¨çš„ flush å¤„ç†æ–¹æ³•</span>
        <span class="token function">invokeFlush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// å½“å‰ä¸Šä¸‹æ–‡å¯¹åº”çš„å¤„ç†å™¨ä¸å¤„ç†ï¼Œ</span>
        <span class="token comment">// ç»§ç»­åœ¨ç®¡é“ä¸­å¯»æ‰¾ä¸‹ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨å¤„ç†</span>
        <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeFlush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ï¼ˆ3ï¼‰å› ä¸ºæ˜¯ flush æ˜¯å‡ºç«™äº‹ä»¶ï¼Œæ‰€ä»¥æœ€ç»ˆä¼šè°ƒç”¨åˆ° HeadContext ä¸­çš„ flush æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unsafe<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ï¼ˆ4ï¼‰AbstractUnsafe#flushï¼Œè¿™é‡Œå…¶å®åšçš„äº‹æƒ…å°±æ˜¯ï¼Œæ“ä½œä¹‹å‰ write äº‹ä»¶ä¿å­˜åˆ°å‡ºç«™ç¼“å†²åŒºé‡Œé¢çš„æ•°æ®äº†ï¼Œå°†å®ƒä»¬åˆ·æ–°åˆ°åº•å±‚ Socketï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assertEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelOutboundBuffer</span> outboundBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outboundBuffer<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outboundBuffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å†™ç¼“å†²åŒºä¸ºç©ºï¼Œç›´æ¥è¿”å›</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// é¢„å‡†å¤‡åˆ·æ–°å·¥ä½œ</span>
    <span class="token comment">// å°†flushedEntryæŒ‡å‘ç¬¬ä¸€ä¸ªéœ€è¦åˆ·æ–°çš„entryèŠ‚ç‚¹</span>
    <span class="token comment">// è®¡ç®—å‡º flushedEntry --&gt; taiLEntry ä¹‹é—´æ€»å…±æœ‰å¤šå°‘ä¸ªentryå¾…åˆ·æ–°ï¼Œå€¼èµ‹å€¼åˆ°flushedå­—æ®µå†…</span>
    outboundBuffer<span class="token punctuation">.</span><span class="token function">addFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">flush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æœ€ç»ˆäº†è§£ flush æ–¹æ³•åšäº†ä»€ä¹ˆäº‹æƒ…ä¹‹å‰ï¼Œæˆ‘ä»¬å¾—äº†è§£ä¸€äº›å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡å’ŒåŸç†ã€‚</p><h2 id="å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡å’ŒåŸç†" tabindex="-1"><a class="header-anchor" href="#å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡å’ŒåŸç†" aria-hidden="true">#</a> å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡å’ŒåŸç†</h2><h3 id="å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡åŸç†" tabindex="-1"><a class="header-anchor" href="#å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡åŸç†" aria-hidden="true">#</a> å‡ºç«™ç¼“å†²åŒºçš„è®¾è®¡åŸç†</h3><p>å‡ºç«™ç¼“å†²åŒº ChannelOutboundBuffer æ˜¯ä¸€ä¸ªå•é“¾è¡¨çš„ç»“æ„ï¼Œé“¾è¡¨ä¸Šçš„èŠ‚ç‚¹æ˜¯ Entry å¯¹è±¡ã€‚å‡ºç«™ç¼“å†²åŒºé€šè¿‡å‡ ä¸ªæŒ‡é’ˆæ¥ç»´æŠ¤æ•°æ®çš„åˆ·æ–°çŠ¶æ€ã€‚</p><p>æŒ‡é’ˆå¦‚ä¸‹ï¼š</p><ul><li>Entry unflushedEntryï¼šæŒ‡å‘ç¬¬ä¸€ä¸ªæœªè¢« flush çš„èŠ‚ç‚¹ï¼›</li><li>Entry tailEntryï¼šæŒ‡å‘é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼Œé€šè¿‡ unflushedEntry å’Œ tailEntry è¿™ä¸¤ä¸ªæŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®šä½åˆ°å¾…å‘é€æ•°æ®çš„èŠ‚ç‚¹ï¼›</li><li>Entry flushedEntryï¼šæŒ‡å‘ç¬¬ä¸€ä¸ªå·²ç»å‡†å¤‡ flush çš„èŠ‚ç‚¹ã€‚å½“è°ƒç”¨ flush æ–¹æ³•æ—¶ï¼ŒflushedEntry æŒ‡é’ˆä¼šæŒ‡å‘ unflushedEntry çš„ä½ç½®ï¼Œè¿™æ · flushedEntry æŒ‡é’ˆå’Œ tailEntry æŒ‡é’ˆä¹‹é—´çš„èŠ‚ç‚¹å°±æ˜¯æˆ‘ä»¬å³å°†å‘é€åˆ° Socket ä¸­çš„ç½‘ç»œæ•°æ®ï¼›</li></ul><h4 id="å‡ºç«™ç¼“å†²åŒºæ·»åŠ èŠ‚ç‚¹" tabindex="-1"><a class="header-anchor" href="#å‡ºç«™ç¼“å†²åŒºæ·»åŠ èŠ‚ç‚¹" aria-hidden="true">#</a> å‡ºç«™ç¼“å†²åŒºæ·»åŠ èŠ‚ç‚¹</h4><p><img src="/assets/Nettyå‡ºç«™ç¼“å†²åŒºé“¾è¡¨å¢åŠ å…ƒç´ -fcff4ff0.png" alt="Nettyå‡ºç«™ç¼“å†²åŒºé“¾è¡¨å¢åŠ å…ƒç´ "></p><h4 id="å‡ºç«™ç¼“å†²åŒºåˆ é™¤èŠ‚ç‚¹" tabindex="-1"><a class="header-anchor" href="#å‡ºç«™ç¼“å†²åŒºåˆ é™¤èŠ‚ç‚¹" aria-hidden="true">#</a> å‡ºç«™ç¼“å†²åŒºåˆ é™¤èŠ‚ç‚¹</h4><p><img src="/assets/Nettyå‡ºç«™ç¼“å†²åŒºé“¾è¡¨ç§»é™¤å…ƒç´ -a97e70e1.png" alt="Nettyå‡ºç«™ç¼“å†²åŒºé“¾è¡¨ç§»é™¤å…ƒç´ "></p><h4 id="ç‰¹æ®Šæƒ…å†µ" tabindex="-1"><a class="header-anchor" href="#ç‰¹æ®Šæƒ…å†µ" aria-hidden="true">#</a> ç‰¹æ®Šæƒ…å†µ</h4><p><img src="/assets/Nettyå‡ºç«™ç¼“å†²åŒºé“¾è¡¨ç§»é™¤å…ƒç´ ç‰¹æ®Š-8737a44e.png" alt="Nettyå‡ºç«™ç¼“å†²åŒºé“¾è¡¨ç§»é™¤å…ƒç´ ç‰¹æ®Š"></p><h3 id="channeloutboundbuffer-çš„å±æ€§" tabindex="-1"><a class="header-anchor" href="#channeloutboundbuffer-çš„å±æ€§" aria-hidden="true">#</a> ChannelOutboundBuffer çš„å±æ€§</h3><p>é¦–å…ˆéœ€è¦äº†è§£ä¸€ä¸‹ ChannelOutboundBuffer ç±»ä¸­çš„ä¸€äº›å±æ€§</p><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Channel channel</td><td>å½“å‰å‡ºç«™ç¼“å†²åŒºæ˜¯å±äºå“ªä¸€ä¸ª Channel çš„</td></tr><tr><td>Entry flushedEntry</td><td>æŒ‡å‘ç¬¬ä¸€ä¸ªå·²ç»å‡†å¤‡ flush çš„èŠ‚ç‚¹ã€‚å½“è°ƒç”¨ flush æ–¹æ³•æ—¶ï¼ŒflushedEntry æŒ‡é’ˆä¼šæŒ‡å‘ unflushedEntry çš„ä½ç½®ï¼Œè¿™æ · flushedEntry æŒ‡é’ˆå’Œ tailEntry æŒ‡é’ˆä¹‹é—´çš„èŠ‚ç‚¹å°±æ˜¯æˆ‘ä»¬å³å°†å‘é€åˆ° Socket ä¸­çš„ç½‘ç»œæ•°æ®ï¼›</td></tr><tr><td>Entry unflushedEntry</td><td>æŒ‡å‘ç¬¬ä¸€ä¸ªæœªè¢« flush çš„èŠ‚ç‚¹ï¼›</td></tr><tr><td>Entry tailEntry</td><td>æŒ‡å‘é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼Œé€šè¿‡ unflushedEntry å’Œ tailEntry è¿™ä¸¤ä¸ªæŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®šä½åˆ°å¾…å‘é€æ•°æ®çš„èŠ‚ç‚¹ï¼›</td></tr><tr><td>int flushed</td><td>è¡¨ç¤ºè¿˜æœ‰å¤šå°‘ä¸ªèŠ‚ç‚¹è¿˜æœªè¢« flush</td></tr><tr><td>int nioBufferCount</td><td>è¡¨ç¤ºå‡ºç«™ç¼“å†²åŒºä¸­æœ‰å¤šå°‘ä¸ª ByteBuffer ç­‰å¾…å‡ºç«™</td></tr><tr><td>long nioBufferSize</td><td>è¡¨ç¤ºå‡ºç«™ç¼“å†²åŒºæœ‰å¤šå°‘å­—èŠ‚çš„ ByteBuffer ç­‰å¾…å‡ºç«™</td></tr><tr><td>long totalPendingSize</td><td>è¡¨ç¤ºå‡ºç«™ç¼“å†²åŒºä¸­æœ‰å¤šå°‘è‡ªå·±çš„æ•°æ®ç­‰å¾…å‡ºç«™ï¼ˆåŒ…æ‹¬ Entry å¯¹è±¡è‡ªèº«å ç”¨çš„å†…å­˜å¤§å°ï¼‰ï¼Œç”¨äºå’Œé«˜ä½æ°´ä½ä½œæ¯”è¾ƒ</td></tr><tr><td>int unwritable</td><td>è¡¨ç¤ºå‡ºç«™ç¼“å†²åŒºæ˜¯å¦å¯å†™ï¼Œ0 è¡¨ç¤ºå¯å†™ï¼Œ1 è¡¨ç¤ºä¸å¯å†™</td></tr></tbody></table><h3 id="é“¾è¡¨èŠ‚ç‚¹-entry" tabindex="-1"><a class="header-anchor" href="#é“¾è¡¨èŠ‚ç‚¹-entry" aria-hidden="true">#</a> é“¾è¡¨èŠ‚ç‚¹ Entry</h3><p>ChannelOutboundBuffer å†…å°±æ˜¯ä¸€ä¸ªå•é“¾è¡¨ï¼Œé“¾è¡¨çš„èŠ‚ç‚¹æ˜¯ Entry ç±»å‹çš„ï¼Œå…ˆäº†è§£ Entry å¯¹è±¡ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token punctuation">{</span>
    <span class="token comment">// entry å¯¹è±¡æ± </span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ObjectPool</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> <span class="token constant">RECYCLER</span> <span class="token operator">=</span> <span class="token class-name">ObjectPool</span><span class="token punctuation">.</span><span class="token function">newPool</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectCreator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Entry</span> <span class="token function">newObject</span><span class="token punctuation">(</span><span class="token class-name">Handle</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å½’è¿˜entryåˆ°ObjectPoolä½¿ç”¨çš„å¥æŸ„</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Handle</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> handle<span class="token punctuation">;</span>
    <span class="token comment">// ç»„è£…æˆé“¾è¡¨ä½¿ç”¨çš„å­—æ®µï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªentryçš„èŠ‚ç‚¹</span>
    <span class="token class-name">Entry</span> next<span class="token punctuation">;</span>
    <span class="token comment">// ä¸šåŠ¡å±‚é¢çš„æ•°æ®ï¼Œä¸€èˆ¬msgéƒ½æ˜¯ByteBufå¯¹è±¡</span>
    <span class="token class-name">Object</span> msg<span class="token punctuation">;</span>
    <span class="token comment">// å½“unsafeè°ƒç”¨ å‡ºç«™ç¼“å†²åŒºnioBuffersæ–¹æ³•æ—¶ï¼Œè¢«æ¶‰åŠåˆ°çš„entryéƒ½ä¼šå°†ä»–çš„msgè½¬æ¢æˆByteBufferï¼Œè¿™é‡Œç¼“å­˜ç»“æœä½¿ç”¨</span>
    <span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bufs<span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> buf<span class="token punctuation">;</span>
    <span class="token comment">// ä¸šåŠ¡å±‚é¢å…³æ³¨msgå†™ç»“æœæ—¶ï¼Œæäº¤çš„promise</span>
    <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">;</span>
    <span class="token comment">// è¿›åº¦</span>
    <span class="token keyword">long</span> progress<span class="token punctuation">;</span>
    <span class="token comment">// msg byteBuf æœ‰æ•ˆæ•°æ®é‡å¤§å°</span>
    <span class="token keyword">long</span> total<span class="token punctuation">;</span>
    <span class="token comment">// byteBuf æœ‰æ•ˆæ•°æ®é‡å¤§å° + 96 (16 + 6*8 + 16 + 8 + 1)</span>
    <span class="token comment">// Assuming a 64-bit JVM:</span>
    <span class="token comment">//  - 16 bytes object header</span>
    <span class="token comment">//  - 6 reference fields</span>
    <span class="token comment">//  - 2 long fields</span>
    <span class="token comment">//  - 2 int fields</span>
    <span class="token comment">//  - 1 boolean field</span>
    <span class="token comment">//  - padding</span>
    <span class="token keyword">int</span> pendingSize<span class="token punctuation">;</span>
    <span class="token comment">// å½“å‰msg byteBufåº•å±‚ç”±å¤šå°‘ ByteBufferç»„æˆ ä¸€èˆ¬éƒ½æ˜¯1ï¼Œç‰¹æ®Šæƒ…å†µæ˜¯ CompositeByteBufåº•å±‚å¯ä»¥ç”±å¤šä¸ªByteBufç»„æˆ</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// å½“å‰entryæ˜¯å¦å–æ¶ˆåˆ·æ–°åˆ°socket é»˜è®¤æ˜¯false</span>
    <span class="token keyword">boolean</span> cancelled<span class="token punctuation">;</span>
 
    
    <span class="token comment">// ...... çœç•¥æ–¹æ³• ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Entry ç±»ä¸­ä¸€å…±æœ‰ 12 ä¸ªå­—æ®µï¼Œ1 ä¸ªé™æ€å­—æ®µå’Œ 11 ä¸ªå®ä¾‹å­—æ®µã€‚</p><p>æ¥ä¸‹æ¥ä¾æ¬¡è¯´æ˜è¿™äº›å­—æ®µçš„ä½œç”¨ï¼š</p><ul><li><code>ObjectPool&lt;Entry&gt; RECYCLER</code>ï¼šå› ä¸º Netty ä¸­å¾— write æ“ä½œè‚¯å®šååˆ†é¢‘ç¹ï¼Œä¸ºäº†é˜²æ­¢ Entry å¯¹è±¡é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯ï¼Œä½¿ç”¨å¯¹è±¡æ± æŠ€æœ¯æ¥ç»´æŠ¤ä¸€äº› Entry å¯¹è±¡ï¼›</li><li><code>Handle&lt;Entry&gt; handle</code>ï¼šNetty ä¸­é»˜è®¤çš„å®ç°æ˜¯ io.netty.util.Recycler.DefaultHandleã€‚ç”¨äºåœ¨ Entry ä½¿ç”¨å®Œåï¼Œå°†å…¶å›æ”¶åˆ° Entry å¯¹è±¡æ± ï¼›</li><li><code>Entry next</code>ï¼šå› ä¸ºæ˜¯å‡ºç«™ç¼“å†²åŒºæ˜¯å•é“¾è¡¨ï¼Œè¿™ä¸ª next çš„ä½œç”¨å°±æ˜¯æŒ‡å‘é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼›</li><li><code>Object msg</code>ï¼šä¸šåŠ¡å±‚é¢è¦å†™å‡ºçš„æ•°æ®ï¼Œä¸€èˆ¬éƒ½æ˜¯ ByteBuf å¯¹è±¡ï¼Œä¹Ÿæœ‰ FileRegionï¼›</li><li><code>ByteBuffer[] bufs</code>å’Œ <code>ByteBuffer buf</code>ï¼šNetty æœ€ç»ˆæ˜¯è¦å°†å†™å‡ºçš„æ•°æ®è½¬æ¢ä¸º JDK åŸç”Ÿçš„ ByteBufferï¼Œä¼ è¾“åˆ°åº•å±‚ Socket çš„ã€‚è¿™é‡Œçš„ bufs å’Œ buf çš„åŒºåˆ«å°±æ˜¯ï¼Œå‡å¦‚æ˜¯å¤šä¸ª ByteBuffer å°±ç”¨æ•°ç»„å­˜ï¼Œå‡å¦‚æ˜¯å•ä¸ª ByteBuffer å°±ç”¨ buf å­˜ï¼›</li><li><code>ChannelPromise promise</code>ï¼šä¸šåŠ¡å±‚é¢å…³æ³¨ msg å†™ç»“æœæ—¶ï¼Œæäº¤çš„ promiseï¼Œè°ƒç”¨æ–¹å¯ä»¥é€šè¿‡è¿™ä¸ªæ¥çŸ¥é“å†™æ“ä½œçš„æƒ…å†µï¼›</li><li><code>long progress</code>ï¼šå‘é€æ•°æ®çš„è¿›åº¦ï¼Œè¡¨ç¤ºå·²ç»å‘é€äº†å¤šå°‘æ•°æ®ï¼›</li><li><code>long total</code>ï¼šå¾…å‘é€çš„ msg æœ‰æ•ˆæ•°æ®å¤§å°ï¼Œè¿™ä¸ªå­—æ®µå¹¶ä¸åŒ…å« Entry å¯¹è±¡çš„å†…å­˜å ç”¨å¤§å°ï¼›</li><li><code>int pendingSize</code>ï¼šè¡¨ç¤ºå°è£… msg çš„ Entry çš„æ€»ä½“å ç”¨å†…å­˜å¤§å°ï¼ŒåŒ…æ‹¬è¦å‘é€çš„æ•°æ®å’Œ Entry å¯¹è±¡æœ¬èº«å ç”¨çš„å†…å­˜ï¼›</li><li><code>int count </code>ï¼šè¡¨ç¤ºå¾…å‘é€æ•°æ® msg ä¸­ä¸€å…±åŒ…å«äº†å¤šå°‘ä¸ª ByteBuffer éœ€è¦å‘é€ï¼›</li><li><code>boolean cancelled</code>ï¼šå½“å‰ entry æ˜¯å¦å–æ¶ˆåˆ·æ–°åˆ° socketï¼›</li></ul><h3 id="æ·»åŠ æ•°æ®åˆ°å‡ºç«™ç¼“å†²åŒº" tabindex="-1"><a class="header-anchor" href="#æ·»åŠ æ•°æ®åˆ°å‡ºç«™ç¼“å†²åŒº" aria-hidden="true">#</a> æ·»åŠ æ•°æ®åˆ°å‡ºç«™ç¼“å†²åŒº</h3><p>å‰é¢åˆ†æè¿‡ write æ–¹æ³•å°±æ˜¯å°†æ•°æ®å°è£…æˆä¸€ä¸ª Entry å¯¹è±¡ï¼Œæ·»åŠ åˆ°å‡ºç«™ç¼“å†²åŒºä¸­ï¼Œå°±æ˜¯å¯¹åº”çš„ ChannelOutboundBuffer#addMessage æ–¹æ³•</p><p><img src="/assets/image-20230603120237433-7a8e6f28.png" alt="image-20230603120237433"></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Add given message to this <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ChannelOutboundBuffer</span></span><span class="token punctuation">}</span>. The given <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ChannelPromise</span></span><span class="token punctuation">}</span> will be notified once
 * the message was written.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">msg</span> ä¸€èˆ¬æ˜¯ByteBufå¯¹è±¡ï¼Œ è¿™ä¸ªByteBufä¸€èˆ¬æ˜¯Directçš„
 * <span class="token keyword">@param</span> <span class="token parameter">size</span> æ•°æ®é‡å¤§å°
 * <span class="token keyword">@param</span> <span class="token parameter">promise</span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†æä¾›çš„æ¶ˆæ¯å°è£…ä¸ºä¸€ä¸ª Entry å¯¹è±¡</span>
    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token class-name">Entry</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token function">total</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åŒ…è£…çš„ entry å¯¹è±¡å‡å¦‚åˆ° entry é“¾è¡¨ä¸­ï¼Œè¡¨ç¤ºæ•°æ®å…¥ç«™åˆ°å‡ºç«™ç¼“å†²åŒº</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tailEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flushedEntry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†æ–°æ¶ˆæ¯èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—å°¾</span>
        <span class="token class-name">Entry</span> tail <span class="token operator">=</span> tailEntry<span class="token punctuation">;</span>
        tail<span class="token punctuation">.</span>next <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tailEntry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unflushedEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæœªåˆ·æ–°èŠ‚ç‚¹ä¸ºç©ºï¼Œè¯´æ˜é˜Ÿåˆ—èŠ‚ç‚¹éƒ½å˜æˆåˆ·æ–°èŠ‚ç‚¹äº†ï¼Œ</span>
        <span class="token comment">// é‚£ä¹ˆè¿™ä¸ªæ–°æ·»åŠ çš„èŠ‚ç‚¹ï¼Œå°±æ˜¯æœªåˆ·æ–°èŠ‚ç‚¹çš„å¤´äº†ã€‚</span>
        unflushedEntry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// increment pending bytes after adding message to the unflushed arrays.</span>
    <span class="token comment">// See https://github.com/netty/netty/issues/1619</span>
    <span class="token comment">// ç´¯åŠ å‡ºç«™ç¼“å†²åŒº æ€»å¤§å°</span>
    <span class="token function">incrementPendingOutboundBytes</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>pendingSize<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°å°±æ˜¯å•é“¾è¡¨çš„æ“ä½œï¼Œæ·»åŠ å…ƒç´ åˆ°å•é“¾è¡¨ï¼Œ</p><ul><li>tailEntry æŒ‡é’ˆæŒ‡å‘æœ€åä¸€ä¸ªå…ƒç´ ï¼›</li><li>unflushedEntryï¼šæŒ‡å‘é“¾è¡¨ä¸­ç¬¬ä¸€ä¸ªæœª flush åˆ°åº•å±‚ Socket çš„å¾…å‘é€æ•°æ®ï¼›</li></ul><p>æœ€ä¸‹é¢çš„ incrementPendingOutboundBytes æ–¹æ³•æ˜¯å¤„ç†é«˜ä½æ°´ä½çš„æ–¹æ³•ï¼Œåé¢å•ç‹¬åˆ†æï¼›</p><h3 id="å‡ºç«™ç¼“å†²åŒºåˆ·æ–°æ•°æ®çš„å‡†å¤‡å·¥ä½œ" tabindex="-1"><a class="header-anchor" href="#å‡ºç«™ç¼“å†²åŒºåˆ·æ–°æ•°æ®çš„å‡†å¤‡å·¥ä½œ" aria-hidden="true">#</a> å‡ºç«™ç¼“å†²åŒºåˆ·æ–°æ•°æ®çš„å‡†å¤‡å·¥ä½œ</h3><p>åœ¨åˆ†æ flush æ–¹æ³•ä¼ é€’çš„æ—¶å€™ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ AbstractUnsafe#flushï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢çš„æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assertEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelOutboundBuffer</span> outboundBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outboundBuffer<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outboundBuffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å†™ç¼“å†²åŒºä¸ºç©ºï¼Œç›´æ¥è¿”å›</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// é¢„å‡†å¤‡åˆ·æ–°å·¥ä½œ</span>
    <span class="token comment">// å°†flushedEntryæŒ‡å‘ç¬¬ä¸€ä¸ªéœ€è¦åˆ·æ–°çš„entryèŠ‚ç‚¹</span>
    <span class="token comment">// è®¡ç®—å‡º flushedEntry --&gt; taiLEntry ä¹‹é—´æ€»å…±æœ‰å¤šå°‘ä¸ªentryå¾…åˆ·æ–°ï¼Œå€¼èµ‹å€¼åˆ°flushedå­—æ®µå†…</span>
    outboundBuffer<span class="token punctuation">.</span><span class="token function">addFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">flush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨çœŸæ­£è°ƒç”¨ flush0 æ–¹æ³•åˆ·æ–°æ•°æ®å‰ï¼Œä¼šè°ƒç”¨ ChannelOutboundBuffer#addFlush åšå‡†å¤‡å·¥ä½œï¼Œå…¶å®å°±æ˜¯å‰é¢è¯´çš„é‚£äº›æŒ‡é’ˆçš„ç§»åŠ¨ï¼Œç„¶åè®¡ç®—æœ‰å¤šå°‘ä¸ª Entry éœ€è¦åˆ·æ–°ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æœªåˆ·æ–°èŠ‚ç‚¹åé¢çš„é“¾è¡¨ç¤ºæ–°æ·»åŠ çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œéƒ½æ˜¯è¦åŠ å…¥åˆ°åˆ·æ–°ä¸­</span>
    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> unflushedEntry<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flushedEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// there is no flushedEntry yet, so start with the entry</span>
            flushedEntry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            flushed <span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">// å°†æ‰€æœ‰è¦åˆ·æ–°çš„èŠ‚ç‚¹å˜æˆä¸å¯å–æ¶ˆçš„</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">.</span>promise<span class="token punctuation">.</span><span class="token function">setUncancellable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Was cancelled so make sure we free up memory and notify about the freed bytes</span>
                <span class="token keyword">int</span> pending <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æŒ‚èµ·æ¶ˆæ¯è¢«å–æ¶ˆï¼Œæ‰€ä»¥ç¡®ä¿æˆ‘ä»¬é‡Šæ”¾å†…å­˜å¹¶é€šçŸ¥é‡Šæ”¾çš„å­—èŠ‚</span>
                <span class="token function">decrementPendingOutboundBytes</span><span class="token punctuation">(</span>pending<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            entry <span class="token operator">=</span> entry<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// All flushed so reset unflushedEntry</span>
        <span class="token comment">// æ¯æ¬¡è®¾ç½®åéƒ½éœ€è¦æŠŠ unflushedEntry ç½®ä¸ºç©º</span>
        <span class="token comment">// åœ¨ä¸‹æ¬¡æ·»åŠ æ•°æ®æ—¶ï¼ŒunflushedEntry å°±æ˜¯æœ€å…ˆæ·»åŠ çš„ entry</span>
        unflushedEntry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªæ–¹æ³•ä¼šä» unflushedEntry æŒ‡é’ˆå¼€å§‹éå†ï¼Œè®°å½• unflushedEntry èŠ‚ç‚¹åˆ° tailEntry ä¹‹é—´æ€»å…±æœ‰å¤šå°‘ä¸ªèŠ‚ç‚¹ï¼Œç”¨ flushed å­—æ®µè®°å½•æ­¤æ¬¡åˆ·æ–°æœ‰å¤šå°‘ä¸ª Entry éœ€è¦åˆ·æ–°ï¼ˆè¿˜æœªå†²åˆ·å‡ºå»ï¼‰ã€‚</p><p>è¿™ä¸ªæ“ä½œå®Œåï¼ŒunflushedEntry ä¸º null äº†ï¼ŒflushedEntry æŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€ä¸ªè¦åˆ·æ–°çš„èŠ‚ç‚¹ã€‚</p><p><img src="/assets/image-20230603120414311-a4a7429c.png" alt="image-20230603120414311"></p><p>åœ¨æ¯æ¬¡éå†èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¼šå‡å°‘å‰é¢çš„ç´¯åŠ çš„å‡ºç«™ç¼“å†²åŒºçš„å¾…å‘é€æ•°æ®é‡ï¼Œä¹Ÿå°±æ˜¯ decrementPendingOutboundBytes æ–¹æ³•ï¼Œè¿™æ˜¯é«˜ä½æ°´ä½ç›¸å…³çš„æ“ä½œã€‚</p><p>ChannelOutboundBuffer#addFlush æ–¹æ³•èµ°å®Œåï¼Œå°±ä¼šè°ƒç”¨ AbstractUnsafe#flush0 æ–¹æ³•å»å‡†å¤‡åˆ·æ–°æ•°æ®äº†ï¼Œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;deprecation&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">flush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inFlush0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é˜²æ­¢é‡å¤åˆ·æ–°</span>
        <span class="token comment">// Avoid re-entrance</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token class-name">ChannelOutboundBuffer</span> outboundBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outboundBuffer<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outboundBuffer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> outboundBuffer<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å½“å‰å†™ç¼“å†²åŒºæ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¡¨ç¤ºå½“å‰Channelæ­£åœ¨æ‰§è¡Œåˆ·æ–°å·¥ä½œ</span>
    inFlush0 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// Mark all pending write requests as failure if the channel is inactive.</span>
    <span class="token comment">// å¦‚æœé€šé“å¤„äºéæ´»åŠ¨çŠ¶æ€ï¼Œåˆ™å°†æ‰€æœ‰æŒ‚èµ·çš„å†™è¯·æ±‚æ ‡è®°ä¸ºå¤±è´¥ã€‚</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// Check if we need to generate the exception at all.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outboundBuffer<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    outboundBuffer<span class="token punctuation">.</span><span class="token function">failFlushed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NotYetConnectedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Do not trigger channelWritabilityChanged because the channel is closed already.</span>
                    outboundBuffer<span class="token punctuation">.</span><span class="token function">failFlushed</span><span class="token punctuation">(</span><span class="token function">newClosedChannelException</span><span class="token punctuation">(</span>initialCloseCause<span class="token punctuation">,</span> <span class="token string">&quot;flush0()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            inFlush0 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ­£å¸¸é€»è¾‘ æ‰§è¡Œæ­¤å¤„</span>
        <span class="token function">doWrite</span><span class="token punctuation">(</span>outboundBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleWriteError</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ·æ–°æ“ä½œå®Œæˆï¼Œå°† inFlush0é‡æ–°è®¾ç½®ä¸º falseï¼Œä»¥ä¾¿ä¸‹æ¬¡åˆ·æ–°ã€‚</span>
        inFlush0 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AbstractUnsafe#flush0 ä¸»è¦æ˜¯åšåˆ·æ–°æ•°æ®å‰çš„ä¸€äº›æ ¡éªŒï¼š</p><ul><li>æ ¡éªŒå‡ºç«™ç¼“å†²åŒºé‡Œé¢æ˜¯å¦æœ‰æ•°æ®å¾…åˆ·æ–°ï¼›</li><li>Channel ä¸æ˜¯ active æ—¶ï¼Œéœ€è¦æ ‡è®°æœ¬æ¬¡åˆ·æ–°å¤±è´¥ï¼Œå°† ChannelOutboundBuffer ä¸­ flushedEntry ä¸tailEntry ä¹‹é—´çš„ Entry å¯¹è±¡èŠ‚ç‚¹å…¨éƒ¨åˆ é™¤ï¼Œå¹¶é‡Šæ”¾å‘é€æ•°æ®å ç”¨çš„å†…å­˜ç©ºé—´ï¼ŒåŒæ—¶å›æ”¶ Entry å¯¹è±¡å®ä¾‹ï¼›</li></ul><h3 id="å‡ºç«™ç¼“å†²åŒºçš„é«˜ä½æ°´ä½" tabindex="-1"><a class="header-anchor" href="#å‡ºç«™ç¼“å†²åŒºçš„é«˜ä½æ°´ä½" aria-hidden="true">#</a> å‡ºç«™ç¼“å†²åŒºçš„é«˜ä½æ°´ä½</h3><p>ä¸ºäº†æé«˜ç½‘ç»œçš„ååé‡ï¼Œåœ¨è°ƒç”¨ write çš„æ—¶å€™ï¼Œæ•°æ®å¹¶æ²¡æœ‰å†™åˆ° Socketï¼Œè€Œæ˜¯å†™åˆ°äº† ChannelOutboundBuffer è¿™é‡Œï¼Œå½“è°ƒç”¨ flush çš„æ—¶å€™ï¼Œæ‰çœŸæ­£çš„å‘ Socket å†™å‡ºã€‚å‡å¦‚ç”±äºé»˜å†™åŸå› å¯¼è‡´å®¢æˆ·ç«¯å¯¹ç½‘ç»œæ•°æ®çš„æ¥æ”¶é€Ÿåº¦ä»¥åŠå¤„ç†é€Ÿåº¦è¶Šæ¥è¶Šæ…¢ï¼Œè€Œ Netty æœåŠ¡ç«¯å´æœ‰å¤§é‡é¢‘ç¹çš„å†™æ“ä½œï¼Œä¸æ–­çš„å†™å…¥åˆ°å‡ºç«™ç¼“å†²åŒºä¸­ã€‚</p><p>è¿™æ ·æ— é™åˆ¶çš„æ·»åŠ æ•°æ®åˆ°å‡ºç«™ç¼“å†²åŒºï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´å †å¤–å†…å­˜æº¢å‡ºã€‚Netty çš„å‡ºç«™ç¼“å†²åŒºä½¿ç”¨ä¸€ä¸ªé«˜ä½æ°´ä½æ¥æ§åˆ¶ write æ“ä½œæ˜¯å¦å¯ä»¥æ·»åŠ æ•°æ®åˆ°å‡ºç«™ç¼“å†²åŒºã€‚</p><ul><li>å½“å¾…å‘é€çš„æ•°æ®å ç”¨çš„å†…å­˜ï¼ˆåŒ…æ‹¬ Entry å¯¹è±¡çš„å†…å­˜ï¼‰<strong>è¶…è¿‡é«˜æ°´ä½</strong>æ—¶ï¼Œè¯¥ Channel çš„å‡ºç«™ç¼“å†²åŒºä¼šè¢«<strong>æ ‡è®°ä¸ºä¸å¯å†™çŠ¶æ€ï¼›</strong></li><li>å½“å¾…å‘é€çš„æ•°æ®å ç”¨çš„å†…å­˜ï¼ˆåŒ…æ‹¬ Entry å¯¹è±¡çš„å†…å­˜ï¼‰<strong>ä½äºä½æ°´ä½</strong>æ—¶ï¼Œè¯¥ Channel çš„å‡ºç«™ç¼“å†²åŒºä¼š<strong>æ¢å¤ä¸ºå¯å†™çŠ¶æ€ï¼›</strong></li></ul><p><strong>åœ¨ Netty ä¸­çš„é»˜è®¤é«˜æ°´ä½æ˜¯ 64 * 1024ï¼Œé»˜è®¤ä½æ°´ä½æ˜¯ 32 * 1024</strong>ã€‚åœ¨ WriteBufferWaterMark ç±»ä¸­å®šä¹‰çš„ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WriteBufferWaterMark</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_LOW_WATER_MARK</span> <span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_HIGH_WATER_MARK</span> <span class="token operator">=</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">WriteBufferWaterMark</span> <span class="token constant">DEFAULT</span> <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">WriteBufferWaterMark</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_LOW_WATER_MARK</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_HIGH_WATER_MARK</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> low<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> high<span class="token punctuation">;</span>

	<span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‰é¢è¯´è¿‡ï¼ŒChannelOutboundBuffer ä¸­æœ‰ä¸€ä¸ª totalPendingSize å­—æ®µï¼Œè¿™ä¸ªå­—æ®µä¿å­˜çš„æ˜¯å½“å‰å‡ºç«™ç¼“å†²åŒºå ç”¨çš„å†…å­˜å¤§å°ï¼ŒåŒ…æ‹¬çœŸæ­£å¾…åˆ·æ–°çš„æ•°æ®å’Œé“¾è¡¨èŠ‚ç‚¹ Entry å¯¹è±¡æœ¬èº«å ç”¨çš„å¤§å°ã€‚</p><blockquote><p>ä¸ºä»€ä¹ˆè¯´æ˜¯åŒ…å«äº† Entry å¯¹è±¡è‡ªèº«å ç”¨çš„å¤§å°å‘¢ï¼Ÿ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">Entry</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">long</span> total<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// ...... çœç•¥ ......</span>
    
    <span class="token comment">// åŠ ä¸Šæœ¬èº«çš„ 96 çš„å¤§å°</span>
    entry<span class="token punctuation">.</span>pendingSize <span class="token operator">=</span> size <span class="token operator">+</span> <span class="token constant">CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ...... çœç•¥ ......</span>
    <span class="token keyword">return</span> entry<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD è¿™ä¸ªé»˜è®¤å€¼æ˜¯ 96ï¼Œå¯é…ç½®</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// Assuming a 64-bit JVM:</span>
<span class="token comment">//  - 16 bytes object header</span>
<span class="token comment">//  - 6 reference fields</span>
<span class="token comment">//  - 2 long fields</span>
<span class="token comment">//  - 2 int fields</span>
<span class="token comment">//  - 1 boolean field</span>
<span class="token comment">//  - padding</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD</span> <span class="token operator">=</span>
        <span class="token class-name">SystemPropertyUtil</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;io.netty.transport.outboundBufferEntrySizeOverhead&quot;</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><p>æ¯æ¬¡è§¦å‘ write äº‹ä»¶ä¼šç´¯åŠ  totalPendingSize çš„å€¼ï¼Œæ¯æ¬¡è§¦å‘ flush äº‹ä»¶ä¼šå‡å°‘ totalPendingSize çš„å€¼ï¼Œæ‹¿ totalPendingSize çš„å€¼å»å’Œå‡ºç«™ç¼“å†²åŒºé«˜ä½æ°´ä½åšæ¯”è¾ƒã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">incrementPendingOutboundBytes</span><span class="token punctuation">(</span><span class="token keyword">long</span> size<span class="token punctuation">,</span> <span class="token keyword">boolean</span> invokeLater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// CASç´¯åŠ  totalPendingSize</span>
    <span class="token keyword">long</span> newWriteBufferSize <span class="token operator">=</span> <span class="token constant">TOTAL_PENDING_SIZE_UPDATER</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœç´¯åŠ å®Œä¹‹åçš„å€¼å¤§äºå‡ºç«™ç¼“å†²åŒºé«˜æ°´ä½çº¿ï¼Œåˆ™è®¾ç½®unwriteableå­—æ®µè¡¨ç¤ºä¸å¯å†™ï¼Œå¹¶ä¸”å‘ChannelPipelineå‘èµ·unwriteableæ›´æ”¹äº‹ä»¶</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newWriteBufferSize <span class="token operator">&gt;</span> channel<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteBufferHighWaterMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setUnwritable</span><span class="token punctuation">(</span>invokeLater<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">decrementPendingOutboundBytes</span><span class="token punctuation">(</span><span class="token keyword">long</span> size<span class="token punctuation">,</span> <span class="token keyword">boolean</span> invokeLater<span class="token punctuation">,</span> <span class="token keyword">boolean</span> notifyWritability<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> newWriteBufferSize <span class="token operator">=</span> <span class="token constant">TOTAL_PENDING_SIZE_UPDATER</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">-</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœç¼“å†²æ€»æ•°æ®çš„å¤§å°å°äºä½æ°´ä½ï¼Œåˆ™è§¦å‘äº‹ä»¶</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>notifyWritability <span class="token operator">&amp;&amp;</span> newWriteBufferSize <span class="token operator">&lt;</span> channel<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteBufferLowWaterMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setWritable</span><span class="token punctuation">(</span>invokeLater<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“å¾…å‘é€çš„æ•°æ®å ç”¨çš„å†…å­˜ï¼ˆåŒ…æ‹¬ Entry å¯¹è±¡çš„å†…å­˜ï¼‰<strong>è¶…è¿‡é«˜æ°´ä½</strong>æ—¶ï¼Œå°±ä¼šè°ƒç”¨ setUnwritable æ–¹æ³•è®¾ç½® unwritable çš„å€¼ã€‚æœ€ç»ˆä¼šè°ƒç”¨è§¦å‘å…¥ç«™äº‹ä»¶ <code>pipeline.fireChannelWritabilityChanged()</code>ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setUnwritable</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> invokeLater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> oldValue <span class="token operator">=</span> unwritable<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> newValue <span class="token operator">=</span> oldValue <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UNWRITABLE_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">fireChannelWritabilityChanged</span><span class="token punctuation">(</span>invokeLater<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“å¾…å‘é€çš„æ•°æ®å ç”¨çš„å†…å­˜ï¼ˆåŒ…æ‹¬ Entry å¯¹è±¡çš„å†…å­˜ï¼‰<strong>ä½äºä½æ°´ä½</strong>æ—¶ï¼Œè¯¥ Channel çš„å‡ºç«™ç¼“å†²åŒºä¼š<strong>æ¢å¤ä¸ºå¯å†™çŠ¶æ€</strong>ï¼Œä¹Ÿæ˜¯ä¿®æ”¹ unwritable çš„å€¼ã€‚æœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨è§¦å‘å…¥ç«™äº‹ä»¶ <code>pipeline.fireChannelWritabilityChanged()</code>ã€‚</p><blockquote><p>æ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯æ”¹äº† unwritable å±æ€§çš„å€¼ï¼Œ<strong>åœ¨ write å†™æ•°æ®çš„æ—¶å€™éœ€è¦åˆ¤æ–­è¿™ä¸ª unwritable çš„å€¼ï¼Œå¦åˆ™é«˜ä½æ°´ä½çš„é™åˆ¶æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚</strong></p></blockquote><h2 id="çœŸæ­£å‘é€æ•°æ®æµç¨‹" tabindex="-1"><a class="header-anchor" href="#çœŸæ­£å‘é€æ•°æ®æµç¨‹" aria-hidden="true">#</a> çœŸæ­£å‘é€æ•°æ®æµç¨‹</h2><p>çœŸæ­£å‘é€æ•°æ®çš„åœ°æ–¹åœ¨ NioSocketChannel#doWrite æ–¹æ³•ã€‚åœ¨åˆ†æ doWrite æ–¹æ³•å‰ï¼Œå…ˆé€šè¿‡ä¸€ä¸ªæµç¨‹å›¾æ¥æ•´ä½“äº†è§£ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„æµç¨‹ã€‚</p><p><img src="/assets/NioSocketChannelçš„doWriteçš„æµç¨‹å›¾-8fe760ea.png" alt="NioSocketChannelçš„doWriteçš„æµç¨‹å›¾"></p><p>æ•´ä½“ä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * å…¥å‚æ˜¯å½“å‰ Channel çš„å‡ºç«™ç¼“å†²åŒºçš„å¼•ç”¨
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–å±æ€§é…ç½®writeSpinCount å¾ªç¯å†™çš„æœ€å¤§æ¬¡æ•° é»˜è®¤16</span>
    <span class="token comment">// æ§åˆ¶å†™å¾ªç¯æ¬¡æ•°ï¼Œé»˜è®¤æœ€å¤§å…è®¸å†™ 16 æ¬¡</span>
    <span class="token keyword">int</span> writeSpinCount <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteSpinCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç¼“å­˜ä¸­æ•°æ®ä¸ºç©ºï¼Œæ²¡æœ‰æ•°æ®å¯å†™</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// All written so clear OP_WRITE</span>
            <span class="token comment">// æ­£å¸¸é€€å‡º doWrite èµ°è¿™é‡Œ</span>
            <span class="token comment">// ç§»é™¤å†™äº‹ä»¶ï¼Œå¹¶ç›´æ¥è¿”å›ï¼Œç§»é™¤å½“å‰channel æ³¨å†Œåˆ°çš„selectorä¸Šçš„OP_WRITEäº‹ä»¶</span>
            <span class="token function">clearOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Directly return here so incompleteWrite(...) is not called.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜å½“å‰ Channel çš„å‡ºç«™ç¼“å†²åŒºé‡Œé¢è¿˜æœ‰å‰©ä½™çš„entryå¾…åˆ·æ–°</span>

        <span class="token comment">// Ensure the pending writes are made of ByteBufs only.</span>
        <span class="token comment">// è·å–ä¸€æ¬¡æœ€å¤§å¯å†™å­—èŠ‚æ•° é™å®šæ¯æ¬¡ä»å‡ºç«™ç¼“å†²åŒºå†…è½¬æ¢å¤šå°‘ByteBufå­—èŠ‚æ•°æ®çš„ä¸€ä¸ªå˜é‡ï¼Œè¯¥å˜é‡ä¼šéšç€ Channel çš„çŠ¶æ€ä¸æ–­å˜åŒ–</span>
        <span class="token keyword">int</span> maxBytesPerGatheringWrite <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation">)</span> config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å°†å‡ºç«™ç¼“å†²åŒºçš„éƒ¨åˆ† Entry.msg è½¬æ¢ä¸ºJDK Channelä¾èµ–çš„æ ‡å‡†å¯¹è±¡ByteBuffer è¿™é‡Œè¿”å›çš„æ˜¯æ•°ç»„</span>
        <span class="token comment">// å‚æ•°1ï¼šæœ€å¤šè½¬æ¢1024ä¸ª ByteBuffer å¯¹è±¡</span>
        <span class="token comment">// å‚æ•°2ï¼šnioBuffersæ–¹æ³•æœ€å¤šè½¬æ¢ maxBytes ä¸ªå­—èŠ‚çš„ ByteBuf å¯¹è±¡</span>
        <span class="token comment">// maxBytesPerGatheringWrite è¡¨ç¤ºæœ¬æ¬¡ write loop ä¸­æœ€å¤šä» ChannelOutboundBuffer ä¸­</span>
        <span class="token comment">// è½¬æ¢ maxBytesPerGatheringWrite ä¸ªå­—èŠ‚å‡ºæ¥ã€‚ä¹Ÿå°±æ˜¯æœ¬æ¬¡ write loop æœ€å¤šèƒ½å‘é€å¤šå°‘å­—èŠ‚</span>
        <span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nioBuffers <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBuffers</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> maxBytesPerGatheringWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> nioBufferCnt <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBufferCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Always use nioBuffers() to workaround data-corruption.</span>
        <span class="token comment">// See https://github.com/netty/netty/issues/2761</span>
        <span class="token comment">// ç¼“å­˜ä¸­æœ‰å¤šå°‘ä¸ªnioBufferCnt</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>nioBufferCnt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                <span class="token comment">// We have something else beside ByteBuffers to write so fallback to normal writes.</span>
                <span class="token comment">// ä¸æ˜¯ByteBufferæ•°æ®ï¼Œäº¤ç»™çˆ¶ç±»å®ç°</span>
                writeSpinCount <span class="token operator">-=</span> <span class="token function">doWrite0</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token comment">// Only one ByteBuf so use non-gathering write</span>
                <span class="token comment">// Zero length buffers are not added to nioBuffers by ChannelOutboundBuffer, so there is no need</span>
                <span class="token comment">// to check if the total size of all the buffers is non-zero.</span>
                <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> nioBuffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">// bufferå¯è¯»å­—èŠ‚</span>
                <span class="token keyword">int</span> attemptedBytes <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å°†bufferå†™åˆ°åˆ°Socketç¼“å­˜ä¸­ï¼Œæœ‰å¯èƒ½å…¨éƒ¨å†™è¿›å»äº†ï¼Œä¹Ÿæœ‰å¯èƒ½å†™äº†ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæœ‰å¯èƒ½å…¨éƒ¨å†™å¤±è´¥çš„</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> localWrittenBytes <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å‘é€å¤±è´¥ï¼Œè¯´æ˜åº•å±‚ socket å†™ç¼“å†²åŒºå·²ç»æ»¡äº†ï¼Œæœ¬æ¬¡ write æ²¡å†™è¿›å»</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>localWrittenBytes <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å°†å†™äº‹ä»¶æ·»åŠ åˆ°äº‹ä»¶å…´è¶£é›†ä¸­ï¼Œç­‰å¾…socket å†™ç¼“å†²åŒºæœ‰ç©ºé—²ç©ºé—´åï¼Œç»§ç»­å†™</span>
                    <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ buffer å¯èƒ½æ•°æ®å…¨éƒ¨å†™å…¥åˆ° socket ç¼“å­˜åŒºï¼Œä¹Ÿå¯èƒ½å†™äº†ä¸€éƒ¨åˆ†æ•°æ®åˆ° socket ç¼“å­˜åŒº</span>
                <span class="token function">adjustMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span>attemptedBytes<span class="token punctuation">,</span> localWrittenBytes<span class="token punctuation">,</span> maxBytesPerGatheringWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// ç§»é™¤å†™æˆåŠŸçš„å­—èŠ‚æ•°</span>
                in<span class="token punctuation">.</span><span class="token function">removeBytes</span><span class="token punctuation">(</span>localWrittenBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">--</span>writeSpinCount<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token comment">// Zero length buffers are not added to nioBuffers by ChannelOutboundBuffer, so there is no need</span>
                <span class="token comment">// to check if the total size of all the buffers is non-zero.</span>
                <span class="token comment">// We limit the max amount to int above so cast is safe</span>
                <span class="token keyword">long</span> attemptedBytes <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> localWrittenBytes <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>nioBuffers<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nioBufferCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>localWrittenBytes <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// Casting to int is safe because we limit the total amount of data in the nioBuffers to int above.</span>
                <span class="token function">adjustMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> attemptedBytes<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> localWrittenBytes<span class="token punctuation">,</span>
                        maxBytesPerGatheringWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
                in<span class="token punctuation">.</span><span class="token function">removeBytes</span><span class="token punctuation">(</span>localWrittenBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">--</span>writeSpinCount<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>writeSpinCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œdo whileå¾ªç¯äº†16æ¬¡ï¼Œä»ç„¶æ²¡æœ‰æŠŠ å‡ºç«™ç¼“å†²åŒº å¾…å‘é€çš„æ•°æ®å¤„ç†å®Œ</span>
    <span class="token comment">//</span>
    <span class="token function">incompleteWrite</span><span class="token punctuation">(</span>writeSpinCount <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è·å–-netty-å…è®¸å†™å¾ªç¯çš„æ¬¡æ•°" tabindex="-1"><a class="header-anchor" href="#è·å–-netty-å…è®¸å†™å¾ªç¯çš„æ¬¡æ•°" aria-hidden="true">#</a> è·å– Netty å…è®¸å†™å¾ªç¯çš„æ¬¡æ•°</h3><p>ç¬¬ä¸€æ­¥è·å– Netty çš„å…è®¸çš„æœ€å¤§å†™å¾ªç¯æ¬¡æ•°ï¼Œå› ä¸ºä¸€ä¸ª Reactor çº¿ç¨‹çš„ Selector ä¸Šä¼šå¤„ç†å¤šä¸ª Channel çš„äº‹ä»¶ï¼Œæ‰€ä»¥å¾—é™åˆ¶ä¸€æ¬¡è¯»å¾ªç¯çš„æ¬¡æ•°ï¼Œä¸èƒ½ä¸€ç›´åœ¨å¤„ç†æŸä¸ª Channel ä¸Šçš„äº‹ä»¶ï¼Œå¦åˆ™å…¶ä»– Channel ä¸Šçš„äº‹ä»¶æ‰§è¡Œç­‰å¾…çš„æ—¶é—´å¯èƒ½å°±æ¯”è¾ƒé•¿ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">int</span> writeSpinCount <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteSpinCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="do-while-å‡ºç«™ç¼“å†²åŒºæ•°æ®å†™å®Œåé€€å‡º" tabindex="-1"><a class="header-anchor" href="#do-while-å‡ºç«™ç¼“å†²åŒºæ•°æ®å†™å®Œåé€€å‡º" aria-hidden="true">#</a> do...whileï¼šå‡ºç«™ç¼“å†²åŒºæ•°æ®å†™å®Œåé€€å‡º</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç¼“å­˜ä¸­æ•°æ®ä¸ºç©ºï¼Œæ²¡æœ‰æ•°æ®å¯å†™</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// All written so clear OP_WRITE</span>
            <span class="token comment">// æ­£å¸¸é€€å‡º doWrite èµ°è¿™é‡Œ</span>
            <span class="token comment">// ç§»é™¤å†™äº‹ä»¶ï¼Œå¹¶ç›´æ¥è¿”å›ï¼Œç§»é™¤å½“å‰channel æ³¨å†Œåˆ°çš„selectorä¸Šçš„OP_WRITEäº‹ä»¶</span>
            <span class="token function">clearOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Directly return here so incompleteWrite(...) is not called.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>writeSpinCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæ˜¯å°†å‡ºç«™ç¼“å†²åŒºä¸­è¦åˆ·æ–°çš„æ•°æ®å…¨éƒ¨å†™å…¥åˆ° Socket åçš„å‡ºå£ï¼Œä¸€èˆ¬æƒ…å†µéƒ½æ˜¯ä»è¿™é‡Œé€€å‡ºå¾ªç¯çš„ã€‚</p><p>å…³äº ChannelOutboundBuffer#isEmpty æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯åˆ¤æ–­ flushed å­—æ®µæ˜¯å¦æ˜¯ 0ï¼Œå‰é¢åˆ†æè¿‡ flushed å°±æ˜¯è¡¨ç¤ºå½“å‰å‡ºç«™ç¼“å†²åŒºä¸­æœ‰å¤šå°‘ä¸ª Entry å¯¹è±¡éœ€è¦åˆ·æ–°ï¼Œæ˜¯åœ¨ ChannelOutboundBuffer#addFlush ä¸­ç´¯åŠ çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> flushed <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœå‡ºç«™ç¼“å†²åŒºçš„æ•°æ®å·²ç»åˆ·æ–°å®Œäº†ï¼Œå°±æ¸…é™¤å½“å‰ Channel æ³¨å†Œåˆ° Selector ä¸Šçš„å†™äº‹ä»¶ã€‚åé¢è§£é‡Šä¸ºä»€ä¹ˆè¦æ¸…é™¤å†™äº‹ä»¶ã€‚</p><h3 id="do-while-è·å–æ­¤æ¬¡å¾ªç¯èƒ½å¤Ÿå†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°" tabindex="-1"><a class="header-anchor" href="#do-while-è·å–æ­¤æ¬¡å¾ªç¯èƒ½å¤Ÿå†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°" aria-hidden="true">#</a> do...whileï¼šè·å–æ­¤æ¬¡å¾ªç¯èƒ½å¤Ÿå†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
        
        <span class="token comment">// è·å–ä¸€æ¬¡æœ€å¤§å¯å†™å­—èŠ‚æ•° é™å®šæ¯æ¬¡ä»å‡ºç«™ç¼“å†²åŒºå†…è½¬æ¢å¤šå°‘ByteBufå­—èŠ‚æ•°æ®çš„ä¸€ä¸ªå˜é‡ï¼Œè¯¥å˜é‡ä¼šéšç€ Channel çš„çŠ¶æ€ä¸æ–­å˜åŒ–</span>
        <span class="token keyword">int</span> maxBytesPerGatheringWrite <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation">)</span> config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>writeSpinCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>é¦–å…ˆéœ€è¦è·å–æ­¤æ¬¡èƒ½å¤Ÿå†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">int</span> maxBytesPerGatheringWrite <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation">)</span> config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>é»˜è®¤æ˜¯ SocketOptions#SO_SNDBUF çš„ä¸¤å€ã€‚åœ¨ Netty ä¸­ SO_SNDBUF åˆå§‹å¤§å°æ˜¯ 131072ï¼Œä¸¤å€å°±æ˜¯ 262144ã€‚ä¹Ÿå°±æ˜¯è¯´ maxBytesPerGatheringWrite é»˜è®¤åˆå§‹å¤§å°æ˜¯ 262144ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">calculateMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Multiply by 2 to give some extra space in case the OS can process write data faster than we can provide.</span>
    <span class="token keyword">int</span> newSendBufferSize <span class="token operator">=</span> <span class="token function">getSendBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newSendBufferSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span>newSendBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="do-while-å¾…å‘é€æ•°æ®è½¬æ¢ä¸º-bytebuffer" tabindex="-1"><a class="header-anchor" href="#do-while-å¾…å‘é€æ•°æ®è½¬æ¢ä¸º-bytebuffer" aria-hidden="true">#</a> do...whileï¼šå¾…å‘é€æ•°æ®è½¬æ¢ä¸º ByteBuffer</h3><blockquote><p>æœ¬å°ç»“åªéœ€è¦äº†è§£ä¼šå°†å¾…å‘é€çš„æ•°æ®è½¬æ¢ä¸º ByteBuffer å³å¯ã€‚</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
        
        <span class="token comment">// å°†å‡ºç«™ç¼“å†²åŒºçš„éƒ¨åˆ† Entry.msg è½¬æ¢ä¸ºJDK Channelä¾èµ–çš„æ ‡å‡†å¯¹è±¡ByteBuffer è¿™é‡Œè¿”å›çš„æ˜¯æ•°ç»„</span>
        <span class="token comment">// å‚æ•°1ï¼šæœ€å¤šè½¬æ¢1024ä¸ª ByteBuffer å¯¹è±¡</span>
        <span class="token comment">// å‚æ•°2ï¼šnioBuffersæ–¹æ³•æœ€å¤šè½¬æ¢ maxBytes ä¸ªå­—èŠ‚çš„ ByteBuf å¯¹è±¡</span>
        <span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nioBuffers <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBuffers</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> maxBytesPerGatheringWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>writeSpinCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å› ä¸ºæœ€ç»ˆæ•°æ®æ˜¯è¦å†™å…¥åˆ° Socket é‡Œé¢çš„ï¼Œéœ€è¦å°†å‡ºç«™ç¼“å†²åŒºçš„æ•°æ®è½¬æ¢ä¸º JDK çš„ ByteBuffer å¯¹è±¡å†™å…¥ã€‚</p><p>ChannelOutboundBuffer#nioBuffers(int, long) çš„ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li><code>maxCount</code>ï¼šé»˜è®¤ 1024ï¼Œè¡¨ç¤ºæ­¤æ¬¡å¾ªç¯æœ€å¤šåªèƒ½è½¬æ¢ 1024 ä¸ª JDK çš„ ByteBuffer å¯¹è±¡ï¼›</li><li><code>maxBytesPerGatheringWrite</code>ï¼šè¡¨ç¤ºæ­¤æ¬¡æœ€å¤šåªèƒ½è½¬æ¢å¤šå°‘ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰å†™å¾ªç¯æœ€å¤šèƒ½å¤Ÿå‘é€å¤šå°‘å­—èŠ‚ï¼›</li></ul><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯ï¼šä» flushedEntry èŠ‚ç‚¹å¼€å§‹éå†ï¼Œç›´åˆ°éå†å®Œæˆ–è€…é‡åˆ°äº† unflushedEntry èŠ‚ç‚¹å°±é€€å‡ºï¼Œå…·ä½“å¯¹æ¯ä¸ª Entry èŠ‚ç‚¹åšçš„äº‹æƒ…å°±æ˜¯ï¼š</p><ol><li>ç´¯åŠ å¯å‘é€çš„å­—èŠ‚æ•°ï¼›</li><li>è®°å½•éå†åˆ°çš„ Entry ä¸­çš„ count å­—æ®µï¼Œè¿™ä¸ªå­—æ®µå‰é¢è¯´è¿‡ï¼Œè¡¨ç¤ºå½“å‰ msg byteBuf åº•å±‚ç”±å¤šå°‘ ByteBufferç»„æˆï¼Œä¸€èˆ¬éƒ½æ˜¯ 1ï¼Œç‰¹æ®Šæƒ…å†µæ˜¯ CompositeByteBuf åº•å±‚å¯ä»¥ç”±å¤šä¸ª ByteBuf ç»„æˆï¼› <ol><li>å‡å¦‚æ˜¯ 1 ä¸ª ByteBuffer ç»„æˆï¼Œå°±ç”¨ Entry çš„ <code>ByteBuffer buf</code> å­—æ®µä¿å­˜ ByteBufferï¼›</li><li>å‡å¦‚æ˜¯å¤šä¸ª ByteBuffer ç»„æˆï¼Œå°±ç”¨ Entry çš„ <code>ByteBuffer[] bufs</code> å­—æ®µä¿å­˜ ByteBufferï¼›</li></ol></li></ol><p>å½“æ•´ä¸ªéå†èŠ‚ç‚¹ç»“æŸï¼Œæˆ–è€…åˆ°äº† ByteBuffer çš„é™åˆ¶ï¼Œæˆ–è€…åˆ°äº† maxBytesPerGatheringWrite çš„é™åˆ¶ï¼Œæœ€åå°±èƒ½å¾—åˆ°ä¸‹é¢ä¸¤ä¸ªChannelOutboundBuffer çš„å­—æ®µçš„å€¼ï¼š</p><ul><li><code>int nioBufferCount</code>ï¼šå½“å‰å‡ºç«™ç¼“å†²åŒºæœ‰å¤šå°‘ä¸ª ByteBuffer æ­£åœ¨ç­‰å¾…å‡ºç«™ï¼›</li><li><code>long nioBufferSize</code>ï¼šå½“å‰å‡ºç«™ç¼“å†²åŒºæœ‰å¤šå°‘ä¸ªå­—èŠ‚çš„æ•°æ®æ­£åœ¨ç­‰å¾…å‡ºç«™ï¼›</li></ul><p>å…¨éƒ¨ä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">nioBuffers</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxCount<span class="token punctuation">,</span> <span class="token keyword">long</span> maxBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> maxCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span> maxBytes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// æœ¬æ¬¡æ–¹æ³•è°ƒç”¨ä¸€å…±è½¬æ¢äº†å¤šå°‘å®¹é‡çš„buffer</span>
    <span class="token keyword">long</span> nioBufferSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// æœ¬æ¬¡æ–¹æ³•è°ƒç”¨ï¼Œä¸€å…±å°†ByteBufè½¬æ¢æˆå¤šå°‘ä¸ªByteBufferå¯¹è±¡</span>
    <span class="token keyword">int</span> nioBufferCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">InternalThreadLocalMap</span> threadLocalMap <span class="token operator">=</span> <span class="token class-name">InternalThreadLocalMap</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä»çº¿ç¨‹æœ¬åœ°ç¼“å­˜è·å– ByteBuffer æ•°ç»„ï¼Œä¼šç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ª1024çš„ByteBufferæ•°ç»„ï¼Œé¿å…æ¯ä¸ªçº¿ç¨‹æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºä¸€ä¸ªByteBufferæ•°ç»„</span>
    <span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nioBuffers <span class="token operator">=</span> <span class="token constant">NIO_BUFFERS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>threadLocalMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¾ªç¯å¤„ç†å¼€å§‹èŠ‚ç‚¹ï¼Œå‡†å¤‡ç¬¬ä¸€ä¸ªå†™å…¥ Socket çš„å…ƒç´ </span>
    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> flushedEntry<span class="token punctuation">;</span>
    <span class="token comment">// å¾ªç¯æ¡ä»¶ å½“å‰èŠ‚ç‚¹ä¸æ˜¯ null &amp;&amp; å½“å‰èŠ‚ç‚¹ä¸æ˜¯ unflushedEntry æŒ‡å‘çš„èŠ‚ç‚¹</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isFlushedEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> entry<span class="token punctuation">.</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¡ä»¶æˆç«‹ï¼Œåˆ™è¯´æ˜å½“å‰ entry èŠ‚ç‚¹ä¸æ˜¯å–æ¶ˆçŠ¶æ€ï¼Œæ‰€ä»¥éœ€è¦æå–å®ƒçš„æ•°æ®</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">.</span>cancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> entry<span class="token punctuation">.</span>msg<span class="token punctuation">;</span>
            <span class="token comment">// è·å–è¯»ç´¢å¼•ä½ç½®</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> readerIndex <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">readerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æœ‰æ•ˆæ•°æ®é‡ï¼Œå¯å‘é€çš„å­—èŠ‚æ•°</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> readableBytes <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">writerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> readerIndex<span class="token punctuation">;</span>

            <span class="token comment">// æ¡ä»¶æˆç«‹ è¯´æ˜msgåŒ…å«å¾…å‘é€æ•°æ®...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>readableBytes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// nioBufferSize + readableBytes &gt; maxBytes</span>
                <span class="token comment">// æœ¬æ¬¡è°ƒç”¨å·²è½¬æ¢Bufferå®¹é‡å¤§å° + æœ¬æ¬¡å¾ªç¯è½¬æ¢å¤§å° &gt; æœ€å¤§é™åˆ¶ï¼Œåˆ™è·³å‡ºå¾ªç¯</span>
                <span class="token comment">// ç´¯è®¡å‘é€å­—èŠ‚æ•°ä¸èƒ½å¤§äº maxBytes</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>maxBytes <span class="token operator">-</span> readableBytes <span class="token operator">&lt;</span> nioBufferSize <span class="token operator">&amp;&amp;</span> nioBufferCount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// æ­£å¸¸é€»è¾‘èµ°åˆ°æ­¤å¤„</span>

                <span class="token comment">// æ›´æ–°ç´¯è®¡å‘é€å­—èŠ‚æ•°</span>
                nioBufferSize <span class="token operator">+=</span> readableBytes<span class="token punctuation">;</span>
                <span class="token comment">// ä¸€èˆ¬æƒ…å†µä¸‹ counté»˜è®¤å€¼ -1</span>
                <span class="token keyword">int</span> count <span class="token operator">=</span> entry<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//noinspection ConstantValueVariableUse</span>
                    <span class="token comment">// è·å–èŠ‚ç‚¹ä¸­ bytebuffer çš„ä¸ªæ•°ï¼Œï¼Œè·å–å‡ºByteBufåº•å±‚åˆ°åº•æ˜¯ç”±å‡ ä¸ªByteBufferæ„æˆçš„ï¼Œè¿™é‡Œmsgéƒ½æ˜¯direct bytebuf</span>
                    <span class="token comment">// ä¸€èˆ¬æƒ…å†µä¸‹è¿”å›çš„1ï¼Œç‰¹æ®Šæƒ…å†µCompositeByteBuf</span>
                    entry<span class="token punctuation">.</span>count <span class="token operator">=</span> count <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">nioBufferCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// è®¡ç®—å‡ºéœ€è¦å¤šå¤§çš„ByteBufferæ•°ç»„</span>
                <span class="token keyword">int</span> neededSpace <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>maxCount<span class="token punctuation">,</span> nioBufferCount <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>neededSpace <span class="token operator">&gt;</span> nioBuffers<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å‡å¦‚éœ€è¦çš„ æ•°ç»„å¤§å° &gt; é»˜è®¤çš„ 1024 çš„è¯ï¼Œåˆ™æ‰©å®¹æ“ä½œ</span>
                    nioBuffers <span class="token operator">=</span> <span class="token function">expandNioBufferArray</span><span class="token punctuation">(</span>nioBuffers<span class="token punctuation">,</span> neededSpace<span class="token punctuation">,</span> nioBufferCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token constant">NIO_BUFFERS</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>threadLocalMap<span class="token punctuation">,</span> nioBuffers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// å¤§éƒ¨åˆ†æƒ…å†µ count == 1</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ByteBuffer</span> nioBuf <span class="token operator">=</span> entry<span class="token punctuation">.</span>buf<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>nioBuf <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// cache ByteBuffer as it may need to create a new ByteBuffer instance if its a</span>
                        <span class="token comment">// derived buffer</span>
                        <span class="token comment">// è·å–ByteBufåº•å±‚çœŸæ­£å†…å­˜ ByteBufferå¯¹è±¡</span>
                        <span class="token comment">// å‚æ•°1ï¼šè¯»ç´¢å¼•</span>
                        <span class="token comment">// å‚æ•°2ï¼šå¯è¯»æ•°æ®å®¹é‡</span>
                        entry<span class="token punctuation">.</span>buf <span class="token operator">=</span> nioBuf <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">internalNioBuffer</span><span class="token punctuation">(</span>readerIndex<span class="token punctuation">,</span> readableBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// å°†åˆšåˆšè½¬æ¢å‡ºæ¥çš„ByteBufferå¯¹è±¡åŠ å…¥åˆ°æ•°ç»„</span>
                    nioBuffers<span class="token punctuation">[</span>nioBufferCount<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> nioBuf<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// The code exists in an extra method to ensure the method is not too big to inline as this</span>
                    <span class="token comment">// branch is not very likely to get hit very frequently.</span>
                    <span class="token comment">// å¦‚æœæœ‰å¤šä¸ªå¾ªç¯è·å– ByteBuffer å­˜åˆ° niobuffers æ•°ç»„ä¸­</span>
                    nioBufferCount <span class="token operator">=</span> <span class="token function">nioBuffers</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> nioBuffers<span class="token punctuation">,</span> nioBufferCount<span class="token punctuation">,</span> maxCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nioBufferCount <span class="token operator">&gt;=</span> maxCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// èŠ‚ç‚¹æŒ‡é’ˆåç§»</span>
        entry <span class="token operator">=</span> entry<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å‡ºç«™ç¼“å†²åŒºè®°å½• æœ‰å¤šå°‘ byteBuffer ç­‰å¾…å‡ºç«™</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nioBufferCount <span class="token operator">=</span> nioBufferCount<span class="token punctuation">;</span>
    <span class="token comment">// å‡ºç«™ç¼“å†²åŒºè®°å½• æœ‰å¤šå°‘å­—èŠ‚çš„ byteBuffer å¾…å‡ºç«™</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nioBufferSize <span class="token operator">=</span> nioBufferSize<span class="token punctuation">;</span>

    <span class="token comment">// è¿”å›ä»entryé“¾è¡¨ä¸­æå–çš„bufferæ•°ç»„</span>
    <span class="token keyword">return</span> nioBuffers<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="do-while-å‘é€æ•°æ®åˆ°-socket" tabindex="-1"><a class="header-anchor" href="#do-while-å‘é€æ•°æ®åˆ°-socket" aria-hidden="true">#</a> do...whileï¼šå‘é€æ•°æ®åˆ° Socket</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>

        <span class="token keyword">int</span> nioBufferCnt <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBufferCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ç¼“å­˜ä¸­æœ‰å¤šå°‘ä¸ªnioBufferCnt</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>nioBufferCnt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                <span class="token comment">// We have something else beside ByteBuffers to write so fallback to normal writes.</span>
                <span class="token comment">// ä¸æ˜¯ByteBufferæ•°æ®ï¼Œäº¤ç»™çˆ¶ç±»å®ç°</span>
                writeSpinCount <span class="token operator">-=</span> <span class="token function">doWrite0</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> nioBuffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">// bufferå¯è¯»å­—èŠ‚</span>
                <span class="token keyword">int</span> attemptedBytes <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å°†bufferå†™åˆ°åˆ°Socketç¼“å­˜ä¸­ï¼Œæœ‰å¯èƒ½å…¨éƒ¨å†™è¿›å»äº†ï¼Œä¹Ÿæœ‰å¯èƒ½å†™äº†ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæœ‰å¯èƒ½å…¨éƒ¨å†™å¤±è´¥çš„</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> localWrittenBytes <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å‘é€å¤±è´¥ï¼Œè¯´æ˜åº•å±‚ socket å†™ç¼“å†²åŒºå·²ç»æ»¡äº†ï¼Œæœ¬æ¬¡ write æ²¡å†™è¿›å»</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>localWrittenBytes <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å°†å†™äº‹ä»¶æ·»åŠ åˆ°äº‹ä»¶å…´è¶£é›†ä¸­ï¼Œç­‰å¾…socket å†™ç¼“å†²åŒºæœ‰ç©ºé—²ç©ºé—´åï¼Œç»§ç»­å†™</span>
                    <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ buffer å¯èƒ½æ•°æ®å…¨éƒ¨å†™å…¥åˆ° socket ç¼“å­˜åŒºï¼Œä¹Ÿå¯èƒ½å†™äº†ä¸€éƒ¨åˆ†æ•°æ®åˆ° socket ç¼“å­˜åŒº</span>
                <span class="token function">adjustMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span>attemptedBytes<span class="token punctuation">,</span> localWrittenBytes<span class="token punctuation">,</span> maxBytesPerGatheringWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// ç§»é™¤å†™æˆåŠŸçš„å­—èŠ‚æ•°</span>
                in<span class="token punctuation">.</span><span class="token function">removeBytes</span><span class="token punctuation">(</span>localWrittenBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">--</span>writeSpinCount<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token comment">// Zero length buffers are not added to nioBuffers by ChannelOutboundBuffer, so there is no need</span>
                <span class="token comment">// to check if the total size of all the buffers is non-zero.</span>
                <span class="token comment">// We limit the max amount to int above so cast is safe</span>
                <span class="token keyword">long</span> attemptedBytes <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> localWrittenBytes <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>nioBuffers<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nioBufferCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>localWrittenBytes <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// Casting to int is safe because we limit the total amount of data in the nioBuffers to int above.</span>
                <span class="token function">adjustMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> attemptedBytes<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> localWrittenBytes<span class="token punctuation">,</span>
                                                maxBytesPerGatheringWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
                in<span class="token punctuation">.</span><span class="token function">removeBytes</span><span class="token punctuation">(</span>localWrittenBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">--</span>writeSpinCount<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>writeSpinCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è½¬æ¢ ByteBuffer çš„æ–¹æ³•ä¸­ï¼Œå·²ç»å¾—åˆ°äº†æ­¤æ¬¡éœ€è¦è½¬æ¢å¤šå°‘ä¸ª ByteBufferã€‚CASE 0 çš„æƒ…å†µæ˜¯å¤„ç† FileRegion ç±»å‹çš„ï¼Œäº¤ç»™çˆ¶ç±»å»å¤„ç†ã€‚</p><p>è¿™é‡Œåˆ†æ CASE 1 å’Œ default çš„æƒ…å†µï¼Œè¿™ä¸¤ä¸ªæƒ…å†µçš„å¤„ç†å…¶å®å·®ä¸å¤šï¼Œæ— éå°±æ˜¯ä¸€ä¸ªå†™ 1 ä¸ª ByteBuffer åˆ° Socketï¼Œä¸€ä¸ªæ˜¯å†™å¤šä¸ª ByteBuffer åˆ° Socketã€‚è¿™é‡Œæ‹¿ CASE 1 åˆ†æ”¯æ¥åˆ†æã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Only one ByteBuf so use non-gathering write</span>
    <span class="token comment">// Zero length buffers are not added to nioBuffers by ChannelOutboundBuffer, so there is no need</span>
    <span class="token comment">// to check if the total size of all the buffers is non-zero.</span>
    <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> nioBuffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// bufferå¯è¯»å­—èŠ‚</span>
    <span class="token keyword">int</span> attemptedBytes <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å°†bufferå†™åˆ°åˆ°Socketç¼“å­˜ä¸­ï¼Œæœ‰å¯èƒ½å…¨éƒ¨å†™è¿›å»äº†ï¼Œä¹Ÿæœ‰å¯èƒ½å†™äº†ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæœ‰å¯èƒ½å…¨éƒ¨å†™å¤±è´¥çš„</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> localWrittenBytes <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€å¤±è´¥ï¼Œè¯´æ˜åº•å±‚ socket å†™ç¼“å†²åŒºå·²ç»æ»¡äº†ï¼Œæœ¬æ¬¡ write æ²¡å†™è¿›å»</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>localWrittenBytes <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†å†™äº‹ä»¶æ·»åŠ åˆ°äº‹ä»¶å…´è¶£é›†ä¸­ï¼Œç­‰å¾…socket å†™ç¼“å†²åŒºæœ‰ç©ºé—²ç©ºé—´åï¼Œç»§ç»­å†™</span>
        <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ buffer å¯èƒ½æ•°æ®å…¨éƒ¨å†™å…¥åˆ° socket ç¼“å­˜åŒºï¼Œä¹Ÿå¯èƒ½å†™äº†ä¸€éƒ¨åˆ†æ•°æ®åˆ° socket ç¼“å­˜åŒº</span>
    <span class="token function">adjustMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span>attemptedBytes<span class="token punctuation">,</span> localWrittenBytes<span class="token punctuation">,</span> maxBytesPerGatheringWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç§»é™¤å†™æˆåŠŸçš„å­—èŠ‚æ•°</span>
    in<span class="token punctuation">.</span><span class="token function">removeBytes</span><span class="token punctuation">(</span>localWrittenBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">--</span>writeSpinCount<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è®°å½•-bytebuffer-çš„å¯å†™çš„æ•°æ®å¤§å°" tabindex="-1"><a class="header-anchor" href="#è®°å½•-bytebuffer-çš„å¯å†™çš„æ•°æ®å¤§å°" aria-hidden="true">#</a> è®°å½• ByteBuffer çš„å¯å†™çš„æ•°æ®å¤§å°</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> nioBuffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// bufferå¯è¯»å­—èŠ‚</span>
    <span class="token keyword">int</span> attemptedBytes <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å°†æ•°æ®å†™åˆ°-socket" tabindex="-1"><a class="header-anchor" href="#å°†æ•°æ®å†™åˆ°-socket" aria-hidden="true">#</a> å°†æ•°æ®å†™åˆ° socket</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å°†bufferå†™åˆ°åˆ°Socketç¼“å­˜ä¸­ï¼Œæœ‰å¯èƒ½å…¨éƒ¨å†™è¿›å»äº†ï¼Œä¹Ÿæœ‰å¯èƒ½å†™äº†ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæœ‰å¯èƒ½å…¨éƒ¨å†™å¤±è´¥çš„</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> localWrittenBytes <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å¤„ç†-socket-æ»¡-æœªå†™å…¥æˆåŠŸæƒ…å†µ" tabindex="-1"><a class="header-anchor" href="#å¤„ç†-socket-æ»¡-æœªå†™å…¥æˆåŠŸæƒ…å†µ" aria-hidden="true">#</a> å¤„ç† socket æ»¡ï¼Œæœªå†™å…¥æˆåŠŸæƒ…å†µ</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å°†bufferå†™åˆ°åˆ°Socketç¼“å­˜ä¸­ï¼Œæœ‰å¯èƒ½å…¨éƒ¨å†™è¿›å»äº†ï¼Œä¹Ÿæœ‰å¯èƒ½å†™äº†ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæœ‰å¯èƒ½å…¨éƒ¨å†™å¤±è´¥çš„</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> localWrittenBytes <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å‘é€å¤±è´¥ï¼Œè¯´æ˜åº•å±‚ socket å†™ç¼“å†²åŒºå·²ç»æ»¡äº†ï¼Œæœ¬æ¬¡ write æ²¡å†™è¿›å»</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>localWrittenBytes <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†å†™äº‹ä»¶æ·»åŠ åˆ°äº‹ä»¶å…´è¶£é›†ä¸­ï¼Œç­‰å¾…socket å†™ç¼“å†²åŒºæœ‰ç©ºé—²ç©ºé—´åï¼Œç»§ç»­å†™</span>
    <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>localWrittenBytes è¿”å›å€¼å°äºç­‰äº 0ï¼Œè¯´æ˜æœ¬æ¬¡å†™å…¥ Socket å¤±è´¥ï¼Œsocket çš„å†™ç¼“å†²åŒº SEND_BUF æ»¡äº†ï¼Œéœ€è¦è°ƒç”¨ bstractNioByteChannel#incompleteWrite æ–¹æ³•å»è®¾ç½® Channel åœ¨ Selector æ³¨å†Œ OP_WRITE äº‹ä»¶ï¼Œå½“ Socket å†æ¬¡å¯å†™æ—¶ä¼šå”¤é†’ Reactor çº¿ç¨‹ç»§ç»­å†™å…¥ã€‚</p><h4 id="è°ƒæ•´æ¯æ¬¡å¾ªç¯å¯å†™çš„æœ€å¤§å­—èŠ‚æ•°" tabindex="-1"><a class="header-anchor" href="#è°ƒæ•´æ¯æ¬¡å¾ªç¯å¯å†™çš„æœ€å¤§å­—èŠ‚æ•°" aria-hidden="true">#</a> è°ƒæ•´æ¯æ¬¡å¾ªç¯å¯å†™çš„æœ€å¤§å­—èŠ‚æ•°</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ buffer å¯èƒ½æ•°æ®å…¨éƒ¨å†™å…¥åˆ° socket ç¼“å­˜åŒºï¼Œä¹Ÿå¯èƒ½å†™äº†ä¸€éƒ¨åˆ†æ•°æ®åˆ° socket ç¼“å­˜åŒº</span>
<span class="token function">adjustMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span>attemptedBytes<span class="token punctuation">,</span> localWrittenBytes<span class="token punctuation">,</span> maxBytesPerGatheringWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>NioSocketChannel#adjustMaxBytesPerGatheringWrite</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">adjustMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span><span class="token keyword">int</span> attempted<span class="token punctuation">,</span> <span class="token keyword">int</span> written<span class="token punctuation">,</span> <span class="token keyword">int</span> oldMaxBytesPerGatheringWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attempted <span class="token operator">==</span> written<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attempted <span class="token operator">&lt;</span><span class="token generics"><span class="token punctuation">&lt;</span> 1 <span class="token punctuation">&gt;</span></span> oldMaxBytesPerGatheringWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation">)</span> config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span>attempted <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>attempted <span class="token operator">&gt;</span> <span class="token constant">MAX_BYTES_PER_GATHERING_WRITE_ATTEMPTED_LOW_THRESHOLD</span> <span class="token operator">&amp;&amp;</span> written <span class="token generics"><span class="token punctuation">&lt;</span> attempted <span class="token punctuation">&gt;</span></span><span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation">)</span> config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span>attempted <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SO_SNDBUF ç”¨æ¥è®¾ç½®å‘é€ç¼“å†²åŒºå¤§å°çš„ï¼Œå³åº”ç”¨ç¨‹åºå¯ä»¥å†™å…¥åˆ°å¥—æ¥å­—å‘é€ç¼“å†²åŒºçš„æœ€å¤§å­—èŠ‚æ•°ã€‚ä½†ä¸€äº›æ“ä½œç³»ç»Ÿå¯èƒ½ä¼šåŠ¨æ€åœ°è°ƒæ•´ SO_SNDBUF çš„å¤§å°ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°½é‡é€‚åº”æ“ä½œç³»ç»Ÿè¡Œä¸ºå˜åŒ–ã€‚</p><p>è¯¥æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li><code>attempted</code>ï¼šæŸæ¬¡å¾ªç¯å¾…å‘é€çš„æ•°æ®é‡ï¼›</li><li><code>written</code>ï¼šæŸæ¬¡å¾ªç¯çœŸæ­£å†™å…¥åˆ°å‘é€ç¼“å†²åŒºçš„æ•°æ®é‡ï¼›</li><li><code>oldMaxBytesPerGatheringWrite</code>ï¼šæ—§çš„ maxBytesPerGatheringWrite å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸€æ¬¡å†™å¾ªç¯ä¸­çš„å…è®¸å†™å…¥çš„æœ€å¤§å€¼ï¼›</li></ul><p>é€šè¿‡æŠŠ attempted å’Œ written ä½œæ¯”è¾ƒæ¥åŠ¨æ€è°ƒæ•´ maxBytesPerGatheringWriteå­—æ®µçš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯å†™å¾ªç¯æ¯æ¬¡æœ€å¤šèƒ½å‘é€çš„æ•°æ®å¤§å°ã€‚maxBytesPerGatheringWrite åˆå§‹å€¼ä¸º SO_SNDBUF çš„ä¸¤å€ 262144ã€‚</p><p>ç¬¬ä¸€ä¸ª CASE <code>attempted == written</code>ï¼Œè¯´æ˜æŸæ¬¡å¾ªç¯æŠŠè¦å†™å…¥çš„æ•°æ®å…¨éƒ¨å†™å…¥åˆ° Socket äº†ï¼Œè¯´æ˜å¯èƒ½è¿˜æœ‰æ›´å¤šçš„æ•°æ®éœ€è¦å†™å…¥ï¼Œéœ€è¦å°† maxBytesPerGatheringWrite çš„å€¼æ‰©å¤§åˆ°åŸæ¥çš„ä¸¤å€ï¼Œå³ <code>attempted &lt;&lt; 1</code>ã€‚</p><p>ç¬¬äºŒä¸ª CASE <code>attempted &gt; MAX_BYTES_PER_GATHERING_WRITE_ATTEMPTED_LOW_THRESHOLD &amp;&amp; written &lt; attempted &gt;&gt;&gt; 1</code>ï¼Œå…¶ä¸­é‚£ä¸ªå¸¸é‡çš„å€¼æ˜¯ 4096ï¼Œ<code>written &lt; attempted &gt;&gt;&gt; 1</code>ï¼Œè¡¨ç¤ºæœ¬æ¬¡å†™å…¥çš„æ•°æ®è¿˜æœªè¾¾åˆ°ä¸Šé™çš„ä¸€èˆ¬ã€‚æ€»çš„æ¥è¯´å°±æ˜¯ï¼Œå½“æœ¬æ¬¡å†™å…¥çš„æ•°æ®è¿˜æœªè¾¾åˆ°ä¸Šé™çš„ä¸€åŠæ—¶ï¼Œå°±å°† maxBytesPerGatheringWrite ç¼©å°åˆ°åŸæ¥çš„ 1/2ï¼Œå³ <code>attempted &gt;&gt;&gt; 1</code>ï¼Œå½“ç„¶æœ€å°ä¸èƒ½å°äº 4096ã€‚</p><h4 id="ç§»é™¤æˆåŠŸå†™å…¥åˆ°-socket-çš„-entry" tabindex="-1"><a class="header-anchor" href="#ç§»é™¤æˆåŠŸå†™å…¥åˆ°-socket-çš„-entry" aria-hidden="true">#</a> ç§»é™¤æˆåŠŸå†™å…¥åˆ° Socket çš„ Entry</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ç§»é™¤å†™æˆåŠŸçš„å­—èŠ‚æ•°</span>
in<span class="token punctuation">.</span><span class="token function">removeBytes</span><span class="token punctuation">(</span>localWrittenBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ—¢ç„¶å·²ç»å†™å…¥éƒ¨åˆ†æ•°æ®åˆ° Socket çš„å‘é€ç¼“å†²åŒºä¸­å»äº†ï¼Œé‚£ä¹ˆå°±éœ€è¦å°† ChannelOutboundBuffer å‡ºç«™ç¼“å†²åŒºçš„å¯¹åº”çš„ Entry èŠ‚ç‚¹ä»å•é“¾è¡¨ä¸­ç§»é™¤ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå†™å…¥åˆ° Socket çš„æ•°æ®ï¼Œå¯èƒ½ä¸æ˜¯å®Œæ•´ä¸ª Entry çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´æŸä¸ª Entry å¯èƒ½å°±å†™äº†ä¸€éƒ¨åˆ†æ•°æ®åˆ° Socket çš„å‘é€ç¼“å†²åŒºä¸­äº†</p></blockquote><p><img src="/assets/ChannelOutboundBufferçš„removeBytesæ–¹æ³•-9a4487a5.png" alt="ChannelOutboundBufferçš„removeBytesæ–¹æ³•"></p><p>ChannelOutboundBuffer#removeBytes æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeBytes</span><span class="token punctuation">(</span><span class="token keyword">long</span> writtenBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–flushedEntryèŠ‚ç‚¹æŒ‡å‘çš„entry.msgæ•°æ®,ä»ç¬¬ä¸€ä¸ªå‡†å¤‡å†™å…¥socket çš„èŠ‚ç‚¹å¼€å§‹</span>
        <span class="token class-name">Object</span> msg <span class="token operator">=</span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBuf</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">assert</span> writtenBytes <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> readerIndex <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">readerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¡ç®—å‡ºmsgå¯è¯»æ•°æ®é‡å¤§å°</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> readableBytes <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">writerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> readerIndex<span class="token punctuation">;</span>

        <span class="token comment">// æ¡ä»¶æˆç«‹ è¯´æ˜unsafeå†™å…¥åˆ°socketåº•å±‚ç¼“å­˜åŒºçš„ æ•°æ®é‡ &gt; flushedEntry.msgå¯è¯»æ•°æ®é‡çš„å¤§å°ï¼Œifå†…çš„é€»è¾‘å°±æ˜¯ç§»é™¤flushedEntryä»£è¡¨çš„entry</span>
        <span class="token comment">// å¦‚æœå½“å‰èŠ‚ç‚¹çš„å­—èŠ‚æ•°å°äºæˆ–ç­‰äºå·²å‘é€çš„å­—èŠ‚æ•°ï¼Œåˆ™ç›´æ¥åˆ é™¤æ•´ä¸ªèŠ‚ç‚¹ï¼Œå¹¶æ›´æ–°ç²¾åº¦è¿›åº¦</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>readableBytes <span class="token operator">&lt;=</span> writtenBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>writtenBytes <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">progress</span><span class="token punctuation">(</span>readableBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                writtenBytes <span class="token operator">-=</span> readableBytes<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ‰§è¡Œåˆ°elseè¯´æ˜ unsafeçœŸæ­£å†™å…¥åˆ°socketçš„æ•°æ®é‡ &lt; å½“å‰flushedEntry.msgçš„å¯è¯»æ•°æ®é‡</span>
        <span class="token comment">// è‹¥å½“å‰èŠ‚ç‚¹è¿˜æœ‰éƒ¨åˆ†æœªå‘é€å®Œï¼Œåˆ™ç¼©å°å½“å‰èŠ‚ç‚¹çš„å¯å‘é€å­—èŠ‚é•¿åº¦</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// readableBytes &gt; writtenBytes</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>writtenBytes <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                buf<span class="token punctuation">.</span><span class="token function">readerIndex</span><span class="token punctuation">(</span>readerIndex <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> writtenBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">progress</span><span class="token punctuation">(</span>writtenBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å› ä¸ºæ¯æ¬¡å‘é€æ—¶ï¼Œéƒ½æ˜¯ä»çº¿ç¨‹æœ¬åœ°ç¼“å­˜è·å–çš„ byteBuffer æ•°ç»„</span>
    <span class="token comment">// éœ€è¦åœ¨æ¯æ¬¡å¤„ç†å®Œåæ¸…ç†è¿™ä¸ªæ•°ç»„</span>
    <span class="token function">clearNioBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥æ–¹æ³• for å¾ªç¯éå† Entryï¼Œç›´åˆ°æ‰€æœ‰çš„ writtenBytes éƒ½å¤„ç†å®Œæ¯•äº†å°±é€€å‡ºå¾ªç¯ã€‚</p><p>ï¼ˆ1ï¼‰ç¬¬ä¸€æ­¥é€šè¿‡ ChannelOutboundBuffer#current æ–¹æ³•ï¼Œè·å– flushedEntry æŒ‡é’ˆæŒ‡å‘çš„ Entry çš„ msgï¼Œä¹Ÿå°±æ˜¯è¯¥ Entry å†…ä¿å­˜çš„æ•°æ®ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> flushedEntry<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> entry<span class="token punctuation">.</span>msg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ï¼ˆ2ï¼‰ç¬¬äºŒæ­¥ï¼šè®¡ç®—è¿™ä¸ª Entry å†…çš„æ•°æ®å¤§å° readableBytesã€‚</p><p>ï¼ˆ3ï¼‰ç¬¬ä¸‰æ­¥ï¼šå°† readableBytes å’Œ writtenBytes åšæ¯”è¾ƒï¼Œåšä¸åŒçš„å¤„ç†ã€‚readableBytes æ˜¯å½“å‰ Entry å†…çš„æ•°æ®å¤§å°ï¼ŒwrittenBytes æ˜¯å‰©ä½™å¾…å¤„ç†çš„æ•°æ®å¤§å°ã€‚</p><ul><li>å‡å¦‚ readableBytes å°äºç­‰äº writtenBytesï¼Œè¯´æ˜å½“å‰ Entry å†…çš„æ•°æ®å·²ç»æˆåŠŸå†™å…¥åˆ° Socket çš„å‘é€ç¼“å†²åŒºäº†ï¼Œéœ€è¦è®°å½•å½“å‰çš„å‘é€è¿›åº¦ï¼Œç„¶åå°† writtenBytes çš„å€¼å‡å°‘ï¼Œæœ€åè°ƒç”¨ remove æ–¹æ³•ï¼Œå°†å†™å…¥æˆåŠŸçš„æ•°æ®ä»é“¾è¡¨ç§»é™¤ï¼›</li><li>å‡å¦‚ readableBytes å¤§äº writtenBytesï¼Œæœ‰ä¸¤ç§æƒ…å†µ <ul><li>writtenBytes å¤§äº 0ï¼Œä½†æ˜¯æ¯” readableBytes å°ï¼Œè¯´æ˜æŸä¸ª Entry å†…çš„æ•°æ®ï¼Œåªæœ‰éƒ¨åˆ†æ•°æ®æˆåŠŸå†™å…¥åˆ° Socket çš„å‘é€ç¼“å†²åŒºäº†ã€‚è¿™æ˜¯éœ€è¦å°† Entry å†…çš„ ï¼ˆNetty çš„å¯¹è±¡ï¼‰ByteBuf çš„è¯»æŒ‡é’ˆå¢å¤§ä¸€ä¸‹ã€‚æœ€åéœ€è¦é€€å‡ºå¾ªç¯ï¼›</li><li>writtenBytes ç­‰äº 0ï¼Œè¯´æ˜è¿™æ¬¡å†™å…¥æ•°æ®åˆšå¥½éƒ½æ˜¯å®Œæ•´çš„ Entry çš„æ•°æ®ï¼Œç›´æ¥é€€å‡ºå¾ªç¯å³å¯ï¼›</li></ul></li></ul><p>é‚£ä¹ˆæ˜¯æ€ä¹ˆç§»é™¤èŠ‚ç‚¹çš„å‘¢ï¼Ÿ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span> e <span class="token operator">=</span> flushedEntry<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å‡å¦‚è·å–ä¸åˆ°é“¾è¡¨å¤´ç»“ç‚¹ï¼Œåˆ™æ¸…ç©º Bytebuf ç¼“å­˜</span>
        <span class="token function">clearNioBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Object</span> msg <span class="token operator">=</span> e<span class="token punctuation">.</span>msg<span class="token punctuation">;</span>

    <span class="token class-name">ChannelPromise</span> promise <span class="token operator">=</span> e<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> e<span class="token punctuation">.</span>pendingSize<span class="token punctuation">;</span>

    <span class="token comment">// ä¸€èˆ¬æ˜¯ç§»åŠ¨ flushedEntryæŒ‡å‘å½“å‰eçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ›´æ–°flushedå­—æ®µ</span>
    <span class="token function">removeEntry</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span>cancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// only release message, notify and decrement if it was not canceled before.</span>
        <span class="token comment">// ByteBufå®ç°äº†å¼•ç”¨è®¡æ•°ï¼Œæ›´æ–°å¼•ç”¨è®¡æ•°</span>
        <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">safeRelease</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">safeSuccess</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">decrementPendingOutboundBytes</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// recycle the entry</span>
    <span class="token comment">// å½’è¿˜entryåˆ°å¯¹è±¡æ± </span>
    e<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">removeEntry</span><span class="token punctuation">(</span><span class="token class-name">Entry</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span> flushed <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¯´æ˜å¾…åˆ·æ–°çš„æ•°æ®éƒ½ åˆ·å®Œäº†</span>
        <span class="token comment">// processed everything</span>
        flushedEntry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> tailEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tailEntry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            unflushedEntry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        flushedEntry <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç§»é™¤èŠ‚ç‚¹çš„é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯å•é“¾è¡¨çš„æ“ä½œï¼Œå‰é¢è¯´è¿‡ flushed è¡¨ç¤ºæ­¤æ¬¡è¦åˆ·æ–°çš„ Entry çš„ä¸ªæ•°ã€‚å½“ <code>--flushed == 0</code> æ—¶å°±è¯´æ˜æ‰€æœ‰çš„ Entry éƒ½å·²ç»å†™åˆ° Socket çš„å‘é€ç¼“å†²åŒºä¸Šå»äº†ã€‚å½“ <code>--flushed</code> æ“ä½œä¸ç­‰äº 0 æ—¶ï¼Œè¯´æ˜è¿˜æœ‰ Entry æ²¡æœ‰åˆ·æ–°å®Œï¼Œ <code>flushedEntry = e.next</code> è®© flushedEntry æŒ‡é’ˆåç§»å³å¯ï¼Œè¿™é‡Œå°±æ˜¯å•é“¾è¡¨çš„åˆ é™¤æ“ä½œäº†ã€‚</p><h3 id="do-while-é€€å‡ºå†™å¾ªç¯çš„åœ°æ–¹" tabindex="-1"><a class="header-anchor" href="#do-while-é€€å‡ºå†™å¾ªç¯çš„åœ°æ–¹" aria-hidden="true">#</a> do...whileï¼šé€€å‡ºå†™å¾ªç¯çš„åœ°æ–¹</h3><p>æœ‰ä¸¤ä¸ªåœ°æ–¹é€€å‡ºå†™å¾ªç¯</p><p>**ï¼ˆ1ï¼‰å‡ºç«™ç¼“å†²åŒºçš„æ•°æ®å…¨éƒ¨åˆ·æ–°åˆ° Socket çš„å‘é€ç¼“å†²åŒºäº†ã€‚æ­¤æ—¶å¾ªç¯æ¡ä»¶ <code>while(writeSpinCount &gt; 0)</code> ä¸­çš„ writeSpinCount å¯èƒ½è¿˜æœªå‡åˆ° 0ï¼›**è¿™é‡Œä¸ä»…æ˜¯é€€å‡ºå¾ªç¯ï¼Œæ˜¯ç›´æ¥é€€å‡ºæ–¹æ³•äº†ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ç¼“å­˜ä¸­æ•°æ®ä¸ºç©ºï¼Œæ²¡æœ‰æ•°æ®å¯å†™</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// All written so clear OP_WRITE</span>
    <span class="token comment">// æ­£å¸¸é€€å‡º doWrite èµ°è¿™é‡Œ</span>
    <span class="token comment">// ç§»é™¤å†™äº‹ä»¶ï¼Œå¹¶ç›´æ¥è¿”å›ï¼Œç§»é™¤å½“å‰channel æ³¨å†Œåˆ°çš„selectorä¸Šçš„OP_WRITEäº‹ä»¶</span>
    <span class="token function">clearOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Directly return here so incompleteWrite(...) is not called.</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ2ï¼‰å¦å¤–ä¸€ç§æƒ…å†µå°±æ˜¯ writeSpinCount çš„å€¼å‡åˆ° 0 äº†ï¼Œä¹Ÿå°±æ˜¯å†™äº† 16 æ¬¡ï¼Œå‡ºç«™ç¼“å†²åŒºçš„æ•°æ®è¿˜æœªå†™å®Œï¼›</strong></p><h3 id="å¤„ç†-socket-å¯å†™ä½†å†™æ»¡16æ¬¡è¿˜æ²¡å®Œå…¨å†™å®Œ" tabindex="-1"><a class="header-anchor" href="#å¤„ç†-socket-å¯å†™ä½†å†™æ»¡16æ¬¡è¿˜æ²¡å®Œå…¨å†™å®Œ" aria-hidden="true">#</a> å¤„ç† Socket å¯å†™ä½†å†™æ»¡16æ¬¡è¿˜æ²¡å®Œå…¨å†™å®Œ</h3><p>AbstractNioByteChannel#incompleteWrite æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> setOpWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Did not write completely.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>setOpWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ²¡æœ‰å†™å®Œï¼Œè®¾ç½® OP_WRITE äº‹ä»¶</span>
        <span class="token function">setOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// It is possible that we have set the write OP, woken up by NIO because the socket is writable, and then</span>
        <span class="token comment">// use our write quantum. In this case we no longer want to set the write OP because the socket is still</span>
        <span class="token comment">// writable (as far as we know). We will find out next time we attempt to write if the socket is writable</span>
        <span class="token comment">// and set the write OP if necessary.</span>
        <span class="token function">clearOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Schedule flush again later so other tasks can be picked up in the meantime</span>
        <span class="token comment">// è°ƒç”¨ä»»åŠ¡æ˜¯ï¼Œå› ä¸ºé˜²æ­¢å¤šè·¯å¤ç”¨å™¨ä¸Šçš„å…¶ä»– Channelé¥¥é¥¿ï¼Œ</span>
        <span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>flushTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ‰ä¸¤ä¸ªåœ°æ–¹ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼š</p><ul><li>ä¼  true çš„æ—¶å€™ï¼šå‘é€ç¼“å†²åŒºæ»¡äº†ï¼Œæ— æ³•å†™å…¥äº†ï¼Œæ­¤æ—¶è°ƒç”¨ <code>incompleteWrite</code> æ–¹æ³•ä¼ å…¥ trueï¼Œå»æ³¨å†Œ OP_WRITE äº‹ä»¶ã€‚å½“å‘é€ç¼“å†²åŒºå¯å†™æ—¶ï¼Œä¼šå”¤é†’ Reactor çº¿ç¨‹ï¼›</li><li>ä¼  false çš„æ—¶å€™æœ‰ä¸¤ç§æƒ…å†µï¼š <ul><li>ä¸€ç§æ˜¯å¤„ç† ByteBuf çš„æ—¶å€™ï¼Œæ­¤æ¬¡è¦å†™çš„æ•°æ®å¤ªå¤šäº†ï¼Œå¯¼è‡´å†™å¾ªç¯ 16 æ¬¡è¿˜æ²¡æœ‰å†™å®Œï¼Œæ­¤æ—¶ writeSpinCount å°±æ˜¯ 0 äº†ï¼›</li><li>å¦å¤–ä¸€ç§æ˜¯å¤„ç† FileRegion çš„æ—¶å€™ï¼Œå½“æ— æ³•å†™å…¥åˆ°å‘é€ç¼“å†²åŒºçš„æ—¶å€™ï¼Œä¼šè¿”å› <code>WRITE_STATUS_SNDBUF_FULL</code>ï¼Œè¿™ä¸ªå¸¸é‡çš„å€¼æ˜¯ Integer.MAX_VALUEï¼Œä¼šè§¦å‘ <code>writeSpinCount -= doWrite0(in);</code>ï¼Œè¿™æ ·å­ writeSpinCount å°±å°äº 0äº†ï¼›</li></ul></li></ul><p>ä¼  true çš„æ—¶å€™å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æ³¨å†Œ OP_WRITE äº‹ä»¶ã€‚ä¼  false çš„æ—¶å€™ï¼Œé¦–å…ˆæ¸…é™¤æ‰å…³æ³¨çš„ OP_WRITE äº‹ä»¶ï¼Œç„¶åæ·»åŠ ä¸€ä¸ªåˆ·æ–°ä»»åŠ¡ã€‚å› ä¸ºå†™ç¼“å†²åŒºæ˜¯å¯å†™çš„ï¼Œæ­¤æ¬¡æ˜¯å› ä¸ºè¦å†™çš„æ•°æ®é‡å¤ªå¤§äº†ï¼Œå†™äº† 16 æ¬¡è¿˜æ²¡å†™å®Œï¼Œæ‰€ä»¥å…ˆè¦æ¸…é™¤æ‰å…³æ³¨çš„ OP_WRITE äº‹ä»¶ã€‚å¦åˆ™ä¼šåº”ä¸ºå†™ç¼“å†²åŒºæ˜¯å¯å†™çš„ä¸€ç›´è§¦å‘å†™äº‹ä»¶ã€‚ï¼ˆJDK NIO Selector é»˜è®¤çš„æ˜¯ epoll çš„æ°´å¹³è§¦å‘ï¼‰</p><h2 id="nioeventloop-å¤„ç†-op-write-äº‹ä»¶" tabindex="-1"><a class="header-anchor" href="#nioeventloop-å¤„ç†-op-write-äº‹ä»¶" aria-hidden="true">#</a> NioEventLoop å¤„ç† OP_WRITE äº‹ä»¶</h2><p>å‰é¢åœ¨åˆ†æ NioEventLoop çš„ run æ–¹æ³•çš„æ—¶å€™ï¼Œå·²ç»åˆ†æè¿‡ Reactor çº¿ç¨‹å¤„ç† I/O äº‹ä»¶çš„å…¥å£å°±æ˜¯ NioEventLoop#processSelectedKey(SelectionKey, AbstractNioChannel) æ–¹æ³•ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processSelectedKey</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> k<span class="token punctuation">,</span> <span class="token class-name">AbstractNioChannel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractNioChannel<span class="token punctuation">.</span>NioUnsafe</span> unsafe <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...... çœç•¥</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å– I/O äº‹ä»¶ç±»å‹</span>
        <span class="token keyword">int</span> readyOps <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_CONNECT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> ops <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åˆ é™¤OP_CONNECTï¼Œå¦åˆ™Selector.select(..)å°†å§‹ç»ˆè¿”å›è€Œä¸é˜»å¡</span>
            ops <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_CONNECT</span><span class="token punctuation">;</span>
            k<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// è¿æ¥å®Œæˆåˆ™è°ƒç”¨finishiConnectæ“ä½œ</span>
            unsafe<span class="token punctuation">.</span><span class="token function">finishConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_WRITE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è°ƒç”¨forceFlushï¼Œå³ä½¿æ²¡æœ‰ä¸œè¥¿å¯å†™ï¼Œå®ƒä¹Ÿä¼šæ¸…é™¤OP_WRITE</span>
            ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forceFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span> <span class="token operator">|</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> readyOps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            unsafe<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// keyå¤±æ•ˆåˆ™closeè¿™ä¸ªchannel</span>
        unsafe<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°å¤„ç† OP_WRITE äº‹ä»¶å°±æ˜¯è°ƒç”¨ <code>ch.unsafe().forceFlush()</code>ï¼Œæœ€ç»ˆè¿™ä¸ªæ–¹æ³•è¿˜æ˜¯ä¼šè°ƒç”¨åˆ° NioSocketChannel#doWrite æ–¹æ³•ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸Šé¢åˆ†æçš„å†™å¾ªç¯çš„æ–¹æ³•ã€‚</p></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: guosgbin@163.com">Dylan Kwok</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a href="/Netty_source/17-Netty%E7%AE%A1%E9%81%93%E6%9C%BA%E5%88%B6.html" class="nav-link prev" aria-label="17-Nettyç®¡é“æœºåˆ¶"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->17-Nettyç®¡é“æœºåˆ¶</div></a><!----></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-ecfdc732.js" defer></script>
  </body>
</html>
