<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.62" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://blog.guosgbin.cn/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html"><meta property="og:title" content="16-ConsumeQueueåŸç†åˆ†æ"><meta property="og:description" content="ç‰ˆæœ¬ å†…å®¹ æ—¶é—´ ---- ---- ---------------------- V1 æ–°å»º 2023å¹´06æœˆ22æ—¥13:01:04 æ¦‚å¿µ ConsumeQueue æ˜¯ä»€ä¹ˆ ConsumeQueueï¼šæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œå¼•å…¥çš„ç›®çš„ä¸»è¦æ˜¯æé«˜æ¶ˆæ¯æ¶ˆè´¹çš„æ€§èƒ½ã€‚ ç”±äº RocketMQ æ˜¯åŸºäºä¸»é¢˜ topic çš„è®¢é˜…æ¨¡å¼ï¼Œæ¶ˆæ¯æ¶ˆè´¹æ˜¯é’ˆå¯¹ä¸»é¢˜è¿›è¡Œçš„ï¼Œå¦‚æœè¦éå† c..."><meta property="og:type" content="article"><meta property="og:image" content="https://blog.guosgbin.cn/"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-07-11T11:36:53.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="16-ConsumeQueueåŸç†åˆ†æ"><meta property="article:author" content="è¶…å¨è“çŒ« Dylan Kwok"><meta property="article:modified_time" content="2023-07-11T11:36:53.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"16-ConsumeQueueåŸç†åˆ†æ","image":["https://blog.guosgbin.cn/"],"dateModified":"2023-07-11T11:36:53.000Z","author":[{"@type":"Person","name":"è¶…å¨è“çŒ« Dylan Kwok","url":"","email":"guosgbin@163.com"}]}</script><link rel="icon" href="/å°ç†ŠçŒ«.svg"><title>16-ConsumeQueueåŸç†åˆ†æ</title><meta name="description" content="ç‰ˆæœ¬ å†…å®¹ æ—¶é—´ ---- ---- ---------------------- V1 æ–°å»º 2023å¹´06æœˆ22æ—¥13:01:04 æ¦‚å¿µ ConsumeQueue æ˜¯ä»€ä¹ˆ ConsumeQueueï¼šæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œå¼•å…¥çš„ç›®çš„ä¸»è¦æ˜¯æé«˜æ¶ˆæ¯æ¶ˆè´¹çš„æ€§èƒ½ã€‚ ç”±äº RocketMQ æ˜¯åŸºäºä¸»é¢˜ topic çš„è®¢é˜…æ¨¡å¼ï¼Œæ¶ˆæ¯æ¶ˆè´¹æ˜¯é’ˆå¯¹ä¸»é¢˜è¿›è¡Œçš„ï¼Œå¦‚æœè¦éå† c...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-542658da.css" as="style"><link rel="stylesheet" href="/assets/style-542658da.css">
    <link rel="modulepreload" href="/assets/app-cadb7c17.js"><link rel="modulepreload" href="/assets/16-ConsumeQueueå’ŒIndexåŸç†åˆ†æ.html-ff18bade.js"><link rel="modulepreload" href="/assets/16-ConsumeQueueå’ŒIndexåŸç†åˆ†æ.html-99fc0a05.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/assets/index.html-d9edbc0d.js" as="script"><link rel="prefetch" href="/assets/01-åˆ›å»ºå’Œé”€æ¯å¯¹è±¡.html-98280ce1.js" as="script"><link rel="prefetch" href="/assets/index.html-c4f42206.js" as="script"><link rel="prefetch" href="/assets/01-CASå’ŒUnsafeçš„APIåˆ†æ.html-612c4d6a.js" as="script"><link rel="prefetch" href="/assets/02-åŸºæœ¬ç±»å‹åŸå­ç±»AtomicLong.html-4083b8fd.js" as="script"><link rel="prefetch" href="/assets/03-å¼•ç”¨ç±»å‹åŸå­ç±»AtomicReference.html-8442553d.js" as="script"><link rel="prefetch" href="/assets/04-åŸå­æ•°ç»„ç±»AtomicLongArray.html-74e4c741.js" as="script"><link rel="prefetch" href="/assets/05-åŸå­æ“ä½œç±»AtomicReferenceFieldUpdater.html-d0310b2a.js" as="script"><link rel="prefetch" href="/assets/06-é«˜æ€§èƒ½åŸå­ç±»LongAdder.html-d6e3da8b.js" as="script"><link rel="prefetch" href="/assets/07-LockSupportåˆ†æ.html-8117dd17.js" as="script"><link rel="prefetch" href="/assets/08-AQSç®€å•ä»‹ç».html-30b6ef5b.js" as="script"><link rel="prefetch" href="/assets/09-åŸºäºReentrantLockåˆ†æAQSçš„ç‹¬å æ¨¡å¼.html-2423c430.js" as="script"><link rel="prefetch" href="/assets/10-åŸºäºCountDownLatchåˆ†æAQSçš„å…±äº«æ¨¡å¼.html-91ef4833.js" as="script"><link rel="prefetch" href="/assets/11-AQSçš„Conditionæœºåˆ¶.html-836364af.js" as="script"><link rel="prefetch" href="/assets/12-ä¿¡å·é‡Semaphore.html-3509682c.js" as="script"><link rel="prefetch" href="/assets/13-å¾ªç¯æ æ …CyclicBarrier.html-812d137d.js" as="script"><link rel="prefetch" href="/assets/14-é˜¶æ®µPhaser.html-d684f4a1.js" as="script"><link rel="prefetch" href="/assets/15-äº¤æ¢Exchanger.html-b9bf24f3.js" as="script"><link rel="prefetch" href="/assets/16-è¯»å†™é”ReentrantReadWriteLock.html-de44a1d3.js" as="script"><link rel="prefetch" href="/assets/17-Futureæ¨¡å¼-FutureTask.html-641c6250.js" as="script"><link rel="prefetch" href="/assets/18-çº¿ç¨‹æ± ä½“ç³»æ¦‚è¿°.html-dbcc52e5.js" as="script"><link rel="prefetch" href="/assets/19-çº¿ç¨‹æ± ä½“ç³»-AbstractExecutorService.html-fbd70afb.js" as="script"><link rel="prefetch" href="/assets/20-çº¿ç¨‹æ± ä½“ç³»-ThreadPoolExecutor.html-a274637a.js" as="script"><link rel="prefetch" href="/assets/21-çº¿ç¨‹æ± ä½“ç³»-ScheduledThreadPoolExecutor.html-707ffd40.js" as="script"><link rel="prefetch" href="/assets/22-CopyOnWriteArrayListå†™æ—¶å¤åˆ¶.html-914977b9.js" as="script"><link rel="prefetch" href="/assets/23-CopyOnWriteArraySetå†™æ—¶å¤åˆ¶.html-6c9c3cf6.js" as="script"><link rel="prefetch" href="/assets/24-ConcurrentSkipListMapè·³è¡¨.html-6cff54bf.js" as="script"><link rel="prefetch" href="/assets/25-ConcurrentSkipListSetè·³è¡¨.html-36cf4f7d.js" as="script"><link rel="prefetch" href="/assets/26-ConcurrentHashMapæºç åˆ†æ.html-a3bba8a9.js" as="script"><link rel="prefetch" href="/assets/27-é˜»å¡é˜Ÿåˆ—ArrayBlockingQueue.html-cd091357.js" as="script"><link rel="prefetch" href="/assets/28-é˜»å¡é˜Ÿåˆ—LinkedBlockingQueue.html-d3579ee7.js" as="script"><link rel="prefetch" href="/assets/29-é˜»å¡é˜Ÿåˆ—LinkedBlockingDeque.html-32c13680.js" as="script"><link rel="prefetch" href="/assets/30-é˜»å¡é˜Ÿåˆ—PriorityBlockingQueue.html-b5455c77.js" as="script"><link rel="prefetch" href="/assets/31-é˜»å¡é˜Ÿåˆ—DelayQueue.html-7759c195.js" as="script"><link rel="prefetch" href="/assets/32-é˜»å¡é˜Ÿåˆ—SynchronousQueue.html-97ed879a.js" as="script"><link rel="prefetch" href="/assets/33-é˜»å¡é˜Ÿåˆ—LinkedTransferQueue.html-3281c1b4.js" as="script"><link rel="prefetch" href="/assets/index.html-f5239cf3.js" as="script"><link rel="prefetch" href="/assets/SPIæœºåˆ¶.html-a1ca3921.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis01ï¼šmyabtisçš„æ•´ä½“æ¶æ„.html-f25c0705.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis02ï¼šå…¥é—¨æ¡ˆä¾‹.html-30e68cd3.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis03ï¼šè§£æå…¨å±€é…ç½®æ–‡ä»¶.html-2db85266.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis04ï¼šè§£æMapperæ˜ å°„æ–‡ä»¶.html-60756a5b.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis05ï¼šè§£æStatementæ“ä½œèŠ‚ç‚¹.html-31e11b60.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis06ï¼šè§£æSQLè¯­å¥.html-a9181b56.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis07ï¼šJavaæ–¹æ³•å’ŒSQLè¯­å¥ç»‘å®š.html-9bfa3db6.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis08ï¼šè·å¾—SqlSession.html-e2a92940.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis09ï¼šExecutoræ‰§è¡Œå™¨.html-ad701715.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis10ï¼šç¼“å­˜æœºåˆ¶.html-f2daa10c.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis11ï¼šStatementHandler.html-95b30d9b.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis12ï¼šå‚æ•°è§£æå’Œèµ‹å€¼.html-5778c0ea.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis13ï¼šç»“æœé›†å¤„ç†.html-2ff72779.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis14ï¼šæ’ä»¶.html-76cc6bf8.js" as="script"><link rel="prefetch" href="/assets/01-æœåŠ¡ç«¯å¯åŠ¨æµç¨‹.html-d2fc1f19.js" as="script"><link rel="prefetch" href="/assets/02-æœåŠ¡ç«¯å¯åŠ¨æ·»åŠ ChannelInitializeråˆ°ç®¡é“.html-86cb5d6a.js" as="script"><link rel="prefetch" href="/assets/03-å®¢æˆ·ç«¯å¯åŠ¨æµç¨‹.html-becc83be.js" as="script"><link rel="prefetch" href="/assets/04-çº¿ç¨‹ä½“ç³»-NioEventLoopGroup.html-700e797e.js" as="script"><link rel="prefetch" href="/assets/05-çº¿ç¨‹ä½“ç³»-NioEventLoopç›¸å…³çˆ¶æ¥å£åˆ†æ.html-754320bc.js" as="script"><link rel="prefetch" href="/assets/06-çº¿ç¨‹ä½“ç³»-AbstractEventExecutor.html-5250cd42.js" as="script"><link rel="prefetch" href="/assets/07-çº¿ç¨‹ä½“ç³»-AbstractScheduledEventExecutor-ä¼˜å…ˆé˜Ÿåˆ—.html-e7bbaf32.js" as="script"><link rel="prefetch" href="/assets/08-çº¿ç¨‹ä½“ç³»-NioEventLoopæ¦‚è¿°.html-fce3fb2c.js" as="script"><link rel="prefetch" href="/assets/09-çº¿ç¨‹ä½“ç³»-NioEventLoopå¼€å¯SelectoråŠä¼˜åŒ–.html-6d8230cf.js" as="script"><link rel="prefetch" href="/assets/10-çº¿ç¨‹ä½“ç³»-NioEventLoopç»‘å®šçº¿ç¨‹.html-db947821.js" as="script"><link rel="prefetch" href="/assets/11-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„runæ–¹æ³•.html-def4cc31.js" as="script"><link rel="prefetch" href="/assets/12-çº¿ç¨‹ä½“ç³»-NioEventLoopè§„é¿JDKçš„NIOç©ºå¾ªç¯bug.html-16ecaf4e.js" as="script"><link rel="prefetch" href="/assets/13-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„ä¼˜é›…å…³é—­.html-912d668d.js" as="script"><link rel="prefetch" href="/assets/14-æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥(ACCEPT).html-63afdec1.js" as="script"><link rel="prefetch" href="/assets/15-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶æ¦‚è¿°.html-b35daeb8.js" as="script"><link rel="prefetch" href="/assets/16-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶è¯¦è§£åŠRecvByteBufAllocator.html-a9faccfa.js" as="script"><link rel="prefetch" href="/assets/17-Nettyç®¡é“æœºåˆ¶.html-ba70b238.js" as="script"><link rel="prefetch" href="/assets/18-Nettyå‘é€æ•°æ®æµç¨‹åŠå‡ºç«™ç¼“å†²åŒº.html-223d04a7.js" as="script"><link rel="prefetch" href="/assets/index.html-b475d8b0.js" as="script"><link rel="prefetch" href="/assets/Redis_BenchmarkåŸºå‡†æµ‹è¯•.html-dbf21951.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤å’Œæ§½ç®¡ç†å‘½ä»¤.html-2b4a1244.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤åŸºæœ¬ç‰¹æ€§å’Œé›†ç¾¤æ­å»º.html-42be726b.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤ç®¡ç†å·¥å…·redis-cli.html-fc4f1503.js" as="script"><link rel="prefetch" href="/assets/Redis_Pipelineä¼˜åŒ–RTT.html-8a4aa041.js" as="script"><link rel="prefetch" href="/assets/Redis_Sentinelé«˜å¯ç”¨.html-6bcdb34a.js" as="script"><link rel="prefetch" href="/assets/Redis_keyè®¾è®¡è§„èŒƒ.html-ab90a7dc.js" as="script"><link rel="prefetch" href="/assets/Redisäº‹åŠ¡.html-e43061e1.js" as="script"><link rel="prefetch" href="/assets/Rediså†…å­˜æ·˜æ±°ç­–ç•¥.html-feabd314.js" as="script"><link rel="prefetch" href="/assets/Rediså‘å¸ƒè®¢é˜….html-68771977.js" as="script"><link rel="prefetch" href="/assets/Rediså¤åˆ¶.html-33b20d6f.js" as="script"><link rel="prefetch" href="/assets/Rediså¤§keyå’Œçƒ­keyé—®é¢˜.html-394d194e.js" as="script"><link rel="prefetch" href="/assets/Redisæ…¢æŸ¥è¯¢æ—¥å¿—.html-7fb06db0.js" as="script"><link rel="prefetch" href="/assets/RedisæŒä¹…åŒ–æœºåˆ¶.html-53af3f7a.js" as="script"><link rel="prefetch" href="/assets/Redisé”®ç©ºé—´é€šçŸ¥(keyspace notification).html-012bd277.js" as="script"><link rel="prefetch" href="/assets/redis-cli ä½¿ç”¨.html-f7ab22db.js" as="script"><link rel="prefetch" href="/assets/01-RocketMQæ¦‚è¿°.html-25463efe.js" as="script"><link rel="prefetch" href="/assets/02-NameServerå¯åŠ¨æµç¨‹.html-a514999f.js" as="script"><link rel="prefetch" href="/assets/03-Brokerå¯åŠ¨æµç¨‹.html-43c84806.js" as="script"><link rel="prefetch" href="/assets/04-RocketMQç½‘ç»œé€šä¿¡åŸç†.html-ac88de8d.js" as="script"><link rel="prefetch" href="/assets/05-RocketMQ æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¯åŠ¨.html-ef7f1888.js" as="script"><link rel="prefetch" href="/assets/06-RocketMQç½‘ç»œé€šä¿¡æºç .html-b8e0bf43.js" as="script"><link rel="prefetch" href="/assets/07-NameServerä½œç”¨å’Œè·¯ç”±å…ƒä¿¡æ¯.html-82a23869.js" as="script"><link rel="prefetch" href="/assets/08-NameServerè·¯ç”±ç®¡ç†æºç åˆ†æ.html-8da2bd72.js" as="script"><link rel="prefetch" href="/assets/09-ç”Ÿäº§è€…ç›¸å…³ç±»åˆ†æ.html-08f6e840.js" as="script"><link rel="prefetch" href="/assets/10-ç”Ÿäº§è€…å¯åŠ¨æµç¨‹.html-d761cf07.js" as="script"><link rel="prefetch" href="/assets/11-ç”Ÿäº§è€…å‘é€æ¶ˆæ¯.html-743328bc.js" as="script"><link rel="prefetch" href="/assets/12-Brokerå­˜å‚¨æœºåˆ¶æ¦‚è¿°.html-5e7ed491.js" as="script"><link rel="prefetch" href="/assets/13-MappedFileå’ŒMappedFileQueueåˆ†æ.html-5b9afaf2.js" as="script"><link rel="prefetch" href="/assets/14-CommitLogåŸç†åˆ†æ.html-93362aa2.js" as="script"><link rel="prefetch" href="/assets/15-brokerçš„åˆ·ç›˜æœºåˆ¶.html-21e2029f.js" as="script"><link rel="prefetch" href="/assets/17-brokerè¿‡æœŸæ–‡ä»¶åˆ é™¤æœºåˆ¶.html-89f05919.js" as="script"><link rel="prefetch" href="/assets/18-æ¶ˆè´¹è€…å¯åŠ¨æµç¨‹(TODO).html-988c43b3.js" as="script"><link rel="prefetch" href="/assets/19-æ¶ˆæ¯æ‹‰å–å…¥å£å’Œæ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡.html-7e4e20d4.js" as="script"><link rel="prefetch" href="/assets/20-æ¶ˆè´¹è€…å‘é€æ¶ˆæ¯æ‹‰å–è¯·æ±‚æµç¨‹.html-19825069.js" as="script"><link rel="prefetch" href="/assets/21-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-1-ä¸»æµç¨‹.html-d9ca6fa4.js" as="script"><link rel="prefetch" href="/assets/22-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-2-é•¿è½®è¯¢.html-0aba4f38.js" as="script"><link rel="prefetch" href="/assets/23-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-3-è¯»å–æ¶ˆæ¯.html-729d741b.js" as="script"><link rel="prefetch" href="/assets/24-æ¶ˆè´¹è€…å¤„ç†ä»brokeræ‹‰å–çš„æ¶ˆæ¯.html-dcfb7d07.js" as="script"><link rel="prefetch" href="/assets/25-å¹¶å‘æ¶ˆè´¹åŸç†.html-5ef206ec.js" as="script"><link rel="prefetch" href="/assets/001-æœåŠ¡å™¨CPUé—®é¢˜-è§„å¾‹æ€§å³°åˆº.html-81aeb2c9.js" as="script"><link rel="prefetch" href="/assets/002-æœåŠ¡å™¨CPUé…ç½®é™ä½GCåˆ†æ.html-d27479f5.js" as="script"><link rel="prefetch" href="/assets/003-æœåŠ¡å™¨CPUä½¿ç”¨ç‡è¾ƒä½ä½†ç³»ç»Ÿè´Ÿè½½é«˜.html-13cce7d9.js" as="script"><link rel="prefetch" href="/assets/004-log4j2å†…å­˜æ³„éœ²å¯¼è‡´çš„é¢‘ç¹fullgc.html-a403b9d0.js" as="script"><link rel="prefetch" href="/assets/005-çº¿ç¨‹æ± çˆ¶å­ä»»åŠ¡ä½¿ç”¨ä¸å½“é€ æˆæ­»é”.html-362015fc.js" as="script"><link rel="prefetch" href="/assets/006-linuxç³»ç»Ÿå‚æ•°-è¿æ¥é˜Ÿåˆ—é•¿åº¦è¿‡å°å¯¼è‡´è¿æ¥ä¸¢å¼ƒ.html-7c9d02a0.js" as="script"><link rel="prefetch" href="/assets/007-redisé¢‘ç¹æ·˜æ±°-æ¸…é™¤redisçº¿ä¸Šæœªè®¾ç½®è¿‡æœŸæ—¶é—´çš„key.html-e760378c.js" as="script"><link rel="prefetch" href="/assets/é¡¹ç›®-IMé•¿è¿æ¥ä¼˜åŒ–.html-00c51a2b.js" as="script"><link rel="prefetch" href="/assets/JUCç›¸å…³é—®é¢˜.html-9dc4b717.js" as="script"><link rel="prefetch" href="/assets/JVMé—®é¢˜.html-17300c49.js" as="script"><link rel="prefetch" href="/assets/MySQLç›¸å…³é—®é¢˜.html-a6c2cd41.js" as="script"><link rel="prefetch" href="/assets/index.html-8f5e683a.js" as="script"><link rel="prefetch" href="/assets/Redisç›¸å…³é—®é¢˜.html-575f1ee1.js" as="script"><link rel="prefetch" href="/assets/äºŒåˆ†æŸ¥æ‰¾.html-6b017c38.js" as="script"><link rel="prefetch" href="/assets/äºŒå‰æ ‘.html-e277f749.js" as="script"><link rel="prefetch" href="/assets/ä»£ç éšæƒ³å½•é¢˜ç›®ç›®å½•.html-308825f0.js" as="script"><link rel="prefetch" href="/assets/HowToSayResume.html-11d8bbca.js" as="script"><link rel="prefetch" href="/assets/resume.html-3b3f8934.js" as="script"><link rel="prefetch" href="/assets/404.html-f3795607.js" as="script"><link rel="prefetch" href="/assets/index.html-1f3390c0.js" as="script"><link rel="prefetch" href="/assets/index.html-10b45510.js" as="script"><link rel="prefetch" href="/assets/index.html-dfd17ea5.js" as="script"><link rel="prefetch" href="/assets/index.html-2f392b9e.js" as="script"><link rel="prefetch" href="/assets/index.html-4060f68d.js" as="script"><link rel="prefetch" href="/assets/index.html-d5cde66b.js" as="script"><link rel="prefetch" href="/assets/index.html-0efbdc5e.js" as="script"><link rel="prefetch" href="/assets/index.html-fca49f86.js" as="script"><link rel="prefetch" href="/assets/01-åˆ›å»ºå’Œé”€æ¯å¯¹è±¡.html-0f6d3931.js" as="script"><link rel="prefetch" href="/assets/index.html-5fd56c23.js" as="script"><link rel="prefetch" href="/assets/01-CASå’ŒUnsafeçš„APIåˆ†æ.html-e1cdb0df.js" as="script"><link rel="prefetch" href="/assets/02-åŸºæœ¬ç±»å‹åŸå­ç±»AtomicLong.html-7356731a.js" as="script"><link rel="prefetch" href="/assets/03-å¼•ç”¨ç±»å‹åŸå­ç±»AtomicReference.html-ca728b7c.js" as="script"><link rel="prefetch" href="/assets/04-åŸå­æ•°ç»„ç±»AtomicLongArray.html-5e719a21.js" as="script"><link rel="prefetch" href="/assets/05-åŸå­æ“ä½œç±»AtomicReferenceFieldUpdater.html-91f7830a.js" as="script"><link rel="prefetch" href="/assets/06-é«˜æ€§èƒ½åŸå­ç±»LongAdder.html-ca503ef8.js" as="script"><link rel="prefetch" href="/assets/07-LockSupportåˆ†æ.html-95a9996e.js" as="script"><link rel="prefetch" href="/assets/08-AQSç®€å•ä»‹ç».html-58a8cbed.js" as="script"><link rel="prefetch" href="/assets/09-åŸºäºReentrantLockåˆ†æAQSçš„ç‹¬å æ¨¡å¼.html-406aefa4.js" as="script"><link rel="prefetch" href="/assets/10-åŸºäºCountDownLatchåˆ†æAQSçš„å…±äº«æ¨¡å¼.html-18ca9479.js" as="script"><link rel="prefetch" href="/assets/11-AQSçš„Conditionæœºåˆ¶.html-d8d8f77a.js" as="script"><link rel="prefetch" href="/assets/12-ä¿¡å·é‡Semaphore.html-05df68a2.js" as="script"><link rel="prefetch" href="/assets/13-å¾ªç¯æ æ …CyclicBarrier.html-22f5b043.js" as="script"><link rel="prefetch" href="/assets/14-é˜¶æ®µPhaser.html-0f707797.js" as="script"><link rel="prefetch" href="/assets/15-äº¤æ¢Exchanger.html-b2cd8e09.js" as="script"><link rel="prefetch" href="/assets/16-è¯»å†™é”ReentrantReadWriteLock.html-739300fa.js" as="script"><link rel="prefetch" href="/assets/17-Futureæ¨¡å¼-FutureTask.html-f5c72714.js" as="script"><link rel="prefetch" href="/assets/18-çº¿ç¨‹æ± ä½“ç³»æ¦‚è¿°.html-5e4eb10b.js" as="script"><link rel="prefetch" href="/assets/19-çº¿ç¨‹æ± ä½“ç³»-AbstractExecutorService.html-71b36473.js" as="script"><link rel="prefetch" href="/assets/20-çº¿ç¨‹æ± ä½“ç³»-ThreadPoolExecutor.html-951e8f96.js" as="script"><link rel="prefetch" href="/assets/21-çº¿ç¨‹æ± ä½“ç³»-ScheduledThreadPoolExecutor.html-5a0714f8.js" as="script"><link rel="prefetch" href="/assets/22-CopyOnWriteArrayListå†™æ—¶å¤åˆ¶.html-8880dadf.js" as="script"><link rel="prefetch" href="/assets/23-CopyOnWriteArraySetå†™æ—¶å¤åˆ¶.html-009c38e9.js" as="script"><link rel="prefetch" href="/assets/24-ConcurrentSkipListMapè·³è¡¨.html-afc79837.js" as="script"><link rel="prefetch" href="/assets/25-ConcurrentSkipListSetè·³è¡¨.html-5808023f.js" as="script"><link rel="prefetch" href="/assets/26-ConcurrentHashMapæºç åˆ†æ.html-a502c334.js" as="script"><link rel="prefetch" href="/assets/27-é˜»å¡é˜Ÿåˆ—ArrayBlockingQueue.html-721589c3.js" as="script"><link rel="prefetch" href="/assets/28-é˜»å¡é˜Ÿåˆ—LinkedBlockingQueue.html-ee861ae1.js" as="script"><link rel="prefetch" href="/assets/29-é˜»å¡é˜Ÿåˆ—LinkedBlockingDeque.html-599ff961.js" as="script"><link rel="prefetch" href="/assets/30-é˜»å¡é˜Ÿåˆ—PriorityBlockingQueue.html-b3589ecb.js" as="script"><link rel="prefetch" href="/assets/31-é˜»å¡é˜Ÿåˆ—DelayQueue.html-236460bf.js" as="script"><link rel="prefetch" href="/assets/32-é˜»å¡é˜Ÿåˆ—SynchronousQueue.html-df6a07e7.js" as="script"><link rel="prefetch" href="/assets/33-é˜»å¡é˜Ÿåˆ—LinkedTransferQueue.html-db2e4374.js" as="script"><link rel="prefetch" href="/assets/index.html-1b3e4104.js" as="script"><link rel="prefetch" href="/assets/SPIæœºåˆ¶.html-d03563cd.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis01ï¼šmyabtisçš„æ•´ä½“æ¶æ„.html-cf741833.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis02ï¼šå…¥é—¨æ¡ˆä¾‹.html-c7cf5659.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis03ï¼šè§£æå…¨å±€é…ç½®æ–‡ä»¶.html-a2ae71cd.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis04ï¼šè§£æMapperæ˜ å°„æ–‡ä»¶.html-ec178f01.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis05ï¼šè§£æStatementæ“ä½œèŠ‚ç‚¹.html-8298c673.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis06ï¼šè§£æSQLè¯­å¥.html-7257625f.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis07ï¼šJavaæ–¹æ³•å’ŒSQLè¯­å¥ç»‘å®š.html-46ce93b2.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis08ï¼šè·å¾—SqlSession.html-cbe18da7.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis09ï¼šExecutoræ‰§è¡Œå™¨.html-5a0cffb6.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis10ï¼šç¼“å­˜æœºåˆ¶.html-7f848ffe.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis11ï¼šStatementHandler.html-d8bb8146.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis12ï¼šå‚æ•°è§£æå’Œèµ‹å€¼.html-09dfbdfa.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis13ï¼šç»“æœé›†å¤„ç†.html-fa536850.js" as="script"><link rel="prefetch" href="/assets/æ·±å…¥æµ…å‡ºMybatis14ï¼šæ’ä»¶.html-6ef58a94.js" as="script"><link rel="prefetch" href="/assets/01-æœåŠ¡ç«¯å¯åŠ¨æµç¨‹.html-7b13223d.js" as="script"><link rel="prefetch" href="/assets/02-æœåŠ¡ç«¯å¯åŠ¨æ·»åŠ ChannelInitializeråˆ°ç®¡é“.html-924b98cf.js" as="script"><link rel="prefetch" href="/assets/03-å®¢æˆ·ç«¯å¯åŠ¨æµç¨‹.html-142ac98d.js" as="script"><link rel="prefetch" href="/assets/04-çº¿ç¨‹ä½“ç³»-NioEventLoopGroup.html-5f77c9fe.js" as="script"><link rel="prefetch" href="/assets/05-çº¿ç¨‹ä½“ç³»-NioEventLoopç›¸å…³çˆ¶æ¥å£åˆ†æ.html-a3bcd97a.js" as="script"><link rel="prefetch" href="/assets/06-çº¿ç¨‹ä½“ç³»-AbstractEventExecutor.html-41be38a3.js" as="script"><link rel="prefetch" href="/assets/07-çº¿ç¨‹ä½“ç³»-AbstractScheduledEventExecutor-ä¼˜å…ˆé˜Ÿåˆ—.html-2875426e.js" as="script"><link rel="prefetch" href="/assets/08-çº¿ç¨‹ä½“ç³»-NioEventLoopæ¦‚è¿°.html-c14cceca.js" as="script"><link rel="prefetch" href="/assets/09-çº¿ç¨‹ä½“ç³»-NioEventLoopå¼€å¯SelectoråŠä¼˜åŒ–.html-d84db5bf.js" as="script"><link rel="prefetch" href="/assets/10-çº¿ç¨‹ä½“ç³»-NioEventLoopç»‘å®šçº¿ç¨‹.html-9d2fe4d1.js" as="script"><link rel="prefetch" href="/assets/11-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„runæ–¹æ³•.html-a557e40f.js" as="script"><link rel="prefetch" href="/assets/12-çº¿ç¨‹ä½“ç³»-NioEventLoopè§„é¿JDKçš„NIOç©ºå¾ªç¯bug.html-9d31e82a.js" as="script"><link rel="prefetch" href="/assets/13-çº¿ç¨‹ä½“ç³»-NioEventLoopçš„ä¼˜é›…å…³é—­.html-9b235df6.js" as="script"><link rel="prefetch" href="/assets/14-æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥(ACCEPT).html-2dc31f15.js" as="script"><link rel="prefetch" href="/assets/15-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶æ¦‚è¿°.html-ce4350fb.js" as="script"><link rel="prefetch" href="/assets/16-å®¢æˆ·ç«¯å¤„ç†READäº‹ä»¶è¯¦è§£åŠRecvByteBufAllocator.html-e48e3d3e.js" as="script"><link rel="prefetch" href="/assets/17-Nettyç®¡é“æœºåˆ¶.html-fe680d30.js" as="script"><link rel="prefetch" href="/assets/18-Nettyå‘é€æ•°æ®æµç¨‹åŠå‡ºç«™ç¼“å†²åŒº.html-c17829fb.js" as="script"><link rel="prefetch" href="/assets/index.html-8fc6f797.js" as="script"><link rel="prefetch" href="/assets/Redis_BenchmarkåŸºå‡†æµ‹è¯•.html-5c444187.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤å’Œæ§½ç®¡ç†å‘½ä»¤.html-23c2a82a.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤åŸºæœ¬ç‰¹æ€§å’Œé›†ç¾¤æ­å»º.html-c142a7a6.js" as="script"><link rel="prefetch" href="/assets/Redis_Clusteré›†ç¾¤ç®¡ç†å·¥å…·redis-cli.html-66fa191b.js" as="script"><link rel="prefetch" href="/assets/Redis_Pipelineä¼˜åŒ–RTT.html-02d6a877.js" as="script"><link rel="prefetch" href="/assets/Redis_Sentinelé«˜å¯ç”¨.html-2a21a491.js" as="script"><link rel="prefetch" href="/assets/Redis_keyè®¾è®¡è§„èŒƒ.html-b815d849.js" as="script"><link rel="prefetch" href="/assets/Redisäº‹åŠ¡.html-19d6479f.js" as="script"><link rel="prefetch" href="/assets/Rediså†…å­˜æ·˜æ±°ç­–ç•¥.html-e54c7729.js" as="script"><link rel="prefetch" href="/assets/Rediså‘å¸ƒè®¢é˜….html-1a23b90a.js" as="script"><link rel="prefetch" href="/assets/Rediså¤åˆ¶.html-e9cb51ad.js" as="script"><link rel="prefetch" href="/assets/Rediså¤§keyå’Œçƒ­keyé—®é¢˜.html-c028d365.js" as="script"><link rel="prefetch" href="/assets/Redisæ…¢æŸ¥è¯¢æ—¥å¿—.html-b4222c27.js" as="script"><link rel="prefetch" href="/assets/RedisæŒä¹…åŒ–æœºåˆ¶.html-c9bc6fa7.js" as="script"><link rel="prefetch" href="/assets/Redisé”®ç©ºé—´é€šçŸ¥(keyspace notification).html-62850bde.js" as="script"><link rel="prefetch" href="/assets/redis-cli ä½¿ç”¨.html-e445cfa2.js" as="script"><link rel="prefetch" href="/assets/01-RocketMQæ¦‚è¿°.html-193b1fbb.js" as="script"><link rel="prefetch" href="/assets/02-NameServerå¯åŠ¨æµç¨‹.html-dca7c2cf.js" as="script"><link rel="prefetch" href="/assets/03-Brokerå¯åŠ¨æµç¨‹.html-3b2652df.js" as="script"><link rel="prefetch" href="/assets/04-RocketMQç½‘ç»œé€šä¿¡åŸç†.html-5ca12a13.js" as="script"><link rel="prefetch" href="/assets/05-RocketMQ æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¯åŠ¨.html-00fdf779.js" as="script"><link rel="prefetch" href="/assets/06-RocketMQç½‘ç»œé€šä¿¡æºç .html-37e1beb7.js" as="script"><link rel="prefetch" href="/assets/07-NameServerä½œç”¨å’Œè·¯ç”±å…ƒä¿¡æ¯.html-2f303415.js" as="script"><link rel="prefetch" href="/assets/08-NameServerè·¯ç”±ç®¡ç†æºç åˆ†æ.html-508f58c3.js" as="script"><link rel="prefetch" href="/assets/09-ç”Ÿäº§è€…ç›¸å…³ç±»åˆ†æ.html-144b315a.js" as="script"><link rel="prefetch" href="/assets/10-ç”Ÿäº§è€…å¯åŠ¨æµç¨‹.html-f3f8c2da.js" as="script"><link rel="prefetch" href="/assets/11-ç”Ÿäº§è€…å‘é€æ¶ˆæ¯.html-9a2b66e9.js" as="script"><link rel="prefetch" href="/assets/12-Brokerå­˜å‚¨æœºåˆ¶æ¦‚è¿°.html-bda9c552.js" as="script"><link rel="prefetch" href="/assets/13-MappedFileå’ŒMappedFileQueueåˆ†æ.html-3c4a7053.js" as="script"><link rel="prefetch" href="/assets/14-CommitLogåŸç†åˆ†æ.html-c532a0e5.js" as="script"><link rel="prefetch" href="/assets/15-brokerçš„åˆ·ç›˜æœºåˆ¶.html-3e4538e7.js" as="script"><link rel="prefetch" href="/assets/17-brokerè¿‡æœŸæ–‡ä»¶åˆ é™¤æœºåˆ¶.html-d8487fab.js" as="script"><link rel="prefetch" href="/assets/18-æ¶ˆè´¹è€…å¯åŠ¨æµç¨‹(TODO).html-6125e7ee.js" as="script"><link rel="prefetch" href="/assets/19-æ¶ˆæ¯æ‹‰å–å…¥å£å’Œæ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡.html-ada44887.js" as="script"><link rel="prefetch" href="/assets/20-æ¶ˆè´¹è€…å‘é€æ¶ˆæ¯æ‹‰å–è¯·æ±‚æµç¨‹.html-a2812f67.js" as="script"><link rel="prefetch" href="/assets/21-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-1-ä¸»æµç¨‹.html-4a09e2ab.js" as="script"><link rel="prefetch" href="/assets/22-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-2-é•¿è½®è¯¢.html-6c964007.js" as="script"><link rel="prefetch" href="/assets/23-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-3-è¯»å–æ¶ˆæ¯.html-c766dc24.js" as="script"><link rel="prefetch" href="/assets/24-æ¶ˆè´¹è€…å¤„ç†ä»brokeræ‹‰å–çš„æ¶ˆæ¯.html-ab2cad1e.js" as="script"><link rel="prefetch" href="/assets/25-å¹¶å‘æ¶ˆè´¹åŸç†.html-ecfd699e.js" as="script"><link rel="prefetch" href="/assets/001-æœåŠ¡å™¨CPUé—®é¢˜-è§„å¾‹æ€§å³°åˆº.html-18e05319.js" as="script"><link rel="prefetch" href="/assets/002-æœåŠ¡å™¨CPUé…ç½®é™ä½GCåˆ†æ.html-d90ac8a4.js" as="script"><link rel="prefetch" href="/assets/003-æœåŠ¡å™¨CPUä½¿ç”¨ç‡è¾ƒä½ä½†ç³»ç»Ÿè´Ÿè½½é«˜.html-ef5ba313.js" as="script"><link rel="prefetch" href="/assets/004-log4j2å†…å­˜æ³„éœ²å¯¼è‡´çš„é¢‘ç¹fullgc.html-e9d30fcf.js" as="script"><link rel="prefetch" href="/assets/005-çº¿ç¨‹æ± çˆ¶å­ä»»åŠ¡ä½¿ç”¨ä¸å½“é€ æˆæ­»é”.html-9451c35a.js" as="script"><link rel="prefetch" href="/assets/006-linuxç³»ç»Ÿå‚æ•°-è¿æ¥é˜Ÿåˆ—é•¿åº¦è¿‡å°å¯¼è‡´è¿æ¥ä¸¢å¼ƒ.html-6100d466.js" as="script"><link rel="prefetch" href="/assets/007-redisé¢‘ç¹æ·˜æ±°-æ¸…é™¤redisçº¿ä¸Šæœªè®¾ç½®è¿‡æœŸæ—¶é—´çš„key.html-453b1ee8.js" as="script"><link rel="prefetch" href="/assets/é¡¹ç›®-IMé•¿è¿æ¥ä¼˜åŒ–.html-c3d76188.js" as="script"><link rel="prefetch" href="/assets/JUCç›¸å…³é—®é¢˜.html-38f09d99.js" as="script"><link rel="prefetch" href="/assets/JVMé—®é¢˜.html-5ea728c3.js" as="script"><link rel="prefetch" href="/assets/MySQLç›¸å…³é—®é¢˜.html-a20917ea.js" as="script"><link rel="prefetch" href="/assets/index.html-884e0ec5.js" as="script"><link rel="prefetch" href="/assets/Redisç›¸å…³é—®é¢˜.html-56c4ab69.js" as="script"><link rel="prefetch" href="/assets/äºŒåˆ†æŸ¥æ‰¾.html-d464c8da.js" as="script"><link rel="prefetch" href="/assets/äºŒå‰æ ‘.html-0a740e50.js" as="script"><link rel="prefetch" href="/assets/ä»£ç éšæƒ³å½•é¢˜ç›®ç›®å½•.html-bdb37885.js" as="script"><link rel="prefetch" href="/assets/HowToSayResume.html-48291ff0.js" as="script"><link rel="prefetch" href="/assets/resume.html-7a343d37.js" as="script"><link rel="prefetch" href="/assets/404.html-7168dcd4.js" as="script"><link rel="prefetch" href="/assets/index.html-38f47dfb.js" as="script"><link rel="prefetch" href="/assets/index.html-42acbd4e.js" as="script"><link rel="prefetch" href="/assets/index.html-2fc21520.js" as="script"><link rel="prefetch" href="/assets/index.html-fd134188.js" as="script"><link rel="prefetch" href="/assets/index.html-e3d24bb9.js" as="script"><link rel="prefetch" href="/assets/index.html-bf6b3d0b.js" as="script"><link rel="prefetch" href="/assets/index.html-60e3e3b7.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-2450701e.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a href="/" class="vp-brand"><img class="vp-nav-logo" src="/å°ç†ŠçŒ«.png" alt><!----><!----></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a href="/RocketMQ_source/01-RocketMQ%E6%A6%82%E8%BF%B0.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="01-RocketMQæ¦‚è¿°"><!---->01-RocketMQæ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/02-NameServer%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="02-NameServerå¯åŠ¨æµç¨‹"><!---->02-NameServerå¯åŠ¨æµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/03-Broker%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="03-Brokerå¯åŠ¨æµç¨‹"><!---->03-Brokerå¯åŠ¨æµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/04-RocketMQ%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="04-RocketMQç½‘ç»œé€šä¿¡åŸç†"><!---->04-RocketMQç½‘ç»œé€šä¿¡åŸç†<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/05-RocketMQ%20%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E5%90%AF%E5%8A%A8.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="05-RocketMQ æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¯åŠ¨"><!---->05-RocketMQ æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¯åŠ¨<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/06-RocketMQ%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E6%BA%90%E7%A0%81.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="06-RocketMQç½‘ç»œé€šä¿¡æºç "><!---->06-RocketMQç½‘ç»œé€šä¿¡æºç <!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/07-NameServer%E4%BD%9C%E7%94%A8%E5%92%8C%E8%B7%AF%E7%94%B1%E5%85%83%E4%BF%A1%E6%81%AF.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="07-NameServerè·¯ç”±å…ƒä¿¡æ¯å’Œbrokeræ³¨å†Œ"><!---->07-NameServerè·¯ç”±å…ƒä¿¡æ¯å’Œbrokeræ³¨å†Œ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/08-NameServer%E8%B7%AF%E7%94%B1%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="08-NameServerè·¯ç”±ç®¡ç†æºç åˆ†æ"><!---->08-NameServerè·¯ç”±ç®¡ç†æºç åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/09-%E7%94%9F%E4%BA%A7%E8%80%85%E7%9B%B8%E5%85%B3%E7%B1%BB%E5%88%86%E6%9E%90.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="09-ç”Ÿäº§è€…ç›¸å…³æ¦‚å¿µå’Œç±»åˆ†æ"><!---->09-ç”Ÿäº§è€…ç›¸å…³æ¦‚å¿µå’Œç±»åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/10-%E7%94%9F%E4%BA%A7%E8%80%85%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="10-ç”Ÿäº§è€…å¯åŠ¨æµç¨‹"><!---->10-ç”Ÿäº§è€…å¯åŠ¨æµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/11-%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="11-ç”Ÿäº§è€…å‘é€æ¶ˆæ¯"><!---->11-ç”Ÿäº§è€…å‘é€æ¶ˆæ¯<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/12-Broker%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6%E6%A6%82%E8%BF%B0.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="12-Brokerå­˜å‚¨æœºåˆ¶æ¦‚è¿°"><!---->12-Brokerå­˜å‚¨æœºåˆ¶æ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/13-MappedFile%E5%92%8CMappedFileQueue%E5%88%86%E6%9E%90.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="13-MappedFileå’ŒMappedFileQueueåˆ†æ"><!---->13-MappedFileå’ŒMappedFileQueueåˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/14-CommitLog%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="14-CommitLogåŸç†åˆ†æ"><!---->14-CommitLogåŸç†åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/15-broker%E7%9A%84%E5%88%B7%E7%9B%98%E6%9C%BA%E5%88%B6.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="15-brokerçš„åˆ·ç›˜æœºåˆ¶"><!---->15-brokerçš„åˆ·ç›˜æœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html" class="router-link-active router-link-exact-active nav-link active vp-sidebar-link vp-sidebar-page active" aria-label="16-ConsumeQueueåŸç†åˆ†æ"><!---->16-ConsumeQueueåŸç†åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#æ¦‚å¿µ" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="æ¦‚å¿µ"><!---->æ¦‚å¿µ<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#consumequeue-æ˜¯ä»€ä¹ˆ" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="ConsumeQueue æ˜¯ä»€ä¹ˆ"><!---->ConsumeQueue æ˜¯ä»€ä¹ˆ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#index-æ˜¯ä»€ä¹ˆ" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="Index æ˜¯ä»€ä¹ˆ"><!---->Index æ˜¯ä»€ä¹ˆ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#ç´¢å¼•æ–‡ä»¶æ„å»ºè¿‡ç¨‹" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="ç´¢å¼•æ–‡ä»¶æ„å»ºè¿‡ç¨‹"><!---->ç´¢å¼•æ–‡ä»¶æ„å»ºè¿‡ç¨‹<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#æ¶ˆæ¯è¯»å–æµç¨‹" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="æ¶ˆæ¯è¯»å–æµç¨‹"><!---->æ¶ˆæ¯è¯»å–æµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#consumequeue-æ„å»ºè¿‡ç¨‹" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="ConsumeQueue æ„å»ºè¿‡ç¨‹"><!---->ConsumeQueue æ„å»ºè¿‡ç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#index-æ„å»ºè¿‡ç¨‹" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="Index æ„å»ºè¿‡ç¨‹"><!---->Index æ„å»ºè¿‡ç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#ç´¢å¼•æ–‡ä»¶å¦‚ä½•ä½¿ç”¨" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="ç´¢å¼•æ–‡ä»¶å¦‚ä½•ä½¿ç”¨"><!---->ç´¢å¼•æ–‡ä»¶å¦‚ä½•ä½¿ç”¨<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#consumequeue-çš„ä½¿ç”¨" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="ConsumeQueue çš„ä½¿ç”¨"><!---->ConsumeQueue çš„ä½¿ç”¨<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#index-çš„ä½¿ç”¨" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="Index çš„ä½¿ç”¨"><!---->Index çš„ä½¿ç”¨<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#ç´¢å¼•æ–‡ä»¶çš„åˆ·ç›˜" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="ç´¢å¼•æ–‡ä»¶çš„åˆ·ç›˜"><!---->ç´¢å¼•æ–‡ä»¶çš„åˆ·ç›˜<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#consumequeue-çš„åˆ·ç›˜" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="ConsumeQueue çš„åˆ·ç›˜"><!---->ConsumeQueue çš„åˆ·ç›˜<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#index-æ–‡ä»¶çš„åˆ·ç›˜" class="router-link-active router-link-exact-active nav-link vp-sidebar-link vp-heading" aria-label="Index æ–‡ä»¶çš„åˆ·ç›˜"><!---->Index æ–‡ä»¶çš„åˆ·ç›˜<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/17-broker%E8%BF%87%E6%9C%9F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4%E6%9C%BA%E5%88%B6.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="17-brokerè¿‡æœŸæ–‡ä»¶åˆ é™¤æœºåˆ¶"><!---->17-brokerè¿‡æœŸæ–‡ä»¶åˆ é™¤æœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/18-%E6%B6%88%E8%B4%B9%E8%80%85%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B(TODO).html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="18-æ¶ˆè´¹è€…å¯åŠ¨æµç¨‹ï¼ˆä¸å®Œæ•´ï¼‰"><!---->18-æ¶ˆè´¹è€…å¯åŠ¨æµç¨‹ï¼ˆä¸å®Œæ•´ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/19-%E6%B6%88%E6%81%AF%E6%8B%89%E5%8F%96%E5%85%A5%E5%8F%A3%E5%92%8C%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="19-æ¶ˆæ¯æ‹‰å–å…¥å£å’Œæ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡"><!---->19-æ¶ˆæ¯æ‹‰å–å…¥å£å’Œæ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/20-%E6%B6%88%E8%B4%B9%E8%80%85%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%8B%89%E5%8F%96%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="20-æ¶ˆè´¹è€…å‘é€æ¶ˆæ¯æ‹‰å–è¯·æ±‚æµç¨‹"><!---->20-æ¶ˆè´¹è€…å‘é€æ¶ˆæ¯æ‹‰å–è¯·æ±‚æµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/21-broker%E5%A4%84%E7%90%86%E6%B6%88%E6%81%AF%E6%8B%89%E5%8F%96%E8%AF%B7%E6%B1%82-1-%E4%B8%BB%E6%B5%81%E7%A8%8B.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="21-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-1-ä¸»æµç¨‹"><!---->21-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-1-ä¸»æµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/22-broker%E5%A4%84%E7%90%86%E6%B6%88%E6%81%AF%E6%8B%89%E5%8F%96%E8%AF%B7%E6%B1%82-2-%E9%95%BF%E8%BD%AE%E8%AF%A2.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="22-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-2-é•¿è½®è¯¢"><!---->22-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-2-é•¿è½®è¯¢<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/23-broker%E5%A4%84%E7%90%86%E6%B6%88%E6%81%AF%E6%8B%89%E5%8F%96%E8%AF%B7%E6%B1%82-3-%E8%AF%BB%E5%8F%96%E6%B6%88%E6%81%AF.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="23-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-3-è¯»å–æ¶ˆæ¯"><!---->23-brokerå¤„ç†æ¶ˆæ¯æ‹‰å–è¯·æ±‚-3-è¯»å–æ¶ˆæ¯<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/24-%E6%B6%88%E8%B4%B9%E8%80%85%E5%A4%84%E7%90%86%E4%BB%8Ebroker%E6%8B%89%E5%8F%96%E7%9A%84%E6%B6%88%E6%81%AF.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="24-æ¶ˆè´¹è€…å¤„ç†ä»brokeræ‹‰å–çš„æ¶ˆæ¯"><!---->24-æ¶ˆè´¹è€…å¤„ç†ä»brokeræ‹‰å–çš„æ¶ˆæ¯<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/RocketMQ_source/25-%E5%B9%B6%E5%8F%91%E6%B6%88%E8%B4%B9%E5%8E%9F%E7%90%86.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="25-å¹¶å‘æ¶ˆè´¹åŸç†"><!---->25-å¹¶å‘æ¶ˆè´¹åŸç†<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->16-ConsumeQueueåŸç†åˆ†æ</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">è¶…å¨è“çŒ« Dylan Kwok</span></span><span property="author" content="è¶…å¨è“çŒ« Dylan Kwok"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-07-11T11:36:53.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 19 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT19M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#æ¦‚å¿µ" class="router-link-active router-link-exact-active toc-link level2">æ¦‚å¿µ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#consumequeue-æ˜¯ä»€ä¹ˆ" class="router-link-active router-link-exact-active toc-link level3">ConsumeQueue æ˜¯ä»€ä¹ˆ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#index-æ˜¯ä»€ä¹ˆ" class="router-link-active router-link-exact-active toc-link level3">Index æ˜¯ä»€ä¹ˆ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#ç´¢å¼•æ–‡ä»¶æ„å»ºè¿‡ç¨‹" class="router-link-active router-link-exact-active toc-link level2">ç´¢å¼•æ–‡ä»¶æ„å»ºè¿‡ç¨‹</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#æ¶ˆæ¯è¯»å–æµç¨‹" class="router-link-active router-link-exact-active toc-link level3">æ¶ˆæ¯è¯»å–æµç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#consumequeue-æ„å»ºè¿‡ç¨‹" class="router-link-active router-link-exact-active toc-link level3">ConsumeQueue æ„å»ºè¿‡ç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#index-æ„å»ºè¿‡ç¨‹" class="router-link-active router-link-exact-active toc-link level3">Index æ„å»ºè¿‡ç¨‹</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#ç´¢å¼•æ–‡ä»¶å¦‚ä½•ä½¿ç”¨" class="router-link-active router-link-exact-active toc-link level2">ç´¢å¼•æ–‡ä»¶å¦‚ä½•ä½¿ç”¨</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#consumequeue-çš„ä½¿ç”¨" class="router-link-active router-link-exact-active toc-link level3">ConsumeQueue çš„ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#index-çš„ä½¿ç”¨" class="router-link-active router-link-exact-active toc-link level3">Index çš„ä½¿ç”¨</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#ç´¢å¼•æ–‡ä»¶çš„åˆ·ç›˜" class="router-link-active router-link-exact-active toc-link level2">ç´¢å¼•æ–‡ä»¶çš„åˆ·ç›˜</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#consumequeue-çš„åˆ·ç›˜" class="router-link-active router-link-exact-active toc-link level3">ConsumeQueue çš„åˆ·ç›˜</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/RocketMQ_source/16-ConsumeQueue%E5%92%8CIndex%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html#index-æ–‡ä»¶çš„åˆ·ç›˜" class="router-link-active router-link-exact-active toc-link level3">Index æ–‡ä»¶çš„åˆ·ç›˜</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><table><thead><tr><th>ç‰ˆæœ¬</th><th>å†…å®¹</th><th>æ—¶é—´</th></tr></thead><tbody><tr><td>V1</td><td>æ–°å»º</td><td>2023å¹´06æœˆ22æ—¥13:01:04</td></tr></tbody></table><h2 id="æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#æ¦‚å¿µ" aria-hidden="true">#</a> æ¦‚å¿µ</h2><h3 id="consumequeue-æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#consumequeue-æ˜¯ä»€ä¹ˆ" aria-hidden="true">#</a> ConsumeQueue æ˜¯ä»€ä¹ˆ</h3><p><strong>ConsumeQueue</strong>ï¼š<strong>æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œå¼•å…¥çš„ç›®çš„ä¸»è¦æ˜¯æé«˜æ¶ˆæ¯æ¶ˆè´¹çš„æ€§èƒ½</strong>ã€‚</p><p>ç”±äº RocketMQ æ˜¯åŸºäºä¸»é¢˜ topic çš„è®¢é˜…æ¨¡å¼ï¼Œæ¶ˆæ¯æ¶ˆè´¹æ˜¯é’ˆå¯¹ä¸»é¢˜è¿›è¡Œçš„ï¼Œå¦‚æœè¦éå† commitlog æ–‡ä»¶ï¼Œæ ¹æ® topic æ£€ç´¢æ¶ˆæ¯æ˜¯éå¸¸ä½æ•ˆçš„ã€‚Consumer å¯æ ¹æ® ConsumeQueue æ¥æŸ¥æ‰¾å¾…æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚å…¶ä¸­ï¼Œ<strong>ConsumeQueueï¼ˆé€»è¾‘æ¶ˆè´¹é˜Ÿåˆ—ï¼‰ä½œä¸ºæ¶ˆè´¹æ¶ˆæ¯çš„ç´¢å¼•ï¼Œä¿å­˜äº†æŒ‡å®š topic ä¸‹çš„é˜Ÿåˆ—æ¶ˆæ¯åœ¨ CommitLog ä¸­çš„èµ·å§‹ç‰©ç†åç§»é‡ offsetï¼Œæ¶ˆæ¯å¤§å° size å’Œæ¶ˆæ¯ Tag çš„ HashCode å€¼ã€‚</strong></p><p><strong>consumequeue æ–‡ä»¶å¯ä»¥çœ‹æˆæ˜¯åŸºäº topic çš„ commitlog ç´¢å¼•æ–‡ä»¶</strong>ï¼Œæ•… consumequeue æ–‡ä»¶å¤¹çš„ç»„ç»‡æ–¹å¼å¦‚ä¸‹ï¼štopic/queue/file ä¸‰å±‚ç»„ç»‡ç»“æ„ï¼Œå…·ä½“å­˜å‚¨è·¯å¾„ä¸ºï¼š $HOME/store/consumequeue/{topic}/{queueId}/{fileName}ã€‚åŒæ · consumequeue æ–‡ä»¶é‡‡å–å®šé•¿è®¾è®¡ï¼Œ<strong>æ¯ä¸€ä¸ªæ¡ç›®å…± 20 ä¸ªå­—èŠ‚ï¼Œåˆ†åˆ«ä¸º 8 å­—èŠ‚çš„ commitlog ç‰©ç†åç§»é‡ã€4 å­—èŠ‚çš„æ¶ˆæ¯é•¿åº¦ã€8 å­—èŠ‚ tag hashcode</strong>ï¼Œå­˜å‚¨ tag çš„å“ˆå¸Œç çš„åŸå› æ˜¯ä¸ºäº†ä¿è¯æ¯ä¸ªæ¡ç›®çš„é•¿åº¦ä¸€è‡´ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼æ•°ç»„ä¸‹æ ‡å¿«é€Ÿè®¿é—®æ¡ç›®ã€‚å•ä¸ªæ–‡ä»¶ç”± 30W ä¸ªæ¡ç›®ç»„æˆï¼Œå¯ä»¥åƒæ•°ç»„ä¸€æ ·éšæœºè®¿é—®æ¯ä¸€ä¸ªæ¡ç›®ï¼Œæ¯ä¸ª ConsumeQueue æ–‡ä»¶å¤§å°çº¦ 5.72Mï¼›</p><img src="/assets/ConsumeQueueå­˜å‚¨æ ¼å¼-3d9874b1.png" alt="ConsumeQueueå­˜å‚¨æ ¼å¼" style="zoom:67%;"><p>æ¶ˆæ¯æ¶ˆè´¹è€…æ ¹æ® topicã€æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦ï¼ˆConsumeQueue é€»è¾‘åç§»é‡ï¼‰ï¼Œä¹Ÿå°±æ˜¯ç¬¬å‡ ä¸ª ConsumeQueue æ¡ç›®ï¼Œç±»ä¼¼æ•°ç»„çš„ç´¢å¼•ï¼Œè¿™æ ·çš„æ¶ˆè´¹è¿›åº¦å»è®¿é—®æ¶ˆæ¯ï¼Œé€šè¿‡é€»è¾‘åç§»é‡ logicOffset Ã— 20ï¼Œå³å¯æ‰¾åˆ°è¯¥æ¡ç›®çš„èµ·å§‹åç§»é‡ï¼ˆConsumeQueue æ–‡ä»¶ä¸­çš„åç§»é‡ï¼‰ï¼Œç„¶åè¯»å–è¯¥åç§»é‡å 20 ä¸ªå­—èŠ‚å³å¯å¾—åˆ°ä¸€ä¸ªæ¡ç›®ï¼Œæ— é¡»éå† ConsumeQueue æ–‡ä»¶ã€‚</p><h3 id="index-æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#index-æ˜¯ä»€ä¹ˆ" aria-hidden="true">#</a> Index æ˜¯ä»€ä¹ˆ</h3><p>Index æ˜¯ä¸€ä¸ªå“ˆå¸Œç´¢å¼•ï¼Œä¸»è¦åœ¨æ–¹ä¾¿æ¶ˆæ¯ key æŸ¥è¯¢æ—¶ä½¿ç”¨ï¼Œä¸»è¦æ˜¯é€šè¿‡ IndexFile å®ç°çš„ã€‚</p><p><img src="/assets/Indexçš„å­˜å‚¨æ ¼å¼-6c462c8c.png" alt="Indexçš„å­˜å‚¨æ ¼å¼"></p><p>RocketMQ ä¸­æœ‰å¤šä¸ª IndexFileï¼Œæ¯ä¸ª IndexFile çš„å­˜å‚¨æ ¼å¼å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li><strong>IndexHeader å¤´éƒ¨åˆ†</strong>ï¼šIndex æ–‡ä»¶å¤´ï¼Œä¿å­˜ç€è¯¥æ–‡ä»¶çš„ä¸€äº›ä¿¡æ¯ï¼›</li><li><strong>å“ˆå¸Œæ§½éƒ¨åˆ†</strong>ï¼šæ¯ä¸ª Index æ–‡ä»¶é»˜è®¤æœ‰ 500w ä¸ªå“ˆå¸Œæ§½ï¼Œå­˜æ”¾çš„å°±æ˜¯çœŸæ­£çš„ç´¢å¼•è®°å½•åœ¨å½“å‰ Index æ–‡ä»¶ä¸­çš„ç¼–å·ï¼Œé€šè¿‡ç¼–å·å¯ä»¥å¿«é€Ÿå®šä½åˆ°ç´¢å¼•ä¿¡æ¯ï¼›</li><li><strong>ç´¢å¼•è®°å½•éƒ¨åˆ†</strong>ï¼šï¼ˆ2000w -1ï¼‰ä¸ªç´¢å¼•è®°å½•ï¼Œé¡ºåºå†™å…¥ï¼Œä¸»è¦å­˜çš„å°±æ˜¯æ¶ˆæ¯åœ¨ commitlog ä¸­çš„ç‰©ç†åç§»é‡ï¼›</li></ul><p>è¯¦ç»†è¯´ä¸‹è¿™ä¸‰éƒ¨åˆ†çš„å…·ä½“å†…å®¹</p><p><strong>IndexHeader éƒ¨åˆ†</strong>ï¼š</p><ul><li><strong>beginTimestamp</strong>ï¼šç¬¬ä¸€ä¸ªæ·»åŠ åˆ°è¯¥ IndexFile æ–‡ä»¶çš„ç´¢å¼•è®°å½•å¯¹åº”æ¶ˆæ¯çš„ storeTimestampï¼›</li><li><strong>endTimestamp</strong>ï¼šæœ€åä¸€ä¸ªæ·»åŠ åˆ°è¯¥ IndexFile æ–‡ä»¶çš„ç´¢å¼•è®°å½•å¯¹åº”æ¶ˆæ¯çš„ storeTimestampï¼ˆæ¯æ¬¡å†™éƒ½ä¼šæ›´æ–°ï¼‰ï¼›</li><li><strong>beginPhyOffset</strong>ï¼šç¬¬ä¸€ä¸ªæ·»åŠ åˆ°è¯¥ IndexFile æ–‡ä»¶çš„ç´¢å¼•è®°å½•å¯¹åº”æ¶ˆæ¯åœ¨ commitlog ä¸­çš„ç‰©ç†åç§»é‡ï¼›</li><li><strong>endPhyOffset</strong>ï¼šæœ€åä¸€ä¸ªæ·»åŠ åˆ°è¯¥ IndexFile æ–‡ä»¶çš„ç´¢å¼•è®°å½•å¯¹åº”æ¶ˆæ¯åœ¨ commitlog ä¸­çš„ç‰©ç†åç§»é‡ï¼ˆæ¯æ¬¡å†™éƒ½ä¼šæ›´æ–°ï¼‰ï¼›</li><li><strong>hashSlotCount</strong>ï¼šå½“å‰å“ˆå¸Œæ§½å ç”¨ä¸ªæ•°ï¼Œæœ‰å¯èƒ½ä¼šå“ˆå¸Œå†²çªï¼›</li><li><strong>indexCount</strong>ï¼šå½“å‰ IndexFile æ–‡ä»¶ä¸­ï¼Œç´¢å¼•è®°å½•çš„ä¸ªæ•°ï¼›</li></ul><p><strong>å“ˆå¸Œæ§½éƒ¨åˆ†</strong>ï¼šè¿™éƒ¨åˆ†å°±ç®€å•äº†ï¼Œå°±æ˜¯è®°å½•å½“å‰å“ˆå¸Œæ§½å¯¹åº”çš„æ˜¯é‚£ä¸€æ¡ç´¢å¼•è®°å½•ï¼Œå­˜çš„æ˜¯ç¼–å·ï¼Œç´¢å¼•è®°å½•åœ¨ IndexFile æ–‡ä»¶åœ¨æ˜¯æŒ‰ç…§é¡ºåºå†™å…¥çš„ï¼Œå› ä¸ºæ¯æ¡ç´¢å¼•è®°å½•éƒ½æ˜¯å®šé•¿çš„ï¼Œæ ¹æ®ç¼–å·å¯ä»¥å¾ˆå¿«çš„å®šä½åˆ°å…·ä½“çš„ç´¢å¼•è®°å½•ã€‚</p><p><strong>ç´¢å¼•è®°å½•éƒ¨åˆ†</strong>ï¼šæ¯ä¸ªç´¢å¼•è®°å½•éƒ½æ˜¯å®šé•¿çš„ï¼Œæ–¹ä¾¿æ ¹æ®ç¼–å·å¿«é€Ÿå®šä½</p><ul><li><strong>hashCode</strong>ï¼škey çš„å“ˆå¸Œå€¼ï¼Œå­˜å‚¨ key çš„å“ˆå¸Œå€¼æ˜¯ä¸ºäº†æ§åˆ¶æ¯æ¡ç´¢å¼•è®°å½•çš„é•¿åº¦ä¸€è‡´ï¼›</li><li><strong>phyoffset</strong>ï¼šç´¢å¼•è®°å½•å†…å­˜å‚¨ key å¯¹åº”æ¶ˆæ¯çš„ commitlog çš„åœ°å€åç§»é‡ï¼›</li><li><strong>timediff</strong>ï¼šå½“å‰ç´¢å¼•è®°å½•å†…å¯¹åº”çš„æ¶ˆæ¯ç›¸å¯¹ç¬¬ä¸€ä¸ªæ·»åŠ åˆ°è¯¥ IndexFile æ–‡ä»¶çš„ç´¢å¼•è®°å½•å¯¹åº”æ¶ˆæ¯çš„ storeTimestamp çš„æ—¶é—´å·®å€¼ï¼Œæ—¶é—´å•ä½æ˜¯ç§’ã€‚å­˜å‚¨å·®å€¼å¹¶ä¸”å•ä½æ˜¯ç§’çš„åŸå› æ˜¯ä¸ºäº†å°½å¯èƒ½çš„èŠ‚çº¦ç©ºé—´ï¼›</li><li><strong>preIndexNo</strong>ï¼šè§£å†³å“ˆå¸Œå†²çªä½¿ç”¨çš„ï¼Œç»„æˆä¸€ä¸ªå•å‘é“¾è¡¨çš„ç»“æ„ï¼›</li></ul><p><strong>Index æ˜¯å¦‚ä½•è§£å†³å“ˆå¸Œå†²çªçš„ï¼Ÿ</strong></p><p><img src="/assets/Indexå¦‚ä½•è§£å†³å“ˆå¸Œå†²çªçš„-3f74a36f.png" alt="Indexå¦‚ä½•è§£å†³å“ˆå¸Œå†²çªçš„"></p><p>è§£é‡Šä¸€ä¸‹è¿™ä¸ªå›¾ï¼š</p><ul><li>é€šè¿‡è®¡ç®—æŸä¸ª key çš„å“ˆå¸Œç ï¼Œå‘½ä¸­äº†å“ˆå¸Œæ§½ä¸­çš„æ§½ Xï¼Œç„¶åæŒ‰ç…§é¡ºåºå°†è¯¥ç´¢å¼•è®°å½•å†™åˆ° index æ–‡ä»¶ä¸­ï¼Œå‡å¦‚æ­¤æ—¶æ˜¯å†™åˆ°ç¼–å· 1 ä½ç½®ï¼›</li><li>æŸä¸ªæ—¶åˆ»æ·»åŠ ä¸€ä¸ªæ–°çš„ key çš„ä¿¡æ¯ï¼Œé€šè¿‡è®¡ç®—å“ˆå¸Œç å‘ç°ä¹Ÿå‘½ä¸­äº†æ§½ Xï¼Œå‡å¦‚ index æ–‡ä»¶é¡ºåºå†™åˆ°äº†ç¼–å· 3 çš„ä½ç½®ï¼Œæ­¤æ—¶éœ€è¦å°†æ§½ X ä¿å­˜çš„æ•°æ®ç”±ç¼–å· 1 æ”¹ä¸ºç¼–å· 3ï¼Œç„¶åå°†æ–° key çš„ç´¢å¼•æ–‡ä»¶çš„ preIndexNo ä½ç½®å†™å…¥ç¼–å· 1ï¼Œè¡¨ç¤ºå‘ç”Ÿå“ˆå¸Œå†²çªäº†ï¼Œä¿å­˜çš„æ˜¯å†²çªå‰çš„ç´¢å¼•è®°å½•çš„ç¼–å·ï¼Œè¿™æ ·å°±å½¢æˆäº†é“¾è¡¨ç»“æ„äº†ï¼ŒæŸ¥è¯¢çš„æ—¶å€™å°±å¯ä»¥é€šè¿‡è¿™ä¸ª preIndexNo çš„ç¼–ç å·å»éå†äº†ï¼›</li></ul><h2 id="ç´¢å¼•æ–‡ä»¶æ„å»ºè¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#ç´¢å¼•æ–‡ä»¶æ„å»ºè¿‡ç¨‹" aria-hidden="true">#</a> ç´¢å¼•æ–‡ä»¶æ„å»ºè¿‡ç¨‹</h2><p>åœ¨ DefaultMessageStore ä¸­æœ‰ä¸ªæ¶ˆæ¯åˆ†å‘çš„æœåŠ¡ ReputMessageServiceï¼Œè¿™ä¸ªæœåŠ¡å°±æ˜¯ä¸ºäº†æ„å»º ConsumeQueue å’Œ Index æ–‡ä»¶çš„ã€‚æ•´ä¸ªæ¶ˆæ¯åˆ†å‘çš„æ ¸å¿ƒå°±æ˜¯ ReputMessageService#doReput æ–¹æ³•ï¼Œå…·ä½“å°±æ˜¯è¯»å– commitlog æ–‡ä»¶ï¼Œä»æ–‡ä»¶ä¸­ä¸€ä¸ªä¸€ä¸ªçš„è¯»å–ä¸€ä¸ªå®Œæ•´æ¶ˆæ¯ï¼Œç„¶åè°ƒç”¨ ConsumeQueue å’Œ Index å¯¹åº”çš„å„è‡ªçš„æ¶ˆæ¯åˆ†å‘å¤„ç†å»æ„å»ºå¯¹åº”çš„æ–‡ä»¶ã€‚</p><p>ReputMessageService æœ‰ä¸€ä¸ªå±æ€§ reputFromOffsetï¼Œè¡¨ç¤ºå½“å‰å·²ç»ä» commitlog ä¸­åˆ†å‘åˆ°äº†å“ªä¸€ä¸ªåœ°å€ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// åˆ†å‘æœåŠ¡å·²ç»åˆ†å‘çš„åç§»é‡</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> reputFromOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥æ ¸å¿ƒå°±æ˜¯åˆ†æ ReputMessageService#doReput æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æµç¨‹å¾ˆé•¿ï¼Œåˆ†æ­¥åˆ†æï¼š</p><h3 id="æ¶ˆæ¯è¯»å–æµç¨‹" tabindex="-1"><a class="header-anchor" href="#æ¶ˆæ¯è¯»å–æµç¨‹" aria-hidden="true">#</a> æ¶ˆæ¯è¯»å–æµç¨‹</h3><h4 id="æ ¡éªŒæ¶ˆæ¯åˆ†å‘çš„åç§»é‡æ˜¯å¦æ­£å¸¸" tabindex="-1"><a class="header-anchor" href="#æ ¡éªŒæ¶ˆæ¯åˆ†å‘çš„åç§»é‡æ˜¯å¦æ­£å¸¸" aria-hidden="true">#</a> æ ¡éªŒæ¶ˆæ¯åˆ†å‘çš„åç§»é‡æ˜¯å¦æ­£å¸¸</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">&lt;</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;The reputFromOffset={} is smaller than minPyOffset={}, this usually indicate that the dispatch behind too much and the commitlog has expired.&quot;</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset<span class="token punctuation">,</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">=</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸»è¦å°±æ˜¯ç”¨ reputFromOffset å’Œ commitlog æ–‡ä»¶å¤¹ä¸­æœ€å°çš„ä¸€ä¸ªç‰©ç†åç§»é‡åšæ¯”è¾ƒï¼Œå‡å¦‚ reputFromOffset æ¯”è¾ƒå°ï¼Œè¯´æ˜å¯èƒ½æ˜¯å¤ªä¹…æ²¡æœ‰åšæ¶ˆæ¯åˆ†å‘äº†ï¼Œcommitlog è‡ªåŠ¨è¿‡æœŸè¢«åˆ é™¤äº†ï¼Œæ‰€ä»¥æ­¤æ—¶éœ€è¦å°† reputFromOffset è®¾ç½®ä¸ºæœ€å°çš„ commitlog çš„åœ°å€åç§»é‡ã€‚</p><h4 id="è·å–æ¶ˆæ¯åˆ†å‘ä½ç½®çš„å†…å­˜åˆ‡ç‰‡" tabindex="-1"><a class="header-anchor" href="#è·å–æ¶ˆæ¯åˆ†å‘ä½ç½®çš„å†…å­˜åˆ‡ç‰‡" aria-hidden="true">#</a> è·å–æ¶ˆæ¯åˆ†å‘ä½ç½®çš„å†…å­˜åˆ‡ç‰‡</h4><p><strong>ç¬¬äºŒæ­¥ï¼šå¼€å¯ä¸€ä¸ª for å¾ªç¯ï¼Œé€šè¿‡ reputFromOffset å®šä½åˆ°è¯¥åç§»é‡å¯¹åº”çš„æ˜¯é‚£ä¸ª commitlogï¼Œç„¶åè·å–è¯¥ä½ç½®åé¢çš„ commitlog çš„å†…å­˜åˆ‡ç‰‡ï¼Œå°±å»è¯»å–è¯¥å†…å­˜åˆ‡ç‰‡å†…çš„æ¶ˆæ¯äº†åšè½¬å‘æ“ä½œäº†ã€‚</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// for å¾ªç¯è½¬å‘æ¶ˆæ¯</span>
<span class="token comment">// isCommitLogAvailable() ä¸º true è¡¨åè¿˜æœ‰æ¶ˆæ¯éœ€è¦åŒæ­¥</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">boolean</span> doNext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isCommitLogAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> doNext<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// ...... çœç•¥ ......</span>

    <span class="token comment">// æ ¹æ®æ¶ˆæ¯è½¬å‘çš„åç§»é‡ï¼Œè·å–è¯¥åç§»é‡åœ¨é‚£ä¸ª commitlog æ–‡ä»¶ä¸Šï¼Œè·å–è¯¥æ–‡ä»¶çš„å†…å­˜æ˜ å°„çš„åˆ‡ç‰‡</span>
    <span class="token class-name">SelectMappedBufferResult</span> result <span class="token operator">=</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span>reputFromOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...... çœç•¥çœŸæ­£çš„æ¶ˆæ¯è½¬å‘å¤„ç† ......</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        doNext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è¯»å–æ¶ˆæ¯å°è£…æˆæ¶ˆæ¯è½¬å‘å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#è¯»å–æ¶ˆæ¯å°è£…æˆæ¶ˆæ¯è½¬å‘å¯¹è±¡" aria-hidden="true">#</a> è¯»å–æ¶ˆæ¯å°è£…æˆæ¶ˆæ¯è½¬å‘å¯¹è±¡</h4><p><strong>ç¬¬ä¸‰æ­¥ï¼šä»å†…å­˜åˆ‡ç‰‡ä¸­ï¼Œä¸€ä¸ªæ¶ˆæ¯ä¸€ä¸ªæ¶ˆæ¯çš„è¯»å–å‡ºæ¥ï¼Œå°è£…æˆæ¶ˆæ¯è½¬å‘å¯¹è±¡ DispatchRequestã€‚</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token comment">// for å¾ªç¯è½¬å‘æ¶ˆæ¯</span>
<span class="token comment">// isCommitLogAvailable() ä¸º true è¡¨åè¿˜æœ‰æ¶ˆæ¯éœ€è¦åŒæ­¥</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">boolean</span> doNext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isCommitLogAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> doNext<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// ...... çœç•¥ ......</span>

    <span class="token comment">// æ ¹æ®æ¶ˆæ¯è½¬å‘çš„åç§»é‡ï¼Œè·å–è¯¥åç§»é‡åœ¨é‚£ä¸ª commitlog æ–‡ä»¶ä¸Šï¼Œè·å–è¯¥æ–‡ä»¶çš„å†…å­˜æ˜ å°„çš„åˆ‡ç‰‡</span>
    <span class="token class-name">SelectMappedBufferResult</span> result <span class="token operator">=</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span>reputFromOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getStartOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// ä¸€æ¡æ¶ˆæ¯ä¸€æ¡æ¶ˆæ¯çš„åŒæ­¥</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> readSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> readSize <span class="token operator">&lt;</span> result<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> doNext<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// ä»å†…å­˜æ˜ å°„æ–‡ä»¶åˆ‡ç‰‡ä¸­è¯»å–åˆ°äº†ä¸€ä¸ª dipatch åˆ†å‘æ¶ˆæ¯</span>
                <span class="token class-name">DispatchRequest</span> dispatchRequest <span class="token operator">=</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">checkMessageAndReturnSize</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> size <span class="token operator">=</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getMsgSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ...... çœç•¥æ¶ˆæ¯è¯»å–ç»“æœçš„å¤„ç† ......</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> 
            result<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        doNext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢ä»£ç çš„å…³é”®å°±æ˜¯ CommitLog#checkMessageAndReturnSize(ByteBuffer, boolean, boolean) è¿™ä¸ªæ–¹æ³•äº†ï¼Œè¿™é‡Œé¢å°±æ˜¯è¯»å–å†…å­˜åˆ‡ç‰‡ ByteBuffer ä¸­çš„æ•°æ®ï¼Œæ¯è¯»å–åˆ°ä¸€ä¸ªæ¶ˆæ¯å°±ä¼šå°†å…¶å°è£…ä¸º DispatchRequest å¯¹è±¡ã€‚</p><p>è¯»å–æ¶ˆæ¯æ˜¯ä¸¥æ ¼æŒ‰ç…§ commitlog å­˜å‚¨æ¶ˆæ¯çš„é¡ºåºæ¥åšçš„ï¼Œå…³äº commitlog çš„å•ä¸ªæ¶ˆæ¯çš„å­˜å‚¨æ•°æ®çš„æ ¼å¼å¯ä»¥çœ‹å‰é¢çš„æ–‡ç« ã€‚è¿™é‡Œä¸»è¦è¯´ä¸‹ checkMessageAndReturnSize æ–¹æ³•çš„å‡ ç§æƒ…å†µï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DispatchRequest</span> <span class="token function">checkMessageAndReturnSize</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span>ByteBuffer</span> byteBuffer<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> checkCRC<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> readBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1 TOTAL SIZE</span>
        <span class="token keyword">int</span> totalSize <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2 MAGIC CODE</span>
        <span class="token keyword">int</span> magicCode <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>magicCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">MESSAGE_MAGIC_CODE</span><span class="token operator">:</span>
                <span class="token comment">// æ­£å¸¸æ¶ˆæ¯çš„é­”æ³•å€¼</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">BLANK_MAGIC_CODE</span><span class="token operator">:</span>
                <span class="token comment">// æ–‡ä»¶å°¾</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DispatchRequest</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* success */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;found a illegal magic code 0x&quot;</span> <span class="token operator">+</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>magicCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æ³¨æ„æœ‰é—®é¢˜çš„ magic å€¼çš„ size å‚æ•°ä¼ çš„æ˜¯ -1</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DispatchRequest</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* success */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//  æ­£å¸¸æ¶ˆæ¯æ‰ä¼šèµ°åˆ°è¿™é‡Œï¼Œå¼‚å¸¸æƒ…å†µåœ¨ switch...case... ä¸­ç›´æ¥è¿”å›äº†</span>

        
        <span class="token comment">// ...... çœç•¥å…¶ä»– ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªæ–¹æ³•æœ‰å‡ ç§æƒ…å†µï¼Œä¸»è¦å…³æ³¨è¿”å›çš„å¯¹è±¡ DispatchRequest çš„ size å±æ€§å’Œ success å±æ€§</p><ul><li>æ¶ˆæ¯è¯»å–æˆåŠŸçš„æƒ…å†µï¼š <ul><li>è¯»åˆ°æŸä¸ª commitlog æ–‡ä»¶å°¾äº†ï¼Œå…ˆè¿”å›å‡ºå»ï¼Œåé¢ä¼šè·å–ä¸‹ä¸€ä¸ª commitlogï¼›</li><li>è¯»åˆ°ä¸€ä¸ªæ­£å¸¸çš„æ¶ˆæ¯äº†ï¼Œå°è£… DispatchRequest è¿”å›ï¼Œç­‰å¾…å¤„ç†ï¼›</li></ul></li><li>æ¶ˆæ¯è¯»å–å¤±è´¥çš„æƒ…å†µï¼š <ul><li>æ¶ˆæ¯å­˜å‚¨çš„é­”æ³•å€¼æœ‰é—®é¢˜ï¼›</li><li>æ¶ˆæ¯è™½ç„¶è¯»å–æˆåŠŸäº†ï¼Œä½†æ˜¯å¯èƒ½æ¶ˆæ¯çš„ crc æ ¡éªŒæ²¡è¿‡ï¼Œæˆ–è€…è¯»å–çš„æ¶ˆæ¯é•¿åº¦å’Œå…¶æœ¬èº«å­˜å‚¨çš„é•¿åº¦å­—æ®µçš„å€¼ä¸åŒï¼›</li></ul></li></ul><h4 id="æ¶ˆæ¯å¤„ç†" tabindex="-1"><a class="header-anchor" href="#æ¶ˆæ¯å¤„ç†" aria-hidden="true">#</a> æ¶ˆæ¯å¤„ç†</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>dispatchRequest<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// æ¶ˆæ¯è¯»å–æ­£å¸¸</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæ¶ˆæ¯é•¿åº¦å¤§äº 0ï¼Œåˆ™è°ƒç”¨ doDispatch() æ–¹æ³•å»åšçœŸæ­£çš„è½¬å‘å·¥ä½œ</span>
        <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doDispatch</span><span class="token punctuation">(</span>dispatchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ...... çœç•¥é•¿è½®è¯¢çš„æ¶ˆæ¯ç›‘å¬å™¨çš„å¤„ç† ......</span>

        <span class="token comment">// æ›´æ–°åŒæ­¥è¿›åº¦ï¼Œä¹Ÿå°±æ˜¯åç§»é‡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">+=</span> size<span class="token punctuation">;</span>
        readSize <span class="token operator">+=</span> size<span class="token punctuation">;</span>

        <span class="token comment">// ...... çœç•¥ç»Ÿè®¡ ......</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¯»åˆ°æ–‡ä»¶å°¾äº†ï¼Œç¿»é¡µæ“ä½œ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">=</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">rollNextFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        readSize <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dispatchRequest<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// æ¶ˆæ¯è§£æå¤±è´¥</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// æŸä¸ªæ¶ˆæ¯è¯»çš„æœ‰é—®é¢˜</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[BUG]read total count not equals msg total size. reputFromOffset={}&quot;</span><span class="token punctuation">,</span> reputFromOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">+=</span> size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        doNext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// If user open the dledger pattern or the broker is master node,</span>
        <span class="token comment">// it will not ignore the exception and fix the reputFromOffset variable</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getBrokerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token constant">MASTER_ID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[BUG]dispatch message to consume queue error, COMMITLOG OFFSET: {}&quot;</span><span class="token punctuation">,</span>
                      <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">+=</span> result<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> readSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°±çœ‹æ­£å¸¸çš„æƒ…å†µå§ï¼Œ<code>DefaultMessageStore.this.doDispatch(dispatchRequest);</code>ï¼Œæ ¸å¿ƒå°±æ˜¯æ‹¿è¯»å–åˆ°çš„ DispatchRequest å¯¹è±¡å»åšè½¬å‘æ“ä½œäº†ã€‚DefaultMessageStore#doDispatch çš„å®ç°å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * åŒæ­¥æ¶ˆæ¯åˆ° consumeQueue å’Œ index
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doDispatch</span><span class="token punctuation">(</span><span class="token class-name">DispatchRequest</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CommitLogDispatcher</span> dispatcher <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dispatcher<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ DefaultMessageStore çš„æ„é€ æ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº†ä¸¤ä¸ª CommitLogDispatcher ç±»å‹çš„å¯¹è±¡ï¼Œä»–ä»¬åˆ†åˆ«å¯¹åº”çš„æ˜¯ ConsumeQueue å’Œ index æ–‡ä»¶çš„è½¬å‘å™¨ã€‚æ¥ä¸‹æ¥å°±ä¾æ¬¡åˆ†æ ConsumeQueue å’Œ Index æ–‡ä»¶æ˜¯å¦‚ä½•æ„å»ºçš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æ·»åŠ æ¶ˆæ¯è½¬å‘å™¨ï¼Œæ„å»ºæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—çš„è½¬å‘å™¨å’Œæ„å»ºç´¢å¼•æ–‡ä»¶çš„è½¬å‘å™¨</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommitLogDispatcherBuildConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommitLogDispatcherBuildIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="consumequeue-æ„å»ºè¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#consumequeue-æ„å»ºè¿‡ç¨‹" aria-hidden="true">#</a> ConsumeQueue æ„å»ºè¿‡ç¨‹</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *  æ¶ˆæ¯åˆ†å‘ï¼Œåˆ†å‘åˆ° ConsumeQueue
 */</span>
<span class="token keyword">class</span> <span class="token class-name">CommitLogDispatcherBuildConsumeQueue</span> <span class="token keyword">implements</span> <span class="token class-name">CommitLogDispatcher</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token class-name">DispatchRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> tranType <span class="token operator">=</span> <span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token function">getTransactionValue</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>tranType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_NOT_TYPE</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_COMMIT_TYPE</span><span class="token operator">:</span>
                <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putMessagePositionInfo</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_PREPARED_TYPE</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_ROLLBACK_TYPE</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…³é”®å°±æ˜¯ DefaultMessageStore#putMessagePositionInfo æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putMessagePositionInfo</span><span class="token punctuation">(</span><span class="token class-name">DispatchRequest</span> dispatchRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ ¹æ®æ¶ˆæ¯ä¸»é¢˜ä¸é˜Ÿåˆ—IDï¼Œå…ˆè·å–å¯¹åº”çš„ConsumeQueueæ–‡ä»¶</span>
    <span class="token class-name">ConsumeQueue</span> cq <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findConsumeQueue</span><span class="token punctuation">(</span>dispatchRequest<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cq<span class="token punctuation">.</span><span class="token function">putMessagePositionInfoWrapper</span><span class="token punctuation">(</span>dispatchRequest<span class="token punctuation">,</span> <span class="token function">checkMultiDispatchQueue</span><span class="token punctuation">(</span>dispatchRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è·å–æˆ–åˆ›å»º-consumequeue" tabindex="-1"><a class="header-anchor" href="#è·å–æˆ–åˆ›å»º-consumequeue" aria-hidden="true">#</a> è·å–æˆ–åˆ›å»º ConsumeQueue</h4><p>åœ¨ DefaultMessageStore ä¸­æœ‰ consumeQueueTable çš„ Mapï¼Œä»è¿™é‡Œå°±å¯ä»¥çœ‹å‡º ConsumeQueue æ˜¯æ ¹æ® topic æ¥åŒºåˆ†çš„ï¼Œç„¶åæ¯ä¸ª queueId å¯¹åº”ä¸€ä¸ª ConsumeQueueï¼Œæ–¹ä¾¿åç»­ Consumer æ¥æ¶ˆè´¹æ¶ˆæ¯ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æ¶ˆæ¯é˜Ÿåˆ—å­˜å‚¨ç¼“å­˜è¡¨ï¼ŒæŒ‰ç…§æ¶ˆæ¯ä¸»é¢˜åˆ†ç»„</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* topic */</span><span class="token punctuation">,</span> <span class="token class-name">ConcurrentMap</span><span class="token operator">&lt;</span><span class="token class-name">Integer</span><span class="token comment">/* queueId */</span><span class="token punctuation">,</span> <span class="token class-name">ConsumeQueue</span><span class="token operator">&gt;&gt;</span> consumeQueueTable<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸»è¦çœ‹ä¸‹ ConsumeQueue æ„é€ æ–¹æ³•ï¼Œå› ä¸ºåœ¨æ¶ˆæ¯åˆ†å‘çš„æ—¶å€™ï¼Œä¼šå…ˆå°è¯•é€šè¿‡ topic å’Œ queueId è·å–å¯¹åº”çš„ ConsumeQueueï¼Œå¦‚æœä¸å­˜åœ¨å°±ä¼šå»åˆ›å»ºä¸€ä¸ªæ–°çš„ ConsumeQueueã€‚</p><p>ConsumeQueue çš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ConsumeQueue</span><span class="token punctuation">(</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> storePath<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> mappedFileSize<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">DefaultMessageStore</span> defaultMessageStore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>storePath <span class="token operator">=</span> storePath<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize <span class="token operator">=</span> mappedFileSize<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore <span class="token operator">=</span> defaultMessageStore<span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>topic <span class="token operator">=</span> topic<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queueId <span class="token operator">=</span> queueId<span class="token punctuation">;</span>

    <span class="token class-name">String</span> queueDir <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storePath
        <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span> topic
        <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span> queueId<span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFileQueue</span><span class="token punctuation">(</span>queueDir<span class="token punctuation">,</span> mappedFileSize<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ç”³è¯·äº† 20byte å¤§å°çš„ä¸´æ—¶ç¼“å†²åŒº</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferIndex <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token constant">CQ_STORE_UNIT_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...... çœç•¥ ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°±æ˜¯åˆ›å»ºä¸€ä¸ª mappedFileQueue å¯¹è±¡ï¼Œè¿™ä¸ªä¼šå»åšå†…å­˜æ˜ å°„æ“ä½œã€‚ç„¶åä¼šåˆ†é…ä¸€ä¸ªä¸´æ—¶ç¼“å†²åŒºï¼Œåœ¨æ’å…¥æ–°çš„ CQData æ—¶ä½¿ç”¨ï¼Œsize = 20byteã€‚</p><h4 id="è¿½åŠ -consumequeue-çš„æ•°æ®" tabindex="-1"><a class="header-anchor" href="#è¿½åŠ -consumequeue-çš„æ•°æ®" aria-hidden="true">#</a> è¿½åŠ  ConsumeQueue çš„æ•°æ®</h4><p>è¿½åŠ  ConsumeQueue æ•°æ® ConsumeQueue#putMessagePositionInfoWrapperï¼Œä¼šæœ€å¤§å°è¯•è¿½åŠ  30 æ¬¡ï¼Œæ ¸å¿ƒæ–¹æ³•å°±æ˜¯è°ƒç”¨ putMessagePositionInfo æ–¹æ³•ï¼Œå°±æ˜¯å»å¾€ ConsumeQueue çš„å†…å­˜æ˜ å°„æ–‡ä»¶ä¸­å†™å…¥æ•°æ®äº†ï¼Œå†…éƒ¨æ²¡ä»€ä¹ˆå¥½åˆ†æçš„ã€‚æˆ‘ä»¬åªè¦è®°ä½</p><ul><li>ConsumeQueue å†…å­˜å‚¨çš„æ¯æ¡æ•°æ®çš„æ ¼å¼æ˜¯ï¼š<strong>æ¯ä¸€ä¸ªæ¡ç›®å…± 20 ä¸ªå­—èŠ‚ï¼Œåˆ†åˆ«ä¸º 8 å­—èŠ‚çš„ commitlog ç‰©ç†åç§»é‡ã€4 å­—èŠ‚çš„æ¶ˆæ¯é•¿åº¦ã€8 å­—èŠ‚ tag hashcode</strong>ï¼›</li><li><strong>æ¯ä¸ª topic å’Œ queueId å¯¹åº”ä¸€ä¸ª ConsumeQueueï¼›</strong></li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putMessagePositionInfoWrapper</span><span class="token punctuation">(</span><span class="token class-name">DispatchRequest</span> request<span class="token punctuation">,</span> <span class="token keyword">boolean</span> multiQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æœ€å¤§é‡è¯• 30 æ¬¡</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> maxRetries <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å– ConsumeQueue æ ‡è®°ä½çŠ¶æ€ï¼Œåˆ¤æ–­å½“å‰æ˜¯å¦å¯å†™</span>
    <span class="token keyword">boolean</span> canWrite <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getRunningFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isCQWriteable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¾ªç¯å†™å…¥ CQDataï¼Œæœ€å¤§é‡è¯•æ¬¡æ•° 30</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxRetries <span class="token operator">&amp;&amp;</span> canWrite<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–æ¶ˆæ¯çš„ tagCode</span>
        <span class="token keyword">long</span> tagsCode <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getTagsCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...... çœç•¥å…¶ä»–å¤„ç† ......</span>

        <span class="token comment">// å‚æ•° 1ï¼šå½“å‰æ¶ˆæ¯ç‰©ç† offset</span>
        <span class="token comment">// å‚æ•° 2ï¼šæ¶ˆæ¯ size</span>
        <span class="token comment">// å‚æ•° 3ï¼štagCode</span>
        <span class="token comment">// å‚æ•° 4ï¼šæ¶ˆæ¯é€»è¾‘åç§»é‡ï¼ˆConsumeQueue å†…çš„åç§»é‡ï¼Œè½¬æ¢ä¸ºçœŸå®çš„ç‰©ç†åç§»é‡ï¼šæ¶ˆæ¯é€»è¾‘åç§»é‡ * 20ï¼‰</span>
        <span class="token comment">// æ­£å¸¸è¿”å›å€¼æ˜¯ true</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putMessagePositionInfo</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            request<span class="token punctuation">.</span><span class="token function">getMsgSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tagsCode<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getConsumeQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...... çœç•¥å…¶ä»–å¤„ç† ......</span>
            <span class="token comment">// checkPoint è®°å½•æœ€åä¸€æ¡ CQData æ‰€å½’å±çš„ msg çš„å­˜å‚¨æ—¶é—´</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLogicsMsgTimestamp</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// ...... çœç•¥å…¶ä»–å¤„ç† ......</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...... çœç•¥å¼‚å¸¸æƒ…å†µå¤„ç† ......</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// XXX: warn and notify me</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[BUG]consume queue can not write, {} {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topic<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getRunningFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeLogicsQueueError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="index-æ„å»ºè¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#index-æ„å»ºè¿‡ç¨‹" aria-hidden="true">#</a> Index æ„å»ºè¿‡ç¨‹</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">buildIndex</span><span class="token punctuation">(</span><span class="token class-name">DispatchRequest</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–å½“å‰ç´¢å¼•æ–‡ä»¶ï¼Œå‡å¦‚ list å†…ä¸å­˜åœ¨ file æˆ–è€…å½“å‰ file å†™æ»¡çš„è¯ï¼Œå°±åˆ›å»ºæ–°çš„ file</span>
    <span class="token class-name">IndexFile</span> indexFile <span class="token operator">=</span> <span class="token function">retryGetAndCreateIndexFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>indexFile <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–æ‰€æœ‰æ–‡ä»¶æœ€å¤§çš„ç‰©ç†åç§»é‡</span>
        <span class="token comment">// è·å–ç´¢å¼•æ–‡ä»¶æœ€åä¸€æ¡æ¶ˆæ¯ offset</span>
        <span class="token keyword">long</span> endPhyOffset <span class="token operator">=</span> indexFile<span class="token punctuation">.</span><span class="token function">getEndPhyOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DispatchRequest</span> msg <span class="token operator">=</span> req<span class="token punctuation">;</span>
        <span class="token comment">// æ¶ˆæ¯ä¸»é¢˜</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ¶ˆæ¯ key</span>
        <span class="token class-name">String</span> keys <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...... çœç•¥å¼‚å¸¸æƒ…å†µ ......</span>

        <span class="token comment">// ...... çœç•¥æ¶ˆæ¯ç±»å‹çš„åˆ¤æ–­ ......</span>

        <span class="token comment">// å¦‚æœæ¶ˆæ¯çš„å”¯ä¸€é”®ä¸ä¸ºç©ºï¼Œåˆ™æ·»åŠ åˆ°å“ˆå¸Œç´¢å¼•ä¸­ï¼Œä»¥ä¾¿åŠ é€Ÿæ ¹æ®å”¯ä¸€é”®æ£€ç´¢æ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getUniqKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            indexFile <span class="token operator">=</span> <span class="token function">putKey</span><span class="token punctuation">(</span>indexFile<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token function">buildKey</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getUniqKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ...... çœç•¥å¼‚å¸¸æƒ…å†µ ......</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æ„å»ºç´¢å¼•é”®ï¼ŒRocketMQæ”¯æŒä¸ºåŒä¸€ä¸ªæ¶ˆæ¯å»ºç«‹å¤šä¸ªç´¢å¼•ï¼Œå¤šä¸ªç´¢å¼•é”®ç”¨ç©ºæ ¼åˆ†å¼€ã€‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keys <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyset <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">KEY_SEPARATOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keyset<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> key <span class="token operator">=</span> keyset<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    indexFile <span class="token operator">=</span> <span class="token function">putKey</span><span class="token punctuation">(</span>indexFile<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token function">buildKey</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// ...... çœç•¥å¼‚å¸¸æƒ…å†µ ......</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;build index error, stop building index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼ŒRocketMQ ä¼šç»™æ¶ˆæ¯ç”Ÿæˆçš„å”¯ä¸€é”® UniqKeyï¼Œå’Œç”¨æˆ·è‡ªå®šä¹‰çš„ key ç”Ÿæˆç´¢å¼•ã€‚ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰å¤šä¸ª keyï¼Œç”¨ç©ºæ ¼éš”å¼€ã€‚</p><h4 id="è¿½åŠ æ•°æ®åˆ°-index" tabindex="-1"><a class="header-anchor" href="#è¿½åŠ æ•°æ®åˆ°-index" aria-hidden="true">#</a> è¿½åŠ æ•°æ®åˆ° Index</h4><p>è¿½åŠ æ•°æ®çš„æ ¸å¿ƒåœ¨ IndexFile#putKey æ–¹æ³•ï¼š</p><p><strong>ï¼ˆ1ï¼‰ç¬¬ä¸€æ­¥ï¼šè®¡ç®— key çš„å“ˆå¸Œå€¼ï¼Œæ ¹æ®å“ˆå¸Œå€¼è·¯ç”±å¯»å€åˆ°ä¸€ä¸ªå“ˆå¸Œæ§½ï¼Œè®¡ç®—è¯¥å“ˆå¸Œæ§½åœ¨è¯¥ Index æ–‡ä»¶ä¸Šçš„åœ°å€åç§»é‡</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// è®¡ç®—å“ˆå¸Œå€¼ï¼Œæ˜¯ä¸ªæ­£å€¼</span>
<span class="token keyword">int</span> keyHash <span class="token operator">=</span> <span class="token function">indexKeyHashMethod</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// æ ¹æ® keyHash å¯¹å“ˆå¸Œæ§½æ•°é‡å–ä½™å®šä½åˆ°å“ˆå¸Œå€¼å¯¹åº”çš„å“ˆå¸Œæ§½ä¸‹æ ‡</span>
<span class="token keyword">int</span> slotPos <span class="token operator">=</span> keyHash <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum<span class="token punctuation">;</span>
<span class="token comment">// å“ˆå¸Œç å¯¹åº”çš„å“ˆå¸Œæ§½çš„ç‰©ç†åœ°å€ä¸º   IndexHeaderï¼ˆ40å­—èŠ‚ï¼‰+ ä¸‹æ ‡ * æ¯ä¸ªå“ˆå¸Œæ§½çš„å¤§å°ï¼ˆ4å­—èŠ‚ï¼‰</span>
<span class="token keyword">int</span> absSlotPos <span class="token operator">=</span> <span class="token class-name">IndexHeader</span><span class="token punctuation">.</span><span class="token constant">INDEX_HEADER_SIZE</span> <span class="token operator">+</span> slotPos <span class="token operator">*</span> hashSlotSize<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ2ï¼‰ç¬¬äºŒæ­¥ï¼šè·å–è¯¥å“ˆå¸Œæ§½ä¹‹å‰å­˜å‚¨çš„æ•°æ®ï¼Œç”¨åœ¨å“ˆå¸Œå†²çªçš„æ—¶å€™çš„ï¼Œå°±ç›¸å½“äºä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ä¹‹å‰å­˜åœ¨è¿™é‡Œçš„ç´¢å¼•æ¡ç›®ï¼Œé“¾è¡¨ç»“æ„ã€‚</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">int</span> slotValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>absSlotPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>slotValue <span class="token operator">&lt;=</span> invalidIndex <span class="token operator">||</span> slotValue <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">getIndexCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    slotValue <span class="token operator">=</span> invalidIndex<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ3ï¼‰ç¬¬ä¸‰æ­¥ï¼šè®¡ç®—å¾…å­˜å‚¨æ¶ˆæ¯çš„æ—¶é—´æˆ³ä¸ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶é—´æˆ³çš„å·®å€¼ï¼Œå¹¶è½¬æ¢æˆç§’</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// è®¡ç®—å¾…å­˜å‚¨æ¶ˆæ¯çš„æ—¶é—´æˆ³ä¸ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶é—´æˆ³çš„å·®å€¼ï¼Œå¹¶è½¬æ¢æˆç§’</span>
<span class="token keyword">long</span> timeDiff <span class="token operator">=</span> storeTimestamp <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">getBeginTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
timeDiff <span class="token operator">=</span> timeDiff <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">getBeginTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    timeDiff <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>timeDiff <span class="token operator">&gt;</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    timeDiff <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>timeDiff <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    timeDiff <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ4ï¼‰ç¬¬å››æ­¥ï¼šå°† key çš„å“ˆå¸Œå€¼ã€æ¶ˆæ¯åœ¨ commitlog ä¸Šçš„ç‰©ç†åç§»é‡ã€æ¶ˆæ¯å­˜å‚¨çš„æ—¶é—´æˆ³çš„å·®å€¼ã€å“ˆå¸Œæ§½åŸæœ¬çš„å€¼ï¼ˆå¦‚æœå‘é€å“ˆå¸Œå†²çªäº†ï¼Œè¿™é‡Œå°±æ˜¯å­˜çš„å†²çªä¹‹å‰çš„æ¡ç›®çš„ç¼–å·äº†ï¼‰ï¼Œæœ€åå°†å½“å‰æ¶ˆæ¯çš„ç´¢å¼•ç¼–å·å­˜åˆ°å“ˆå¸Œæ§½é‡Œé¢ã€‚</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// è®¡ç®—æ–°æ·»åŠ æ¡ç›®çš„èµ·å§‹ç‰©ç†åç§»é‡</span>
<span class="token comment">// å¤´éƒ¨å­—èŠ‚é•¿åº¦ + å“ˆå¸Œæ§½æ•°é‡ Ã— å•ä¸ªå“ˆå¸Œæ§½å¤§å°ï¼ˆ4ä¸ªå­—èŠ‚ï¼‰+ å½“å‰Indexæ¡ç›®ä¸ªæ•° Ã— å•ä¸ªIndexæ¡ç›®å¤§å°ï¼ˆ20ä¸ªå­—èŠ‚ï¼‰ã€‚</span>
<span class="token comment">// 40 + 500w * 4 + å½“å‰Indexæ¡ç›®ä¸ªæ•° * 20</span>
<span class="token keyword">int</span> absIndexPos <span class="token operator">=</span>
    <span class="token class-name">IndexHeader</span><span class="token punctuation">.</span><span class="token constant">INDEX_HEADER_SIZE</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum <span class="token operator">*</span> hashSlotSize
        <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">getIndexCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> indexSize<span class="token punctuation">;</span>

<span class="token comment">// ä¾æ¬¡å°† key å“ˆå¸Œã€æ¶ˆæ¯ç‰©ç†åç§»é‡ã€æ¶ˆæ¯æ—¶é—´æˆ³å­˜å…¥MappedByteBufferã€‚</span>
<span class="token comment">// 20 ä¸ªå­—èŠ‚</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>absIndexPos<span class="token punctuation">,</span> keyHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> phyOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> timeDiff<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> slotValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å°†å½“å‰ Index æ–‡ä»¶ä¸­åŒ…å«çš„æ¡ç›®æ•°é‡å­˜å…¥å“ˆå¸Œæ§½ä¸­ï¼Œè¦†ç›–åŸå…ˆå“ˆå¸Œæ§½çš„å€¼ã€‚</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>absSlotPos<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">getIndexCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ5ï¼‰ç¬¬äº”æ­¥ï¼šå¦‚æœ <code>slotValue == invalidIndex</code>ï¼Œè¯´æ˜æ²¡æœ‰å‘ç”Ÿå“ˆå¸Œå†²çªï¼Œå°±éœ€è¦å»å¢åŠ æ§½å ç”¨ä¸ªæ•°äº†ã€‚ç„¶åå¢åŠ  Index ç´¢å¼•æ–‡ä»¶ä¸ªæ•°ï¼Œè®¾ç½® indexHeader çš„ endPhyOffset å’Œ endTimestamp çš„æŒ‡é’ˆã€‚</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜ä¹‹å‰çš„å“ˆå¸Œæ§½çš„æ•°æ®æ˜¯ 0ï¼Œè¯´æ˜ä¹‹å‰çš„å“ˆå¸Œæ§½æ²¡æœ‰è¢«å ç”¨ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å‘é€å“ˆå¸Œå†²çª</span>
<span class="token comment">// é‚£ä¹ˆå°±å°†å“ˆå¸Œæ§½å ç”¨çš„è®¡æ•° + 1</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>invalidIndex <span class="token operator">==</span> slotValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">incHashSlotCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// å½“å‰æ–‡ä»¶ä½¿ç”¨ç´¢å¼•æ¡ç›®å¢åŠ </span>
<span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">incIndexCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setEndPhyOffset</span><span class="token punctuation">(</span>phyOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setEndTimestamp</span><span class="token punctuation">(</span>storeTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç´¢å¼•æ–‡ä»¶å¦‚ä½•ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#ç´¢å¼•æ–‡ä»¶å¦‚ä½•ä½¿ç”¨" aria-hidden="true">#</a> ç´¢å¼•æ–‡ä»¶å¦‚ä½•ä½¿ç”¨</h2><h3 id="consumequeue-çš„ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#consumequeue-çš„ä½¿ç”¨" aria-hidden="true">#</a> ConsumeQueue çš„ä½¿ç”¨</h3><p>ç•¥ï¼Œä¼šåœ¨åˆ†ææ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™åˆ†æ</p><h3 id="index-çš„ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#index-çš„ä½¿ç”¨" aria-hidden="true">#</a> Index çš„ä½¿ç”¨</h3><p>Index ä½œä¸ºå“ˆå¸Œç´¢å¼•ï¼Œä¸»è¦æ˜¯ä¸ºäº†æä¾›æŸ¥è¯¢ä½¿ç”¨çš„ã€‚ä¸»è¦çœ‹ä¸€ä¸‹ IndexFile#selectPhyOffset æŸ¥è¯¢æ–¹æ³•ï¼Œè§£æä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å…¥å‚ï¼š</p><ul><li><code>List&lt;Long&gt; phyOffsets</code>ï¼šå­˜æ”¾æ¶ˆæ¯æŸ¥æ‰¾ç»“æœçš„å®¹å™¨ï¼›</li><li><code>String key</code>ï¼šå¾…æŸ¥è¯¢çš„ keyï¼Œæ ¼å¼å°±æ˜¯ topic#keyï¼›</li><li><code>int maxNum</code>ï¼šæœ¬æ¬¡æŸ¥è¯¢å…è®¸æŸ¥è¯¢çš„æœ€å¤šçš„æ¶ˆæ¯æ¬¡æ•°ï¼›</li><li><code>long begin</code>ï¼šæ¶ˆæ¯å­˜å‚¨çš„å¼€å¯æ—¶é—´ï¼›</li><li><code>long end</code>ï¼šæ¶ˆæ¯å­˜å‚¨çš„ç»“æŸæ—¶é—´ï¼›</li><li><code>boolean lock</code>ï¼šæ²¡å•¥ç”¨ï¼Œè¿™ä¸ªå‚æ•°ä»£ç ä¸­å·²ç»æ³¨é‡Šäº†ï¼Œï¼ˆä¹Ÿä¸åˆ é™¤ï¼ŒRocketMQ çš„ä»£ç æ‹‰èƒ¯ï¼‰ï¼›</li></ul><p>ä¸‹é¢åˆ†æå¦‚ä½•é€šè¿‡ Index æŸ¥æ‰¾æ¶ˆæ¯åœ¨ commitlog ä¸Šçš„åœ°å€åç§»é‡ï¼Œä»¥åŠå¦‚ä½•å¤„ç†å“ˆå¸Œç¢°æ’ï¼š</p><p><strong>ï¼ˆ1ï¼‰ç¬¬ä¸€æ­¥ï¼šè®¡ç®—å‡ºè¦æŸ¥æ‰¾çš„ key çš„å“ˆå¸Œå€¼ï¼Œä»¥åŠå‘½ä¸­çš„å“ˆå¸Œæ§½å’Œå¯¹åº”åœ¨ IndexFile æ–‡ä»¶ä¸­çš„åœ°å€åç§»é‡ã€‚</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æ ¹æ® key ç®—å‡º key çš„å“ˆå¸Œç ï¼ŒkeyHash å¯¹å“ˆå¸Œæ§½æ•°é‡å–ä½™ï¼Œå®šä½åˆ°å“ˆå¸Œç å¯¹åº”çš„å“ˆå¸Œæ§½ä¸‹æ ‡</span>
<span class="token keyword">int</span> keyHash <span class="token operator">=</span> <span class="token function">indexKeyHashMethod</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è®¡ç®—å½“å‰ key å‘½ä¸­å“ˆå¸Œæ§½ä¸­çš„ä¸‹æ ‡</span>
<span class="token keyword">int</span> slotPos <span class="token operator">=</span> keyHash <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum<span class="token punctuation">;</span>
<span class="token comment">// è®¡ç®—å‘½ä¸­çš„å“ˆå¸Œæ§½åœ¨ IndexFile æ–‡ä»¶ä¸­çš„åœ°å€åç§»é‡</span>
<span class="token keyword">int</span> absSlotPos <span class="token operator">=</span> <span class="token class-name">IndexHeader</span><span class="token punctuation">.</span><span class="token constant">INDEX_HEADER_SIZE</span> <span class="token operator">+</span> slotPos <span class="token operator">*</span> hashSlotSize<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ2ï¼‰ç¬¬äºŒæ­¥ï¼šæ ¹æ®å“ˆå¸Œæ§½çš„åœ°å€åç§»é‡ï¼Œè·å–å…¶ä¿å­˜çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ç´¢å¼•è®°å½•åœ¨ IndexFile æ–‡ä»¶ä¸­çš„ç¼–å·äº†ã€‚</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// è·å–å“ˆå¸Œæ§½ä¸­åŸæ¥å­˜å‚¨çš„ index æ–‡ä»¶çš„ç´¢å¼•</span>
<span class="token keyword">int</span> slotValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>absSlotPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ3ï¼‰ç¬¬ä¸‰æ­¥ï¼šæ ¡éªŒä»å“ˆå¸Œæ§½ä¸­è·å–çš„ç´¢å¼•è®°å½•ç¼–å·ï¼Œå¦‚æœè¯¥ç¼–å·æ— æ•ˆåˆ™ä»€ä¹ˆéƒ½ä¸å¤„ç†ã€‚</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>dex <span class="token operator">||</span> slotValue <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">getIndexCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">getIndexCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœå¯¹åº”çš„å“ˆå¸Œæ§½ä¸­å­˜å‚¨çš„æ•°æ®å°äº1æˆ–å¤§äºå½“å‰ç´¢å¼•æ¡ç›®ä¸ªæ•°ï¼Œè¡¨ç¤ºè¯¥å“ˆå¸Œç æ²¡æœ‰å¯¹åº”çš„æ¡ç›®ï¼Œç›´æ¥è¿”å›</span>
    <span class="token comment">// do nothing</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...... çœç•¥æœ‰æ•ˆçš„å¤„ç†æƒ…å†µ ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**ï¼ˆ4ï¼‰ç¬¬å››æ­¥ï¼šå¦‚æœä»å“ˆå¸Œæ§½è·å–çš„ç´¢å¼•è®°å½•çš„ç¼–å·æ˜¯æœ‰æ•ˆçš„ï¼Œé‚£ä¹ˆéœ€è¦æ ¡éªŒè¯¥ç´¢å¼•è®°å½•æ˜¯å¦åœ¨æŸ¥è¯¢çš„æ—¶é—´èŒƒå›´å†…ã€‚**å› ä¸ºç»™åœ¨å†™è®°å½•çš„æ—¶å€™ key å¯èƒ½ä¼šå­˜åœ¨å“ˆå¸Œå†²çªï¼Œå‰é¢è¯´è¿‡ï¼Œindex æ–‡ä»¶è§£å†³å“ˆå¸Œå†²çªçš„æ–¹å¼å°±æ˜¯ï¼Œåœ¨å‘é€å†²çªæ—¶åœ¨æ¯ä¸ªç´¢å¼•è®°å½•çš„æœ€å 4 ä¸ªå­—èŠ‚ä¿å­˜ä¸Šä¸€ä¸ªç´¢å¼•è®°å½•çš„ç¼–å·ï¼Œé€šè¿‡è¿™ä¸ªç¼–å·ç»„æˆé“¾è¡¨ç»“æ„ï¼Œè¿™æ ·å°±å¯ä»¥éå†æŸ¥æ‰¾äº†ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å› ä¸ºä¼šå­˜åœ¨å“ˆå¸Œå†²çªï¼Œæ‰€ä»¥éœ€è¦ for å¾ªç¯ä¾æ¬¡æŸ¥è¯¢</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> nextIndexToRead <span class="token operator">=</span> slotValue<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>phyOffsets<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> maxNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å·²ç»åˆ°è¾¾æœ¬æ¬¡æŸ¥æ‰¾æœ€å¤§æ¶ˆæ¯æ¡æ•°ï¼Œè·³å‡ºå¾ªç¯</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ ¹æ®Indexä¸‹æ ‡å®šä½åˆ°ç´¢å¼•è®°å½•çš„èµ·å§‹ç‰©ç†åç§»é‡ï¼Œç„¶åä¾æ¬¡è¯»å–å“ˆå¸Œç ã€ç‰©ç†åç§»é‡ã€æ—¶é—´æˆ³ã€ä¸Šä¸€ä¸ªæ¡ç›®çš„Indexä¸‹æ ‡</span>
    <span class="token keyword">int</span> absIndexPos <span class="token operator">=</span> <span class="token class-name">IndexHeader</span><span class="token punctuation">.</span><span class="token constant">INDEX_HEADER_SIZE</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum <span class="token operator">*</span> hashSlotSize <span class="token operator">+</span> nextIndexToRead <span class="token operator">*</span> indexSize<span class="token punctuation">;</span>

    <span class="token comment">// ä¾æ¬¡è·å– keyHashã€phyoffsetã€timeDiffã€prevIndex çš„æ•°æ®</span>
    <span class="token keyword">int</span> keyHashRead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>absIndexPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> phyOffsetRead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> timeDiff <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> prevIndexRead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>absIndexPos <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeDiff <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœå­˜å‚¨çš„æ—¶é—´æˆ³å°äº0ï¼Œåˆ™ç›´æ¥ç»“æŸæŸ¥æ‰¾</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ¢å¤æ¯«ç§’å€¼</span>
    timeDiff <span class="token operator">*=</span> <span class="token number">1000L</span><span class="token punctuation">;</span>

    <span class="token keyword">long</span> timeRead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">getBeginTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timeDiff<span class="token punctuation">;</span>
    <span class="token comment">// æ ¡éªŒæ—¶é—´æ˜¯å¦åŒ¹é…</span>
    <span class="token keyword">boolean</span> timeMatched <span class="token operator">=</span> <span class="token punctuation">(</span>timeRead <span class="token operator">&gt;=</span> begin<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>timeRead <span class="token operator">&lt;=</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>keyHash <span class="token operator">==</span> keyHashRead <span class="token operator">&amp;&amp;</span> timeMatched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‰¾åˆ°äº†</span>
        phyOffsets<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>phyOffsetRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevIndexRead <span class="token operator">&lt;=</span> invalidIndex
        <span class="token operator">||</span> prevIndexRead <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">getIndexCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">||</span> prevIndexRead <span class="token operator">==</span> nextIndexToRead <span class="token operator">||</span> timeRead <span class="token operator">&lt;</span> begin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å‘å‰æŸ¥æ‰¾</span>
    nextIndexToRead <span class="token operator">=</span> prevIndexRead<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç´¢å¼•æ–‡ä»¶çš„åˆ·ç›˜" tabindex="-1"><a class="header-anchor" href="#ç´¢å¼•æ–‡ä»¶çš„åˆ·ç›˜" aria-hidden="true">#</a> ç´¢å¼•æ–‡ä»¶çš„åˆ·ç›˜</h2><h3 id="consumequeue-çš„åˆ·ç›˜" tabindex="-1"><a class="header-anchor" href="#consumequeue-çš„åˆ·ç›˜" aria-hidden="true">#</a> ConsumeQueue çš„åˆ·ç›˜</h3><p>ConsumeQueue çš„åˆ·ç›˜æ˜¯ç”± FlushConsumeQueueService åå°çº¿ç¨‹æœåŠ¡å¤„ç†çš„ã€‚é¦–å…ˆçœ‹ FlushConsumeQueueService#run æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; service started&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// consumeQueue åˆ·ç›˜çš„ç­‰å¾…æ—¶é—´ï¼Œé»˜è®¤ 1 ç§’é’Ÿ</span>
            <span class="token keyword">int</span> interval <span class="token operator">=</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushIntervalConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doFlush</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; service has exception. &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doFlush</span><span class="token punctuation">(</span><span class="token constant">RETRY_TIMES_OVER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; service end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**RocketMQ ä¸­ ConsumeQueue çš„é»˜è®¤æ¯éš” 1 ç§’é’Ÿå»è°ƒç”¨ doFlush æ–¹æ³•å°è¯•åˆ·ç›˜ã€‚é‚£ä¹ˆçœ‹ä¸‹ doFlush æ–¹æ³•åšäº†ä»€ä¹ˆäº‹æƒ…ï¼š**ä¸»è¦å°±æ˜¯è·å–æ‰€æœ‰çš„ ConsumeQueueï¼Œå¹¶è°ƒç”¨å¯¹åº”çš„åˆ·ç›˜æ–¹æ³•å»è½ç›˜ï¼Œå¼ºåˆ¶åˆ·ç›˜çš„æ—¶é—´é—´éš”æ˜¯ 1 åˆ†é’Ÿã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFlush</span><span class="token punctuation">(</span><span class="token keyword">int</span> retryTimes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–æ¯æ¬¡åˆ·æ–°çš„è„é¡µæ•°é‡ï¼Œé»˜è®¤ 2 é¡µ</span>
    <span class="token keyword">int</span> flushConsumeQueueLeastPages <span class="token operator">=</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushConsumeQueueLeastPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>retryTimes <span class="token operator">==</span> <span class="token constant">RETRY_TIMES_OVER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flushConsumeQueueLeastPages <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> logicsMsgTimestamp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// å¼ºåˆ¶åˆ·ç›˜çš„æ—¶é—´å‘¨æœŸï¼Œé»˜è®¤ 1 åˆ†é’Ÿ</span>
    <span class="token keyword">int</span> flushConsumeQueueThoroughInterval <span class="token operator">=</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushConsumeQueueThoroughInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> currentTimeMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTimeMillis <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastFlushTimestamp <span class="token operator">+</span> flushConsumeQueueThoroughInterval<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lastFlushTimestamp <span class="token operator">=</span> currentTimeMillis<span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½®ä¸ºå¼ºåˆ¶åˆ·ç›˜</span>
        flushConsumeQueueLeastPages <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        logicsMsgTimestamp <span class="token operator">=</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLogicsMsgTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ConcurrentMap</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">ConsumeQueue</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tables <span class="token operator">=</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueTable<span class="token punctuation">;</span>

    <span class="token comment">// è°ƒç”¨æ¯ä¸ª consumerQueue çš„åˆ·ç›˜æ–¹æ³•</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">ConsumeQueue</span><span class="token punctuation">&gt;</span></span> maps <span class="token operator">:</span> tables<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumeQueue</span> cq <span class="token operator">:</span> maps<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> retryTimes <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>result<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> cq<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span>flushConsumeQueueLeastPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...... çœç•¥ checkpoint æ–‡ä»¶çš„æ“ä½œ ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="index-æ–‡ä»¶çš„åˆ·ç›˜" tabindex="-1"><a class="header-anchor" href="#index-æ–‡ä»¶çš„åˆ·ç›˜" aria-hidden="true">#</a> Index æ–‡ä»¶çš„åˆ·ç›˜</h3><p>å½“ä¸€ä¸ª Index æ–‡ä»¶å†™æ»¡åï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Index æ–‡ä»¶ï¼Œæ­¤æ—¶ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å»ç»™æ—§çš„ Index æ–‡ä»¶åšåˆ·ç›˜æ“ä½œã€‚ä¸»è¦çœ‹ IndexService#getAndCreateLastIndexFile æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">IndexFile</span> <span class="token function">getAndCreateLastIndexFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// çœç•¥ ......</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>indexFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> fileName <span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>storePath <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span> <span class="token class-name">UtilAll</span><span class="token punctuation">.</span><span class="token function">timeMillisToHumanString</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åˆ›å»º indexFile æ–‡ä»¶</span>
            indexFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexNum<span class="token punctuation">,</span> 
                                        lastUpdateEndPhyOffset<span class="token punctuation">,</span>lastUpdateIndexTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>indexFileList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>indexFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        
        <span class="token comment">// çœç•¥ ......</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>indexFile <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆ›å»ºæ–°æ–‡ä»¶åå¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè®©å‰ä¸€ä¸ªæ–‡ä»¶å¼ºåˆ¶åˆ·ç›˜</span>
            <span class="token keyword">final</span> <span class="token class-name">IndexFile</span> flushThisFile <span class="token operator">=</span> prevIndexFile<span class="token punctuation">;</span>
            <span class="token class-name">Thread</span> flushThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">IndexService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span>flushThisFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;FlushIndexFileThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            flushThread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            flushThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> indexFile<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: guosgbin@163.com">Dylan Kwok</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a href="/RocketMQ_source/15-broker%E7%9A%84%E5%88%B7%E7%9B%98%E6%9C%BA%E5%88%B6.html" class="nav-link prev" aria-label="15-brokerçš„åˆ·ç›˜æœºåˆ¶"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->15-brokerçš„åˆ·ç›˜æœºåˆ¶</div></a><a href="/RocketMQ_source/17-broker%E8%BF%87%E6%9C%9F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4%E6%9C%BA%E5%88%B6.html" class="nav-link next" aria-label="17-brokerè¿‡æœŸæ–‡ä»¶åˆ é™¤æœºåˆ¶"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">17-brokerè¿‡æœŸæ–‡ä»¶åˆ é™¤æœºåˆ¶<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-cadb7c17.js" defer></script>
  </body>
</html>
