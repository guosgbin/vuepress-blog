import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,f as e}from"./app-89fa67df.js";const t="/assets/broker的注册流程-080fdf9e.png",p={},o=e('<table><thead><tr><th>版本</th><th>内容</th><th style="text-align:left;">时间</th></tr></thead><tbody><tr><td>V1</td><td>新建</td><td style="text-align:left;">2022年08月01日23:15:33</td></tr><tr><td>V2</td><td>重构</td><td style="text-align:left;">2023年06月11日21:12:12</td></tr></tbody></table><h2 id="nameserver-路由管理" tabindex="-1"><a class="header-anchor" href="#nameserver-路由管理" aria-hidden="true">#</a> NameServer 路由管理</h2><p>NameServer 的作用</p><ol><li><strong>Broker 管理</strong>：NameServer 接受 Broker 集群的注册信息并且保存下来作为路由信息的基本数据。然后提供<strong>心跳检测机制，检查 Broker 是否还存活</strong>；</li><li><strong>路由信息管理</strong>：每个 NameServer 将保存关于 Broker 集群的整个路由信息和用于客户端查询的队列信息。然后 Producer 和 Consumer 通过 NameServer 就可以知道整个 Broker 集群的路由信息，从而进行消息的投递和消费；</li></ol><p>本文主要分析：</p><ol><li><strong>路由注册</strong>：broker 是如何注册到 NameServer 以及是如何保活的；</li><li><strong>路由剔除</strong>：NameServer 如何剔除失效的 broker；</li><li><strong>路由发现</strong>：Producer 和 Consumer 如何获取 NameServer 的路由信息；</li></ol><h2 id="路由注册" tabindex="-1"><a class="header-anchor" href="#路由注册" aria-hidden="true">#</a> 路由注册</h2><p><img src="'+t+`" alt="broker的注册流程"></p><h3 id="路由注册入口" tabindex="-1"><a class="header-anchor" href="#路由注册入口" aria-hidden="true">#</a> 路由注册入口</h3><p>我们需要关注 broker 是如何注册到 NameServer 的。关注 BrokerController#start 方法。</p><p>在 BrokerController#start 方法中会调用 <code>this.registerBrokerAll(true, false, true);</code> 方法去向 NameServer 注册路由信息。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// HA 相关处理</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">startProcessorByHa</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">handleSlaveSynchronize</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册broker</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerBrokerAll</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后在 broker 的启动过程中有触发一个定时任务，默认每 30 秒向 NameServer 发送一次心跳。具体代码在 方法中：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// broker 给 NameServer 发送心跳包</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">BrokerController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerBrokerAll</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> brokerConfig<span class="token punctuation">.</span><span class="token function">isForceRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;registerBrokerAll Exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getRegisterNameServerPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那么关键点就是 BrokerController#registerBrokerAll 方法了。</p><h3 id="broker-发送心跳信息" tabindex="-1"><a class="header-anchor" href="#broker-发送心跳信息" aria-hidden="true">#</a> broker 发送心跳信息</h3><p>BrokerController#registerBrokerAll 方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">registerBrokerAll</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> checkOrderConfig<span class="token punctuation">,</span> <span class="token keyword">boolean</span> oneway<span class="token punctuation">,</span> <span class="token keyword">boolean</span> forceRegister<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取 Topic 配置信息（生成 TopicConfigSerializeWrapper 对象）</span>
    <span class="token class-name">TopicConfigSerializeWrapper</span> topicConfigWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTopicConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildTopicConfigSerializeWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...... 省略 ...... 如果 Broker 没有写权限或读权限，则修改 TopicConfig 权限为 Broker 的权限；</span>

    <span class="token comment">// 判断是否需要向 nameserver 注册</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>forceRegister <span class="token operator">||</span> <span class="token function">needRegister</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getBrokerClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBrokerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getBrokerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getRegisterBrokerTimeoutMills</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 注册 broker</span>
        <span class="token function">doRegisterBrokerAll</span><span class="token punctuation">(</span>checkOrderConfig<span class="token punctuation">,</span> oneway<span class="token punctuation">,</span> topicConfigWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这一步的关键点就是通过 TopicConfigManager 创建一个 TopicConfigSerializeWrapper 实例。然后调用 BrokerController#doRegisterBrokerAll 方法去处理，最后会调用到 BrokerOuterAPI#registerBrokerAll 方法去给所有的 NameServer 发送一个心跳包（RPC）。</p><p>给 NameServer 的心跳包有哪些字段呢？主要是创建请求头和请求体。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 创建自定义请求头数据</span>
<span class="token keyword">final</span> <span class="token class-name">RegisterBrokerRequestHeader</span> requestHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegisterBrokerRequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
requestHeader<span class="token punctuation">.</span><span class="token function">setBrokerAddr</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
requestHeader<span class="token punctuation">.</span><span class="token function">setBrokerId</span><span class="token punctuation">(</span>brokerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
requestHeader<span class="token punctuation">.</span><span class="token function">setBrokerName</span><span class="token punctuation">(</span>brokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
requestHeader<span class="token punctuation">.</span><span class="token function">setClusterName</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
requestHeader<span class="token punctuation">.</span><span class="token function">setHaServerAddr</span><span class="token punctuation">(</span>haServerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
requestHeader<span class="token punctuation">.</span><span class="token function">setCompressed</span><span class="token punctuation">(</span>compressed<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建请求体数据</span>
<span class="token class-name">RegisterBrokerBody</span> requestBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegisterBrokerBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
requestBody<span class="token punctuation">.</span><span class="token function">setTopicConfigSerializeWrapper</span><span class="token punctuation">(</span>topicConfigWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
requestBody<span class="token punctuation">.</span><span class="token function">setFilterServerList</span><span class="token punctuation">(</span>filterServerList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> requestBody<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>compressed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 算出 crc32，用于做数据校验</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> bodyCrc32 <span class="token operator">=</span> <span class="token class-name">UtilAll</span><span class="token punctuation">.</span><span class="token function">crc32</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
requestHeader<span class="token punctuation">.</span><span class="token function">setBodyCrc32</span><span class="token punctuation">(</span>bodyCrc32<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>请求头部分：</p><ul><li>brokerAddr：当前 broker 的地址；</li><li>brokerId：当前 broker 的角色，0 是主节点，大于 0 表示从节点；</li><li>brokerName：当前 broker 的名称；</li><li>clusterName：当前 broker 所属的集群名；</li><li>haServerAddr：高可用节点的地址；</li><li>compressed：请求体是否压缩；</li><li>bodyCrc32：校验请求体是否被篡改；</li></ul><p>请求体部分：</p><ul><li>topicConfigWrapper：当前 broker 的主题配置信息。主要就是 Broker 启动时会创建的一些默认的 topic，这些默认的 topic 是在 TopicConfigManager 类的构造方法中配置的，例如自动创建主题的 AUTO_CREATE_TOPIC_KEY_TOPIC 主题，延迟消息的主题 RMQ_SYS_SCHEDULE_TOPIC。broker 的 topic 会存储在 topics.json 文件中；</li><li>filterServerList：消息过滤服务；</li></ul><p>在组装好注册 broker 的请求后，就会遍历所有的 NameServer 的地址，依次向其发送注册的 RPC 请求。消息的请求 code 是 RequestCode.REGISTER_BROKER。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> namesrvAddr <span class="token operator">:</span> nameServerAddressList<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// ...... 省略 ......</span>
    
    <span class="token comment">// 真正注册的地方，发送 rpc</span>
    <span class="token class-name">RegisterBrokerResult</span> result <span class="token operator">=</span> <span class="token function">registerBroker</span><span class="token punctuation">(</span>namesrvAddr<span class="token punctuation">,</span> oneway<span class="token punctuation">,</span> timeoutMills<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 保存注册结果</span>
        registerBrokerResultList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ...... 省略 ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="nameserver-处理心跳信息" tabindex="-1"><a class="header-anchor" href="#nameserver-处理心跳信息" aria-hidden="true">#</a> NameServer 处理心跳信息</h3><p>根据前面注册 broker 的请求 code 是 RequestCode.REGISTER_BROKER，可以定位到DefaultRequestProcessor#processRequest 用来处理 broker 的注册，通过 switch...case...语句定位到 DefaultRequestProcessor#registerBrokerWithFilterServer</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">registerBrokerWithFilterServer</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...... 省略 ...... 获取请求头数据</span>

    <span class="token comment">// ...... 省略 ...... 校验 crc</span>

    <span class="token comment">// ...... 省略 ...... 获取请求体数据</span>

    <span class="token comment">// broker 向 nameserver 注册</span>
    <span class="token class-name">RegisterBrokerResult</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>namesrvController<span class="token punctuation">.</span><span class="token function">getRouteInfoManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerBroker</span><span class="token punctuation">(</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">getBrokerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">getBrokerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">getHaServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        registerBrokerBody<span class="token punctuation">.</span><span class="token function">getTopicConfigSerializeWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        registerBrokerBody<span class="token punctuation">.</span><span class="token function">getFilterServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...... 省略 ...... 组装响应数据，响应头，响应体</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个方法的主要流程就是：</p><ol><li>首先创建一个响应的 RemotingCommand 对象；</li><li>将请求类型的 RemotingCommand 对象的请求头解析出来；</li><li>校验 crc32；</li><li>解码请求类型的 RemotingCommand 对象的请求体，也就是 topicConfigWrapper 对象；</li><li>调用 RouteInfoManager#registerBroker 方法存储 broker 相关信息；</li><li>将注册结果设置到响应对象 RemotingCommand 中；</li></ol><p>OK 到了关键的 RouteInfoManager#registerBroker 方法。这个方法其实就是对 RouteInfoManager 的几个 Map 属性的 CURD 操作。没什么好分析的，可以自行阅读。</p><h2 id="路由剔除" tabindex="-1"><a class="header-anchor" href="#路由剔除" aria-hidden="true">#</a> 路由剔除</h2><p>假如一个 Broker 发生故障了，NameServer 是如何感知的呢？</p><p>前面在分析 Broker 注册的时候，我们知道了 broker 的信息会存放在 RouteInfoManager 类的几个 Map 里，其中 RouteInfoManager#brokerLiveTable 的 key-value 的 value 如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">BrokerLiveInfo</span> <span class="token punctuation">{</span>
    <span class="token comment">// 上次收到 Broker 心跳的时间</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> lastUpdateTimestamp<span class="token punctuation">;</span>
    <span class="token comment">// 心跳的版本号</span>
    <span class="token keyword">private</span> <span class="token class-name">DataVersion</span> dataVersion<span class="token punctuation">;</span>
    <span class="token comment">// 通信通道</span>
    <span class="token keyword">private</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">;</span>
    <span class="token comment">// 用于主从同步</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> haServerAddr<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>NameServer 感知 broker 下线有两个路径：</p><ul><li><strong>第一个是 broker 关机，会主动给 NameServer 发送一个下线的请求，这样 NameServer 就会将对应的 broker 信息从 RouteInfoManager 的几个 Map 中移除；</strong></li><li><strong>在 NamesrvController#initialize 中启动了一个定时任务，每隔 10 秒去扫描 RouteInfoManager#brokerLiveTable；</strong></li></ul><p>本次主要以定时任务来分析路由剔除：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 省略...</span>

    <span class="token comment">// 定时任务，每隔 10 秒扫描一次 Broker，移除故障的 Broker</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">NamesrvController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>routeInfoManager<span class="token punctuation">.</span><span class="token function">scanNotActiveBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 省略...</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关键到了 RouteInfoManager#scanNotActiveBroker</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 扫描 brokerLiveTable 表，剔除掉 120 秒（默认）内未发心跳的 broker 地址
 * 1 关闭 Channel
 * 2 将当前 broker 地址从 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">brokerLiveTable</span></span><span class="token punctuation">}</span> 移除
 * 3 移除映射表的数据
 *      <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">brokerAddrTable</span></span><span class="token punctuation">}</span>
 *      <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">clusterAddrTable</span></span><span class="token punctuation">}</span>
 *      <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">topicQueueTable</span></span><span class="token punctuation">}</span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scanNotActiveBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BrokerLiveInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerLiveTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BrokerLiveInfo</span><span class="token punctuation">&gt;</span></span> next <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取上次收到 broker 的心跳时间</span>
        <span class="token keyword">long</span> last <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastUpdateTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 校验时间，上一次时间 + 默认 120 秒 &lt; 当前时间</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>last <span class="token operator">+</span> <span class="token constant">BROKER_CHANNEL_EXPIRED_TIME</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 关闭 Channel</span>
            <span class="token class-name">RemotingUtil</span><span class="token punctuation">.</span><span class="token function">closeChannel</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;The broker channel expired, {} {}ms&quot;</span><span class="token punctuation">,</span> next<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">BROKER_CHANNEL_EXPIRED_TIME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onChannelDestroy</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主要流程就是遍历 RouteInfoManager#brokerLiveTable 依次做如下处理：</p><ol><li>获取上次 broker 的心跳时间，判断这个 broker 是否已经超过 120 秒未发心跳；</li><li>假如超过 120 秒未发送心跳，则认为这个 broker 发生故障了，需要 <ol><li>关闭 Channel 连接；</li><li>将当前 broker 的信息从 RouteInfoManager#brokerLiveTable 移除；</li><li>针对 RouteInfoManager 类中的几个 Map 做增删改查的操作；</li></ol></li></ol><h2 id="路由发现" tabindex="-1"><a class="header-anchor" href="#路由发现" aria-hidden="true">#</a> 路由发现</h2><p>主题的路由信息都是存在 NameServer 的，当某个主题的路由信息发生改变了，NameServer 不会主动推送新的路由信息到客户端。客户端会定时的从 NameServer 中拉取最新的路由信息。</p><p>客户端定时拉取最新的路由信息的定时任务在 MQClientInstance#startScheduledTask 方法中：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 定时任务1，从 nameserver 更新客户端本地的 topic 的路由信息</span>
<span class="token comment">// 30 秒</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">MQClientInstance</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateTopicRouteInfoFromNameServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;ScheduledTask updateTopicRouteInfoFromNameServer exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientConfig<span class="token punctuation">.</span><span class="token function">getPollNameServerInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>客户端每隔 30 秒从 NameServer 拉取一次主题路由信息。在 updateTopicRouteInfoFromNameServer 方法中根据主题名称给 NameServer 发送一个更新路由信息的请求 code 是 RequestCode.GET_ROUTEINFO_BY_TOPIC。</p><p>NameServer 处理 RequestCode.GET_ROUTEINFO_BY_TOPIC 流程如下，主要就是 pickupTopicRouteData 方法，其实就是对 RouteInfoManager 中的几个 Map 的 CURD，没什么好分析的。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">getRouteInfoByTopic</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span>
    <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// ...... 省略 ......</span>
    
    <span class="token comment">// 获取 topic 的路由信息</span>
    <span class="token class-name">TopicRouteData</span> topicRouteData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>namesrvController<span class="token punctuation">.</span><span class="token function">getRouteInfoManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pickupTopicRouteData</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...... 省略 ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最终返回给客户端的路由信息的对象是 TopicRouteData，它的各个字段如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * topic 路由信息
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopicRouteData</span> <span class="token keyword">extends</span> <span class="token class-name">RemotingSerializable</span> <span class="token punctuation">{</span>
    <span class="token comment">// 顺序消息配置</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderTopicConf<span class="token punctuation">;</span>
    <span class="token comment">// 主题队列的元数据</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QueueData</span><span class="token punctuation">&gt;</span></span> queueDatas<span class="token punctuation">;</span>
    <span class="token comment">// 主题分布在那些 broker 上，地址信息</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BrokerData</span><span class="token punctuation">&gt;</span></span> brokerDatas<span class="token punctuation">;</span>
    <span class="token comment">// broker 上的过滤服务器列表</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* brokerAddr */</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token comment">/* Filter Server */</span><span class="token operator">&gt;</span> filterServerTable<span class="token punctuation">;</span>

    <span class="token comment">// ...... 省略 ......</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,54),c=[o];function l(i,u){return s(),a("div",null,c)}const d=n(p,[["render",l],["__file","08-NameServer路由管理源码分析.html.vue"]]);export{d as default};
